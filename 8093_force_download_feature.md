# 8093系统强制下载功能实现

## 实施日期
2025-09-11

## 问题背景
系统设计为优先使用本地缓存文件，导致：
1. 无法获取最新的腾讯文档内容
2. 测试时使用了过期的本地文件
3. 出现编码错误（CSV读取器试图读取Excel文件）

## 解决方案

### 1. 添加强制下载选项
在高级设置中添加了"强制下载新文件"复选框，默认勾选。

### 2. 代码修改
- 修改了`run_complete_workflow`函数
- 添加了`force_download`参数
- 当启用时，跳过本地文件检查，直接下载

### 3. UI更新
```html
<div class="setting-row">
    <label>强制下载新文件（不使用本地缓存）</label>
    <input type="checkbox" id="forceDownload" checked>
</div>
```

## 使用方法

### 默认行为（推荐）
- **强制下载**默认开启 ✅
- 每次执行都会从腾讯文档下载最新内容
- 确保数据的实时性和准确性

### 使用本地缓存
- 取消勾选"强制下载新文件"
- 系统将优先使用本地已下载的文件
- 适合测试和调试场景

## 技术细节

### 工作流程
```
用户输入URL → 检查force_download标志
    ↓
如果force_download = true:
    → 直接下载新文件
如果force_download = false:
    → 先检查本地缓存
    → 如果有则使用本地
    → 如果没有则下载
```

### 文件存储规范
- 基线文件：`csv_versions/2025_W{周数}/baseline/`
- 目标文件：`csv_versions/2025_W{周数}/midweek/`
- 命名格式：`tencent_{文档名}_{时间戳}_{类型}_W{周数}.{扩展名}`

## 优势

1. **灵活性**：用户可以选择使用缓存或强制下载
2. **实时性**：默认获取最新数据
3. **性能**：需要时可以使用缓存提高速度
4. **可靠性**：避免使用过期或错误的本地文件

## 注意事项

1. **Cookie有效性**：确保Cookie仍然有效（24-48小时）
2. **网络连接**：强制下载需要稳定的网络连接
3. **存储空间**：频繁下载会占用更多磁盘空间
4. **清理缓存**：定期清理旧的下载文件

## 测试建议

1. 访问 http://202.140.143.88:8093/
2. 输入腾讯文档URL和有效Cookie
3. 确保"强制下载新文件"已勾选
4. 点击"开始执行完整流程"
5. 观察日志确认是否执行实际下载

## 后续优化

1. 添加缓存过期时间设置
2. 显示本地缓存文件信息
3. 提供一键清理缓存功能
4. 添加下载进度显示