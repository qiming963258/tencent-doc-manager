# 腾讯文档上传系统 - 技术文档

## 1. 系统架构

### 核心组件关系图

```
┌─────────────────────────────────────────────┐
│           Web界面 (8109端口)                  │
│         upload_test_server_8109.py           │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│          核心上传模块                         │
│      tencent_upload_enhanced.py              │
│                                              │
│  - Cookie认证                                │
│  - 文件上传                                  │
│  - URL获取                                   │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│         Playwright浏览器自动化                │
│         (Chromium/Firefox/WebKit)            │
└─────────────────────────────────────────────┘
```

## 2. 关键技术实现

### 2.1 Cookie认证机制

```python
# Cookie添加到多个域名确保兼容性
for domain in ['.qq.com', '.docs.qq.com']:
    cookie_list.append({
        'name': name.strip(),
        'value': value.strip(),
        'domain': domain,
        'path': '/',
        'httpOnly': False,
        'secure': True,
        'sameSite': 'None'
    })
```

关键字段：
- `DOC_SID` - 文档会话ID
- `SID` - 会话ID
- `uid` - 用户ID
- `uid_key` - 用户密钥

### 2.2 上传流程

1. **点击导入按钮**
```python
selector = 'button.desktop-import-button-pc'
await page.click(selector)
```

2. **处理文件选择**
```python
# 监听文件选择器事件
async with page.expect_file_chooser() as fc_info:
    file_chooser = await fc_info.value
    await file_chooser.set_files(file_path)
```

3. **点击确认按钮**
```python
selector = 'button.dui-button.dui-button-type-primary > div.dui-button-container'
await page.click(selector)
```

4. **获取新文档URL**
```python
# 等待新文档生成
await page.wait_for_timeout(5000)
# 获取当前URL
new_url = page.url
```

### 2.3 登录状态检测

修复后的检测逻辑：
```javascript
const hasUserInfo = document.querySelector('.user-info, [class*="avatar"]');
const hasLoginBtn = Array.from(document.querySelectorAll('button')).some(
    btn => btn.textContent && btn.textContent.includes('登录')
);
```

### 2.4 错误处理策略

采用"尽力而为"策略：
- Cookie认证失败 → 记录警告但继续
- 文件选择器超时 → 尝试直接设置文件
- URL获取失败 → 返回部分成功结果

## 3. CSS选择器说明

### 当前使用的选择器（2025-09-09）

| 元素 | 选择器 | 说明 |
|-----|--------|-----|
| 导入按钮 | `button.desktop-import-button-pc` | 桌面版导入按钮 |
| 确认按钮 | `button.dui-button.dui-button-type-primary > div.dui-button-container` | 主要操作按钮的容器 |
| 文件输入 | `input[type="file"]` | 文件选择输入框 |
| 用户信息 | `.user-info, [class*="avatar"]` | 用户头像或信息区域 |
| 创建按钮 | `.create-btn, .new-doc-btn` | 新建文档按钮 |

### 选择器更新方法

如果腾讯文档UI更新，按以下步骤更新选择器：

1. 打开浏览器开发者工具（F12）
2. 使用元素选择器定位目标元素
3. 右键 → Copy → Copy selector
4. 更新 `tencent_upload_enhanced.py` 中的 `self.selectors`

## 4. 调试技巧

### 4.1 启用详细日志

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

### 4.2 截图调试

```python
# 在关键步骤截图
await page.screenshot(path=f'debug_{timestamp}.png')
```

### 4.3 暂停调试

```python
# 暂停等待手动操作
await page.pause()
```

### 4.4 网络请求监控

```python
# 监听网络请求
page.on('request', lambda req: print(f'Request: {req.url}'))
page.on('response', lambda res: print(f'Response: {res.status} {res.url}'))
```

## 5. 性能优化

### 5.1 无头模式

生产环境使用无头模式提高性能：
```python
await p.chromium.launch(headless=True)
```

### 5.2 资源优化

禁用图片和CSS加载：
```python
await page.route('**/*.{png,jpg,jpeg,gif,css}', lambda route: route.abort())
```

### 5.3 并发限制

避免同时启动多个浏览器实例：
```python
# 使用单例模式或信号量控制
semaphore = asyncio.Semaphore(1)
```

## 6. 安全考虑

### 6.1 Cookie安全

- 不要将Cookie提交到版本控制
- 使用环境变量或加密存储
- 定期更新Cookie

### 6.2 文件验证

```python
# 验证文件类型和大小
ALLOWED_EXTENSIONS = {'.xlsx', '.xls', '.csv'}
MAX_FILE_SIZE = 10 * 1024 * 1024  # 10MB
```

### 6.3 输入清理

```python
# 使用secure_filename清理文件名
from werkzeug.utils import secure_filename
filename = secure_filename(file.filename)
```

## 7. 故障排查

### 常见错误及解决方案

| 错误 | 原因 | 解决方案 |
|-----|------|---------|
| Cookie认证失败 | Cookie过期或无效 | 重新获取Cookie |
| 文件选择器超时 | 页面加载慢或UI变化 | 增加超时时间或更新选择器 |
| 导入按钮未找到 | 未登录或页面未加载 | 检查登录状态和等待时间 |
| URL获取失败 | 上传未完成 | 增加等待时间 |
| 浏览器启动失败 | Playwright未正确安装 | 运行 `playwright install` |

### 日志分析

关键日志标记：
- `🚀` - 启动操作
- `✅` - 成功
- `⚠️` - 警告
- `❌` - 错误
- `📊` - 状态信息
- `📤` - 上传操作

## 8. API限制

### 腾讯文档限制

- 单文件大小：最大20MB
- 支持格式：xlsx, xls, csv
- 并发上传：建议单线程
- 请求频率：避免频繁请求

### Playwright限制

- 内存使用：每个浏览器实例约100-200MB
- CPU使用：渲染页面时CPU占用较高
- 磁盘空间：浏览器缓存和临时文件

## 9. 扩展开发

### 添加新功能

1. **批量上传**
```python
async def batch_upload(file_list):
    results = []
    for file in file_list:
        result = await upload_file(file)
        results.append(result)
    return results
```

2. **定时上传**
```python
import schedule
schedule.every().day.at("09:00").do(upload_task)
```

3. **文件监控**
```python
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler
```

### 集成其他服务

- **钉钉通知**
- **邮件通知**
- **数据库记录**
- **日志分析**

## 10. 版本兼容性

### Python版本
- 最低要求：Python 3.7+
- 推荐版本：Python 3.9+

### 依赖版本
- playwright >= 1.40.0
- flask >= 2.0.0
- asyncio (内置)

### 浏览器版本
- Chromium: 最新版
- Firefox: 最新版（可选）
- WebKit: 最新版（可选）

### 操作系统
- Windows 10/11
- Linux (Ubuntu 20.04+)
- macOS 10.15+

---

*技术文档版本：1.0.0*
*更新日期：2025-09-09*