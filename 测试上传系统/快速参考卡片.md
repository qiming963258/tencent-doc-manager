# 🎯 腾讯文档自动化 - 快速参考卡片

## ✅ 成功登录的5个关键点

### 1️⃣ Cookie分割必须正确
```python
# ❌ 错误
cookie_string.split(';')

# ✅ 正确
cookie_string.split('; ')  # 注意空格！
```

### 2️⃣ Cookie域设置
```python
# ❌ 错误 - 多个域
'domain': '.qq.com' 和 '.docs.qq.com'

# ✅ 正确 - 单一域
'domain': '.docs.qq.com'
```

### 3️⃣ 访问正确的页面
```python
# ❌ 错误
await page.goto('https://docs.qq.com/')

# ✅ 正确
await page.goto('https://docs.qq.com/desktop/')
```

### 4️⃣ 充分等待
```python
# ❌ 错误
await page.wait_for_timeout(2000)

# ✅ 正确
await page.wait_for_timeout(5000)
```

### 5️⃣ 验证登录状态
```python
# 成功标志
✅ 无登录按钮
✅ 有导入按钮 (button.desktop-import-button-pc)
✅ 有用户信息
```

---

## 📤 成功上传的4个步骤

### 步骤1：点击导入按钮
```python
button = await page.wait_for_selector('button.desktop-import-button-pc')
await button.click()
```

### 步骤2：选择文件
```python
file_inputs = await page.query_selector_all('input[type="file"]')
await file_inputs[-1].set_input_files(file_path)
```

### 步骤3：确认上传
```python
confirm = await page.query_selector('button.dui-button-type-primary:has-text("确定")')
await confirm.click()
```

### 步骤4：等待完成
```python
# URL变化表示成功
if '/sheet/' in page.url or '/doc/' in page.url:
    print("上传成功")
```

---

## 🚀 最简代码（30行）

```python
import asyncio
from playwright.async_api import async_playwright

async def upload(cookie_str, file_path):
    async with async_playwright() as p:
        # 启动
        browser = await p.chromium.launch(headless=False)
        context = await browser.new_context()
        page = await context.new_page()
        
        # Cookie处理（关键！）
        cookies = []
        for pair in cookie_str.split('; '):  # 注意空格
            if '=' in pair:
                name, value = pair.split('=', 1)
                cookies.append({
                    'name': name.strip(),
                    'value': value.strip(),
                    'domain': '.docs.qq.com',
                    'path': '/'
                })
        await context.add_cookies(cookies)
        
        # 登录
        await page.goto('https://docs.qq.com/desktop/')  # desktop!
        await page.wait_for_timeout(5000)  # 5秒！
        
        # 上传
        btn = await page.wait_for_selector('button.desktop-import-button-pc')
        await btn.click()
        await page.wait_for_timeout(1000)
        
        inputs = await page.query_selector_all('input[type="file"]')
        await inputs[-1].set_input_files(file_path)
        
        await page.wait_for_timeout(2000)
        confirm = await page.query_selector('button:has-text("确定")')
        if confirm:
            await confirm.click()
        
        await page.wait_for_timeout(10000)
        success = '/sheet/' in page.url or '/doc/' in page.url
        
        await browser.close()
        return success
```

---

## 📋 Cookie获取步骤

1. Chrome打开 https://docs.qq.com
2. 登录账号
3. F12 → Network
4. 刷新页面
5. 找任意请求 → Headers → Cookie
6. 复制完整值

---

## ⚠️ 常见错误对照表

| 症状 | 原因 | 解决 |
|-----|------|------|
| 登录失败 | Cookie分割错误 | 使用 `'; '` |
| 页面超时 | 访问主页而非desktop | 直接访问 `/desktop/` |
| 找不到按钮 | 等待时间不足 | 等待5秒 |
| 文件选择失败 | 路径不是绝对路径 | 使用 `Path.resolve()` |
| 上传无响应 | 未点击确定 | 查找确定按钮或按Enter |

---

## 🔑 核心原理

```
成功 = 正确的Cookie处理 + 正确的页面访问 + 充分的等待
```

1. **Cookie处理**：浏览器标准格式是 `; ` 分隔
2. **页面访问**：desktop是已登录用户的入口
3. **等待策略**：React/Vue需要时间渲染

---

## 📞 调试技巧

```python
# 1. 使用可见模式
headless=False

# 2. 打印关键信息
print(f"Cookies: {len(cookies)}")
print(f"Title: {await page.title()}")
print(f"URL: {page.url}")

# 3. 截图保存
await page.screenshot(path="debug.png")

# 4. 保持浏览器打开
await asyncio.sleep(30)
```

---

**记住核心要点**：
- Cookie用 `'; '` 分割
- 只设置 `.docs.qq.com` 域  
- 直接访问 `/desktop/` 页面
- 等待5秒确保加载完成
- 通过URL变化判断成功