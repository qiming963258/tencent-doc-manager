# 📖 腾讯文档Cookie自动化操作手册

## 🎯 快速复制成功经验的步骤指南

---

## 第一步：获取有效Cookie（最关键）

### 1.1 手动登录腾讯文档
1. 打开Chrome浏览器
2. 访问 https://docs.qq.com
3. 使用QQ或微信完成登录
4. 确保能看到你的文档列表

### 1.2 提取Cookie的精确方法
1. **按F12打开开发者工具**
2. **切换到Network（网络）面板**
3. **在腾讯文档页面进行任意操作**（如点击文档、刷新页面）
4. **在Network面板中找到以下关键请求**：
   - `user_info?get_vip_info=1`
   - `account_list?xsrf=...`
   - 或任何发送到`docs.qq.com`的请求

5. **右键点击该请求 → Copy → Copy as cURL**
6. **或者点击请求 → Headers标签 → 找到Request Headers中的cookie行**

### 1.3 Cookie格式示例
提取到的Cookie应该类似这样：
```
fingerprint=xxx; low_login_enable=1; RK=xxx; ptcz=xxx; DOC_QQ_APPID=101458937; uid=144115414584628119; DOC_SID=xxx; SID=xxx; language=zh-CN; ...
```

**必须包含的关键字段**：
- `uid=` - 用户ID
- `DOC_SID=` - 文档会话ID  
- `SID=` - 会话ID
- `TOK=` - 令牌
- `traceid=` - 追踪ID

---

## 第二步：配置自动化脚本

### 2.1 更新Cookie字符串
在脚本中找到这一行：
```python
self.cookie_string = "你的旧Cookie"
```

替换为：
```python
self.cookie_string = "你刚才提取的完整Cookie字符串"
```

### 2.2 验证脚本配置
确保脚本包含以下关键配置：
```python
# 正确的Cookie解析
def parse_cookies(self):
    cookies = []
    for cookie_pair in self.cookie_string.split('; '):
        if '=' in cookie_pair:
            name, value = cookie_pair.split('=', 1)
            cookies.append({
                'name': name.strip(),
                'value': value.strip(),
                'domain': '.docs.qq.com',  # 注意前面的点
                'path': '/'
            })
    return cookies

# 正确的浏览器配置
browser = await playwright.chromium.launch(
    headless=False,  # 设为False便于观察
    args=['--start-maximized', '--no-sandbox']
)

# 正确的执行顺序
await context.add_cookies(self.parse_cookies())
await self.page.goto('https://docs.qq.com/desktop/')  # 直接访问桌面
```

---

## 第三步：执行和验证

### 3.1 运行脚本
```bash
cd D:\enterprise_download_system
python latest_valid_downloader.py
```

### 3.2 成功标志
看到以下输出表示成功：
```
[PAGE] 桌面页面加载完成
[PAGE] 标题: 腾讯文档
[FOUND] a[href*="/doc/"]: 找到X个元素
[DOC 1] 文档名称...
```

### 3.3 失败排查
如果看到以下输出表示失败：
```
[ERROR] Cookie无效，仍需登录
```

**解决方法**：
1. 重新提取Cookie（可能已过期）
2. 检查Cookie字符串是否完整
3. 确认手动登录状态正常

---

## 第四步：优化下载功能

### 4.1 当前状态
脚本现在能够：
- ✅ 成功登录
- ✅ 访问文档列表
- ✅ 找到文档元素
- ✅ 触发下载动作
- ❌ 文件实际保存（需要优化）

### 4.2 下载优化建议
```python
# 增加下载格式选择
async def handle_download_dialog(self):
    # 等待下载格式选择对话框
    try:
        # 选择PDF格式
        pdf_option = await self.page.wait_for_selector('text=PDF', timeout=5000)
        await pdf_option.click()
        
        # 确认下载
        download_btn = await self.page.wait_for_selector('text=确定', timeout=5000)
        await download_btn.click()
    except:
        pass

# 在下载触发后调用
await element.click(button='right')
await self.page.click('text=下载')
await self.handle_download_dialog()  # 新增这一行
```

---

## 第五步：故障排除指南

### 5.1 常见问题及解决方案

#### 问题1：Cookie过期
**现象**：脚本运行但显示需要登录
**解决**：重新执行第一步获取新Cookie

#### 问题2：页面元素找不到
**现象**：`[FOUND] 找到0个元素`
**解决**：
1. 增加页面等待时间
2. 检查文档选择器是否正确
3. 手动检查页面结构

#### 问题3：下载未完成
**现象**：点击下载但文件未保存
**解决**：
1. 检查下载文件夹权限
2. 添加下载格式选择逻辑
3. 增加下载完成等待时间

#### 问题4：编码错误
**现象**：Windows下出现中文乱码
**解决**：在脚本开头添加：
```python
# -*- coding: utf-8 -*-
```

### 5.2 调试技巧

#### 实时观察模式
```python
# 在关键步骤后添加
await asyncio.sleep(10)  # 暂停10秒供观察
input("按Enter继续...")  # 手动控制进度
```

#### 详细日志记录
```python
print(f"[DEBUG] 当前URL: {self.page.url}")
print(f"[DEBUG] 页面标题: {await self.page.title()}")
print(f"[DEBUG] 找到元素数: {len(elements)}")
```

---

## 第六步：扩展和自定义

### 6.1 下载数量调整
```python
# 修改下载数量
downloaded_count = await self.find_and_download_documents(20)  # 下载20个
```

### 6.2 文档类型筛选
```python
# 只下载特定类型的文档
document_selectors = [
    'a[href*="/doc/"]:has-text("重要")',  # 包含"重要"字样
    'a[href*="/sheet/"]',                # 表格文档
    'a[href*="/slide/"]'                 # 演示文档
]
```

### 6.3 下载路径自定义
```python
# 自定义下载目录
self.download_dir = Path("C:/Users/用户名/Documents/腾讯文档下载").resolve()
```

---

## 📋 成功检查清单

执行前确认：
- [ ] 已手动登录腾讯文档
- [ ] 已提取最新完整Cookie
- [ ] 已更新脚本中的Cookie字符串
- [ ] 已安装Python和Playwright
- [ ] 已设置正确的下载目录权限

执行中观察：
- [ ] 浏览器成功打开
- [ ] 页面标题显示"腾讯文档"
- [ ] 能找到文档元素
- [ ] 右键菜单正常弹出
- [ ] 下载选项可点击

执行后验证：
- [ ] 检查downloads文件夹
- [ ] 确认文件数量和格式
- [ ] 验证文件内容完整性

---

## 🔄 Cookie更新维护

### 定期更新策略
1. **Cookie有效期**：通常7-30天
2. **更新频率**：建议每周检查一次
3. **自动检测**：脚本失败时重新获取Cookie

### Cookie失效标志
- 页面跳转到登录界面
- API返回认证错误
- 找不到任何文档元素

### 批量更新脚本
```python
def update_all_scripts_cookie(new_cookie):
    script_files = [
        "latest_valid_downloader.py",
        "smart_downloader.py",
        "windows_compatible_downloader.py"
    ]
    
    for script in script_files:
        # 更新每个脚本文件中的Cookie
        pass
```

---

这个操作手册提供了完整的复制成功经验的步骤，任何人都可以按照这个指南实现腾讯文档的自动化访问和下载。