# 📅 时间管理和文件版本规格说明书

**文档版本**: v1.0  
**创建时间**: 2025-08-17  
**最后更新**: 2025-08-17  
**适用范围**: 腾讯文档智能监控系统 - 步骤2 CSV比对功能

---

## 🎯 规格总览

本规格定义了系统中所有与时间相关的判断逻辑、文件版本管理策略、基准版选择算法等核心技术标准，确保系统能够准确、可靠地进行时间驱动的自动化操作。

---

## ⏰ 时间管理规格

### 🗓️ **当周时间定义**
```
标准定义: 周一00:00:00 至 周六23:59:59
实现方式: ISO 8601周标准 + Python datetime
时区标准: 本地服务器时区
```

### ⚡ **关键时间节点**
| 时间节点 | 具体时间 | 系统行为 | 基准版策略 |
|---------|---------|---------|-----------|
| **周一** | 00:00-23:59 | 监控模式 | 使用上周基准版 |
| **周二12点前** | 00:00-11:59 | 监控模式 | 使用上周基准版 |
| **周二12点后** | 12:00-23:59 | 基准版生成 | 使用本周基准版 |
| **周三-周六** | 全天 | 分析对比模式 | 使用本周基准版 |

### 🔍 **时间判断算法**
```python
def get_time_strategy():
    """
    严格时间判断算法 - 核心规格实现
    
    Returns:
        tuple: (策略类型, 说明文字, 周数信息)
    """
    now = datetime.now()
    weekday = now.weekday()  # 0=周一, 1=周二...
    hour = now.hour
    week_info = now.isocalendar()  # (year, week, weekday)
    
    if weekday < 1 or (weekday == 1 and hour < 12):
        # 周一全天 OR 周二12点前
        target_week = week_info[1] - 1  # 上周
        return "previous_week", f"使用上周W{target_week}基准版", target_week
    else:
        # 周二12点后 OR 周三到周六
        target_week = week_info[1]  # 本周
        return "current_week", f"使用本周W{target_week}基准版", target_week
```

---

## 📂 文件版本管理规格

### 🏷️ **文件命名标准**
```
新格式规范: {系统标识}_{随url输入的文件名}_{时间戳}_{版本类型}_{周标识}.{扩展名}
旧格式规范: {系统标识}_{随url输入的文件名}_csv_{时间戳}_{版本类型}_{周标识}.csv (向后兼容)

实际示例: 
- CSV格式: tencent_【腾讯文档】副本-副本-测试版本-出国销售计划表_20250813_1200_baseline_W33.csv
- Excel格式: tencent_【腾讯文档】副本-副本-测试版本-出国销售计划表_20250813_1200_baseline_W33.xlsx

组成要素说明:
- 系统标识: tencent (固定)
- 随url输入的文件名 (腾讯文档的分析会自动携带文件名字段，如：【腾讯文档】副本-副本-测试版本-出国销售计划表
https://docs.qq.com/sheet/DWHR6UXh1UVRtSERw?tab=BB08J2，在输入url时系统将字段分开为文件名和url，这里{随url输入的文件名}就是提取到的文件名如上面例子中的："【腾讯文档】副本-副本-测试版本-出国销售计划表")
- 时间戳: YYYYMMDD_HHMM (精确到分钟)
- 版本类型: baseline/midweek/weekend
- 周标识: W{周数} (ISO周数)
- 扩展名: 根据实际文件格式动态决定 (csv/xlsx/xls/xlsm等)

注：系统同时支持新旧两种格式，确保向后兼容性
```

### 📁 **目录结构规范**
```
csv_versions/                           # 版本管理根目录
├── 2025_W33/                          # 年份_周数目录
│   ├── baseline/                       # 基准版目录 (周二12:00)
│   │   ├── tencent_出国销售计划表_20250813_1200_baseline_W33.xlsx
│   │   └── tencent_回国销售计划表_20250813_1200_baseline_W33.csv
│   ├── midweek/                        # 周中版目录 (周四09:00)  
│   │   ├── tencent_出国销售计划表_20250815_0900_midweek_W33.xlsx
│   │   └── tencent_回国销售计划表_20250815_0900_midweek_W33.csv
│   └── weekend/                        # 周末版目录 (周六19:00)
│       ├── tencent_出国销售计划表_20250817_1900_weekend_W33.xlsx
│       └── tencent_回国销售计划表_20250817_1900_weekend_W33.csv
├── 2025_W34/                          # 下周目录
├── current_week -> 2025_W33/          # 当周软链接
└── comparison_cache/                   # 比对结果缓存
    └── comparison_W33_vs_baseline.json
```

### 🔐 **版本类型定义**
| 版本类型 | 英文标识 | 生成时间 | 用途说明 |
|---------|---------|---------|---------|
| **基准版** | baseline | 周二12:00(仅自动化) | 当周对比标准，**仅限自动化任务生成** |
| **周中版** | midweek | 周四09:00/手动测试 | **所有手动测试、临时下载默认存储位置** |
| **周末版** | weekend | 周六19:00 | 完整分析版本，生成最终报告 |

⚠️ **重要规则：**
- baseline目录仅限周二12点的自动化任务使用
- 所有手动测试、临时下载必须使用midweek目录
- 这确保基准版的纯净性和可靠性

---

## 🤖 基准版选择算法规格

### ⚡ **严格选择策略**
```python
def get_baseline_files_strict():
    """
    严格基准版选择 - 不掩盖问题
    
    规则:
    1. 周二12点前 → 必须找到上周基准版，找不到报错
    2. 周二12点后 → 必须找到本周基准版，找不到报错  
    3. 绝不使用模糊查找或降级策略
    
    Raises:
        FileNotFoundError: 基准版文件不存在时的明确错误
    """
    strategy, description, target_week = get_time_strategy()
    
    if strategy == "current_week":
        baseline_path = f"csv_versions/2025_W{target_week}/baseline/"
        baseline_files = glob.glob(baseline_path + "*_baseline_W{target_week}.csv")
        
        if not baseline_files:
            raise FileNotFoundError(
                f"❌ 本周基准版不存在: {baseline_path}\n"
                f"请检查周二12:00定时下载任务是否正常执行"
            )
    else:  # previous_week
        baseline_path = f"csv_versions/2025_W{target_week}/baseline/"
        baseline_files = glob.glob(baseline_path + "*_baseline_W{target_week}.csv")
        
        if not baseline_files:
            raise FileNotFoundError(
                f"❌ 上周基准版不存在: {baseline_path}\n"
                f"请检查历史数据完整性或手动补充基准版"
            )
    
    return baseline_files, description
```

### 🚨 **错误处理规范**
| 错误场景 | 错误类型 | 错误消息 | 处理建议 |
|---------|---------|---------|---------|
| 本周基准版缺失 | FileNotFoundError | "本周基准版不存在，请检查周二12:00定时下载" | 检查定时任务状态 |
| 上周基准版缺失 | FileNotFoundError | "上周基准版不存在，请检查历史数据完整性" | 手动补充或重新下载 |
| 目录权限问题 | PermissionError | "基准版目录访问权限不足" | 检查文件系统权限 |
| 文件格式错误 | ValueError | "基准版文件格式不符合规范" | 检查文件命名是否正确 |

---

## 🔧 技术实现规格

### 📦 **依赖模块**
```python
import datetime
import glob
import os
from pathlib import Path
```

### 🔄 **核心接口规范**
```python
class WeekTimeManager:
    """时间管理核心类"""
    
    def get_current_week_info(self) -> dict:
        """获取当周信息"""
        pass
    
    def get_baseline_strategy(self) -> tuple:
        """获取基准版策略"""
        pass
    
    def find_baseline_files(self) -> list:
        """查找基准版文件"""
        pass
    
    def validate_file_naming(self, filename: str) -> bool:
        """验证文件命名规范"""
        pass
```

### 📏 **性能指标**
- **时间判断响应**: < 1ms
- **文件查找速度**: < 10ms (单目录)
- **内存占用**: < 50MB
- **错误恢复时间**: < 5s

---

## 📋 集成规范

### 🔗 **与其他模块集成**
| 模块名称 | 集成点 | 数据交换格式 |
|---------|--------|-------------|
| adaptive_table_comparator.py | 基准版文件路径 | List[str] |
| final_heatmap_server.py | API响应 | JSON |
| simple_scheduler.py | 定时任务触发 | Event |

### 🧪 **测试规范**
```python
def test_time_strategy():
    """时间策略测试用例"""
    # 测试周一时间判断
    # 测试周二12点边界
    # 测试周末时间判断
    pass

def test_baseline_selection():
    """基准版选择测试用例"""  
    # 测试正常基准版查找
    # 测试文件不存在错误
    # 测试命名规范验证
    pass
```

---

## 📝 更新记录

| 版本 | 日期 | 更新内容 | 更新人 |
|------|------|---------|--------|
| v1.0 | 2025-08-17 | 初始版本，定义完整时间管理和文件版本规格 | Claude |

---

**备注**: 本规格文档是系统关键技术标准，任何修改都必须更新版本号并记录更新内容。