# 12-监控设置UI组件技术规格

> 版本: v3.0
> 更新日期: 2025-09-18
> 作者: System Architecture Team
> 状态: 生产环境

## 📋 目录

1. [概述](#概述)
2. [系统架构](#系统架构)
3. [热力图核心功能](#热力图核心功能)
4. [列排序切换功能](#列排序切换功能)
5. [监控设置模块](#监控设置模块)
6. [API接口规范](#api接口规范)
7. [颜色映射算法](#颜色映射算法)
8. [故障排查指南](#故障排查指南)

## 概述

腾讯文档智能监控系统的热力图UI组件（端口8089）是一个企业级的数据可视化和配置管理平台。系统采用React 18前端框架，通过Flask后端提供RESTful API，实现了完整的文档监控、风险评估和智能分析功能。

### 核心特性
- 🔥 **智能热力图可视化**: 动态N×19矩阵，支持高斯平滑和科学色彩映射
- 🔄 **双模式列排序**: 支持默认顺序和智能聚类两种显示模式
- 📊 **综合打分系统**: 集成AI语义分析的多维度评分
- 🔗 **腾讯文档集成**: 实时监控和管理腾讯文档链接
- 📁 **基线文件管理**: 按周管理和归档基线数据

## 系统架构

### 技术栈
```yaml
前端:
  - React: 18.2.0 (CDN引入)
  - Tailwind CSS: 3.x (CDN版本)
  - Babel: 实时JSX转译
  - 状态管理: React Hooks (useState, useEffect, useCallback, useMemo)

后端:
  - Flask: 2.3.x
  - Python: 3.10+
  - 数据处理: NumPy, Pandas, SciPy

数据存储:
  - JSON配置文件
  - CSV/Excel数据文件
  - 本地文件系统
```

### 项目结构
```
/root/projects/tencent-doc-manager/
├── production/
│   ├── servers/
│   │   └── final_heatmap_server.py    # 主服务器文件（9700+行）
│   ├── core_modules/
│   │   ├── real_doc_loader.py         # 动态文档加载器
│   │   ├── heatmap_sorting.py         # 热力图排序算法
│   │   └── comparison_to_scoring_adapter.py # 评分适配器
│   └── config/
│       ├── column_definitions.py      # 列定义配置
│       ├── config_center.py          # 配置中心
│       └── real_documents.json       # 真实文档配置
├── config/
│   └── download_config.json          # 下载配置存储
└── csv_versions/                     # 按周存储的CSV数据
    └── 2025_W{周数}/
        ├── baseline/                 # 基线文件
        └── midweek/                  # 周中数据
```

## 热力图核心功能

### 数据可视化特性

#### 1. 动态矩阵渲染
- **矩阵大小**: 动态N×19（N为文档数量，19为标准列数）
- **数据范围**: 0-1浮点数，表示风险等级
- **更新频率**: 实时响应用户操作

#### 2. 高斯平滑算法
```javascript
// 位置: final_heatmap_server.py, 行号 7830-7880
const gaussianSmooth = (data, kernelSize = 5, sigma = 1.5) => {
  // 创建高斯核
  const kernel = createGaussianKernel(kernelSize, sigma);
  // 应用卷积
  return convolve2D(data, kernel);
};
```

#### 3. 科学色彩映射（5级）
```javascript
// 当前颜色映射（值 > 0.8 使用黄色）
// 即将修改为更红的颜色以提高警示效果
if (value <= 0) return '#F3F4F6';      // 灰色 - 无数据
if (value <= 0.2) return '#3B82F6';    // 蓝色 - 低风险
if (value <= 0.4) return '#10B981';    // 绿色 - 正常
if (value <= 0.6) return '#F59E0B';    // 橙色 - 中等
if (value <= 0.8) return '#EF4444';    // 红色 - 高风险
return '#FBBF24';                      // 黄色 - 极高（将改为深红）
```

## 列排序切换功能

### 双模式支持

#### 1. 默认顺序模式
- **列顺序**: 按业务逻辑原始顺序（序号→项目类型→来源...）
- **应用场景**: 标准业务查看，符合传统阅读习惯
- **特点**: 保持数据的业务逻辑关系

#### 2. 智能聚类模式
- **列顺序**: 基于热度相似性聚类排序
- **算法**: 皮尔逊相关系数 + 层次聚类
- **特点**: 相似热度的列聚集显示，便于发现模式

### 切换机制
```javascript
// 位置: final_heatmap_server.py, 行号 9040-9060
onClick={() => {
  const newMode = sortingMode === 'default' ? 'intelligent' : 'default';
  setSortingMode(newMode);

  // 更新URL参数
  const urlParams = new URLSearchParams(window.location.search);
  urlParams.set('sorting', newMode);
  window.history.replaceState(null, '', `?${urlParams.toString()}`);

  // 重新获取数据
  fetchApiData();
}}
```

### 后端数据重排逻辑
```python
# 位置: final_heatmap_server.py, 行号 1730-1775
if sorting_mode == 'default':
    # 恢复原始列顺序
    if current_columns != original_columns:
        # 创建列映射索引
        col_index_map = [current_columns.index(col) for col in original_columns]
        # 重排矩阵数据
        matrix = [[row[idx] for idx in col_index_map] for row in matrix]
```

## 监控设置模块

### 表格链接管理

#### 功能特性
- 批量导入腾讯文档链接
- 支持软删除和恢复
- 实时同步到热力图显示

#### 数据格式
```json
{
  "document_links": [
    {
      "name": "副本-测试版本-出国销售计划表",
      "url": "https://docs.qq.com/sheet/DWEFNU25TemFnZXJN",
      "doc_id": "WEFNU25TemFnZXJN",
      "enabled": true,
      "added_date": "2025-09-18T10:00:00"
    }
  ],
  "deleted_links": []
}
```

### 基线文件管理

#### 存储结构
```
csv_versions/
└── 2025_W38/
    └── baseline/
        ├── tencent_*_baseline_W38.csv    # 活跃文件
        └── .deleted/                      # 软删除存档
            └── tencent_*_baseline_W38.csv
```

#### 文件命名规范
```
tencent_{文档名}_{时间戳}_{版本类型}_W{周数}.{扩展名}
```
- 扩展名: 自动识别（csv/xlsx）
- 版本类型: baseline/midweek/hotspot

### Cookie管理

#### 安全措施
- Cookie不完整显示在前端
- 使用HTTPS传输
- 定期验证有效性
- 自动过期提醒

## API接口规范

### 数据接口

| 端点 | 方法 | 用途 | 参数 |
|------|------|------|------|
| `/api/data` | GET | 获取热力图数据 | `?sorting=default\|intelligent` |
| `/api/real_csv_data` | GET | 获取真实CSV数据 | `?sorting=default\|intelligent` |
| `/api/get_data_source` | GET | 获取当前数据源 | - |
| `/api/get_column_order_status` | GET | 获取列排序状态 | - |

### 配置接口

| 端点 | 方法 | 用途 | 请求体 |
|------|------|------|------|
| `/api/save-download-links` | POST | 保存文档链接 | `{links: [...]}` |
| `/api/get-download-links` | GET | 获取文档链接 | - |
| `/api/baseline-files` | GET/POST/DELETE | 基线文件管理 | 多种格式 |
| `/api/save-cookies` | POST | 保存Cookie | `{cookie: "..."}` |

### 响应格式
```json
{
  "success": true,
  "data": {
    "heatmap_data": {
      "matrix": [[...]],
      "clustered": false
    },
    "column_names": [...],
    "sorted_column_names": [...],
    "table_names": [...],
    "clustering_info": {...}
  },
  "metadata": {
    "timestamp": "2025-09-18T10:00:00",
    "data_source": "comprehensive"
  }
}
```

## 颜色映射算法

### 当前实现（即将优化）
```javascript
// 位置: final_heatmap_server.py, 行号 7200-7250
const getScientificHeatColor = (value) => {
  if (value <= 0) return '#F3F4F6';     // 空白
  if (value <= 0.2) return '#3B82F6';   // 蓝色
  if (value <= 0.4) return '#10B981';   // 绿色
  if (value <= 0.6) return '#F59E0B';   // 橙色
  if (value <= 0.8) return '#EF4444';   // 红色
  return '#FBBF24';                     // 黄色（将改为深红）
};
```

### 优化方向
- 值 > 0.8 改为深红色（#991B1B）以增强警示效果
- 添加渐变过渡以提高视觉连续性
- 支持色盲友好模式

## 故障排查指南

### 常见问题

#### 1. 热力图不刷新
**症状**: 点击排序切换按钮后数据不更新
**原因**: React.useCallback依赖数组问题
**解决**: 确保fetchApiData依赖数组为空`[]`

#### 2. 列名与数据不匹配
**症状**: 列标题改变但数据位置不变
**原因**: 矩阵数据未同步重排
**解决**: 检查后端col_index_map映射逻辑

#### 3. Cookie验证失败
**症状**: 无法下载腾讯文档
**原因**: Cookie过期或格式错误
**解决**: 重新获取Cookie，确保使用`'; '`分隔

### 调试命令
```bash
# 检查API响应
curl -s "http://localhost:8089/api/data?sorting=default" | jq '.data.column_names[:5]'

# 查看服务器日志
tail -f /tmp/heatmap_server.log | grep -E "排序|聚类|默认"

# 验证配置文件
cat config/download_config.json | jq '.document_links'
```

### 性能优化建议

1. **前端优化**
   - 使用React.memo避免不必要的重渲染
   - 虚拟滚动处理大数据量
   - 防抖处理用户输入

2. **后端优化**
   - 缓存聚类计算结果
   - 使用NumPy向量化操作
   - 异步处理耗时任务

3. **网络优化**
   - 启用Gzip压缩
   - 实施HTTP缓存策略
   - 使用WebSocket实时更新

## 版本历史

### v3.0 (2025-09-18)
- ✅ 修复列排序切换的数据刷新问题
- ✅ 优化React.useCallback依赖管理
- ✅ 增强矩阵数据重排逻辑
- 🔄 即将更新：高风险区域颜色优化

### v2.5 (2025-09-17)
- 添加调试日志输出
- 修复前端数据路径问题
- 优化错误处理机制

### v2.0 (2025-09-14)
- 实现双模式列排序
- 集成智能聚类算法
- 添加URL参数持久化

---

**文档维护说明**: 本文档与代码同步更新，确保技术规格与实际实现一致。最后更新于2025-09-18。