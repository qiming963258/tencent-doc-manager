# 监控设置UI组件技术规格文档

> 版本: v2.0
> 更新日期: 2025-09-14
> 作者: System Architecture Team

## 📋 目录

1. [概述](#概述)
2. [组件架构](#组件架构)
3. [表格链接管理组件](#表格链接管理组件)
4. [基线文件管理组件](#基线文件管理组件)
5. [Cookie管理组件](#cookie管理组件)
6. [综合打分文件管理](#综合打分文件管理)
7. [数据流与状态管理](#数据流与状态管理)
8. [API端点参考](#api端点参考)
9. [故障排查指南](#故障排查指南)

## 概述

监控设置是热力图UI系统的核心配置模块，位于端口8089的主界面中。它通过React组件实现，提供了完整的文档管理、配置设置和系统控制功能。

### 核心特性
- 🔗 **表格链接管理**: 动态管理腾讯文档链接
- 📁 **基线文件管理**: 周期性基线文件存储与管理
- 🍪 **Cookie配置**: 腾讯文档访问凭证管理
- 📊 **综合打分管理**: 评分文件的上传与选择
- 🔄 **实时同步**: 所有配置即时生效

## 组件架构

### 技术栈
- **前端**: React 18 (CDN引入，使用Babel实时转译)
- **UI框架**: Tailwind CSS (CDN版本)
- **状态管理**: React Hooks (useState, useEffect)
- **通信**: Fetch API
- **服务器**: Flask (Python 3.10)

### 文件位置
```
/root/projects/tencent-doc-manager/
├── production/
│   └── servers/
│       └── final_heatmap_server.py  # 主服务器文件（包含所有组件）
└── config/
    └── download_config.json         # 配置存储文件
```

## 表格链接管理组件

### 功能描述
管理需要监控的腾讯文档链接，支持批量导入、编辑和软删除。

### 技术实现

#### 前端组件位置
- **文件**: `final_heatmap_server.py`
- **行号**: 5408-5442 (loadStoredLinks函数)
- **行号**: 6191-6230 (UI渲染部分)

#### 关键代码结构

```javascript
// 数据加载函数 (行号: 5409-5442)
const loadStoredLinks = async () => {
  try {
    const response = await fetch('/api/get-download-links');
    const result = await response.json();

    // ⚠️ 重要：数据路径是嵌套的
    if (result.success && result.data && result.data.document_links) {
      const links = result.data.document_links;

      // 转换为文本格式
      const linkText = links
        .filter(link => link.enabled !== false)  // 过滤软删除
        .map(link => `【腾讯文档】${link.name}\\n${link.url}`)
        .join('\\n\\n');

      setTableLinks(linkText);
      setStoredUrls(links);
      setLinkCount(activeLinks.length);
    }
  } catch (error) {
    console.error('❌ 加载链接失败:', error);
  }
};
```

#### 数据格式

**输入格式** (文本域):
```
【腾讯文档】文档名称1
https://docs.qq.com/sheet/xxx1

【腾讯文档】文档名称2
https://docs.qq.com/sheet/xxx2
```

**存储格式** (JSON):
```json
{
  "document_links": [
    {
      "name": "文档名称",
      "url": "https://docs.qq.com/sheet/xxx",
      "doc_id": "xxx",
      "enabled": true,
      "added_date": "2025-09-14T10:00:00"
    }
  ],
  "deleted_links": []  // 软删除的链接
}
```

### API端点

#### GET /api/get-download-links
- **位置**: 行号 2043-2053
- **返回格式**:
```json
{
  "success": true,
  "data": {
    "document_links": [...],
    "deleted_links": [...],
    "last_updated": "2025-09-14T13:00:00"
  }
}
```

#### POST /api/save-download-links
- **位置**: 行号 1989-2041
- **请求体**:
```json
{
  "links": [
    {"name": "文档名", "url": "URL"}
  ]
}
```

### 常见问题与解决

#### 问题1: 文本域不显示已存储的链接
**原因**: 数据路径不匹配
**解决**: 确保前端代码使用 `result.data.document_links` 而非 `result.links`

#### 问题2: 链接数量显示不正确
**原因**: 未过滤软删除的链接
**解决**: 使用 `.filter(link => link.enabled !== false)`

## 基线文件管理组件

### 功能描述
管理每周的基线文件，支持上传、下载和软删除。

### 技术实现

#### 前端组件位置
- **文件**: `final_heatmap_server.py`
- **行号**: 5444-5569 (基线文件管理函数)
- **行号**: 6231-6380 (UI渲染部分)

#### 关键功能

```javascript
// 加载基线文件列表 (行号: 5445-5480)
const loadBaselineFiles = async (week = null) => {
  const params = week ? `?week=${week}` : '';
  const response = await fetch(`/api/baseline-files${params}`);
  const result = await response.json();

  if (result.success) {
    setBaselineFiles(result.files);
    setCurrentWeek(result.current_week);
    setBaselinePath(result.path);
  }
};

// 上传基线文件 (行号: 5481-5520)
const handleBaselineUpload = async () => {
  const formData = new FormData();
  formData.append('url', baselineUrl);
  formData.append('week', selectedWeek || currentWeek);

  const response = await fetch('/api/baseline-files', {
    method: 'POST',
    body: formData
  });
};
```

#### 文件存储结构
```
/root/projects/tencent-doc-manager/csv_versions/
└── 2025_W37/
    └── baseline/
        ├── tencent_文档名_时间戳_baseline_W37.csv
        └── .deleted/  # 软删除的文件
```

### API端点

#### GET /api/baseline-files
- **位置**: 行号 2435-2470
- **参数**: `?week=37` (可选)
- **返回**: 文件列表、当前周、存储路径

#### POST /api/baseline-files
- **位置**: 行号 2471-2530
- **用途**: 从URL下载并保存为基线文件

#### DELETE /api/baseline-files
- **位置**: 行号 2531-2570
- **用途**: 软删除文件到 `.deleted` 文件夹

## Cookie管理组件

### 功能描述
管理腾讯文档访问所需的Cookie凭证。

### 技术实现

#### 前端组件位置
- **文件**: `final_heatmap_server.py`
- **行号**: 5389-5406 (Cookie加载函数)
- **行号**: 6100-6150 (UI渲染部分)

#### Cookie验证流程

```javascript
// 加载Cookie配置 (行号: 5390-5406)
const loadCookieConfig = async () => {
  const response = await fetch('/api/get-cookies');
  const result = await response.json();

  if (result.success && result.data) {
    setCookieValue(result.data.current_cookies || '');
    setCookieStatus(result.data.validation_message || '');
  }
};

// 保存并验证Cookie (行号: 5700-5730)
const handleSaveCookie = async () => {
  const response = await fetch('/api/save-cookies', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({cookie: cookieValue})
  });
};
```

#### Cookie格式
```
p_skey=xxx; p_uin=xxx; pt4_token=xxx; ...
```

### API端点

#### GET /api/get-cookies
- **位置**: 行号 1959-1979
- **返回**: 当前Cookie和验证状态

#### POST /api/save-cookies
- **位置**: 行号 1928-1958
- **用途**: 保存并验证Cookie

#### POST /api/test-cookies
- **位置**: 行号 1981-1988
- **用途**: 测试Cookie有效性

## 综合打分文件管理

### 功能描述
管理综合评分文件，支持选择不同周的评分数据。

### 技术实现

#### 前端组件位置
- **文件**: `final_heatmap_server.py`
- **行号**: 5570-5650 (综合打分管理函数)
- **行号**: 6381-6450 (UI渲染部分)

#### 文件选择逻辑

```javascript
// 加载综合打分文件列表 (行号: 5571-5600)
const loadComprehensiveFiles = async () => {
  const response = await fetch('/api/comprehensive-files', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({action: 'list'})
  });

  const result = await response.json();
  if (result.success) {
    setComprehensiveFiles(result.files);
  }
};

// 选择文件 (行号: 5601-5630)
const handleFileSelect = async (filePath) => {
  const response = await fetch('/api/comprehensive-files', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      action: 'select',
      file_path: filePath
    })
  });
};
```

## 数据流与状态管理

### 组件生命周期

```javascript
// 组件挂载时的初始化 (行号: 5280-5290)
React.useEffect(() => {
  loadCookieConfig();       // 加载Cookie配置
  loadPresetComprehensiveFiles();  // 加载预设文件
  loadBaselineFiles();      // 加载基线文件
  loadComprehensiveFiles(); // 加载综合打分文件
  loadStoredLinks();        // 加载存储的链接
}, []);
```

### 状态管理策略

1. **独立状态**: 每个功能模块独立管理自己的状态
2. **异步加载**: 所有数据通过异步API加载
3. **乐观更新**: UI先更新，后台异步保存
4. **错误恢复**: 失败时回滚到上一个有效状态

## API端点参考

### 完整端点列表

| 端点 | 方法 | 用途 | 行号 |
|------|------|------|------|
| `/api/get-download-links` | GET | 获取链接配置 | 2043-2053 |
| `/api/save-download-links` | POST | 保存链接配置 | 1989-2041 |
| `/api/baseline-files` | GET/POST/DELETE | 基线文件管理 | 2435-2570 |
| `/api/get-cookies` | GET | 获取Cookie | 1959-1979 |
| `/api/save-cookies` | POST | 保存Cookie | 1928-1958 |
| `/api/test-cookies` | POST | 测试Cookie | 1981-1988 |
| `/api/comprehensive-files` | POST | 综合打分文件 | 2571-2650 |
| `/api/get_column_order_status` | GET | 列排序状态 | 2651-2670 |
| `/api/workflow-status` | GET | 工作流状态 | 2671-2700 |

## 故障排查指南

### 调试步骤

1. **检查浏览器控制台**
   - 打开F12开发者工具
   - 查看Console中的日志输出
   - 注意带有 `📋`、`✅`、`❌` 图标的日志

2. **验证API响应**
   ```bash
   # 测试链接API
   curl http://localhost:8089/api/get-download-links | jq

   # 测试基线文件API
   curl http://localhost:8089/api/baseline-files | jq
   ```

3. **检查配置文件**
   ```bash
   # 查看配置文件内容
   cat /root/projects/tencent-doc-manager/config/download_config.json | jq
   ```

4. **服务器日志**
   ```bash
   # 查看服务器输出
   tail -f /tmp/server.log
   ```

### 常见错误代码

| 错误 | 原因 | 解决方案 |
|------|------|----------|
| `result.links undefined` | 数据路径错误 | 使用 `result.data.document_links` |
| `CORS blocked` | 跨域问题 | 检查Flask CORS配置 |
| `Cookie expired` | Cookie过期 | 重新获取并更新Cookie |
| `File not found` | 文件路径错误 | 使用绝对路径 |

## 性能优化建议

1. **防抖处理**: 文本输入使用防抖减少API调用
2. **缓存策略**: 静态数据使用localStorage缓存
3. **懒加载**: 大文件列表使用分页或虚拟滚动
4. **批量操作**: 多个更新合并为单次API调用

## 安全考虑

1. **Cookie安全**:
   - 不在前端日志中完整显示Cookie
   - 使用HTTPS传输
   - 定期更新Cookie

2. **文件访问**:
   - 限制文件上传大小
   - 验证文件类型
   - 使用白名单验证URL

3. **API安全**:
   - 添加速率限制
   - 验证请求来源
   - 输入参数验证

## 版本历史

### v2.0 (2025-09-14)
- 修复表格链接管理数据路径问题
- 添加调试日志功能
- 优化错误处理机制

### v1.5 (2025-09-12)
- 添加软删除功能
- 实现基线文件管理
- Cookie验证增强

### v1.0 (2025-09-10)
- 初始版本发布
- 基础功能实现

---

**文档维护**: 此文档应随代码更新同步维护，确保技术规格与实际实现一致。