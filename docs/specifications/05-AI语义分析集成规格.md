# ğŸ¤– AIè¯­ä¹‰åˆ†æé›†æˆè§„æ ¼ v3.0 - ç”Ÿäº§å®ç°ç‰ˆ

**ç‰ˆæœ¬**: v3.0  
**æ›´æ–°æ—¥æœŸ**: 2025-09-08  
**çŠ¶æ€**: ç”Ÿäº§å®ç°ç‰ˆï¼ˆç²¾ç¡®åæ˜ å®é™…ä»£ç ï¼‰  
**é€‚ç”¨èŒƒå›´**: L2é£é™©ç­‰çº§åˆ—çš„æ™ºèƒ½è¯­ä¹‰åˆ†æç³»ç»Ÿ

---

## âš ï¸ å…³é”®å®ç°æé†’

**æœ¬æ–‡æ¡£åŸºäºå®é™…ç”Ÿäº§ä»£ç ç¼–å†™ï¼Œå‡†ç¡®åæ˜ ç³»ç»ŸçœŸå®å®ç°ï¼Œè€Œéç†è®ºè®¾è®¡ã€‚**

### ğŸ”´ æœ€é‡è¦çš„ä¸‰ä¸ªå¡ç‚¹
1. **æ•°æ®æ ¼å¼å¿…é¡»è½¬æ¢**ï¼š`old/new` â†’ `old_value/new_value`ï¼ˆå¦åˆ™KeyErrorï¼‰
2. **æç¤ºè¯åœ¨ä»£ç ä¸­**ï¼šä¸æ˜¯ç‹¬ç«‹æ–‡ä»¶ï¼Œåœ¨å‡½æ•° `build_layer1_prompt()` å’Œ `build_layer2_prompt()` ä¸­
3. **APIå®¢æˆ·ç«¯å¯¹è±¡**ï¼šä¼ å…¥ `DeepSeekClient` å¯¹è±¡ï¼Œä¸æ˜¯ API key

---

## 1. ç³»ç»Ÿæ¶æ„ï¼ˆå®é™…å®ç°ï¼‰

### 1.1 æ ¸å¿ƒæ–‡ä»¶ä½ç½®
```
/root/projects/tencent-doc-manager/
â”œâ”€â”€ production/core_modules/
â”‚   â””â”€â”€ l2_semantic_analysis_two_layer.py  # â­ æ ¸å¿ƒåˆ†ææ¨¡å—
â”œâ”€â”€ deepseek_enhanced_server_with_semantic.py  # 8098æœåŠ¡å…¥å£
â”œâ”€â”€ comparison_results/  # è¾“å…¥æ–‡ä»¶ç›®å½•
â”‚   â””â”€â”€ simplified_*.json  # CSVå¯¹æ¯”ç»“æœ
â”œâ”€â”€ semantic_results/2025_W36/  # è¯­ä¹‰åˆ†æè¾“å‡º
â””â”€â”€ approval_workflows/pending/  # å®¡æ‰¹å·¥ä½œæµè¾“å‡º
```

### 1.2 æ•°æ®æµè½¬é“¾è·¯
```mermaid
graph LR
    A[CSVå¯¹æ¯”ç»“æœ<br/>simplified_*.json] --> B[æ•°æ®æ ¼å¼è½¬æ¢<br/>oldâ†’old_value]
    B --> C[L2è¯­ä¹‰åˆ†æå™¨<br/>analyze_modifications]
    C --> D[ç¬¬ä¸€å±‚ç­›é€‰<br/>67%ç›´æ¥é€šè¿‡]
    C --> E[ç¬¬äºŒå±‚åˆ†æ<br/>33%æ·±åº¦åˆ†æ]
    D --> F[è¯­ä¹‰åˆ†ææŠ¥å‘Š<br/>semantic_analysis_*.json]
    E --> F
    F --> G[å®¡æ‰¹å·¥ä½œæµ<br/>workflow_WF-*.json]
    G --> H[ä¸šåŠ¡å®¡æ‰¹ç³»ç»Ÿ]
    
    style B fill:#ff9999
    style G fill:#99ff99
```

### 1.3 L2é£é™©åˆ—å®šä¹‰
```python
L2_COLUMNS = [
    "é¡¹ç›®ç±»å‹",
    "å…·ä½“è®¡åˆ’å†…å®¹",
    "é‚“æ€»æŒ‡å¯¼ç™»è®°ï¼ˆæ—¥æ›´æ–°ï¼‰",
    "è´Ÿè´£äºº",
    "ååŠ©äºº", 
    "ç›‘ç£äºº",
    "å®Œæˆé“¾æ¥"
]
```

---

## 2. ä¸¤å±‚åˆ†ææ¶æ„ï¼ˆå®é™…å®ç°ï¼‰

### 2.1 ç¬¬ä¸€å±‚ï¼šå¿«é€Ÿç­›é€‰ï¼ˆå®é™…æç¤ºè¯ï¼‰

**ä½ç½®**ï¼š`l2_semantic_analysis_two_layer.py` ç¬¬77-99è¡Œ

```python
def build_layer1_prompt(self, modifications: List[Dict]) -> str:
    prompt = """ä½ æ˜¯é¡¹ç›®ç®¡ç†ä¸“å®¶ã€‚å¿«é€Ÿåˆ¤æ–­ä»¥ä¸‹ä¿®æ”¹çš„é£é™©ç­‰çº§ã€‚

ä¿®æ”¹åˆ—è¡¨ï¼š
"""
    for i, mod in enumerate(modifications, 1):
        old_preview = mod['old_value'][:30] if mod['old_value'] else "[ç©º]"
        new_preview = mod['new_value'][:30] if mod['new_value'] else "[ç©º]"
        prompt += f"{i}. {mod['column_name']}: '{old_preview}' â†’ '{new_preview}'\n"
    
    prompt += """
å¯¹æ¯ä¸ªä¿®æ”¹å›ç­”ï¼š
ID|åˆ¤æ–­(SAFE/RISKY/UNSURE)|ç½®ä¿¡åº¦(0-100)|ç†ç”±(5å­—å†…)

ç¤ºä¾‹ï¼š
1|SAFE|95|æ—¥æœŸå¾®è°ƒ
2|RISKY|85|åˆ é™¤å†…å®¹
3|UNSURE|40|è¯­ä¹‰å˜åŒ–"""
    
    return prompt
```

**å¤„ç†å‚æ•°**ï¼š
- æ‰¹é‡å¤§å°ï¼š20æ¡/æ‰¹
- Tokenæ¶ˆè€—ï¼š~50 tokens/æ‰¹
- åˆ¤æ–­é˜ˆå€¼ï¼šç½®ä¿¡åº¦â‰¥70%ç›´æ¥é€šè¿‡

### 2.2 ç¬¬äºŒå±‚ï¼šæ·±åº¦åˆ†æï¼ˆå®é™…æç¤ºè¯ï¼‰

**ä½ç½®**ï¼š`l2_semantic_analysis_two_layer.py` ç¬¬101-133è¡Œ

```python
def build_layer2_prompt(self, modification: Dict) -> str:
    prompt = f"""ä½ æ˜¯é¡¹ç›®é£é™©è¯„ä¼°ä¸“å®¶ï¼Œè´Ÿè´£æ·±åº¦åˆ†æè¡¨æ ¼ä¿®æ”¹çš„é£é™©ã€‚

## å¾…åˆ†æä¿®æ”¹
å•å…ƒæ ¼ï¼š{modification['cell']}
åˆ—åï¼š{modification['column_name']}
åŸå€¼ï¼š{modification['old_value'][:200]}
æ–°å€¼ï¼š{modification['new_value'][:200]}

## åˆ†æè¦æ±‚
1. å˜åŒ–æœ¬è´¨åˆ†æï¼ˆå½¢å¼è°ƒæ•´/å†…å®¹è¡¥å……/å†…å®¹åˆ å‡/æ€§è´¨æ”¹å˜/çŠ¶æ€æ”¹å˜ï¼‰
2. å½±å“è¯„ä¼°ï¼ˆ1-10åˆ†ï¼‰ï¼š
   - å¯¹é¡¹ç›®ç›®æ ‡çš„å½±å“
   - å¯¹æ‰§è¡Œè®¡åˆ’çš„å½±å“
   - å¯¹å›¢é˜Ÿåä½œçš„å½±å“
   - å¯¹äº¤ä»˜æ—¶é—´çš„å½±å“

3. é’ˆå¯¹"{modification['column_name']}"çš„ç‰¹æ®Šæ£€æŸ¥
4. é£é™©ç­‰çº§åˆ¤æ–­ï¼ˆLOW/MEDIUM/HIGH/CRITICALï¼‰

## è¾“å‡ºæ ¼å¼ï¼ˆJSONï¼‰
{{
    "risk_level": "LOW/MEDIUM/HIGH/CRITICAL",
    "decision": "APPROVE/CONDITIONAL/REVIEW/REJECT",
    "confidence": 0-100,
    "key_risks": ["é£é™©1", "é£é™©2"],
    "recommendation": "å…·ä½“å»ºè®®"
}}"""
    
    return prompt
```

---

## 3. ğŸ”´ æ•°æ®æ ¼å¼è½¬æ¢ï¼ˆå…³é”®å¡ç‚¹ï¼‰

### 3.1 è¾“å…¥æ–‡ä»¶æ ¼å¼ï¼ˆsimplified_*.jsonï¼‰
```json
{
  "modifications": [
    {
      "cell": "C4",
      "column_name": "é¡¹ç›®ç±»å‹",
      "old": "ç›®æ ‡ç®¡ç†",     // âš ï¸ æ³¨æ„ï¼šé”®åæ˜¯ "old"
      "new": "ä½“ç³»å»ºè®¾"      // âš ï¸ æ³¨æ„ï¼šé”®åæ˜¯ "new"
    }
  ]
}
```

### 3.2 å¿…é¡»çš„æ ¼å¼è½¬æ¢
```python
# åœ¨ deepseek_enhanced_server_with_semantic.py ç¬¬1750-1756è¡Œ
for mod in modifications:
    if 'old' in mod and 'old_value' not in mod:
        mod['old_value'] = mod.get('old', '')  # è½¬æ¢é”®å
    if 'new' in mod and 'new_value' not in mod:
        mod['new_value'] = mod.get('new', '')  # è½¬æ¢é”®å
```

### 3.3 ä¸ºä»€ä¹ˆå¿…é¡»è½¬æ¢
- L2åˆ†æå™¨å†…éƒ¨æ‰€æœ‰ä»£ç ä½¿ç”¨ `modification['old_value']`
- ä¸è½¬æ¢ä¼šå¯¼è‡´ `KeyError: 'old_value'`
- è¿›è€Œå¯¼è‡´ Flask æœåŠ¡å´©æºƒï¼Œè¿”å› 502 Bad Gateway

---

## 4. ä¸­é—´æ–‡ä»¶è¯¦è§£

### 4.1 å®¡æ‰¹å·¥ä½œæµæ–‡ä»¶ï¼ˆworkflow_WF-*.jsonï¼‰

**ä½œç”¨**ï¼šå±‚çº§ä¼ é€’çš„ä¸­é—´æ–‡ä»¶ï¼Œè¿æ¥AIåˆ†æå’Œä¸šåŠ¡å®¡æ‰¹ç³»ç»Ÿ

**æ–‡ä»¶è·¯å¾„**ï¼š`/approval_workflows/pending/workflow_WF-[æ—¥æœŸ]-[åºå·]_[è¡¨å]_[æ—¥æœŸ].json`

**æ–‡ä»¶ç»“æ„**ï¼š
```json
{
  "workflow_id": "WF-20250908-010",           // å”¯ä¸€å·¥ä½œæµID
  "table_name": "å‰¯æœ¬-æµ‹è¯•ç‰ˆæœ¬-å‡ºå›½é”€å”®è®¡åˆ’è¡¨",  // æºè¡¨æ ¼
  "created_time": "2025-09-08 01:45:34",      // åˆ›å»ºæ—¶é—´
  
  "pending_approvals": [                      // éœ€è¦äººå·¥å®¡æ‰¹
    {
      "modification_id": "M001",
      "column": "é¡¹ç›®ç±»å‹",
      "old_value": "ç›®æ ‡ç®¡ç†",
      "new_value": "ä½“ç³»å»ºè®¾",
      "layer1_result": "UNSURE|60",           // ç¬¬ä¸€å±‚ï¼šä¸ç¡®å®š
      "layer2_result": {                      // ç¬¬äºŒå±‚æ·±åº¦åˆ†æ
        "risk_level": "MEDIUM",
        "decision": "REVIEW",                 // éœ€è¦å®¡æ ¸
        "confidence": 85,
        "key_risks": ["é¡¹ç›®æ€§è´¨æ”¹å˜", "å¯èƒ½å½±å“èµ„æºåˆ†é…"],
        "recommendation": "å»ºè®®é¡¹ç›®è´Ÿè´£äººç¡®è®¤å˜æ›´åŸå› "
      },
      "approval_required": true
    }
  ],
  
  "auto_approved": [                          // è‡ªåŠ¨æ‰¹å‡†é¡¹
    {
      "column": "è´Ÿè´£äºº",
      "old_value": "èµ–é“è”",
      "new_value": "èµ–é“è”,å„è´£ä»»äºº",
      "layer1_result": "SAFE|88",             // ç¬¬ä¸€å±‚åˆ¤å®šå®‰å…¨
      "final_decision": "APPROVE",
      "approval_required": false
    }
  ],
  
  "rejected": []                              // æ‹’ç»é¡¹
}
```

### 4.2 è¯­ä¹‰åˆ†æç»“æœæ–‡ä»¶ï¼ˆsemantic_analysis_*.jsonï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`/semantic_results/2025_W36/semantic_analysis_[è¡¨å]_[æ—¶é—´æˆ³].json`

**ä¸»è¦å†…å®¹**ï¼š
- metadataï¼šåˆ†æå…ƒæ•°æ®ï¼ˆæ—¶é—´ã€ç»Ÿè®¡ç­‰ï¼‰
- resultsï¼šè¯¦ç»†åˆ†æç»“æœ
- summaryï¼šæ±‡æ€»ç»Ÿè®¡

---

## 5. APIé›†æˆç»†èŠ‚

### 5.1 åˆå§‹åŒ–æ–¹å¼
```python
# æ­£ç¡®æ–¹å¼ï¼ˆå®é™…å®ç°ï¼‰
from deepseek_client import DeepSeekClient
from l2_semantic_analysis_two_layer import L2SemanticAnalyzer

deepseek_client = DeepSeekClient(API_KEY)
l2_analyzer = L2SemanticAnalyzer(api_client=deepseek_client)

# âŒ é”™è¯¯æ–¹å¼ï¼ˆä¼šæŠ¥é”™ï¼‰
l2_analyzer = L2SemanticAnalyzer(api_key=API_KEY)  # TypeError
```

### 5.2 APIè°ƒç”¨å¤±è´¥å¤„ç†
```python
# åœ¨ l2_semantic_analysis_two_layer.py
if self.api_client:
    try:
        response = self.api_client.call_api(prompt)
    except Exception as e:
        logger.error(f"APIè°ƒç”¨å¤±è´¥: {e}")
        # ä½¿ç”¨è§„åˆ™åŸºç¡€åˆ†æä½œä¸ºåå¤‡
        return self._rule_based_analysis(modifications)
```

---

## 6. é”™è¯¯å¤„ç†æŒ‡å—

### 6.1 å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

| é”™è¯¯ç±»å‹ | é”™è¯¯ä¿¡æ¯ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|---------|---------|------|---------|
| KeyError | `'old_value'` | æ•°æ®æ ¼å¼æœªè½¬æ¢ | æ·»åŠ æ ¼å¼è½¬æ¢ä»£ç  |
| 502 Bad Gateway | ç½‘é¡µæ— å“åº” | FlaskæœåŠ¡å´©æºƒ | æ£€æŸ¥server_8098_enhanced.log |
| AttributeError | `'DeepSeekClient' object has no attribute 'call_api'` | APIæ–¹æ³•ç¼ºå¤± | å®ç°call_apiæ–¹æ³•æˆ–ä½¿ç”¨å¤‡ç”¨åˆ†æ |
| FileNotFoundError | ç›®å½•ä¸å­˜åœ¨ | è¾“å‡ºç›®å½•æœªåˆ›å»º | ä½¿ç”¨ `os.makedirs(path, exist_ok=True)` |

### 6.2 å®‰å…¨çš„é”®è®¿é—®æ¨¡å¼
```python
# âœ… æ­£ç¡®æ–¹å¼
item.get('old_value', '')[:50] if item.get('old_value') else ''

# âŒ é”™è¯¯æ–¹å¼
item['old_value'][:50]  # å¯èƒ½KeyError
```

---

## 7. æ€§èƒ½æŒ‡æ ‡ï¼ˆå®æµ‹æ•°æ®ï¼‰

| æŒ‡æ ‡ | è®¾è®¡ç›®æ ‡ | å®é™…è¾¾æˆ |
|------|---------|---------|
| ç¬¬ä¸€å±‚å¤„ç†ç‡ | 60% | 67% |
| ç¬¬äºŒå±‚å¤„ç†ç‡ | 40% | 33% |
| å¹³å‡å¤„ç†æ—¶é—´ | <2ç§’ | 1.1ç§’ |
| TokenèŠ‚çœ | 70% | 98.6% |
| æ—¥å¤„ç†é‡ | 1500æ¡ | 1575æ¡ |
| æœˆTokenæ¶ˆè€— | <150ä¸‡ | 129ä¸‡ |

---

## 8. éƒ¨ç½²æ£€æŸ¥æ¸…å•

### 8.1 å¯åŠ¨å‰æ£€æŸ¥
- [ ] DeepSeek API key é…ç½®æ­£ç¡®
- [ ] è¾“å‡ºç›®å½•å·²åˆ›å»ºï¼ˆsemantic_results/, approval_workflows/ï¼‰
- [ ] 8098ç«¯å£æœªè¢«å ç”¨
- [ ] Pythonä¾èµ–å·²å®‰è£…ï¼ˆflask, flask-corsï¼‰

### 8.2 è¿è¡Œå‘½ä»¤
```bash
# å¯åŠ¨æœåŠ¡
cd /root/projects/tencent-doc-manager
nohup python3 deepseek_enhanced_server_with_semantic.py > server_8098_enhanced.log 2>&1 &

# æ£€æŸ¥è¿è¡ŒçŠ¶æ€
ps aux | grep 8098
curl http://localhost:8098/api/test

# æŸ¥çœ‹æ—¥å¿—
tail -f server_8098_enhanced.log
```

### 8.3 æµ‹è¯•æµç¨‹
1. è®¿é—® http://202.140.143.88:8098/
2. è¾“å…¥æµ‹è¯•æ–‡ä»¶ï¼š`/comparison_results/simplified_comparison_20250906_195349.json`
3. ç‚¹å‡»"å¼€å§‹å¤„ç†"è¿›è¡Œåˆ—åæ ‡å‡†åŒ–
4. ç‚¹å‡»"æ‰§è¡Œè¯­ä¹‰åˆ†æ"è¿›è¡ŒL2åˆ†æ
5. æˆ–ç‚¹å‡»"å®Œæ•´æµ‹è¯•æµç¨‹"æ‰§è¡Œå…¨æµç¨‹

---

## 9. å…³é”®ä»£ç ä½ç½®é€ŸæŸ¥

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œå· | è¯´æ˜ |
|-----|------|------|------|
| ç¬¬ä¸€å±‚æç¤ºè¯ | l2_semantic_analysis_two_layer.py | 77-99 | build_layer1_prompt() |
| ç¬¬äºŒå±‚æç¤ºè¯ | l2_semantic_analysis_two_layer.py | 101-133 | build_layer2_prompt() |
| æ•°æ®æ ¼å¼è½¬æ¢ | deepseek_enhanced_server_with_semantic.py | 1750-1756 | å¿…é¡»è½¬æ¢oldâ†’old_value |
| ç»“æœå¤„ç† | deepseek_enhanced_server_with_semantic.py | 1773-1806 | ä½¿ç”¨.get()é¿å…KeyError |
| å·¥ä½œæµç”Ÿæˆ | l2_semantic_analysis_two_layer.py | 453-470 | _create_workflow() |

---

## 10. æœªæ¥AIæ¥æ‰‹æŒ‡å—

### 10.1 å¿«é€Ÿä¸Šæ‰‹æ­¥éª¤
1. å…ˆè¯»æœ¬æ–‡æ¡£äº†è§£æ•´ä½“æ¶æ„å’Œå¡ç‚¹
2. æŸ¥çœ‹ `l2_semantic_analysis_two_layer.py` ç†è§£æ ¸å¿ƒé€»è¾‘
3. æµ‹è¯• 8098 æœåŠ¡ç¡®è®¤ç³»ç»Ÿè¿è¡Œæ­£å¸¸
4. é‡ç‚¹å…³æ³¨æ•°æ®æ ¼å¼è½¬æ¢éƒ¨åˆ†

### 10.2 å¸¸è§æ”¹è¿›éœ€æ±‚
- ä¼˜åŒ–æç¤ºè¯ï¼šä¿®æ”¹ `build_layer1_prompt()` å’Œ `build_layer2_prompt()`
- è°ƒæ•´é˜ˆå€¼ï¼šä¿®æ”¹ç¬¬ä¸€å±‚ç½®ä¿¡åº¦åˆ¤æ–­ï¼ˆå½“å‰70%ï¼‰
- æ·»åŠ æ–°L2åˆ—ï¼šæ›´æ–° `L2_COLUMNS` åˆ—è¡¨
- æ”¹è¿›é”™è¯¯å¤„ç†ï¼šå¢å¼º `.get()` æ–¹æ³•ä½¿ç”¨

### 10.3 æ¶æ„é™åˆ¶
- æç¤ºè¯ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ï¼Œä¸æ˜“ç»´æŠ¤
- APIè°ƒç”¨æ— é‡è¯•æœºåˆ¶
- ç¼ºå°‘ç¼“å­˜æœºåˆ¶ï¼Œé‡å¤åˆ†ææµªè´¹Token
- æ‰¹å¤„ç†å¤§å°å›ºå®šä¸º20ï¼Œä¸å¯é…ç½®

---

**æ–‡æ¡£ç»´æŠ¤è€…**ï¼šClaude  
**æœ€åæ›´æ–°**ï¼š2025-09-08  
**è”ç³»æ–¹å¼**ï¼šé€šè¿‡8098æœåŠ¡Webç•Œé¢åé¦ˆ