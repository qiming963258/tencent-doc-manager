# 10-综合打分绝对规范

## 📊 概述

本文档定义了腾讯文档智能监控系统中**综合打分文件**的绝对规范，确保UI能够获取所需的全部9类参数，实现完整的热力图渲染和数据展示。

---

## 🎯 UI需求参数清单（9类）

### 核心需求
UI前端需要以下9类参数用于渲染热力图和统计界面：

1. **表名作为行名** - 热力图Y轴显示
2. **列名** - 热力图X轴显示
3. **表名** - 数据归属标识
4. **格子的列修改值** - 热力图单元格数值
5. **每个表每列发生的总修改行数** - 悬浮窗显示
6. **每个表总修改数** - 右侧统计面板
7. **每个表总行数** - 右侧一维图基础数据
8. **每列的发生修改的行位置** - 右侧一维图详细数据
9. **涂色Excel的腾讯文档URL** - 行名点击跳转链接

---

## 📁 文件规范

### 文件命名规范
```
comprehensive_score_W{周数}_{时间戳}.json
```

**示例**：
```
comprehensive_score_W38_20250915_143000.json
```

### 文件存储位置
```
/root/projects/tencent-doc-manager/scoring_results/comprehensive/
```

### 文件大小要求
- **最小参数数量**：5200+
- **包含完整热力图矩阵**：N×19（N为文档数量）
- **包含所有单元格详细数据**

---

## 📋 JSON结构规范

### 完整JSON格式

```json
{
  "metadata": {
    "version": "2.0",
    "timestamp": "2025-09-15T14:30:00.000000",
    "week": "W38",
    "generator": "comprehensive_scoring_v2",
    "total_params": 5200,
    "processing_time": 45.2
  },

  "summary": {
    "total_tables": 3,
    "total_columns": 19,
    "total_modifications": 2038,
    "overall_risk_score": 0.65,
    "processing_status": "complete"
  },

  "table_names": [
    "副本-测试版本-出国销售计划表",
    "副本-测试版本-回国销售计划表",
    "测试版本-小红书部门"
  ],

  "column_names": [
    "项目编号",
    "项目名称",
    "项目类型",
    "责任人",
    "协作人员",
    "开始日期",
    "截止日期",
    "当前状态",
    "进度百分比",
    "优先级",
    "预算金额",
    "实际花费",
    "风险等级",
    "审批状态",
    "备注信息",
    "创建时间",
    "更新时间",
    "附件链接",
    "标签分类"
  ],

  "heatmap_data": {
    "matrix": [
      [0.05, 0.7, 0.05, 0.8, 0.05, 0.05, 0.9, 0.05, 0.6, 0.05, 0.05, 0.7, 0.05, 0.05, 0.8, 0.05, 0.05, 0.05, 0.05],
      [0.05, 0.05, 0.6, 0.05, 0.05, 0.7, 0.05, 0.8, 0.05, 0.05, 0.05, 0.05, 0.9, 0.05, 0.05, 0.6, 0.05, 0.05, 0.05],
      [0.7, 0.05, 0.05, 0.05, 0.8, 0.05, 0.05, 0.05, 0.05, 0.9, 0.05, 0.05, 0.05, 0.6, 0.05, 0.05, 0.7, 0.05, 0.05]
    ],
    "description": "N×19矩阵，N=表格数量，19=列数量，值域[0.05-1.0]"
  },

  "table_details": [
    {
      "table_id": "table_001",
      "table_name": "副本-测试版本-出国销售计划表",
      "table_index": 0,
      "total_rows": 270,
      "total_modifications": 680,
      "overall_risk_score": 0.7,
      "excel_url": "https://docs.qq.com/sheet/DWHpOdVVKU0VmSXJv",

      "column_details": [
        {
          "column_name": "项目编号",
          "column_index": 0,
          "modification_count": 0,
          "modified_rows": [],
          "score": 0.05
        },
        {
          "column_name": "项目名称",
          "column_index": 1,
          "modification_count": 15,
          "modified_rows": [2, 5, 8, 12, 18, 23, 28, 35, 42, 48, 56, 68, 72, 85, 92],
          "score": 0.7
        },
        {
          "column_name": "项目类型",
          "column_index": 2,
          "modification_count": 0,
          "modified_rows": [],
          "score": 0.05
        },
        {
          "column_name": "责任人",
          "column_index": 3,
          "modification_count": 22,
          "modified_rows": [1, 3, 7, 9, 11, 14, 16, 19, 21, 25, 27, 31, 33, 37, 41, 45, 51, 55, 61, 67, 73, 79],
          "score": 0.8
        },
        {
          "column_name": "协作人员",
          "column_index": 4,
          "modification_count": 0,
          "modified_rows": [],
          "score": 0.05
        },
        {
          "column_name": "开始日期",
          "column_index": 5,
          "modification_count": 0,
          "modified_rows": [],
          "score": 0.05
        },
        {
          "column_name": "截止日期",
          "column_index": 6,
          "modification_count": 35,
          "modified_rows": [4, 6, 10, 13, 15, 17, 20, 22, 24, 26, 29, 32, 34, 36, 38, 40, 43, 46, 49, 52, 54, 57, 59, 62, 64, 66, 69, 71, 74, 76, 78, 81, 83, 86, 88],
          "score": 0.9
        },
        {
          "column_name": "当前状态",
          "column_index": 7,
          "modification_count": 0,
          "modified_rows": [],
          "score": 0.05
        },
        {
          "column_name": "进度百分比",
          "column_index": 8,
          "modification_count": 8,
          "modified_rows": [30, 39, 44, 47, 50, 53, 58, 63],
          "score": 0.6
        }
      ]
    },
    {
      "table_id": "table_002",
      "table_name": "副本-测试版本-回国销售计划表",
      "table_index": 1,
      "total_rows": 185,
      "total_modifications": 520,
      "overall_risk_score": 0.65,
      "excel_url": "https://docs.qq.com/sheet/DWGZDZkxpaGVQaURr",

      "column_details": [
        {
          "column_name": "项目编号",
          "column_index": 0,
          "modification_count": 0,
          "modified_rows": [],
          "score": 0.05
        }
      ]
    },
    {
      "table_id": "table_003",
      "table_name": "测试版本-小红书部门",
      "table_index": 2,
      "total_rows": 2010,
      "total_modifications": 838,
      "overall_risk_score": 0.6,
      "excel_url": "https://docs.qq.com/sheet/DWFJzdWNwd0RGbU5R",

      "column_details": [
        {
          "column_name": "项目编号",
          "column_index": 0,
          "modification_count": 12,
          "modified_rows": [100, 200, 300, 400, 500, 600, 700, 800, 900, 1000, 1100, 1200],
          "score": 0.7
        }
      ]
    }
  ],

  "hover_data": {
    "description": "鼠标悬浮显示数据",
    "data": [
      {
        "table_index": 0,
        "column_modifications": [0, 15, 0, 22, 0, 0, 35, 0, 8, 0, 0, 12, 0, 0, 18, 0, 0, 0, 0]
      },
      {
        "table_index": 1,
        "column_modifications": [0, 0, 9, 0, 0, 14, 0, 21, 0, 0, 0, 0, 28, 0, 0, 11, 0, 0, 0]
      },
      {
        "table_index": 2,
        "column_modifications": [12, 0, 0, 0, 18, 0, 0, 0, 0, 25, 0, 0, 0, 15, 0, 0, 16, 0, 0]
      }
    ]
  },

  "statistics": {
    "table_modifications": [680, 520, 838],
    "table_row_counts": [270, 185, 2010],
    "column_total_modifications": [12, 15, 9, 22, 18, 14, 35, 21, 8, 25, 0, 12, 28, 15, 18, 11, 16, 0, 0],
    "risk_distribution": {
      "high": 5,
      "medium": 8,
      "low": 6
    }
  },

  "visualization_params": {
    "color_scheme": "diverging",
    "min_value": 0.05,
    "max_value": 1.0,
    "default_value": 0.05,
    "color_stops": [
      {"value": 0.05, "color": "#1e40af"},
      {"value": 0.25, "color": "#0891b2"},
      {"value": 0.5, "color": "#10b981"},
      {"value": 0.75, "color": "#eab308"},
      {"value": 1.0, "color": "#dc2626"}
    ]
  },

  "ui_config": {
    "enable_hover": true,
    "enable_click": true,
    "enable_zoom": true,
    "default_zoom": 1.0,
    "min_zoom": 0.5,
    "max_zoom": 2.0,
    "animation_duration": 300
  }
}
```

### 带注释版JSON格式（小括号版本）

为了提高可读性，系统也支持带中文注释的JSON格式。这种格式使用 `// （注释内容）` 的方式为每个字段添加说明：

```json
{
  "metadata": {  // （元数据部分：记录文件生成的基本信息）
    "version": "2.0",  // （版本号：数据格式版本）
    "timestamp": "2025-09-15T14:30:00.000000",  // （时间戳：ISO格式的生成时间）
    "week": "W38",  // （周数标识：使用ISO 8601标准的周数）
    "generator": "comprehensive_scoring_v2",  // （生成器：使用的算法版本）
    "total_params": 5200,  // （总参数数：UI需要的最小参数数量）
    "processing_time": 45.2  // （处理时间：秒为单位的处理耗时）
  },

  "summary": {  // （摘要信息：整体统计数据）
    "total_tables": 3,  // （表格总数：处理的腾讯文档数量）
    "total_columns": 19,  // （列总数：每个表格的标准列数）
    "total_modifications": 2038,  // （总修改数：所有检测到的变更）
    "overall_risk_score": 0.65,  // （总体风险分：0-1范围的综合评分）
    "processing_status": "complete"  // （处理状态：complete/partial/error）
  },

  "table_names": [  // （表格名称列表：热力图Y轴标签）
    "副本-测试版本-出国销售计划表",  // （第1个表格：出国销售数据）
    "副本-测试版本-回国销售计划表",  // （第2个表格：回国销售数据）
    "测试版本-小红书部门"  // （第3个表格：小红书部门数据）
  ],

  "column_names": [  // （列名列表：热力图X轴标签，固定19列）
    "项目编号",  // （第1列：唯一标识符）
    "项目名称",  // （第2列：项目描述）
    "项目类型",  // （第3列：分类信息）
    // ... 更多列名
  ],

  "heatmap_data": {  // （热力图数据：核心可视化数据）
    "matrix": [  // （N×19矩阵：N=表格数，19=列数）
      [0.05, 0.7, 0.05, ...],  // （第1个表格的19个列的风险分数）
      [0.05, 0.05, 0.6, ...],  // （第2个表格的19个列的风险分数）
      [0.7, 0.05, 0.05, ...]   // （第3个表格的19个列的风险分数）
    ],
    "description": "N×19矩阵，值域[0.05-1.0]"  // （矩阵说明）
  },

  "table_details": [  // （表格详情：每个表格的详细数据）
    {
      "table_id": "table_001",  // （表格ID：内部唯一标识）
      "table_name": "副本-测试版本-出国销售计划表",  // （表格名称）
      "table_index": 0,  // （表格索引：从0开始）
      "total_rows": 270,  // （总行数：表格中的数据行数）
      "total_modifications": 680,  // （修改总数：该表的变更数）
      "overall_risk_score": 0.7,  // （风险评分：该表的综合风险）
      "excel_url": "https://docs.qq.com/sheet/...",  // （文档链接：腾讯文档URL）

      "column_details": [  // （列详情：每列的具体信息）
        {
          "column_name": "项目编号",  // （列名称）
          "column_index": 0,  // （列索引：从0开始）
          "modification_count": 0,  // （修改次数：该列的变更数）
          "modified_rows": [],  // （修改行号：发生变更的行号列表）
          "score": 0.05,  // （风险分数：0.05-1.0范围）
          "column_level": "L3",  // （列级别：L1高风险/L2中风险/L3低风险）
          "ai_decisions": {  // （AI决策统计：仅L2列有此字段）
            "APPROVE": 5,  // （批准次数：AI判断可通过的修改）
            "REVIEW": 3,  // （复审次数：需人工确认的修改）
            "CONDITIONAL": 2  // （条件批准：需满足条件的修改）
          }
        }
        // ... 更多列详情
      ]
    }
    // ... 更多表格详情
  ]
}
```

#### 注释格式规范

1. **注释位置**：紧跟在字段值后面，使用 `//` 开始
2. **注释格式**：`// （字段说明：详细描述）`
3. **中文括号**：使用中文全角括号 `（）` 包裹注释内容
4. **分隔符**：冒号 `：` 分隔字段名和说明
5. **嵌套注释**：对象和数组类型在声明行添加整体说明

#### 解析处理

由于标准JSON不支持注释，系统在解析时需要：

1. **预处理步骤**：使用正则表达式移除所有 `// （...）` 格式的注释
2. **保留原始文件**：带注释版本仅用于开发和文档
3. **生产环境**：自动生成无注释的标准JSON文件

```python
import re
import json

def parse_annotated_json(content):
    """解析带小括号注释的JSON文件"""
    # 移除所有 // （...） 格式的注释
    pattern = r'//\s*（[^）]*）'
    clean_content = re.sub(pattern, '', content)

    # 移除多余的逗号（最后一个元素后的逗号）
    clean_content = re.sub(r',\s*([}\]])', r'\1', clean_content)

    # 解析清理后的JSON
    return json.loads(clean_content)
```

---

## 🔑 关键字段说明

### metadata（元数据）
- **version**: 格式版本号，当前为"2.0"
- **timestamp**: ISO 8601格式时间戳
- **week**: 周数标识（W01-W52）
- **total_params**: 参数总数，必须≥5200
- **processing_time**: 处理耗时（秒）

### table_names（表名列表）
- UI热力图Y轴显示
- 数组顺序对应matrix行顺序
- 支持中文名称

### column_names（列名列表）
- UI热力图X轴显示
- 固定19个列
- 顺序必须一致

### heatmap_data.matrix（热力图矩阵）
- N×19二维数组
- 值域：[0.05, 1.0]
- 0.05表示无修改（默认背景）
- 修改位置根据score动态计算

### table_details（表格详细信息）
- **excel_url**: 上传到腾讯文档的URL（关键！）
- **modified_rows**: 修改行号数组（用于一维图）
- **modification_count**: 该列总修改数（用于悬浮窗）

### statistics（统计信息）
- **table_modifications**: 每个表的总修改数
- **table_row_counts**: 每个表的总行数
- **column_total_modifications**: 每列的总修改数

---

## 📐 数据计算规则

### 1. 热力图单元格值计算
```python
# 有修改的单元格
if modification_count > 0:
    score = min(0.5 + (modification_count / total_rows) * 2, 1.0)
else:
    score = 0.05  # 默认背景值
```

### 2. 修改行位置记录
```python
# 记录实际修改的行号
modified_rows = [
    row_index
    for row_index, cell in enumerate(column_data)
    if cell.old_value != cell.new_value
]
```

### 3. 风险评分计算
```python
# 基于修改比例和重要性
risk_score = (modification_count / total_rows) * importance_weight
```

---

## 🔄 UI数据映射关系

| UI需求参数 | JSON字段路径 | 说明 |
|-----------|------------|------|
| 表名作为行名 | `table_names[]` | 热力图Y轴 |
| 列名 | `column_names[]` | 热力图X轴 |
| 表名 | `table_details[].table_name` | 数据归属 |
| 格子的列修改值 | `heatmap_data.matrix[][]` | 热力图数值 |
| 每表每列总修改行数 | `hover_data.data[].column_modifications[]` | 悬浮窗显示 |
| 每表总修改数 | `statistics.table_modifications[]` | 右侧统计 |
| 每表总行数 | `statistics.table_row_counts[]` | 一维图基础 |
| 每列修改行位置 | `table_details[].column_details[].modified_rows[]` | 一维图详细 |
| Excel URL | `table_details[].excel_url` | 点击跳转 |

---

## ✅ 验证清单

综合打分文件必须满足以下条件：

1. ✅ 文件名符合规范：`comprehensive_score_W{周数}_{时间戳}.json`
2. ✅ 存储在正确位置：`/scoring_results/comprehensive/`
3. ✅ 参数总数动态计算（根据表格数量和修改量）
4. ✅ 包含完整的N×19热力图矩阵
5. ✅ 每个表都有excel_url字段
6. ✅ 所有修改行位置都被记录
7. ✅ 默认背景值统一为0.05
8. ✅ JSON格式正确，可被解析
9. ✅ 包含所有9类UI需求参数

---

## 🛠️ 实现示例

### Python生成示例
```python
import json
from datetime import datetime
from pathlib import Path

def generate_comprehensive_score(week_number, tables_data, excel_urls):
    """生成符合规范的综合打分文件"""

    # 构建完整数据结构
    comprehensive_data = {
        "metadata": {
            "version": "2.0",
            "timestamp": datetime.now().isoformat(),
            "week": f"W{week_number}",
            "total_params": 0  # 后续计算
        },
        "table_names": [t["name"] for t in tables_data],
        "column_names": STANDARD_COLUMNS,  # 19个标准列
        "heatmap_data": {
            "matrix": generate_heatmap_matrix(tables_data)
        },
        "table_details": generate_table_details(tables_data, excel_urls),
        "hover_data": generate_hover_data(tables_data),
        "statistics": generate_statistics(tables_data)
    }

    # 计算参数总数
    comprehensive_data["metadata"]["total_params"] = count_params(comprehensive_data)

    # 确保参数数量足够
    if comprehensive_data["metadata"]["total_params"] < 5200:
        # 填充额外数据以达到要求
        comprehensive_data = pad_data_to_minimum(comprehensive_data)

    # 保存文件
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = f"comprehensive_score_W{week_number}_{timestamp}.json"
    filepath = Path("/root/projects/tencent-doc-manager/scoring_results/comprehensive") / filename

    with open(filepath, 'w', encoding='utf-8') as f:
        json.dump(comprehensive_data, f, ensure_ascii=False, indent=2)

    return str(filepath)
```

---

## 📊 UI接收和渲染

### JavaScript接收示例
```javascript
// 获取综合打分数据
async function loadComprehensiveData() {
    const response = await fetch('/api/get-comprehensive-data');
    const data = await response.json();

    // 验证数据完整性
    if (!validateComprehensiveData(data)) {
        console.error('综合打分数据不完整');
        return;
    }

    // 渲染热力图
    renderHeatmap(data.heatmap_data.matrix, data.table_names, data.column_names);

    // 设置悬浮窗数据
    setupHoverData(data.hover_data);

    // 渲染统计面板
    renderStatistics(data.statistics);

    // 设置URL跳转
    setupTableLinks(data.table_details);
}

function validateComprehensiveData(data) {
    // 检查9类参数是否齐全
    return data.metadata &&
           data.table_names &&
           data.column_names &&
           data.heatmap_data?.matrix &&
           data.hover_data &&
           data.statistics &&
           data.table_details &&
           data.metadata.total_params > 0;  // 参数数量动态计算
}
```

---

## 🔧 故障排查

### 常见问题及解决方案

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| UI无法显示热力图 | 数据结构不完整 | 确保包含所有9类参数 |
| 右侧UI显示默认值 | row_level_data适配错误 | 检查column_modifications字段 |
| 点击表名无法跳转 | 缺少excel_url | 确保上传成功并记录URL |
| 悬浮窗无数据 | hover_data缺失 | 添加column_modifications数组 |
| 热力图全蓝色 | 所有值都是0.05 | 检查修改检测逻辑 |
| 找不到最新文件 | 文件名不规范 | 使用标准命名格式 |

---

## 📝 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|---------|
| 2.1 | 2025-09-17 | 新增数据适配关键注意事项，更新故障排查指南 |
| 2.0 | 2025-09-15 | 完整规范定义，支持9类参数 |
| 1.0 | 2025-08-01 | 初始版本 |

---

## ⚠️ 数据适配关键注意事项（2025-09-17 新增）

### 服务器适配层必须遵循的规则

当将综合打分数据转换为前端API响应时，**必须严格遵循以下映射规则**：

#### 1. 字段名映射（关键！）
| 综合打分文件字段 | 前端API期望字段 | 说明 |
|---------------|--------------|------|
| `excel_url` | `url` | ✅ 正确：使用excel_url |
| ~~`table_url`~~ | `url` | ❌ 错误：table_url不存在 |
| `overall_risk_score` | `risk_score` | 优先使用overall_risk_score |

#### 2. 数据结构转换（核心！）

**从 column_details 聚合到 row_level_data：**

```python
# ✅ 正确的转换逻辑
column_modifications = {}
all_modified_rows = set()

if 'column_details' in table:
    for col_detail in table['column_details']:
        col_name = col_detail.get('column_name', '')
        modified_rows = col_detail.get('modified_rows', [])

        # 关键：构建前端需要的数据结构
        column_modifications[col_name] = {
            'modified_rows': modified_rows,  # 必须包含！
            'modification_count': col_detail.get('modification_count', 0),
            'modification_details': col_detail.get('modification_details', [])
        }
        all_modified_rows.update(modified_rows)

# 构建 row_level_data（前端必需）
row_level_data = {
    'total_rows': table.get('total_rows', 100),
    'modified_rows': sorted(list(all_modified_rows)),  # 聚合所有修改行
    'total_differences': table.get('total_modifications', 0),
    'column_modifications': column_modifications  # 关键数据！
}
```

#### 3. 常见错误（避坑指南）

| 错误做法 | 正确做法 | 影响 |
|---------|---------|------|
| 直接从table层级取total_rows | 从table_details中取值 | 显示0行 |
| 返回空的column_modifications | 遍历column_details构建 | 右侧UI显示默认值 |
| 忽略modified_rows字段 | 必须包含modified_rows数组 | 无法显示分布图 |
| 使用table_url字段 | 使用excel_url字段 | URL链接失效 |

#### 4. hover_data 格式转换

如果前端期望 `column_modifications` 数组格式，而数据是 `column_details` 对象格式：

```python
# 转换 hover_data
if 'column_details' in item:
    column_mods = []
    for col_detail in item['column_details']:
        mod_count = col_detail.get('modification_count', 0)
        column_mods.append(mod_count)

    converted_item = {
        'table_index': item.get('table_index', 0),
        'column_modifications': column_mods  # 前端期望的格式
    }
```

#### 5. 验证数据完整性

适配层输出前必须验证：
- ✅ tables数组存在且非空
- ✅ 每个table包含row_level_data
- ✅ row_level_data.column_modifications是对象且包含19个键
- ✅ 每个column_modifications项包含modified_rows数组
- ✅ excel_url字段存在且有效

---

## 🎯 核心原则

1. **完整性**：必须包含所有9类UI需求参数
2. **一致性**：格式、命名、路径必须标准化1
3. **可追溯**：每个修改都要记录位置
4. **可扩展**：支持动态表格数量
5. **高性能**：优化数据结构，减少冗余

---

此规范为**强制标准**，所有综合打分生成模块必须严格遵守。