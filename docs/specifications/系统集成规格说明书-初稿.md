# 腾讯文档智能监控热力图系统集成规格说明书

## 1. 系统概述

### 1.1 项目背景
基于现有腾讯文档自动化平台，集成高级热力图可视化组件，实现文档变更的实时监控和风险分析。

### 1.2 核心功能
- 30个表格×19列数据的实时热力图显示
- L1/L2/L3三级风险分类监控
- 表格内修改分布可视化
- 智能排序和异常检测

### 1.3 技术架构
- **后端**：Python Flask + SQLite + Redis + Playwright
- **前端**：React + Tailwind CSS + 热力图组件
- **部署**：4H2G Ubuntu服务器 + Nginx

## 2. 数据模型设计

### 2.1 表格基础数据结构
```python
table_schema = {
    "table_id": "String",           # 表格唯一标识
    "table_name": "String",         # 表格显示名称
    "table_url": "String",          # 腾讯文档链接
    "total_rows": "Integer",        # 表格总行数
    "actual_columns": "Array",      # 实际包含的列
    "last_modified": "DateTime",    # 最后修改时间
    "owner": "String",              # 负责人
    "department": "String"          # 所属部门
}
```

### 2.2 修改记录数据结构
```python
modification_schema = {
    "table_id": "String",
    "column_name": "String",
    "row_number": "Integer",
    "modification_intensity": "Float",  # 0-1修改强度
    "modification_count": "Integer",
    "last_modified": "DateTime",
    "modifier": "String",
    "change_type": "Enum",              # content_update/value_change/etc
    "severity": "Enum",                 # low/medium/high/critical
    "risk_level": "Enum"                # L1/L2/L3
}
```

### 2.3 列风险等级配置
```python
column_risk_levels = {
    "序号": "L3",                    # 可自由编辑
    "项目类型": "L2",                # 需要语义审核
    "来源": "L1",                    # 绝对不能修改
    "任务发起时间": "L1",            # 绝对不能修改
    "目标对齐": "L1",                # 绝对不能修改
    "关键KR对齐": "L1",              # 绝对不能修改
    "具体计划内容": "L2",            # 需要语义审核
    "邓总指导登记": "L2",            # 需要语义审核
    "负责人": "L2",                  # 需要语义审核
    "协助人": "L2",                  # 需要语义审核
    "监督人": "L2",                  # 需要语义审核
    "重要程度": "L1",                # 绝对不能修改
    "预计完成时间": "L1",            # 绝对不能修改
    "完成进度": "L1",                # 绝对不能修改
    "形成计划清单": "L2",            # 需要语义审核
    "复盘时间": "L3",                # 可自由编辑
    "对上汇报": "L3",                # 可自由编辑
    "应用情况": "L3",                # 可自由编辑
    "进度分析总结": "L3"             # 可自由编辑
}
```

## 3. 系统组件架构

### 3.1 后端组件扩展

#### 3.1.1 数据采集层
- **现有组件**：`tencent_upload_automation.py`（已验证可用）
- **扩展需求**：增加实时监控和版本对比功能

#### 3.1.2 数据处理层
```python
class HeatmapDataService:
    def generate_risk_matrix(self, tables_data):
        """
        生成30×19风险分数矩阵
        输入：30个表格的修改数据
        输出：热力图数据矩阵
        """
        
    def calculate_modification_patterns(self, table_data):
        """
        计算表格内修改分布模式
        输出：每列的修改位置和强度分布
        """
        
    def get_real_time_statistics(self):
        """
        计算实时统计数据
        输出：严重修改数、异常修改数、常规修改数等
        """
```

#### 3.1.3 API接口层
```python
# Flask API端点
@app.route('/api/heatmap/data', methods=['GET'])
def get_heatmap_data():
    """获取热力图主数据"""
    
@app.route('/api/heatmap/patterns', methods=['GET'])  
def get_modification_patterns():
    """获取修改分布模式数据"""
    
@app.route('/api/tables/import', methods=['POST'])
def import_table_links():
    """批量导入腾讯文档链接"""
    
@app.route('/api/monitoring/settings', methods=['POST'])
def update_monitoring_settings():
    """更新监控配置"""
```

### 3.2 前端组件集成

#### 3.2.1 React项目结构
```
src/
├── components/
│   └── AdvancedSortedHeatmap.jsx  # 核心热力图组件（已有）
├── services/
│   └── api.js                     # API调用服务
├── utils/
│   └── dataProcessor.js          # 数据处理工具
└── App.jsx
```

#### 3.2.2 部署配置
- **构建工具**：Vite（推荐）
- **样式框架**：Tailwind CSS（已配置）
- **状态管理**：React Hooks（useMemo, useState）

## 4. 数据流设计

### 4.1 数据采集流程
```
腾讯文档 → Playwright采集 → 版本对比 → SQLite存储 → Redis缓存 → API提供
```

### 4.2 热力图数据转换流程
```
CSV原始数据 → 风险评估算法 → 30×19矩阵生成 → 高斯平滑处理 → 前端渲染
```

### 4.3 实时更新机制
```
定时采集(5-30分钟) → 差异检测 → WebSocket推送 → 前端热更新
```

## 5. 核心算法设计

### 5.1 风险分数计算算法
```python
def calculate_risk_score(modification_record):
    """
    风险分数 = 修改次数权重(0.3) × 变更复杂度权重(0.25) × 
              风险等级权重(0.35) × 时间新近度权重(0.1)
    """
    weights = {
        'modification_count': 0.3,
        'change_complexity': 0.25,
        'risk_level': 0.35,
        'time_recency': 0.1
    }
    
    risk_level_scores = {
        'L1': 1.0,    # L1修改影响最大
        'L2': 0.6,    # L2修改中等影响
        'L3': 0.2     # L3修改影响最小
    }
    
    return calculate_weighted_score(modification_record, weights)
```

### 5.2 修改模式识别算法
```python
def identify_modification_pattern(modified_rows, total_rows):
    """
    识别修改分布模式：
    - top_heavy: 前40%行集中修改
    - bottom_heavy: 后40%行集中修改
    - middle_heavy: 中间40%行集中修改
    - scattered: 均匀分布修改
    - clustered: 聚集式修改
    """
```

## 6. 性能优化设计

### 6.1 数据缓存策略
- **Redis缓存**：热点数据3600秒TTL
- **前端缓存**：useMemo优化计算密集型操作
- **增量更新**：仅传输变更部分数据

### 6.2 渲染优化
- **高斯平滑预计算**：服务端完成，减少前端计算量
- **虚拟化渲染**：大数据量时采用虚拟滚动
- **WebGL加速**：热力图渲染可选GPU加速

## 7. 部署方案

### 7.1 开发环境搭建
```bash
# 后端环境
cd tencent-doc-manager
pip install flask flask-cors redis playwright
python -m playwright install

# 前端环境  
npm create vite@latest heatmap-frontend --template react
cd heatmap-frontend
npm install
npm install -D tailwindcss postcss autoprefixer
```

### 7.2 生产环境部署
```bash
# 服务器配置
服务器：4H2G Ubuntu
数据库：SQLite + Redis
Web服务器：Nginx
SSL证书：Let's Encrypt

# 部署脚本
./deploy.sh --env production --server 4h2g-ubuntu
```

### 7.3 监控和运维
- **健康检查**：/api/health端点
- **日志管理**：结构化日志 + 轮转
- **性能监控**：响应时间 + 错误率监控
- **备份策略**：SQLite定时备份 + 增量备份

## 8. 安全设计

### 8.1 认证授权
```python
# Cookie认证机制（沿用现有方案）
def authenticate_tencent_docs(cookie_string):
    """使用Cookie访问腾讯文档"""
    
# API访问控制  
@require_auth
def protected_api_endpoint():
    """需要认证的API端点"""
```

### 8.2 数据安全
- **敏感数据加密**：Cookie等认证信息AES加密存储
- **访问日志**：完整的API访问和数据变更日志
- **权限控制**：不同用户角色的数据访问权限

## 9. 测试方案

### 9.1 单元测试
- **后端测试**：pytest覆盖核心算法和API
- **前端测试**：Jest测试React组件
- **集成测试**：端到端的数据流测试

### 9.2 性能测试
- **负载测试**：模拟30个表格并发访问
- **压力测试**：测试系统极限处理能力
- **稳定性测试**：7×24小时连续运行测试

## 10. 实施计划

### 10.1 开发阶段（估计4-6周）
- **Week 1-2**：后端API开发和数据模型设计
- **Week 3-4**：前端组件集成和数据对接
- **Week 5**：系统集成测试和性能优化
- **Week 6**：部署配置和用户验收测试

### 10.2 上线准备
- **数据迁移**：现有监控数据导入新系统
- **用户培训**：热力图界面操作培训
- **应急预案**：故障回滚和数据恢复方案

## 11. 维护和扩展

### 11.1 日常维护
- **数据备份**：每日自动备份SQLite数据库
- **性能监控**：关键指标告警设置
- **版本更新**：组件版本管理和平滑升级

### 11.2 功能扩展
- **多租户支持**：支持多个部门独立使用
- **移动端适配**：响应式设计支持移动设备
- **导出功能**：热力图数据导出Excel/PDF
- **智能告警**：基于ML的异常行为检测

---

**文档版本**：v1.0  
**创建时间**：2025-01-15  
**负责人**：系统架构团队  
**审核状态**：待审核