# 上下文01 - 配置统一核心指引

**创建时间**: 2025-09-17
**目的**: 为新AI提供精准项目状态，避免重复错误

## 一、当前问题状态（已验证）

### 1.1 配置分散事实
- **20个Python文件**各自定义STANDARD_COLUMNS
- **8个文件**重复定义L1/L2/L3分类
- **51个JSON配置文件**分散存储

### 1.2 列名不一致问题（已在文档中修复）
| 列索引 | 原错误版本 | 已统一为 | 修复状态 |
|--------|-----------|---------|----------|
| 14 | 形成计划清单 | 完成链接 | ✅ 文档已修复 |
| 15 | 进度分析总结 | 经理分析复盘 | ✅ 文档已修复 |
| 16 | 复盘时间 | 最新复盘时间 | ✅ 文档已修复 |

**注意**：文档已全部统一，但20个Python文件仍需要代码层面修改

## 二、系统架构要点

### 2.1 数据链路
```
CSV对比 → comparison_to_scoring_adapter.py → comprehensive_score_generator_v2.py
→ comprehensive_score_W{周数}.json → final_heatmap_server.py → 8089端口UI
```

### 2.2 最终目标
生成包含9类UI参数的comprehensive_score JSON文件：
1. 表名作为行名
2. 19个标准列名
3. N×19热力图矩阵
4. 每表每列修改数
5. 表总修改数
6. 表总行数
7. 修改行位置
8. Excel URL
9. 悬浮窗数据

## 三、关键文件清单

### 3.1 P0级生产文件（必须修改）
1. `production/servers/final_heatmap_server.py`
2. `production/core_modules/comparison_to_scoring_adapter.py`
3. `production/core_modules/comprehensive_score_generator_v2.py`
4. `production/scoring_engine/integrated_scorer.py`
5. `standard_columns_config.py`

### 3.2 规范文档（权威参考）
- `10-综合打分绝对规范.md` - UI参数定义
- `10-全链路适配规范.md` - 数据流程
- `11-中心统一配置管理计划.md` - 实施方案

## 四、正确的统一方向

### 4.1 标准19列（唯一版本）
```python
# 来自 standard_columns_config.py
STANDARD_COLUMNS = [
    "序号", "项目类型", "来源", "任务发起时间", "目标对齐",
    "关键KR对齐", "具体计划内容", "邓总指导登记", "负责人",
    "协助人", "监督人", "重要程度", "预计完成时间", "完成进度",
    "完成链接",      # 14 - 统一为此
    "经理分析复盘",  # 15 - 统一为此
    "最新复盘时间",  # 16 - 统一为此
    "对上汇报", "应用情况"
]
```

### 4.2 L1/L2/L3分类
- **L1（7列）**: 来源、任务发起时间、目标对齐、关键KR对齐、重要程度、预计完成时间、完成进度
- **L2（6列）**: 项目类型、具体计划内容、邓总指导登记、负责人、协助人、监督人
- **L3（6列）**: 序号、完成链接、经理分析复盘、最新复盘时间、对上汇报、应用情况

## 五、立即验证命令

```bash
# 1. 验证配置分散
grep -r "STANDARD_COLUMNS\s*=" --include="*.py" /root/projects/tencent-doc-manager | wc -l

# 2. 验证L1/L2/L3分散
grep -r "L1_COLUMNS" --include="*.py" /root/projects/tencent-doc-manager | cut -d':' -f1 | sort -u

# 3. 验证UI是否正常
curl http://202.140.143.88:8089/api/comprehensive_data
```

## 六、Git操作必读

### 6.1 提交方式
```bash
# 必须使用强制提交脚本
./scripts/force_commit.sh "提交信息"
```

### 6.2 常见问题解决
```bash
# CRLF错误
sed -i 's/\r$//' script.sh

# 查找嵌套Git
find . -name ".git" -type d | grep -v "^./.git$"

# 终止卡住的Git
ps aux | grep git | grep commit
kill [PID]
```

## 七、配置统一实施步骤

### 第一步：创建配置中心
```
/production/config/
├── config_center.py
├── column_definitions.py
├── risk_classification.py
└── scoring_parameters.py
```

### 第二步：统一列名
从`standard_columns_config.py`开始，逐步替换20个文件

### 第三步：验证
每步修改后验证8089端口UI正常工作

## 八、关键决策

1. **使用别名映射**处理历史列名差异
2. **保持向后兼容**
3. **分阶段实施**，每阶段验证

## 九、成功标准

- [ ] 所有文件使用相同19列名
- [ ] L1+L2+L3=19列无重复
- [ ] 8089端口热力图正常
- [ ] comprehensive_score文件5200+参数

## 十、注意事项

- 8089端口是生产热力图UI
- 文件命名：`tencent_{文档名}_{时间戳}_{版本类型}_W{周数}.{扩展名}`
- 用中文回复交流

## 十一、文档整理成果（2025-09-17完成）

### 11.1 文档合并优化
- **0000系列**：3个文档→`0000-系统核心索引与标准.md`（统一索引和标准）
- **03系列**：3个文档→`03-CSV对比完整技术规范.md`（完整CSV技术）
- **归档文档**：6个废弃文档移至`/docs/archive/`
- **文档总数**：从35个精简到29个

### 11.2 关键技术信息确认
- ✅ 19个标准列定义完整保留
- ✅ L1/L2/L3分级定义完整保留
- ✅ comprehensive_score格式（5200+参数）完整保留
- ✅ 数据链路和服务端口定义完整保留
- ✅ 所有列名不一致已在文档中修复

### 11.3 下一步执行重点
**立即执行**：按照"11-中心统一配置管理计划.md"实施代码层面的配置统一
- 第一优先级：修改20个Python文件的STANDARD_COLUMNS定义
- 第二优先级：统一L1/L2/L3分类定义
- 第三优先级：建立配置中心目录结构

---

**核心理念**: 建立"单一真相源"配置中心，从standard_columns_config.py的19列定义开始统一。