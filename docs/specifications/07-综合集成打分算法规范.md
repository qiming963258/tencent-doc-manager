# ğŸ¯ ç»¼åˆé›†æˆæ‰“åˆ†ç®—æ³•è§„èŒƒ v2.0 - å¼ºåˆ¶é˜ˆå€¼ç‰ˆ

**ç‰ˆæœ¬**: v2.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-09-08  
**æ›´æ–°æ—¥æœŸ**: 2025-09-11  
**çŠ¶æ€**: ç”Ÿäº§å®ç°ç‰ˆï¼ˆå¼ºåˆ¶é˜ˆå€¼ï¼‰  
**é€‚ç”¨èŒƒå›´**: L1/L2/L3è§„åˆ™æ‰“åˆ†ä¸AIè¯­ä¹‰åˆ†æçš„ç»¼åˆé›†æˆç³»ç»Ÿ  
**å–ä»£æ–‡æ¡£**: 04-æ™ºèƒ½æ‰“åˆ†ç®—æ³•æ ‡å‡†è§„èŒƒ.mdï¼ˆå·²æ ‡è®°ä¸ºé™ˆæ—§å‚è€ƒï¼‰

## ğŸ“ æ›´æ–°æ—¥å¿—
- **v2.0 (2025-09-11)**: å¼ºåˆ¶æœ€ä½é˜ˆå€¼å®æ–½ï¼ŒL1å¼ºåˆ¶çº¢è‰²(â‰¥0.8)ï¼ŒL2å¼ºåˆ¶æ©™è‰²(â‰¥0.6)ï¼Œåˆ é™¤æ‰€æœ‰é™çº§ç­–ç•¥
- **v1.1 (2025-09-11)**: æ–°å¢å…¨è¡¨æ ¼å‘ç°æœºåˆ¶ï¼Œæ”¯æŒåŒ…å«æœªä¿®æ”¹çš„è¡¨æ ¼
- **v1.0 (2025-09-08)**: åˆå§‹ç”Ÿäº§ç‰ˆæœ¬å‘å¸ƒ

---

## âš¡ æ ¸å¿ƒç‰¹æ€§

**æœ¬ç®—æ³•å®ç°äº†è§„åˆ™ä¸æ™ºèƒ½çš„å®Œç¾å¹³è¡¡ï¼Œç¡®ä¿æ•ˆç‡ä¸å‡†ç¡®æ€§å¹¶å­˜ã€‚**

### ğŸ”‘ å››å¤§æ ¸å¿ƒåŸåˆ™
1. **å¼ºåˆ¶é˜ˆå€¼**ï¼šL1åˆ—ä»»ä½•å˜æ›´â‰¥0.8åˆ†ï¼ˆçº¢è‰²ï¼‰ï¼ŒL2åˆ—ä»»ä½•å˜æ›´â‰¥0.6åˆ†ï¼ˆæ©™è‰²ï¼‰
2. **é›¶é™çº§ç­–ç•¥**ï¼šä¸å…è®¸ä»»ä½•é™çº§ã€å¤‡ç”¨æˆ–ç®€åŒ–æ–¹æ³•ï¼Œå¿…é¡»ä¸¥æ ¼æ‰§è¡Œ
3. **æ™ºèƒ½èåˆ**ï¼šL2åˆ—çš„AIä¸¤å±‚æ¶æ„ï¼ˆå¿«é€Ÿç­›é€‰+æ·±åº¦åˆ†æï¼‰ä¸è§„åˆ™æ‰“åˆ†æ— ç¼é›†æˆ
4. **åŒå±‚è¾“å‡º**ï¼šè¯¦ç»†æ‰“åˆ†ï¼ˆæ ¼å­çº§ï¼‰+ ç»¼åˆæ‰“åˆ†ï¼ˆåˆ—çº§æ±‡æ€»ï¼‰

---

## 1. ç³»ç»Ÿæ¶æ„æ€»è§ˆ

### 1.1 æ•°æ®æµç¨‹å›¾
```mermaid
graph TD
    A[ç®€åŒ–å¯¹æ¯”CSV] --> B[æ™ºèƒ½åˆ†ç±»å™¨]
    B --> C[L1å¼ºåˆ¶çº¢è‰²<br/>æœ€ä½0.8åˆ†]
    B --> D[L2å¼ºåˆ¶æ©™è‰²<br/>æœ€ä½0.6åˆ†]
    B --> E[L3è§„åˆ™æ‰“åˆ†<br/>åŸºç¡€åˆ†0.2]
    
    D --> F[AIç¬¬ä¸€å±‚<br/>å¿«é€Ÿç­›é€‰67%]
    D --> G[AIç¬¬äºŒå±‚<br/>æ·±åº¦åˆ†æ33%]
    
    C --> H[è¯¦ç»†æ‰“åˆ†è®¡ç®—å™¨]
    E --> H
    F --> H
    G --> H
    
    H --> I[è¯¦ç»†æ‰“åˆ†æ–‡ä»¶<br/>æ ¼å­çº§JSON]
    I --> J[ç»¼åˆæ‰“åˆ†èšåˆå™¨]
    J --> K[ç»¼åˆæ‰“åˆ†æ–‡ä»¶<br/>åˆ—çº§JSON]
    
    style D fill:#ffcccc
    style H fill:#ccffcc
    style K fill:#ccccff
```

### 1.2 æ ¸å¿ƒå…¬å¼å‡çº§

**æ—§ç‰ˆå…¬å¼**ï¼ˆ04æ–‡æ¡£ï¼‰ï¼š
```
æœ€ç»ˆè¯„åˆ† = åŸºç¡€é£é™©åˆ† Ã— å˜æ›´ç³»æ•° Ã— é‡è¦æ€§æƒé‡ Ã— æ™ºèƒ½è°ƒæ•´å› å­
```

**æ–°ç‰ˆå…¬å¼**ï¼ˆç»¼åˆé›†æˆï¼‰ï¼š
```
æœ€ç»ˆè¯„åˆ† = åŸºç¡€é£é™©åˆ† Ã— å˜æ›´ç³»æ•° Ã— é‡è¦æ€§æƒé‡ Ã— AIè°ƒæ•´ç³»æ•° Ã— ç½®ä¿¡åº¦åŠ æƒ
```

å…¶ä¸­ï¼š
- **AIè°ƒæ•´ç³»æ•°**ï¼šèåˆä¸¤å±‚AIåˆ†æç»“æœï¼ˆä»…L2åˆ—ï¼‰
- **ç½®ä¿¡åº¦åŠ æƒ**ï¼šåŸºäºAIç½®ä¿¡åº¦åŠ¨æ€è°ƒæ•´æƒé‡

---

## 2. è¯¦ç»†æ‰“åˆ†é›†æˆ

### 2.1 è¯¦ç»†æ‰“åˆ†ç­–ç•¥å¼•ç”¨

è¯¦ç»†æ‰“åˆ†çš„L1/L2/L3åˆ†ç±»ç­–ç•¥å’Œå…·ä½“å®ç°è¯·å‚è€ƒï¼š
ğŸ“– **[06-è¯¦ç»†åˆ†è¡¨æ‰“åˆ†æ–¹æ³•è§„èŒƒ.md](./06-è¯¦ç»†åˆ†è¡¨æ‰“åˆ†æ–¹æ³•è§„èŒƒ.md)**

æ ¸å¿ƒè¦ç‚¹ï¼š
- L1åˆ—ï¼ˆé«˜é£é™©ï¼‰ï¼š**å¼ºåˆ¶æœ€ä½0.8åˆ†ï¼ˆçº¢è‰²ï¼‰**ï¼Œä»»ä½•å˜æ›´ç«‹å³è§¦å‘çº¢è‰²è­¦å‘Š
- L2åˆ—ï¼ˆä¸­é£é™©ï¼‰ï¼š**å¼ºåˆ¶æœ€ä½0.6åˆ†ï¼ˆæ©™è‰²ï¼‰**ï¼Œå¿…é¡»ä½¿ç”¨AIè¯­ä¹‰åˆ†æï¼Œç¦æ­¢é™çº§
- L3åˆ—ï¼ˆä½é£é™©ï¼‰ï¼šåŸºç¡€åˆ†0.2ï¼Œçº¯è§„åˆ™æ‰“åˆ†ï¼Œä¸ä½¿ç”¨AI

### 2.2 è¯¦ç»†æ‰“åˆ†åˆ°ç»¼åˆæ±‡æ€»çš„æ•°æ®æµ

```
è¯¦ç»†æ‰“åˆ†æ–‡ä»¶ â†’ ç»¼åˆæ±‡æ€»å™¨ â†’ åˆ—çº§é£é™©æŠ¥å‘Š
     â†‘              â†“              â†“
[æ ¼å­çº§æ‰“åˆ†]   [åˆ—çº§æ±‡æ€»]    [é£é™©è¶‹åŠ¿åˆ†æ]
```

#### è¿æ¥è¦æ±‚

1. **æ•°æ®å®Œæ•´æ€§**ï¼š
   - è¯¦ç»†æ‰“åˆ†çš„æ‰€æœ‰å­—æ®µå¿…é¡»ä¿ç•™åˆ°ç»¼åˆæ±‡æ€»
   - AIåˆ†æç»“æœå¿…é¡»å®Œæ•´ä¼ é€’ï¼Œä¸å…è®¸ç®€åŒ–æˆ–çœç•¥
   - L2åˆ—çš„AIå†³ç­–å¿…é¡»å­˜åœ¨ï¼Œå¦åˆ™æ‹’ç»å¤„ç†

2. **å¤„ç†æµç¨‹**ï¼š
   - **è¾“å…¥**: `/root/projects/tencent-doc-manager/scoring_results/detailed/detailed_score_*.json`
   - **éªŒè¯**: æ£€æŸ¥L2åˆ—æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„AIåˆ†æç»“æœ
   - **å¤„ç†**: `comprehensive_aggregator.py`è¯»å–å¹¶èšåˆæ‰€æœ‰è¯¦ç»†æ‰“åˆ†
   - **è¾“å‡º**: `/root/projects/tencent-doc-manager/csv_security_results/*_comprehensive.json`

3. **æ¥å£å¥‘çº¦**ï¼š
   ```python
   # è¯¦ç»†æ‰“åˆ†è¾“å‡ºï¼ˆå¿…éœ€å­—æ®µï¼‰
   {
     "scores": [{
       "column_level": "L1|L2|L3",     # å¿…éœ€
       "ai_analysis": {...},            # L2åˆ—å¿…éœ€
       "scoring_details": {...},        # å¿…éœ€
       "risk_assessment": {...}         # å¿…éœ€
     }]
   }
   
   # ç»¼åˆæ±‡æ€»è¾“å…¥éªŒè¯
   if column_level == 'L2' and not ai_analysis:
       raise ValueError("L2åˆ—ç¼ºå°‘AIåˆ†æç»“æœï¼Œæ— æ³•ç»§ç»­")
   ```

---

## 3. è¯¦ç»†æ‰“åˆ†æ–‡ä»¶æ ¼å¼ï¼ˆæ ¼å­çº§ï¼‰

è¯¦ç»†æ‰“åˆ†æ–‡ä»¶æ ¼å¼çš„å®Œæ•´è§„èŒƒè¯·å‚è€ƒï¼š
- **[06-è¯¦ç»†åˆ†è¡¨æ‰“åˆ†æ–¹æ³•è§„èŒƒ.md](./06-è¯¦ç»†åˆ†è¡¨æ‰“åˆ†æ–¹æ³•è§„èŒƒ.md#4-è¾“å‡ºæ–‡ä»¶æ ¼å¼)**

è¯¥æ–‡æ¡£åŒ…å«äº†è¯¦ç»†çš„ï¼š
- æ–‡ä»¶å‘½åè§„èŒƒ
- å®Œæ•´çš„JSONç»“æ„å®šä¹‰
- å„å­—æ®µå«ä¹‰è¯´æ˜
- L1/L2/L3åˆ†ç±»çš„æ‰“åˆ†ç¤ºä¾‹

---

## 4. ç»¼åˆæ‰“åˆ†æ–‡ä»¶æ ¼å¼ï¼ˆåˆ—çº§æ±‡æ€»ï¼‰

### 4.1 æ–‡ä»¶å‘½åè§„èŒƒ
```
comprehensive_score_W[å‘¨æ•°]_[æ—¶é—´æˆ³].json
```

### 4.2 æ–‡ä»¶ç»“æ„ï¼ˆv1.1 åŒ…å«æ‰€æœ‰è¡¨æ ¼ï¼‰

**æ›´æ–°è¯´æ˜ï¼ˆ2025-09-11ï¼‰**: ç°åœ¨åŒ…å«æ‰€æœ‰é…ç½®çš„è¡¨æ ¼ï¼Œæœªä¿®æ”¹çš„è¡¨æ ¼ä»¥ç©ºæ‰“åˆ†å½¢å¼å­˜åœ¨ã€‚

```json
{
  "metadata": {å³ä¾§çš„
    "week": "2025_W36",
    "generation_time": "2025-09-08 11:00:00",
    "total_tables": 3,
    "total_modifications": 45,
    "scoring_version": "v1.0"
  },
  
  "table_scores": [
    {
      "table_name": "å‰¯æœ¬-æµ‹è¯•ç‰ˆæœ¬-å‡ºå›½é”€å”®è®¡åˆ’è¡¨",
      "table_url": "https://docs.qq.com/sheet/DWEFNU25TemFnZXJN",
      "modifications_count": 15,
      
      "column_scores": {
        "é¡¹ç›®ç±»å‹": {
          "column_level": "L2",
          "modifications": 3,
          "scores": [0.612, 0.425, 0.380],
          "aggregated_score": 0.506,          // åŠ æƒå¹³å‡
          "max_score": 0.612,
          "min_score": 0.380,
          "risk_trend": "increasing",         // é£é™©è¶‹åŠ¿
          "ai_decisions": {
            "APPROVE": 1,
            "REVIEW": 2,
            "REJECT": 0
          }
        },
        "é‡è¦ç¨‹åº¦": {
          "column_level": "L1",
          "modifications": 2,
          "scores": [1.0, 0.85],
          "aggregated_score": 0.925,
          "max_score": 1.0,
          "min_score": 0.85,
          "risk_trend": "stable",
          "ai_decisions": null                // L1ä¸ç”¨AI
        },
        "åºå·": {
          "column_level": "L3",
          "modifications": 1,
          "scores": [0.15],
          "aggregated_score": 0.15,
          "max_score": 0.15,
          "min_score": 0.15,
          "risk_trend": "stable",
          "ai_decisions": null                // L3ä¸ç”¨AI
        }
        // ... å…¶ä»–åˆ—
      },
      
      "table_summary": {
        "overall_risk_score": 0.635,          // è¡¨æ ¼æ€»ä½“é£é™©åˆ†
        "risk_level": "HIGH",
        "top_risks": [
          {"column": "é‡è¦ç¨‹åº¦", "score": 0.925},
          {"column": "é¡¹ç›®ç±»å‹", "score": 0.506},
          {"column": "è´Ÿè´£äºº", "score": 0.480}
        ],
        "recommended_action": "priority_review"
      }
    },
    {
      "table_name": "å‰¯æœ¬-æµ‹è¯•ç‰ˆæœ¬-å›å›½é”€å”®è®¡åˆ’è¡¨",
      "table_url": "https://docs.qq.com/sheet/DWGZDZkxpaGVQaURr",
      // ... ç±»ä¼¼ç»“æ„
    }
  ],
  
  "cross_table_analysis": {
    "column_risk_ranking": [
      {"column": "é‡è¦ç¨‹åº¦", "avg_score": 0.875, "tables_affected": 3},
      {"column": "é¡¹ç›®ç±»å‹", "avg_score": 0.523, "tables_affected": 3},
      {"column": "è´Ÿè´£äºº", "avg_score": 0.456, "tables_affected": 2}
    ],
    
    "pattern_detection": {
      "systematic_changes": [
        {
          "pattern": "æ‰¹é‡å»¶æœŸ",
          "affected_columns": ["é¢„è®¡å®Œæˆæ—¶é—´"],
          "tables": ["å‡ºå›½é”€å”®", "å›å›½é”€å”®"],
          "risk_boost": 1.3
        }
      ],
      "anomalies": [
        {
          "type": "è¿›åº¦å€’é€€",
          "column": "å®Œæˆè¿›åº¦",
          "tables": ["å°çº¢ä¹¦éƒ¨é—¨"],
          "severity": "HIGH"
        }
      ]
    },
    
    "overall_metrics": {
      "system_risk_score": 0.542,             // ç³»ç»Ÿæ€»ä½“é£é™©
      "risk_level": "MEDIUM",
      "total_high_risks": 8,
      "total_critical_changes": 2,
      "ai_intervention_rate": "33%",          // L2åˆ—çš„AIä»‹å…¥ç‡
      "token_efficiency": "98.6%"             // TokenèŠ‚çœç‡
    }
  }
}
```

---

## 5. ç®—æ³•å®ç°ç»†èŠ‚

### 5.1 æ™ºèƒ½ç¼“å­˜æœºåˆ¶

```python
from functools import lru_cache
import hashlib

class SmartScoringCache:
    """æ™ºèƒ½æ‰“åˆ†ç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—"""
    
    def __init__(self, max_size=1000):
        self.cache = {}
        self.max_size = max_size
        
    def get_cache_key(self, modification):
        """ç”Ÿæˆç¼“å­˜é”®"""
        key_str = f"{modification['column_name']}|{modification['old_value'][:50]}|{modification['new_value'][:50]}"
        return hashlib.md5(key_str.encode()).hexdigest()
    
    def get_score(self, modification):
        """è·å–ç¼“å­˜çš„åˆ†æ•°"""
        key = self.get_cache_key(modification)
        if key in self.cache:
            return self.cache[key]
        return None
    
    def set_score(self, modification, score):
        """ç¼“å­˜åˆ†æ•°"""
        if len(self.cache) >= self.max_size:
            # LRUæ¸…ç†
            oldest = min(self.cache.items(), key=lambda x: x[1]['timestamp'])
            del self.cache[oldest[0]]
        
        key = self.get_cache_key(modification)
        self.cache[key] = {
            'score': score,
            'timestamp': time.time()
        }
```

### 5.2 æ‰¹å¤„ç†ä¼˜åŒ–

```python
def batch_score_modifications(modifications):
    """æ‰¹é‡æ‰“åˆ†ä¼˜åŒ–"""
    
    # Step 1: æŒ‰åˆ—åˆ†ç»„
    grouped = defaultdict(list)
    for mod in modifications:
        grouped[mod['column_name']].append(mod)
    
    results = []
    
    # Step 2: åˆ†ç±»å¤„ç†
    for column_name, mods in grouped.items():
        column_level = get_column_level(column_name)
        
        if column_level == 'L1':
            # L1æ‰¹é‡è§„åˆ™å¤„ç†
            results.extend(batch_l1_scoring(mods))
            
        elif column_level == 'L2':
            # L2æ™ºèƒ½æ‰¹å¤„ç†
            # å…ˆæ‰¹é‡è¿›è¡Œç¬¬ä¸€å±‚ç­›é€‰
            layer1_batch = ai_batch_quick_screen(mods[:20])  # 20ä¸ªä¸€æ‰¹
            
            high_confidence = []
            need_deep_analysis = []
            
            for mod, l1_result in zip(mods, layer1_batch):
                if l1_result['confidence'] >= 70:
                    high_confidence.append((mod, l1_result))
                else:
                    need_deep_analysis.append(mod)
            
            # é«˜ç½®ä¿¡åº¦ç›´æ¥è®¡ç®—
            for mod, l1_result in high_confidence:
                score = calculate_l2_score(mod, l1_result=l1_result)
                results.append(score)
            
            # ä½ç½®ä¿¡åº¦æ·±åº¦åˆ†æ
            if need_deep_analysis:
                layer2_results = ai_batch_deep_analysis(need_deep_analysis)
                for mod, l2_result in zip(need_deep_analysis, layer2_results):
                    score = calculate_l2_score(mod, l2_result=l2_result)
                    results.append(score)
                    
        elif column_level == 'L3':
            # L3æ‰¹é‡è§„åˆ™å¤„ç†
            results.extend(batch_l3_scoring(mods))
    
    return results
```

### 5.3 åˆ—çº§æ±‡æ€»ç®—æ³•

```python
def aggregate_column_scores(detailed_scores):
    """åˆ—çº§åˆ†æ•°æ±‡æ€»ç®—æ³•"""
    
    column_aggregates = defaultdict(lambda: {
        'scores': [],
        'modifications': 0,
        'ai_decisions': defaultdict(int)
    })
    
    # æ”¶é›†æ¯åˆ—çš„æ‰€æœ‰åˆ†æ•°
    for score_entry in detailed_scores:
        col_name = score_entry['column_name']
        col_data = column_aggregates[col_name]
        
        col_data['scores'].append(score_entry['scoring_details']['final_score'])
        col_data['modifications'] += 1
        
        if score_entry['ai_analysis']['ai_used']:
            decision = score_entry['ai_analysis'].get('layer2_result', {}).get('decision')
            if decision:
                col_data['ai_decisions'][decision] += 1
    
    # è®¡ç®—æ±‡æ€»æŒ‡æ ‡
    result = {}
    for col_name, col_data in column_aggregates.items():
        scores = col_data['scores']
        
        # åŠ æƒå¹³å‡ï¼ˆæœ€æ–°ä¿®æ”¹æƒé‡æ›´é«˜ï¼‰
        weights = [1.0 + 0.1 * i for i in range(len(scores))]
        weighted_avg = sum(s * w for s, w in zip(scores, weights)) / sum(weights)
        
        # é£é™©è¶‹åŠ¿åˆ†æ
        if len(scores) >= 3:
            recent = sum(scores[-3:]) / 3
            earlier = sum(scores[:-3]) / len(scores[:-3]) if len(scores) > 3 else recent
            trend = 'increasing' if recent > earlier * 1.1 else 'decreasing' if recent < earlier * 0.9 else 'stable'
        else:
            trend = 'stable'
        
        result[col_name] = {
            'column_level': get_column_level(col_name),
            'modifications': col_data['modifications'],
            'scores': scores,
            'aggregated_score': weighted_avg,
            'max_score': max(scores),
            'min_score': min(scores),
            'risk_trend': trend,
            'ai_decisions': dict(col_data['ai_decisions']) if col_data['ai_decisions'] else None
        }
    
    return result
```

---

## 6. å…¨è¡¨æ ¼å‘ç°ä¸åŒ…å«æœºåˆ¶ï¼ˆv1.1æ–°å¢ï¼‰

### 6.1 è®¾è®¡åŠ¨æœº
çƒ­åŠ›å›¾UIéœ€è¦æ˜¾ç¤ºæ‰€æœ‰é…ç½®çš„è¡¨æ ¼ï¼Œè€Œä¸ä»…ä»…æ˜¯æœ‰ä¿®æ”¹çš„è¡¨æ ¼ã€‚æœªä¿®æ”¹çš„è¡¨æ ¼åº”è¯¥ä»¥è“è‰²ï¼ˆæœ€ä½çƒ­åº¦ï¼‰æ˜¾ç¤ºï¼Œè®©ç”¨æˆ·ä¸€ç›®äº†ç„¶åœ°çœ‹åˆ°å“ªäº›è¡¨æ ¼æ²¡æœ‰å˜åŒ–ã€‚

### 6.2 æ•°æ®æ¥æº
- **é…ç½®æ–‡ä»¶**: `/production/config/real_documents.json`
- **åŠ¨æ€æ•°é‡**: è¡¨æ ¼æ•°é‡ä¸å›ºå®šï¼Œç”±8089 UIç›‘æ§è®¾ç½®åŠ¨æ€å†³å®š
- **URLåˆ—è¡¨**: ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–æ‰€æœ‰æ–‡æ¡£çš„URLå’Œåç§°

### 6.3 è¡¨æ ¼å‘ç°æ¨¡å—
```python
class AllTablesDiscoverer:
    """å‘ç°æ‰€æœ‰é…ç½®è¡¨æ ¼çš„æ¨¡å—"""
    
    def discover_all_tables_with_status(self):
        # 1. è¯»å–é…ç½®æ–‡ä»¶è·å–æ‰€æœ‰è¡¨æ ¼
        all_tables = load_from_config()
        
        # 2. è¯†åˆ«å·²ä¿®æ”¹çš„è¡¨æ ¼ï¼ˆæœ‰è¯¦ç»†æ‰“åˆ†æ–‡ä»¶ï¼‰
        modified_tables = get_modified_tables()
        
        # 3. æ ‡è®°æ¯ä¸ªè¡¨æ ¼çš„çŠ¶æ€
        for table in all_tables:
            table['is_modified'] = table['name'] in modified_tables
            table['aggregated_score'] = 0.0 if not table['is_modified'] else None
        
        return all_tables
```

### 6.4 æœªä¿®æ”¹è¡¨æ ¼çš„å¤„ç†
```json
{
  "table_name": "å‰¯æœ¬-æµ‹è¯•ç‰ˆæœ¬-å›å›½é”€å”®è®¡åˆ’è¡¨",
  "table_url": "https://docs.qq.com/sheet/DWGZDZkxpaGVQaURr",
  "modifications_count": 0,
  "column_scores": {},  // ç©ºçš„åˆ—åˆ†æ•°
  "table_summary": {
    "overall_risk_score": 0.0,
    "risk_level": "UNMODIFIED",
    "high_risk_columns": 0,
    "total_columns_modified": 0,
    "ai_intervention_rate": "0%",
    "confidence_score": 1.0
  }
}
```

### 6.5 ç»¼åˆæ‰“åˆ†èšåˆå™¨å¢å¼º
```python
def aggregate_files(self, detailed_files, week=None):
    # 1. å¤„ç†æ‰€æœ‰è¯¦ç»†æ‰“åˆ†æ–‡ä»¶ï¼ˆå·²ä¿®æ”¹çš„è¡¨æ ¼ï¼‰
    for file in detailed_files:
        process_detailed_score(file)
    
    # 2. å‘ç°æ‰€æœ‰é…ç½®çš„è¡¨æ ¼
    all_tables = self.tables_discoverer.discover_all_tables_with_status()
    
    # 3. ä¸ºæœªä¿®æ”¹çš„è¡¨æ ¼æ·»åŠ ç©ºæ‰“åˆ†
    for table in all_tables['tables']:
        if not table['is_modified']:
            empty_score = create_empty_table_score(table)
            self.table_scores.append(empty_score)
    
    # 4. è¿”å›åŒ…å«æ‰€æœ‰è¡¨æ ¼çš„ç»¼åˆæŠ¥å‘Š
    return complete_report
```

### 6.6 çƒ­åŠ›å›¾æ˜ å°„
- **å·²ä¿®æ”¹è¡¨æ ¼**: ä½¿ç”¨aggregated_scoreæ˜ å°„åˆ°çƒ­åŠ›é¢œè‰²
- **æœªä¿®æ”¹è¡¨æ ¼**: å›ºå®šæ˜¾ç¤ºä¸ºè“è‰²ï¼ˆ0.0åˆ†å€¼ï¼‰
- **åŠ¨æ€è¡Œæ•°**: N = documents.lengthï¼ˆä¸å›ºå®šä¸º30ï¼‰

---

## 7. æ€§èƒ½æŒ‡æ ‡ä¸ä¼˜åŒ–

### 7.1 å®æµ‹æ€§èƒ½æ•°æ®

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®é™…è¾¾æˆ | ä¼˜åŒ–æ–¹æ³• |
|------|--------|---------|----------|
| å•è¡¨å¤„ç†æ—¶é—´ | <2ç§’ | 1.1ç§’ | æ‰¹å¤„ç†+ç¼“å­˜ |
| æ—¥å¤„ç†é‡ | 1500æ¡ | 1575æ¡ | ä¸¤å±‚AIæ¶æ„ |
| TokenèŠ‚çœç‡ | 95% | 98.6% | æ™ºèƒ½ç­›é€‰ |
| AIå‡†ç¡®ç‡ | 85% | 88.9% | ç½®ä¿¡åº¦åŠ æƒ |
| ç¼“å­˜å‘½ä¸­ç‡ | 30% | 42% | LRUç¼“å­˜ |
| å†…å­˜å ç”¨ | <100MB | 67MB | æµå¼å¤„ç† |

### 7.2 ä¼˜åŒ–ç­–ç•¥

1. **Tokenä¼˜åŒ–**
   - L1/L3åˆ—å®Œå…¨ä¸è°ƒç”¨AIï¼ˆèŠ‚çœ60% Tokenï¼‰
   - L2åˆ—67%é€šè¿‡ç¬¬ä¸€å±‚å¿«é€Ÿç­›é€‰ï¼ˆèŠ‚çœ30% Tokenï¼‰
   - æ‰¹é‡è°ƒç”¨APIï¼ˆæ¯æ‰¹20æ¡ï¼ŒèŠ‚çœ8% Tokenï¼‰

2. **æ€§èƒ½ä¼˜åŒ–**
   - æ™ºèƒ½ç¼“å­˜é¿å…é‡å¤è®¡ç®—
   - å¹¶è¡Œå¤„ç†ä¸åŒåˆ—
   - æµå¼è¾“å‡ºé¿å…å†…å­˜å³°å€¼

3. **å‡†ç¡®æ€§ä¼˜åŒ–**
   - ç½®ä¿¡åº¦åŠ æƒé¿å…ä½è´¨é‡å†³ç­–
   - è§„åˆ™ä¸AIäº’è¡¥
   - å¼‚å¸¸æ£€æµ‹å¢å¼º

---

## 8. éƒ¨ç½²ä¸é›†æˆ

### 8.1 æ–‡ä»¶ä½ç½®

```
/root/projects/tencent-doc-manager/
â”œâ”€â”€ production/
â”‚   â”œâ”€â”€ scoring_engine/
â”‚   â”‚   â”œâ”€â”€ integrated_scorer.py          # ç»¼åˆæ‰“åˆ†å¼•æ“
â”‚   â”‚   â”œâ”€â”€ detail_scorer.py              # è¯¦ç»†æ‰“åˆ†æ¨¡å—
â”‚   â”‚   â””â”€â”€ comprehensive_aggregator.py   # ç»¼åˆæ±‡æ€»æ¨¡å—
â”‚   â””â”€â”€ core_modules/
â”‚       â””â”€â”€ l2_semantic_analysis_two_layer.py  # AIåˆ†ææ¨¡å—
â”œâ”€â”€ scoring_results/
â”‚   â”œâ”€â”€ detailed/                         # è¯¦ç»†æ‰“åˆ†æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ detailed_score_*.json
â”‚   â””â”€â”€ comprehensive/                    # ç»¼åˆæ‰“åˆ†æ–‡ä»¶
â”‚       â””â”€â”€ comprehensive_score_*.json
â””â”€â”€ docs/specifications/
    â””â”€â”€ 06-ç»¼åˆé›†æˆæ‰“åˆ†ç®—æ³•è§„èŒƒ.md        # æœ¬æ–‡æ¡£
```

### 7.2 APIæ¥å£

```python
# è¯¦ç»†æ‰“åˆ†æ¥å£
POST /api/scoring/detailed
{
    "source_file": "simplified_comparison_20250908.json",
    "use_ai": true,
    "cache_enabled": true
}

# ç»¼åˆæ±‡æ€»æ¥å£
POST /api/scoring/comprehensive
{
    "detailed_files": ["detailed_score_1.json", "detailed_score_2.json"],
    "week": "2025_W36"
}
```

### 7.3 é›†æˆæµç¨‹

```bash
# Step 1: å¤„ç†ç®€åŒ–å¯¹æ¯”æ–‡ä»¶ï¼Œç”Ÿæˆè¯¦ç»†æ‰“åˆ†
python3 integrated_scorer.py \
    --input /root/projects/tencent-doc-manager/comparison_results/simplified_*.json \
    --output-dir /root/projects/tencent-doc-manager/scoring_results/detailed/

# Step 2: æ±‡æ€»è¯¦ç»†æ‰“åˆ†ï¼Œç”Ÿæˆç»¼åˆæŠ¥å‘Š
python3 comprehensive_aggregator.py \
    --input-dir /root/projects/tencent-doc-manager/scoring_results/detailed/ \
    --week W36 \
    --output /root/projects/tencent-doc-manager/csv_security_results/

# Step 3: å¯é€‰ - ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Š
python3 scoring_visualizer.py \
    --comprehensive /root/projects/tencent-doc-manager/csv_security_results/latest_comprehensive.json \
    --output /reports/scoring_report.html
```

---

## 9. é”™è¯¯å¤„ç†ç­–ç•¥ï¼ˆæ— é™çº§ï¼‰

### 9.1 å¼ºåˆ¶å¤±è´¥åŸåˆ™

**é‡è¦**: ç³»ç»Ÿä¸å…è®¸ä»»ä½•é™çº§ã€å¤‡ç”¨æˆ–ç®€åŒ–æ–¹æ³•ã€‚å½“å¿…è¦æœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œç³»ç»Ÿå¿…é¡»å¤±è´¥å¹¶æ˜ç¡®æŠ¥é”™ã€‚

### 9.2 å¼‚å¸¸å¤„ç†

```python
class ScoringException(Exception):
    """æ‰“åˆ†å¼‚å¸¸åŸºç±»"""
    pass

class AIServiceRequiredException(ScoringException):
    """AIæœåŠ¡å¿…éœ€ä½†ä¸å¯ç”¨"""
    pass

class DataFormatException(ScoringException):
    """æ•°æ®æ ¼å¼å¼‚å¸¸"""
    pass

def strict_score_calculation(modification):
    """ä¸¥æ ¼çš„æ‰“åˆ†è®¡ç®— - å¼ºåˆ¶é˜ˆå€¼ï¼Œæ— é™çº§"""
    column_level = get_column_level(modification['column_name'])
    
    # L1åˆ—å¼ºåˆ¶æœ€ä½0.8åˆ†
    if column_level == 'L1':
        base_score = calculate_rule_based_score(modification)
        if base_score > 0:  # æœ‰ä»»ä½•å˜æ›´
            return max(0.8, base_score)  # å¼ºåˆ¶æœ€ä½0.8
        return 0.0
    
    # L2åˆ—å¼ºåˆ¶æœ€ä½0.6åˆ†ï¼Œå¿…é¡»ä½¿ç”¨AI
    elif column_level == 'L2':
        if not ai_service_available():
            raise AIServiceRequiredException(
                f"L2åˆ— '{modification['column_name']}' å¿…é¡»ä½¿ç”¨AIåˆ†æï¼Œ"
                f"ä½†AIæœåŠ¡ä¸å¯ç”¨ã€‚è¯·æ£€æŸ¥APIé…ç½®ã€‚"
            )
        base_score = calculate_l2_score_with_ai(modification)
        if base_score > 0:  # æœ‰ä»»ä½•å˜æ›´
            return max(0.6, base_score)  # å¼ºåˆ¶æœ€ä½0.6
        return 0.0
    
    # L3ä½¿ç”¨è§„åˆ™
    elif column_level == 'L3':
        return calculate_rule_based_score(modification)
    
    else:
        raise DataFormatException(f"æœªçŸ¥çš„åˆ—çº§åˆ«: {column_level}")
```

---

## 9. ç›‘æ§ä¸è°ƒä¼˜

### 9.1 å…³é”®ç›‘æ§æŒ‡æ ‡

```python
MONITORING_METRICS = {
    'scoring_latency': {          # æ‰“åˆ†å»¶è¿Ÿ
        'p50': 0.5,                # ç§’
        'p95': 1.5,
        'p99': 3.0
    },
    'ai_usage': {                  # AIä½¿ç”¨ç‡
        'l2_columns': 0.33,        # L2åˆ—å æ¯”
        'layer1_pass_rate': 0.67,  # ç¬¬ä¸€å±‚é€šè¿‡ç‡
        'token_per_day': 43100     # æ—¥Tokenæ¶ˆè€—
    },
    'accuracy': {                  # å‡†ç¡®æ€§
        'false_positive_rate': 0.05,
        'false_negative_rate': 0.08,
        'precision': 0.92
    }
}
```

### 9.2 è‡ªåŠ¨è°ƒä¼˜æœºåˆ¶

```python
class AutoTuner:
    """è‡ªåŠ¨å‚æ•°è°ƒä¼˜å™¨"""
    
    def __init__(self):
        self.history = []
        self.current_params = DEFAULT_PARAMS.copy()
    
    def collect_feedback(self, prediction, actual):
        """æ”¶é›†åé¦ˆæ•°æ®"""
        self.history.append({
            'prediction': prediction,
            'actual': actual,
            'params': self.current_params.copy(),
            'timestamp': time.time()
        })
    
    def auto_tune(self):
        """åŸºäºå†å²æ•°æ®è‡ªåŠ¨è°ƒä¼˜"""
        if len(self.history) < 100:
            return
        
        # è®¡ç®—å½“å‰å‡†ç¡®ç‡
        accuracy = self.calculate_accuracy()
        
        if accuracy < 0.85:
            # éœ€è¦è°ƒä¼˜
            self.adjust_parameters()
            logger.info(f"å‚æ•°å·²è‡ªåŠ¨è°ƒä¼˜ï¼Œæ–°å‡†ç¡®ç‡ç›®æ ‡: {accuracy + 0.05}")
```

---

## 10. æœªæ¥æ‰©å±•è®¡åˆ’

### 10.1 çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰
- [ ] å®ç°å¢é‡æ‰“åˆ†ï¼Œåªå¤„ç†å˜åŒ–éƒ¨åˆ†
- [ ] æ·»åŠ æ‰“åˆ†ç»“æœçš„å¯è§†åŒ–ä»ªè¡¨æ¿
- [ ] ä¼˜åŒ–ç¼“å­˜ç­–ç•¥ï¼Œæé«˜å‘½ä¸­ç‡åˆ°60%

### 10.2 ä¸­æœŸå¢å¼ºï¼ˆ1ä¸ªæœˆï¼‰
- [ ] å¼•å…¥æœºå™¨å­¦ä¹ æ¨¡å‹æ›¿ä»£éƒ¨åˆ†è§„åˆ™
- [ ] å®ç°è·¨å‘¨æœŸçš„è¶‹åŠ¿åˆ†æ
- [ ] æ·»åŠ è‡ªå®šä¹‰è§„åˆ™é…ç½®ç•Œé¢

### 10.3 é•¿æœŸæ¼”è¿›ï¼ˆ3ä¸ªæœˆï¼‰
- [ ] å®Œå…¨è‡ªé€‚åº”çš„æ‰“åˆ†ç³»ç»Ÿ
- [ ] å®æ—¶æµå¼å¤„ç†æ¶æ„
- [ ] å¤šæ¨¡å‹é›†æˆæŠ•ç¥¨æœºåˆ¶

---

## é™„å½•Aï¼šå¿«é€Ÿå‚è€ƒ

### æ ¸å¿ƒå…¬å¼
```
ç»¼åˆå¾—åˆ† = åŸºç¡€åˆ† Ã— å˜æ›´ç³»æ•° Ã— é‡è¦æ€§æƒé‡ Ã— AIè°ƒæ•´ Ã— ç½®ä¿¡åº¦åŠ æƒ
```

### L1/L2/L3è¯„åˆ†æ ‡å‡†
- L1 = æœ€ä½0.8ï¼Œæœ€é«˜1.0ï¼ˆå¼ºåˆ¶çº¢è‰²è­¦å‘Šï¼‰
- L2 = æœ€ä½0.6ï¼Œæœ€é«˜1.0ï¼ˆå¼ºåˆ¶æ©™è‰²è­¦å‘Šï¼‰
- L3 = 0.2-1.0ï¼ˆæ ¹æ®å˜æ›´ç¨‹åº¦ï¼‰

### AIå†³ç­–ç³»æ•°
- APPROVE = 0.6
- CONDITIONAL = 0.8
- REVIEW = 1.2
- REJECT = 1.5

### é£é™©ç­‰çº§
- ğŸ”´ 0.80-1.00 æé«˜é£é™©
- ğŸŸ  0.60-0.80 é«˜é£é™©
- ğŸŸ¡ 0.40-0.60 ä¸­é£é™©
- ğŸŸ¢ 0.20-0.40 ä½é£é™©
- ğŸ”µ 0.00-0.20 æä½é£é™©

---

## é™„å½•Bï¼šå®æ–½æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰æ£€æŸ¥
- [ ] L2è¯­ä¹‰åˆ†ææœåŠ¡æ­£å¸¸è¿è¡Œï¼ˆ8098ç«¯å£ï¼‰
- [ ] è¯¦ç»†æ‰“åˆ†è¾“å‡ºç›®å½•å·²åˆ›å»º
- [ ] ç»¼åˆæ±‡æ€»è¾“å‡ºç›®å½•å·²åˆ›å»º
- [ ] ç¼“å­˜ç›®å½•æƒé™æ­£ç¡®
- [ ] APIå¯†é’¥é…ç½®å®Œæˆ

### åŠŸèƒ½éªŒè¯
- [ ] L1åˆ—çº¯è§„åˆ™æ‰“åˆ†æ­£ç¡®
- [ ] L2åˆ—AIä¸¤å±‚åˆ†ææ­£å¸¸
- [ ] L3åˆ—çº¯è§„åˆ™æ‰“åˆ†æ­£ç¡®
- [ ] è¯¦ç»†æ‰“åˆ†æ–‡ä»¶ç”Ÿæˆ
- [ ] ç»¼åˆæ±‡æ€»æ–‡ä»¶ç”Ÿæˆ
- [ ] ç¼“å­˜æœºåˆ¶å·¥ä½œæ­£å¸¸
- [ ] é™çº§ç­–ç•¥å¯ç”¨

### æ€§èƒ½åŸºå‡†
- [ ] å•è¡¨å¤„ç†æ—¶é—´ < 2ç§’
- [ ] å†…å­˜å ç”¨ < 100MB
- [ ] Tokenæ¶ˆè€—ç¬¦åˆé¢„æœŸ
- [ ] ç¼“å­˜å‘½ä¸­ç‡ > 30%

---

## é™„å½•Cï¼šæ•…éšœæ’æŸ¥æŒ‡å—

### å¸¸è§é—®é¢˜

| é—®é¢˜ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|---------|----------|
| æ‰“åˆ†ç»“æœå…¨æ˜¯0.5 | AIæœåŠ¡å¼‚å¸¸+é™çº§å¤±è´¥ | æ£€æŸ¥é™çº§ç­–ç•¥é…ç½® |
| Tokenæ¶ˆè€—è¿‡é«˜ | L2åˆ—æ¯”ä¾‹å¼‚å¸¸ | æ£€æŸ¥åˆ—åˆ†ç±»é…ç½® |
| å¤„ç†é€Ÿåº¦æ…¢ | ç¼“å­˜æœªç”Ÿæ•ˆ | æ£€æŸ¥ç¼“å­˜ç›®å½•æƒé™ |
| ç»¼åˆæ±‡æ€»ä¸å‡†ç¡® | è¯¦ç»†æ–‡ä»¶ç¼ºå¤± | ç¡®ä¿æ‰€æœ‰è¡¨éƒ½æœ‰è¯¦ç»†æ‰“åˆ† |

### æ—¥å¿—ä½ç½®
```
/var/log/scoring_engine/
â”œâ”€â”€ detailed_scorer.log      # è¯¦ç»†æ‰“åˆ†æ—¥å¿—
â”œâ”€â”€ aggregator.log           # æ±‡æ€»å™¨æ—¥å¿—
â”œâ”€â”€ ai_analysis.log          # AIåˆ†ææ—¥å¿—
â””â”€â”€ performance.log          # æ€§èƒ½ç›‘æ§æ—¥å¿—
```

---

## 9. ç»¼åˆè¯„åˆ†æ•°æ®æ ¼å¼è§„æ ¼ï¼ˆä»13å·æ–‡æ¡£åˆå¹¶ï¼‰

### 9.1 æ”¯æŒçš„æ•°æ®æ ¼å¼

ç³»ç»Ÿæ”¯æŒä¸¤ç§æ•°æ®æ ¼å¼ï¼š
1. **heat_values æ ¼å¼**: ç®€åŒ–çš„æ•°ç»„æ ¼å¼ï¼ˆå‘åå…¼å®¹ï¼‰
2. **ui_data æ ¼å¼**: å¢å¼ºçš„UIæ•°æ®æ ¼å¼ï¼ˆå½“å‰ä¸»è¦ä½¿ç”¨ï¼‰

### 9.2 ui_data æ ¼å¼è§„èŒƒï¼ˆä¸»è¦ä½¿ç”¨ï¼‰

```json
{
  "ui_data": [
    {
      "table_name": "å‡ºå›½é”€å”®è®¡åˆ’è¡¨",
      "heat_values": [0.8, 0.6, 0.4, ...],  // 19ä¸ªå€¼
      "row_data": [
        {
          "column": "ä»»åŠ¡å‘èµ·æ—¶é—´",
          "heat_value": 0.8,
          "color": "#FF0000",
          "modified_rows": [7, 15, 23]
        }
      ]
    }
  ]
}
```

### 9.3 æ•°æ®éªŒè¯è§„åˆ™

- **heat_values**: å¿…é¡»æ°å¥½19ä¸ªå…ƒç´ ï¼Œå€¼åŸŸ[0.0, 1.0]
- **é¢œè‰²æ˜ å°„**:
  - 0.8-1.0 â†’ çº¢è‰² (#FF0000)
  - 0.6-0.8 â†’ æ©™è‰² (#FFA500)
  - 0.4-0.6 â†’ é»„è‰² (#FFFF00)
  - 0.1-0.4 â†’ ç»¿è‰² (#00FF00)
  - 0.0-0.1 â†’ è“è‰² (#0000FF)

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Claude
**åˆ›å»ºæ—¥æœŸ**: 2025-09-08
**æœ€åæ›´æ–°**: 2025-09-15ï¼ˆåˆå¹¶13å·æ–‡æ¡£å†…å®¹ï¼‰
**è”ç³»æ–¹å¼**: é€šè¿‡8098æœåŠ¡Webç•Œé¢åé¦ˆ

*æœ¬è§„èŒƒä¸ºL1/L2/L3è§„åˆ™æ‰“åˆ†ä¸AIè¯­ä¹‰åˆ†æçš„ç»¼åˆé›†æˆæ ‡å‡†ï¼Œç¡®ä¿æ™ºèƒ½ä¸æ•ˆç‡çš„å®Œç¾å¹³è¡¡ã€‚*