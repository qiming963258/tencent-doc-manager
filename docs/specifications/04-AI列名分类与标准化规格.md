# 📊 AI列名分类与标准化技术规格

**文档版本**: v1.0  
**创建时间**: 2025-09-05  
**最后更新**: 2025-09-05  
**适用范围**: 腾讯文档智能监控系统 - CSV列名标准化模块

---

## 🎯 规格总览

### 核心功能
将CSV对比结果中的任意列名通过AI智能映射到19个预定义标准列名，处理列数不匹配情况，输出严格的19列标准格式。

### 关键特性
- **智能映射**: 自动识别列名变异形式并映射到标准列名
- **高效过滤**: 只处理有实际修改的列（修改值≠0）
- **序号系统**: 英文字母序号（A、B、C...）确保映射准确性
- **缺失处理**: 识别缺失的标准列并标记为空白
- **过滤机制**: 丢弃无法映射的多余列
- **单次会话**: 无需上下文记忆，一个提示词完成全部映射
- **19列保证**: 输出始终包含完整的19个标准列

### 🔄 优化工作流程
```
CSV对比结果 → 提取修改列(≠0) → 去重+序号化(A,B,C...) → AI标准化
     ↓                                                      ↓
生成标准CSV ← 根据序号回写 ← 保持序号映射 ← AI返回映射
```

---

## 📋 19个标准列名定义

### 标准列名列表（固定顺序）
```json
[
  "序号",           // L3级 - 可自由编辑
  "项目类型",       // L2级 - 需要审核
  "来源",           // L1级 - 禁止修改
  "任务发起时间",   // L1级 - 禁止修改
  "目标对齐",       // L1级 - 禁止修改
  "关键KR对齐",     // L1级 - 禁止修改
  "具体计划内容",   // L2级 - 需要审核
  "邓总指导登记",   // L2级 - 需要审核
  "负责人",         // L2级 - 需要审核
  "协助人",         // L2级 - 需要审核
  "监督人",         // L2级 - 需要审核
  "重要程度",       // L1级 - 禁止修改
  "预计完成时间",   // L1级 - 禁止修改
  "完成进度",       // L1级 - 禁止修改
  "完成链接",       // L3级 - 可自由编辑
  "经理分析复盘",   // L3级 - 可自由编辑
  "最新复盘时间",   // L3级 - 可自由编辑
  "对上汇报",       // L3级 - 可自由编辑
  "应用情况"        // L3级 - 可自由编辑
]
```

### 风险等级分类
| 等级 | 含义 | 包含列名 | 处理策略 |
|------|------|----------|----------|
| **L1** | 绝对不能修改 | 来源、任务发起时间、目标对齐、关键KR对齐、重要程度、预计完成时间、完成进度 | 任何修改都需要最高权限审批 |
| **L2** | 需要语义审核 | 项目类型、具体计划内容、邓总指导登记、负责人、协助人、监督人 | AI语义分析后决定是否批准 |
| **L3** | 可自由编辑 | 序号、完成链接、经理分析复盘、最新复盘时间、对上汇报、应用情况 | 自动通过，记录变更日志 |

---

## 🔄 列名变异模式库

### 常见变异映射表
```javascript
{
  "序号": ["序列号", "编号", "ID", "索引", "NO", "No.", "行号"],
  "项目类型": ["项目类别", "项目分类", "类型", "类别", "项目种类"],
  "来源": ["数据来源", "信息来源", "来源渠道", "源头"],
  "任务发起时间": ["发起时间", "任务时间", "开始时间", "创建时间", "发起日期"],
  "目标对齐": ["目标", "对齐目标", "业务目标", "战略对齐"],
  "关键KR对齐": ["KR", "关键结果", "KR对齐", "关键指标"],
  "具体计划内容": ["计划内容", "计划", "内容", "具体内容", "任务内容", "工作内容"],
  "邓总指导登记": ["邓总指导", "领导指导", "指导登记", "上级指导"],
  "负责人": ["责任人", "主负责人", "负责人员", "执行人"],
  "协助人": ["协助人员", "协同人", "配合人", "助理"],
  "监督人": ["监督人员", "监管人", "督导人", "检查人"],
  "重要程度": ["重要性", "优先级", "重要等级", "紧急程度"],
  "预计完成时间": ["完成时间", "截止时间", "预计时间", "结束时间", "deadline"],
  "完成进度": ["进度", "完成度", "进展", "完成百分比", "进度百分比"],
  "完成链接": ["形成计划清单", "计划清单", "清单", "任务清单", "工作清单", "链接"],
  "经理分析复盘": ["进度分析总结", "进度分析", "总结", "分析总结", "进展总结", "情况总结"],
  "最新复盘时间": ["复盘时间", "复盘日期", "回顾时间", "总结时间", "评审时间"],
  "对上汇报": ["汇报", "向上汇报", "上报", "报告"],
  "应用情况": ["应用", "使用情况", "实施情况", "执行情况"]
}
```

---

## 🤖 AI提示词设计

### 📍 CSV标准对比参数文件位置
```
项目根目录: /root/projects/tencent-doc-manager/
对比结果目录: ./compare_results/
文件命名格式: comparison_result_[timestamp].csv

完整路径示例:
/root/projects/tencent-doc-manager/compare_results/comparison_result_20250905_120000.csv
```

### 1. 完整优化提示词V3（支持超19列智能筛选）

```python
def build_smart_standardization_prompt_v3(actual_columns, csv_file_path=None):
    """
    构建V3版本提示词，支持超19列智能筛选
    适配简化CSV格式输入
    """
    
    # 标准列名定义
    standard_columns = [
        "序号", "项目类型", "来源", "任务发起时间", "目标对齐",
        "关键KR对齐", "具体计划内容", "邓总指导登记", "负责人",
        "协助人", "监督人", "重要程度", "预计完成时间", "完成进度",
        "完成链接", "最新复盘时间", "对上汇报", "应用情况", "经理分析复盘"
    ]
    
    # 根据列数情况选择策略
    column_count = len(actual_columns)
    if column_count < 19:
        strategy = "少列策略：识别缺失的标准列，自动标记为空白"
    elif column_count > 19:
        strategy = "多列策略：智能选择最符合标准的19项，舍弃其余"
    else:
        strategy = "等列策略：优化一对一映射"
    
    prompt = f"""
你是一个专业的CSV列名标准化专家，精通数据映射和语义理解。

## 🎯 核心任务
分析CSV表格的列名，将其智能映射到19个预定义的标准列名。必须输出完整的19列标准格式。

## 📋 19个标准列名（固定顺序，必须全部包含）
{json.dumps(standard_columns, ensure_ascii=False, indent=2)}

## 📊 当前CSV文件信息
- 文件路径: {csv_file_path or '未指定'}
- 实际列数: {column_count}个
- 标准列数: 19个
- 处理策略: {strategy}

## 📝 实际列名（共{column_count}个）
{json.dumps(actual_columns, ensure_ascii=False, indent=2)}

## 🔄 智能映射规则
1. **精确匹配优先**: 完全相同的列名直接映射（置信度1.0）
2. **变异识别**: 识别常见变异形式（如"编号"→"序号"，置信度0.8-0.95）
3. **语义理解**: 基于语义相似度映射（如"执行人"→"负责人"，置信度0.6-0.79）
4. **位置推测**: 根据列的位置关系推测（置信度0.4-0.59）

## 🎯 特殊处理逻辑
{"### 少列情况处理（当前状态）" if column_count < 19 else ""}
{"- 识别哪些标准列没有对应的实际列" if column_count < 19 else ""}
{"- 缺失的标准列在输出中标记为null" if column_count < 19 else ""}
{"- 在missing_standard_columns数组中列出所有缺失列" if column_count < 19 else ""}

{"### 多列情况处理（当前状态）" if column_count > 19 else ""}
{"- 为每个标准列选择最佳匹配的实际列" if column_count > 19 else ""}
{"- 当多个实际列可映射到同一标准列时，选择置信度最高的" if column_count > 19 else ""}
{"- 无法映射的多余列放入discarded_columns数组" if column_count > 19 else ""}
{"- 被丢弃的列数据不会出现在最终输出中" if column_count > 19 else ""}

## 📊 输出格式要求（严格JSON）
{{
    "success": true,
    "standard_columns_status": {{
        "序号": "映射的实际列名或null",
        "项目类型": "映射的实际列名或null",
        "来源": "映射的实际列名或null",
        "任务发起时间": "映射的实际列名或null",
        "目标对齐": "映射的实际列名或null",
        "关键KR对齐": "映射的实际列名或null",
        "具体计划内容": "映射的实际列名或null",
        "邓总指导登记": "映射的实际列名或null",
        "负责人": "映射的实际列名或null",
        "协助人": "映射的实际列名或null",
        "监督人": "映射的实际列名或null",
        "重要程度": "映射的实际列名或null",
        "预计完成时间": "映射的实际列名或null",
        "完成进度": "映射的实际列名或null",
        "完成链接": "映射的实际列名或null",
        "最新复盘时间": "映射的实际列名或null",
        "对上汇报": "映射的实际列名或null",
        "应用情况": "映射的实际列名或null",
        "经理分析复盘": "映射的实际列名或null"
    }},
    "mapping": {{
        // 实际列名到标准列名的映射关系
    }},
    "confidence_scores": {{
        // 每个映射的置信度（0.0-1.0）
    }},
    "missing_standard_columns": [
        // 缺失的标准列名列表
    ],
    "discarded_columns": [
        // 被丢弃的多余实际列名列表
    ],
    "statistics": {{
        "mapped_count": 0,      // 成功映射的列数
        "missing_count": 0,     // 缺失的标准列数
        "discarded_count": 0    // 被丢弃的实际列数
    }}
}}

## ⚠️ 关键约束
1. standard_columns_status必须包含全部19个标准列，顺序固定
2. 每个标准列只能映射一个实际列（或null）
3. 缺失的标准列必须明确标记为null
4. 返回纯JSON格式，不要包含其他解释文字

请立即分析并返回标准化映射结果。
"""
    return prompt
```

### 2. CSV对比结果专用提示词

```python
def build_csv_comparison_prompt(csv_comparison_file):
    """
    专门处理CSV对比结果文件的提示词
    输入：CSV对比结果文件路径
    输出：标准化的19列对比结果
    """
    prompt = f"""
分析CSV对比结果文件并标准化为19列格式。

## 输入文件
路径: {csv_comparison_file}
类型: CSV对比差异文件

## 任务目标
1. 读取CSV文件的列名
2. 将所有列名标准化为19个标准列名
3. 重组数据为严格的19列格式
4. 标记缺失列和多余列

## 处理流程
1. 提取CSV文件的所有列名
2. 应用智能映射算法
3. 生成19列标准化输出
4. 保留原始数据但按标准列重新组织

## 输出文件格式
输出路径: {csv_comparison_file.replace('.csv', '_standardized.csv')}
格式: 严格19列的标准CSV
内容: 
- 第1行：19个标准列名
- 第2行起：标准化后的数据
- 缺失列填充：空字符串
- 多余列处理：完全丢弃

请处理文件并返回标准化结果。
"""
    return prompt
```

### 3. 序号映射系统提示词

```python
def build_numbered_mapping_prompt(modified_columns: List[str]) -> str:
    """
    构建序号映射提示词
    只处理有修改的列，提高效率
    """
    # 1. 过滤有修改的列（修改值≠0）
    modified_columns = filter_modified_columns(comparison_result)
    
    # 2. 去重并排序
    unique_columns = sorted(set(modified_columns))
    
    # 3. 添加英文字母序号
    labeled_columns = {}
    for i, col in enumerate(unique_columns):
        if i < 26:
            label = chr(65 + i)  # A-Z
        else:
            # AA, AB, AC...
            first = (i - 26) // 26
            second = (i - 26) % 26
            label = chr(65 + first) + chr(65 + second)
        labeled_columns[label] = col
    
    prompt = f"""
## 输入列（只包含有修改的列）
{format_labeled_columns(labeled_columns)}

## 任务
保持序号不变，只标准化列名部分

## 输出格式
{{
    "numbered_mapping": {{
        "A": "标准列名",
        "B": "标准列名",
        // 保持所有序号
    }}
}}
"""
    return prompt
```

### 4. 映射置信度评分规则

| 匹配类型 | 置信度范围 | 说明 |
|----------|------------|------|
| 精确匹配 | 1.0 | 列名完全相同 |
| 变异匹配 | 0.8-0.95 | 已知变异形式 |
| 语义匹配 | 0.6-0.79 | 基于语义相似度 |
| 位置匹配 | 0.4-0.59 | 基于列位置推测 |
| 强制匹配 | 0.2-0.39 | 相似度很低但强制选择最接近的 |

---

## 📊 列数不匹配处理策略

### 情况1：实际列少于19个（缺列处理）

**处理流程**：
1. 识别能够映射到标准列的实际列
2. 确定哪些标准列没有对应的实际列
3. 在输出中将缺失的标准列标记为`null`
4. 在`missing_standard_columns`数组中列出所有缺失的标准列名

**示例**：
```json
{
  "standard_columns_status": {
    "序号": "ID",
    "项目类型": "项目类别",
    "来源": null,           // 缺失
    "任务发起时间": null,   // 缺失
    // ... 其他15个标准列
  },
  "missing_standard_columns": ["来源", "任务发起时间"],
  "mapped_count": 17,
  "missing_count": 2
}
```

### 情况2：实际列多于19个（智能筛选策略）

**V3版本智能筛选流程**：
1. **优先级排序**（按重要性递减）：
   - 优先级1：完全匹配标准列名（置信度1.0）
   - 优先级2：高相似度变异（置信度0.8-0.95）
   - 优先级3：语义相关列（置信度0.6-0.79）
   - 优先级4：L1级别重要列（关键业务字段）
   - 优先级5：L2级别次要列（需审核字段）

2. **筛选算法**：
   - 计算每个实际列与19个标准列的相似度
   - 按置信度排序，选择前19个最佳匹配
   - 确保每个标准列最多映射一个实际列
   - 被筛选掉的列记录原因（相似度低/已有更好映射）

3. **处理原则**：
   - 保留最有价值的业务信息
   - 优先保证核心字段的完整性
   - 将筛选决策透明化，便于审计

**示例**：
```json
{
  "standard_columns_status": {
    // 19个标准列的映射
  },
  "discarded_columns": ["额外字段1", "测试列2", "临时数据"],
  "mapped_count": 19,
  "discarded_count": 3
}
```

### 情况3：实际列等于19个

**处理流程**：
1. 尽可能进行一对一映射
2. 处理可能的重复映射（多个实际列映射到同一标准列）
3. 优先选择置信度更高的映射

---

## 🔧 技术实现

### 核心类：ColumnStandardizationPrompt

```python
class ColumnStandardizationPrompt:
    """列名标准化提示词生成器"""
    
    def __init__(self):
        self.standard_columns = [19个标准列名]
        self.risk_levels = {风险等级分类}
        self.variation_patterns = {变异模式库}
    
    def build_single_session_prompt(self, actual_columns: List[str]) -> str:
        """构建单次会话提示词"""
        
    def build_csv_comparison_standardization_prompt(self, csv_comparison_result: Dict) -> str:
        """专门为CSV对比结果构建的标准化提示词"""
        
    def process_standardization_result(self, ai_response: Dict, original_comparison: Dict) -> Dict:
        """处理AI返回的标准化结果，生成最终的19列对比输出"""
```

### 使用流程

```python
# 1. 初始化提示词生成器
prompt_gen = ColumnStandardizationPrompt()

# 2. 从CSV对比结果提取列名
actual_columns = extract_columns_from_comparison(csv_comparison_result)

# 3. 生成提示词
prompt = prompt_gen.build_single_session_prompt(actual_columns)

# 4. 调用Claude API
response = await claude_client.analyze({
    "content": prompt,
    "temperature": 0.1,  # 低温度确保一致性
    "max_tokens": 2000
})

# 5. 处理标准化结果
standardized_output = prompt_gen.process_standardization_result(
    response,
    csv_comparison_result
)
```

---

## 📈 输出格式规范

### 标准化输出结构

```json
{
  "metadata": {
    "standard_columns": [19个标准列名],
    "original_columns": [原始列名列表],
    "mapping": {标准列到实际列的映射},
    "timestamp": "2025-09-05T12:00:00"
  },
  "summary": {
    "total_differences": 45,
    "mapped_columns": 15,
    "missing_columns": 4,
    "discarded_columns": 3
  },
  "standardized_differences": [
    {
      "row_number": 3,
      "序号": {
        "baseline_value": "1",
        "target_value": "1",
        "changed": false
      },
      "项目类型": {
        "baseline_value": "A",
        "target_value": "B",
        "changed": true
      },
      "来源": null,  // 缺失列
      // ... 其余16个标准列
    }
  ],
  "quality_metrics": {
    "coverage_rate": 0.79,  // 15/19
    "data_loss_rate": 0.14, // 3/22
    "confidence_average": 0.85
  }
}
```

### 关键约束
1. `standardized_differences`中每行必须包含全部19个字段
2. 字段顺序必须与标准列名顺序完全一致
3. 缺失的标准列统一使用`null`值
4. 被丢弃的实际列数据不出现在输出中

---

## 🚀 性能指标

### 目标性能
| 指标 | 目标值 | 说明 |
|------|--------|------|
| **映射准确率** | ≥ 90% | 正确映射的列数占比 |
| **处理速度** | < 3秒 | 单次API调用响应时间 |
| **精确匹配率** | 40-50% | 列名完全一致的比例 |
| **变异识别率** | 30-40% | 识别已知变异的比例 |
| **语义匹配率** | 15-20% | 通过语义理解匹配的比例 |
| **总体成功率** | > 95% | 所有列名都能映射（包括强制映射） |

### 质量保证
- 使用低温度参数（0.1）确保输出一致性
- 实施结果验证确保JSON格式正确
- 缓存常见映射模式提高效率

---

## 🔍 故障排除

### 常见问题及解决方案

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 映射置信度过低 | 列名变异过大 | 增加变异模式库条目 |
| 多个列映射到同一标准列 | 实际列名相似 | 基于上下文选择最佳映射 |
| 标准列大量缺失 | 数据源不完整 | 在UI中明确标记缺失列 |
| JSON解析失败 | AI输出格式错误 | 增加格式验证和重试机制 |

### 调试建议
1. 记录所有映射决策的理由
2. 保存原始列名和映射关系
3. 监控置信度分布
4. 定期更新变异模式库

---

## 📝 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v1.0 | 2025-09-05 | 初始版本，包含完整的列名标准化和多列/少列处理策略 |

---

## 🔗 相关文档

- [03-列名标准化技术实现规范.md](./03-列名标准化技术实现规范.md)
- [03-CSV对比算法规范.md](./03-CSV对比算法规范.md)
- [05-AI语义分析集成规格.md](./05-AI语义分析集成规格.md)

---

**维护团队**: AI集成开发组  
**技术支持**: 通过项目Issue追踪系统  
**下一版本计划**: 
- 增加更多列名变异模式
- 优化映射算法提高准确率
- 实现批量处理能力