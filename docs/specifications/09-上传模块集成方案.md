# 腾讯文档上传模块集成方案

## ⚠️ 重要更新（2025-09-20）

**关键问题**：系统当前使用了临时修复版本而非生产级v3模块，导致返回错误链接。

**正确的模块使用和参数顺序**：
```python
# 推荐：使用生产级v3模块（95%+准确率）
from production.core_modules.tencent_doc_upload_production_v3 import sync_upload_v3

# 正确的参数顺序（cookie_string在前，file_path在后）
result = sync_upload_v3(cookie_string, file_path)

# 处理返回值（可能是dict）
if isinstance(result, dict):
    doc_url = result.get('url', result.get('doc_url', ''))
    success = result.get('success', False)
else:
    doc_url = result

# 避免：使用临时版本（返回错误链接）
# from tencent_doc_uploader import sync_upload_file  # ❌

# 避免：错误的参数顺序
# result = sync_upload_v3(file_path, cookie_string)  # ❌ 参数顺序错误
```

**参数说明**：
- `cookie_string` (str): 腾讯文档的认证Cookie字符串，必须是第一个参数
- `file_path` (str): 要上传的Excel文件的完整路径，第二个参数
- `headless` (bool, 可选): 是否无头模式运行，默认True

## 📋 概述

本文档详细说明了上传模块如何集成到主流程中，实现从文件生成到自动上传、URL管理的完整链路。

---

## 🏗️ 系统架构

### 核心组件

```
┌─────────────────────────────────────────────────────────┐
│                    主工作流程 (8093)                      │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  1. CSV下载 ──> 2. 数据对比 ──> 3. Excel生成 ──> 4. 自动上传│
│       │              │              │              │      │
│       ▼              ▼              ▼              ▼      │
│  WeekTimeManager  Comparator   ExcelGenerator  UploadV3  │
│                                                          │
├─────────────────────────────────────────────────────────┤
│                    基础设施层                             │
│                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │Cookie Manager│  │ URL Manager  │  │File Manager  │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
```

---

## 🔑 关键设计决策

### 1. Cookie统一管理

**原则**：所有模块共享同一个Cookie源

```python
# 获取Cookie的统一方式（更新 2025-09-20）
# 方式1：从cookie_manager获取
from production.core_modules.cookie_manager import CookieManager

cookie_manager = CookieManager()
cookie = await cookie_manager.get_best_cookie()

# 方式2：从配置文件读取（推荐）
import json

with open('/root/projects/tencent-doc-manager/config/cookies.json', 'r') as f:
    cookies = json.load(f)

# 注意：字段名可能是'current_cookies'或'cookies'
cookie_str = cookies.get('current_cookies', cookies.get('cookies', ''))
```

**Cookie配置文件结构**：
```json
{
  "current_cookies": "fingerprint=xxx; DOC_SID=xxx; ...",  // 主要字段
  "cookies": "...",            // 备用字段（向后兼容）
  "last_update": "2025-09-20T13:31:37.123686",
  "is_valid": true,
  "validation_message": "✅ Cookie格式正确"
}
```

**优势**：
- ✅ 下载和上传使用相同Cookie
- ✅ 集中管理Cookie生命周期
- ✅ 自动处理Cookie刷新
- ✅ 兼容多种字段名格式

### 2. 文件命名规范（唯一标识）

**格式**：`tencent_{文档名}_{时间戳}_{版本类型}_W{周数}.{扩展名}`

**示例**：
```
tencent_副本-测试版本-出国销售计划表_20250910_120000_baseline_W36.csv
risk_analysis_report_20250910_120000.xlsx
```

**唯一性保证**：
- 时间戳精确到秒（YYYYmmdd_HHMMSS）
- 包含周数和版本类型
- 文档名+时间戳组合确保唯一

### 3. URL映射存储

**存储位置**：`/root/projects/tencent-doc-manager/data/upload_mappings.json`

**存储格式**：
```json
{
  "mappings": [
    {
      "file_path": "/full/path/to/file.xlsx",
      "file_name": "risk_analysis_report_20250910_120000.xlsx",
      "doc_url": "https://docs.qq.com/sheet/DWHJjWmZkTUZkcWpB",
      "upload_time": "2025-09-10 12:00:00",
      "doc_name": "risk_analysis_report",
      "week_number": "W36",
      "version_type": "midweek",
      "metadata": {
        "original_doc": "副本-测试版本-出国销售计划表",
        "file_size": 12345,
        "upload_method": "v3"
      }
    }
  ],
  "last_updated": "2025-09-10 12:00:00"
}
```

---

## 🔄 集成流程

### 主流程集成点

#### 1. Excel生成后自动上传

```python
# 在complete_workflow_ui.py中
async def generate_and_upload_excel(data):
    # 1. 生成Excel
    excel_file = await generate_excel_report(data)
    
    # 2. 自动上传
    if config.get('auto_upload'):
        from production.core_modules.workflow_integration import get_workflow_manager
        workflow = get_workflow_manager()
        
        doc_url = await workflow.process_upload(excel_file)
        
        # 3. 返回结果包含URL
        return {
            'file': excel_file,
            'url': doc_url,
            'success': True
        }
```

#### 2. 批量处理模式

```python
# 批量上传历史文件
async def batch_upload_historical_files():
    workflow = get_workflow_manager()
    
    # 查找未上传的文件
    patterns = ['risk_analysis_report_*.xlsx', 'tencent_*_final_W*.xlsx']
    
    for pattern in patterns:
        files = Path('excel_outputs').glob(pattern)
        for file in files:
            # 检查是否已上传
            if not workflow.get_upload_url_for_file(str(file)):
                await workflow.process_upload(str(file))
```

#### 3. URL查询接口

```python
# 通过文件查找对应URL
def get_document_url(file_path: str) -> Optional[str]:
    from production.core_modules.upload_url_manager import get_manager
    
    manager = get_manager()
    record = manager.get_by_file(file_path)
    
    return record.doc_url if record else None
```

---

## 📊 数据流

### 完整数据流程

```
1. 用户请求下载CSV
   ↓
2. WeekTimeManager生成标准文件名
   ↓
3. 下载CSV到标准路径
   ↓
4. 执行数据对比分析
   ↓
5. 生成Excel报告（标准命名）
   ↓
6. 自动触发上传（v3模块）
   ↓
7. 获取腾讯文档URL
   ↓
8. 存储文件-URL映射
   ↓
9. 返回完整结果给用户
```

---

## 🛠️ API接口

### 1. 上传文件

```python
POST /api/upload
{
    "file_path": "/path/to/file.xlsx",
    "auto_upload": true
}

Response:
{
    "success": true,
    "url": "https://docs.qq.com/sheet/xxx",
    "doc_name": "file",
    "message": "上传成功"
}
```

### 2. 查询URL

```python
GET /api/get-url?file_path=/path/to/file.xlsx

Response:
{
    "file_path": "/path/to/file.xlsx",
    "doc_url": "https://docs.qq.com/sheet/xxx",
    "upload_time": "2025-09-10 12:00:00"
}
```

### 3. 上传历史

```python
GET /api/upload-history?limit=10

Response:
{
    "history": [
        {
            "file_name": "risk_analysis_report_20250910.xlsx",
            "doc_url": "https://docs.qq.com/sheet/xxx",
            "upload_time": "2025-09-10 12:00:00"
        }
    ]
}
```

---

## 🎯 核心优势

### 1. 完全自动化
- 文件生成后自动上传
- 无需人工干预
- 支持批量处理

### 2. 可追溯性
- 每个文件都有唯一标识
- 完整的上传历史记录
- 文件与URL的精确映射

### 3. 容错机制
- 重复上传检测
- 失败重试
- 映射关系持久化

### 4. 灵活配置
- 可配置是否自动上传
- 支持批量/单个上传
- 上传延迟控制

### 5. URL常态显示技术 (2025-09-14更新)
- **自动加载存储的URL**: 使用React useEffect钩子在组件挂载时加载
- **正确的转义处理**: JavaScript中使用`\\n`转义序列而非实际换行符
- **实时同步显示**: 通过controlled component模式保持UI与存储同步

#### 技术实现细节：

```javascript
// 加载已存储的链接
const loadStoredLinks = async () => {
  try {
    const response = await fetch('/api/get-download-links');
    const result = await response.json();

    if (result.success && result.data && result.data.document_links) {
      const links = result.data.document_links;

      // 重要：使用\\n转义序列，避免JavaScript解析错误
      const linkText = links
        .filter(link => link.enabled !== false)
        .map(link => `【腾讯文档】${link.name}\\n${link.url}`)
        .join('\\n\\n');

      setTableLinks(linkText);  // 更新textarea显示
      setStoredUrls(links);     // 保存原始数据
    }
  } catch (error) {
    console.error('❌ 加载链接失败:', error);
  }
};

// 在组件挂载时自动加载
React.useEffect(() => {
  if (isOpen) {
    loadStoredLinks();  // 加载URL
    loadCookieConfig(); // 加载Cookie
    // ... 其他初始化
  }
}, [isOpen]);
```

#### 关键注意事项：
1. **转义序列处理**: Python三引号字符串中的`\\n`会传递为JavaScript中的`\n`
2. **Babel限制**: in-browser Babel转换器无法处理包含实际换行符的字符串字面量
3. **解析逻辑同步**: 确保split操作使用相同的转义序列`'\\n'`

---

## 📝 使用示例

### 示例1：主流程中集成

```python
# 在8093系统的主流程中
@app.route('/api/complete-workflow', methods=['POST'])
async def complete_workflow():
    # 1. 获取请求数据
    doc_urls = request.json.get('urls')
    
    # 2. 执行完整工作流
    workflow = get_workflow_manager()
    results = await workflow.run_complete_workflow(doc_urls)
    
    # 3. 返回结果（包含上传的URL）
    return jsonify(results)
```

### 示例2：单独上传文件

```python
# 单独上传一个文件
from production.core_modules.workflow_integration import get_workflow_manager

workflow = get_workflow_manager()
file_path = "excel_outputs/report.xlsx"
doc_url = await workflow.process_upload(file_path)

print(f"文件已上传到: {doc_url}")
```

### 示例3：查询历史URL

```python
# 查询某个文件的上传URL
from production.core_modules.upload_url_manager import get_manager

manager = get_manager()

# 通过文件名查询
record = manager.get_by_name("risk_analysis_report_20250910_120000.xlsx")
if record:
    print(f"文档URL: {record.doc_url}")
    print(f"上传时间: {record.upload_time}")

# 查询某周的所有上传
week_records = manager.get_by_week("W36")
for record in week_records:
    print(f"{record.file_name} -> {record.doc_url}")
```

---

## 🔧 配置文件

### workflow_config.json

```json
{
    "auto_upload": true,
    "upload_delay": 5,
    "batch_upload": false,
    "max_batch_size": 5,
    "preserve_local": true,
    "upload_patterns": [
        "risk_analysis_report_*.xlsx",
        "tencent_*_final_W*.xlsx",
        "comparison_report_*.xlsx"
    ]
}
```

---

## 📈 性能指标（2025-09-20更新）

| 指标 | 数值 | 备注 |
|------|------|------|
| 单文件上传耗时 | 20-30秒 | v3模块实测约25秒 |
| 批量上传速度 | 5个/分钟 | - |
| URL映射查询 | <1ms | - |
| 存储空间占用 | ~1KB/记录 | - |
| Cookie有效期 | 7-14天 | 实测结果，非24-48小时 |
| 链接准确率 | 95%+ | 使用v3模块 |

## 🔬 实际测试案例（2025-09-20）

### 成功案例：涂色Excel上传

**测试文件**：`tencent_111测试版本-小红书部门_20250919_2255_midweek_W38_colored.xlsx`
- 文件大小：47,085 bytes
- 涂色单元格：54个
- 上传耗时：约30秒

**上传过程日志**：
```
[01:21:52] ✅ 浏览器启动成功
[01:21:52] 🔐 开始Cookie登录...
[01:21:52] ✅ 已添加 28 个Cookies
[01:21:58] ✅ 登录成功！
[01:21:58] 📤 开始上传: tencent_111测试版本...
[01:22:01] ⏳ 等待上传完成...
[01:22:21] ✅ 导入对话框已关闭
[01:22:21] ✅ 通过文件名匹配找到文档: https://docs.qq.com/sheet/DWGxaRUpzVWxuVHVH
[01:22:21] ✅ 上传成功
```

**关键发现**：
1. Cookie解析需要正确处理28个cookie项
2. 参数顺序必须是(cookie_string, file_path)
3. 返回值可能是dict，需要提取url字段
4. 腾讯Excel需要先修复空fill标签才能涂色

---

## 🚀 未来优化

1. **并发上传**：支持多文件并发上传
2. **断点续传**：大文件断点续传支持
3. **版本管理**：同一文件多版本管理
4. **权限控制**：基于用户的上传权限
5. **审计日志**：完整的操作审计链

---

## 6. 基线文件管理规范 (2025-09-15更新)

### 功能概述
基线文件管理提供文档版本基准建立和维护功能，支持批量下载和软删除机制。

### 核心功能

#### 6.1 多行URL输入支持
支持与URL管理相同的多行批量输入格式：

```
【腾讯文档】文档名称1 https://docs.qq.com/sheet/xxx
【腾讯文档】文档名称2 https://docs.qq.com/sheet/yyy
https://docs.qq.com/sheet/zzz
```

**解析规则**：
- 自动识别【腾讯文档】格式的分享链接
- 提取文档名称和URL
- 支持纯URL格式（无名称）
- 忽略空行

#### 6.2 软删除机制
同名基线文件管理采用软删除策略：

**工作原理**：
1. 新文件下载时检查同名文件
2. 将旧文件移动到 `.deleted` 隐藏文件夹
3. 添加删除时间戳前缀：`deleted_YYYYMMDD_HHMMSS_原文件名`
4. 主目录只保留最新版本

**优势**：
- ✅ 防止文件丢失
- ✅ 支持历史追溯
- ✅ 避免重复混乱
- ✅ 软删除文件不被查找函数发现

#### 6.3 存储结构
```
csv_versions/
└── 2025_W{周数}/
    └── baseline/
        ├── tencent_{文档名}_{时间戳}_baseline_W{周数}.csv  # 当前基线
        └── .deleted/                                      # 软删除文件夹
            └── deleted_{删除时间}_{原文件名}.csv          # 历史版本
```

#### 6.4 API接口

**获取基线文件列表**
```http
GET /api/baseline-files?week={周数}
```

**下载基线文件**
```http
POST /api/baseline-files
{
    "url": "https://docs.qq.com/sheet/xxx",
    "cookie": "cookie_string",
    "week": 38
}
```

**删除基线文件**
```http
DELETE /api/baseline-files
{
    "filename": "tencent_xxx.csv"
}
```

### 测试验证结果
- ✅ 多行URL解析正常
- ✅ 软删除机制工作正常
- ✅ 文件命名规范符合要求
- ✅ 存储路径组织合理

---

## 📚 相关文档

- [07-腾讯文档上传技术规格.md](./07-腾讯文档上传技术规格.md)
- [02-时间管理和文件版本规格.md](./02-时间管理和文件版本规格.md)
- [系统功能组件完整清单.md](../系统功能组件完整清单.md)