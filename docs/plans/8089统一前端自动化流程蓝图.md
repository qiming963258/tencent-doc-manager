# 🎯 腾讯文档智能监控系统 - 8089统一前端自动化流程蓝图

> 图例：✅ 已实现并验证 | ⚠️ 部分实现 | ❌ 待实现 | 📄 相关文件 | 💡 功能说明

## 第一部分：系统架构与初始化

### ❌ 8089前端控制中心改造 [0%实现]
**📌 验证确认：8089仅为热力图展示，无控制功能（spec/00-系统实际架构说明.md）**
8089端口启动 (final_heatmap_server.py)  
↓ _[意义：统一入口，所有操作从这里开始]_  
Flask应用初始化  
↓ _[内容：加载Web框架，准备接收HTTP请求]_  
加载热力图渲染模块  
↓ _[用途：保留原有热力图功能作为结果展示]_  
**新增**：加载监控配置界面  
↓ _[位置：新增/static/monitor_config.html]_  
**新增**：初始化任务调度器  
↓ _[内容：APScheduler或Celery任务队列]_  
**新增**：建立WebSocket连接  
↓ _[用途：实时推送处理进度到前端]_  
监听8089端口  
↓ _[位置：http://202.140.143.88:8089]_  
**📄 需要创建：production/servers/unified_frontend_server.py**

### ❌ 配置输入界面 [0%实现]
用户访问 http://202.140.143.88:8089/monitor  
↓ _[意义：新的监控配置页面，不影响原热力图]_  
渲染配置表单页面  
↓ _[内容：文档列表输入、Cookie输入、定时设置]_  
```html
<div id="documentList">
  <table>
    <tr><th>文档名称</th><th>腾讯文档URL</th><th>操作</th></tr>
    <tr><td><input name="docName"></td><td><input name="docUrl"></td><td>删除</td></tr>
  </table>
  <button onclick="addDocument()">添加文档</button>
</div>
```  
↓ _[用途：批量管理多个腾讯文档]_  
Cookie输入框  
↓ _[位置：<textarea id="cookie">]_  
定时配置选项（立即执行/定时/周期）  
↓ _[内容：cron表达式或简单时间选择器]_  
**📄 需要创建：static/templates/monitor_config.html**

---

## 第二部分：任务调度与分发

### ❌ 主控制器流程 [0%实现]
用户点击"开始监控"按钮  
↓ _[意义：触发整个自动化流程的起点]_  
JavaScript收集表单数据  
↓ _[内容：{documents: [{name, url}], cookie, schedule}]_  
POST请求到 /api/start_monitoring  
↓ _[用途：提交配置到后端]_  
**📄 8089主控制器 (unified_frontend_server.py:startMonitoring)**  
↓ _[位置：新增的统一控制函数]_  
验证Cookie有效性  
↓ _[内容：测试请求docs.qq.com验证Cookie]_  
创建监控任务队列  
↓ _[用途：为每个文档创建处理任务]_  
```python
tasks = []
for doc in documents:
    task = {
        'id': generate_task_id(),
        'name': doc['name'],
        'url': doc['url'],
        'status': 'pending',
        'csv_task': None,
        'excel_task': None
    }
    tasks.append(task)
```  
↓ _[意义：构建任务管理数据结构]_  
**串行处理每个文档**  
↓ _[用途：避免并发下载触发反爬虫]_  
**📄 需要实现：TaskQueueManager类**

### ❌ 单文档处理调度器 [0%实现]
for task in tasks:  
↓ _[意义：串行遍历每个文档任务]_  
    更新任务状态: "processing"  
    ↓ _[内容：通知前端当前处理进度]_  
    WebSocket推送: {taskId, status: "开始处理"}  
    ↓ _[用途：实时更新前端显示]_  
    **并发创建两个子任务**  
    ↓ _[意义：CSV分析和Excel处理并行]_  
    ```python
    csv_future = executor.submit(process_csv_pipeline, task)
    excel_future = executor.submit(process_excel_pipeline, task)
    ```  
    ↓ _[内容：使用ThreadPoolExecutor并发执行]_  
    等待两个子任务完成  
    ↓ _[用途：确保当前文档处理完成再处理下一个]_  
    合并结果到task对象  
    ↓ _[位置：task['csv_result'], task['excel_result']]_  
    更新任务状态: "completed"  
    ↓ _[意义：标记单个文档处理完成]_  
**📄 需要实现：DocumentProcessor类**

---

## 第三部分：并发流程1 - CSV分析管道

### ✅ CSV下载流程 [95%实现]
**📌 验证确认：production有6个下载器模块**
- stable_cookie_downloader.py（稳定版Cookie管理）
- stability_enhanced_downloader.py（增强稳定性）
- production_downloader.py（生产下载）
- integrated_downloader.py（集成下载）
- tencent_export_automation.py（自动导出）
- auto_recovery_system.py（自动恢复）
process_csv_pipeline(task)函数开始  
↓ _[意义：CSV处理管道入口]_  
调用8093下载接口  
↓ _[内容：POST /api/download {url, cookie, format:'csv'}]_  
**📄 production_integrated_test_system_8093.py:download_document()**  
↓ _[位置：已实现的下载功能]_  
TencentDocAutoExporter.export_to_csv()  
↓ _[用途：将腾讯文档导出为CSV格式]_  
保存到 /downloads/{timestamp}_{name}.csv  
↓ _[内容：CSV文件持久化存储]_  
返回文件路径  
↓ _[意义：后续处理的输入]_  

### ✅ CSV版本对比流程 [85%实现]
**📌 验证确认：有完整对比模块实现**
- adaptive_table_comparator.py（自适应对比）
- production_csv_comparator.py（生产对比）
- auto_comparison_task.py（自动对比任务）
读取当前周基准版本  
↓ _[内容：WeekTimeManager.get_baseline_file()]_  
如果是周二首次下载  
↓ _[意义：判断是否需要创建新基准]_  
    保存为新基准版本  
    ↓ _[位置：/csv_versions/2025_W{week}/baseline/]_  
否则与基准版本对比  
↓ _[用途：检测文档变更]_  
调用8094对比接口  
↓ _[内容：POST /api/compare {baseline, target}]_  
**📄 production_integrated_test_system_8094.py:compare_files()**  
↓ _[位置：已实现的对比功能]_  
AdaptiveTableComparator.compare()  
↓ _[用途：自适应表格结构对比]_  
生成对比结果JSON  
↓ _[内容：{additions, deletions, modifications}]_  
保存到 /comparison_results/  
↓ _[意义：对比结果持久化]_  

### ⚠️ 列标准化处理流程 [75%实现]
**📌 验证确认：已有标准化模块但需集成**
- column_standardization_prompt.py（标准化提示）
- optimized_ai_prompts.py（优化AI提示）
- deepseek_client.py（DeepSeek客户端）
读取对比结果  
↓ _[内容：加载comparison_results JSON]_  
提取所有列名  
↓ _[用途：准备标准化处理]_  
**调用8098标准化接口**  
↓ _[内容：POST /api/standardize {columns}]_  
**📄 deepseek_enhanced_server_with_semantic.py:standardize_columns()**  
↓ _[位置：需要修复的标准实现]_  
ColumnStandardizationProcessorV3.process()  
↓ _[用途：AI驱动的列名标准化]_  
映射原始列名到标准列名  
↓ _[内容：{original: standard}映射表]_  
更新对比结果  
↓ _[意义：使用标准化列名]_  

### ✅ L2语义分析流程 [80%实现]
**📌 验证确认：完整实现（spec/05-AI语义分析集成规格.md）**
- l2_semantic_analysis_two_layer.py（两层分析）
- ai_semantic_analysis_engine.py（语义引擎）
- claude_semantic_analysis.py（Claude分析）
- optimized_claude_l2_wrapper.py（优化L2封装）
准备语义分析输入  
↓ _[内容：标准化后的变更数据]_  
**调用8098语义分析接口**  
↓ _[内容：POST /api/semantic_analysis {changes}]_  
**📄 deepseek_enhanced_server_with_semantic.py:semantic_analysis()**  
↓ _[位置：需要集成的L2分析]_  
L2SemanticAnalyzer.analyze()  
↓ _[用途：深度语义理解]_  
生成L1/L2/L3风险等级  
↓ _[内容：{L1: [], L2: [], L3: []}]_  
```json
{
  "L1": ["低风险变更列表"],
  "L2": ["中风险需审核项"],
  "L3": ["高风险需拒绝项"]
}
```  
↓ _[意义：风险分级结果]_  

### ✅ 详细打分流程 [85%实现]
**📌 验证确认：T-RICE+评分框架已实现（spec/10-智能评分体系规范.md）**
- scoring_heatmap_mapper.py（打分映射）
- scoring_heatmap_mapper_simple.py（简化版）
- document_change_analyzer.py（变更分析）
收集所有分析结果  
↓ _[内容：对比+标准化+语义分析]_  
**调用8100详细打分接口**  
↓ _[内容：POST /api/detailed_scoring {analysis}]_  
**📄 integrated_scoring_test_server.py:calculate_detailed_score()**  
↓ _[位置：已实现的打分算法]_  
按维度计算分数  
↓ _[用途：多维度评估]_  
```python
scores = {
    'data_completeness': 85,
    'format_consistency': 92,
    'business_logic': 78,
    'risk_level': 'L2'
}
```  
↓ _[内容：详细评分结果]_  
保存到 /scoring_results/detailed/  
↓ _[意义：评分结果持久化]_  

### ⚠️ 综合打分流程 [50%实现]
汇总所有详细打分  
↓ _[内容：聚合多个维度分数]_  
包含未修改列名  
↓ _[用途：保持原始信息追溯]_  
**调用8100综合打分接口**  
↓ _[内容：POST /api/comprehensive_scoring]_  
**📄 integrated_scoring_test_server.py:calculate_comprehensive_score()**  
↓ _[位置：综合评分算法]_  
加权平均计算总分  
↓ _[用途：得出最终评分]_  
```python
final_score = {
    'total': 83.5,
    'grade': 'B+',
    'recommendation': '建议人工审核'
}
```  
↓ _[意义：最终决策依据]_  

### ✅ 热力图生成流程 [90%实现]
收集所有文档的综合打分  
↓ _[内容：遍历tasks获取所有分数]_  
构建热力图数据矩阵  
↓ _[用途：准备可视化数据]_  
```javascript
heatmapData = [
    {row: "文档1", columns: [分数1, 分数2, ...]},
    {row: "文档2", columns: [分数1, 分数2, ...]}
]
```  
↓ _[内容：N×19矩阵结构]_  
**调用8089热力图渲染**  
↓ _[内容：已有功能，需要适配]_  
**📄 final_heatmap_server.py:render_heatmap()**  
↓ _[位置：现有热力图渲染]_  
高斯平滑处理  
↓ _[用途：平滑视觉效果]_  
颜色映射（蓝→青→绿→黄→红）  
↓ _[意义：风险等级可视化]_  
添加行标签（文档名称）  
↓ _[内容：每行对应一个文档]_  
WebSocket推送热力图更新  
↓ _[用途：实时更新前端显示]_  

---

## 第四部分：并发流程2 - Excel处理管道

### ✅ Excel下载流程 [90%实现]
**📌 验证确认：与CSV共享下载模块**
process_excel_pipeline(task)函数开始  
↓ _[意义：Excel处理管道入口]_  
调用8093下载接口  
↓ _[内容：POST /api/download {url, cookie, format:'xlsx'}]_  
**📄 production_integrated_test_system_8093.py:download_document()**  
↓ _[位置：复用下载功能]_  
TencentDocAutoExporter.export_to_excel()  
↓ _[用途：导出Excel格式]_  
保存到 /excel_uploads/{timestamp}_{name}.xlsx  
↓ _[内容：Excel文件存储]_  
返回文件路径  
↓ _[意义：涂色处理的输入]_  

### ⚠️ Excel智能涂色流程 [65%实现]
**📌 验证确认：Excel MCP模块已实现（spec/06-Excel智能涂色完整处理流程规范.md）**
- excel_mcp_visualizer.py（MCP可视化器）
- 需集成mcp__excel__函数族
读取详细打分结果  
↓ _[内容：从CSV管道获取评分]_  
加载Excel文件  
↓ _[用途：准备修改]_  
**调用Excel MCP接口**  
↓ _[内容：使用mcp__excel__函数]_  
```python
for cell, score in scoring_map.items():
    if score.risk_level == 'L3':
        color = '#FF0000'  # 红色
    elif score.risk_level == 'L2':
        color = '#FFA500'  # 橙色
    else:
        color = '#00FF00'  # 绿色
    
    mcp__excel__format_range(
        filepath=excel_path,
        sheet_name='Sheet1',
        start_cell=cell,
        bg_color=color
    )
```  
↓ _[用途：根据风险等级涂色]_  
添加批注说明  
↓ _[内容：风险原因和建议]_  
保存涂色后的Excel  
↓ _[位置：/excel_uploads/marked/]_  
**📄 需要实现：ExcelMarker类**  

### ✅ Excel上传流程 [90%实现]
**📌 验证确认：有3个版本上传模块**
- tencent_doc_upload_production_v3.py（V3版本）
- tencent_doc_upload_production_v2.py（V2版本）
- tencent_doc_upload_production.py（V1版本）
- production_upload_manager.py（上传管理器）
- upload_url_manager.py（URL管理）
读取涂色后的Excel  
↓ _[内容：标记完成的文件]_  
生成上传文件名  
↓ _[用途：包含时间戳和标记]_  
`副本_已审核_{原名}_{timestamp}.xlsx`  
↓ _[意义：区分原始和处理后版本]_  
**调用8093上传接口**  
↓ _[内容：POST /api/upload]_  
**📄 production_integrated_test_system_8093.py:upload_document()**  
↓ _[位置：已实现的上传功能]_  
自动化浏览器操作  
↓ _[用途：模拟用户上传]_  
```python
page.goto('https://docs.qq.com/desktop/')
page.click('导入')
page.setInputFiles('input[type=file]', excel_path)
page.waitForNavigation()
new_url = page.url()
```  
↓ _[内容：Playwright自动化]_  
获取新文档URL  
↓ _[意义：生成可访问链接]_  
保存URL映射  
↓ _[位置：task['excel_result']['url']]_  

### ❌ 热力图链接集成流程 [0%实现]
收集所有上传的URL  
↓ _[内容：遍历tasks获取excel_result.url]_  
更新热力图行标签  
↓ _[用途：添加可点击链接]_  
```javascript
rowLabels = tasks.map(task => ({
    text: task.name,
    url: task.excel_result.url,
    clickable: true
}))
```  
↓ _[内容：构建可交互标签]_  
渲染为HTML链接  
↓ _[用途：实现点击跳转]_  
```html
<div class="heatmap-row-label">
    <a href="{url}" target="_blank">{文档名称}</a>
</div>
```  
↓ _[意义：直接访问处理结果]_  
WebSocket推送最终结果  
↓ _[内容：完整的处理结果]_  
**📄 需要修改：final_heatmap_server.py**  

---

## 第五部分：已实现的核心基础模块

### ✅ 配置管理系统 [90%实现]
**📌 验证确认：完整配置管理架构（spec/11-配置管理系统规范.md）**
ConfigManager初始化  
↓ _[意义：统一配置管理入口]_  
**📄 production/core_modules/config_manager.py**  
↓ _[位置：配置管理器核心模块]_  
自动初始化缺失配置  
↓ _[内容：检测并创建默认配置文件]_  
加载所有配置文件  
↓ _[用途：real_documents.json等5个配置]_  
URLSyncService同步  
↓ _[意义：确保URL一致性]_  
**📄 production/core_modules/url_sync_service.py**  
↓ _[位置：URL同步服务]_  
Cookie有效期检测  
↓ _[内容：自动检测过期Cookie]_  
配置备份和恢复  
↓ _[用途：防止配置丢失]_  

### ✅ 时间管理系统 [95%实现]
**📌 验证确认：完整周时间管理（spec/02-时间管理和文件版本规格.md）**
WeekTimeManager初始化  
↓ _[意义：周时间计算核心]_  
**📄 production/core_modules/week_time_manager.py**  
↓ _[位置：时间管理模块]_  
计算当前周数  
↓ _[内容：基于ISO 8601标准]_  
确定版本类型  
↓ _[用途：baseline/midweek/weekend]_  
生成标准文件名  
↓ _[意义：统一命名规范]_  
`tencent_{name}_{YYYYMMDD_HHMM}_{type}_W{week}.{ext}`  
↓ _[格式：支持csv/xlsx扩展名]_  

### ✅ 文档加载系统 [95%实现]
**📌 验证确认：动态文档管理**
RealDocumentLoader初始化  
↓ _[意义：真实文档加载器]_  
**📄 production/core_modules/real_doc_loader.py**  
↓ _[位置：文档加载核心]_  
读取real_documents.json  
↓ _[内容：3个真实腾讯文档配置]_  
解析文档URL和ID  
↓ _[用途：提取doc_id用于API调用]_  
ShareLinkParser解析  
↓ _[意义：智能解析分享链接]_  
**📄 production/core_modules/share_link_parser.py**  
↓ _[位置：链接解析器]_  

### ✅ Cookie管理系统 [85%实现]
**📌 验证确认：多层Cookie管理架构**
Cookie管理器初始化  
↓ _[意义：Cookie统一管理]_  
**📄 production/core_modules/cookie_manager.py**  
↓ _[位置：基础Cookie管理]_  
SmartCookieManager  
↓ _[内容：智能Cookie管理]_  
**📄 production/core_modules/smart_cookie_manager.py**  
↓ _[用途：自动刷新和验证]_  
CookieOptimizationStrategy  
↓ _[意义：优化策略]_  
**📄 production/core_modules/cookie_optimization_strategy.py**  
↓ _[位置：Cookie优化算法]_  
AutoCookieRefresher  
↓ _[内容：自动刷新机制]_  
**📄 production/core_modules/auto_cookie_refresher.py**  
↓ _[用途：防止Cookie过期]_  

### ✅ 版本管理系统 [90%实现]
**📌 验证确认：CSV版本控制**
CSVVersionManager初始化  
↓ _[意义：版本管理核心]_  
**📄 production/core_modules/csv_version_manager.py**  
↓ _[位置：CSV版本管理器]_  
BaselineManager管理  
↓ _[内容：基准版本管理]_  
**📄 production/core_modules/baseline_manager.py**  
↓ _[用途：周二基准版本]_  
CSVSecurityManager  
↓ _[意义：CSV安全管理]_  
**📄 production/core_modules/csv_security_manager.py**  
↓ _[位置：安全备份和恢复]_  

---

## 第六部分：结果展示与持久化

### ❌ 统一结果展示界面 [0%实现]
所有任务完成后  
↓ _[意义：处理流程结束]_  
汇总所有处理结果  
↓ _[内容：CSV分析+Excel标记]_  
生成处理报告  
↓ _[用途：总结本次监控]_  
```json
{
  "monitoring_id": "MON-20250911-001",
  "start_time": "2025-09-11 10:00:00",
  "end_time": "2025-09-11 10:15:00",
  "documents_processed": 5,
  "results": [
    {
      "name": "销售计划表",
      "csv_score": 85,
      "risk_level": "L2",
      "excel_url": "https://docs.qq.com/sheet/xxx",
      "changes_detected": 12
    }
  ]
}
```  
↓ _[内容：结构化报告数据]_  
渲染结果页面  
↓ _[位置：/monitor/results/{monitoring_id}]_  
显示热力图  
↓ _[用途：整体风险可视化]_  
显示处理统计  
↓ _[内容：成功/失败/耗时]_  
提供下载报告  
↓ _[意义：结果导出存档]_  
**📄 需要创建：static/templates/results.html**  

### ⚠️ 定时任务管理 [30%实现]
如果设置了定时执行  
↓ _[意义：自动化监控]_  
创建APScheduler任务  
↓ _[内容：定时触发器配置]_  
```python
scheduler.add_job(
    func=start_monitoring,
    trigger='cron',
    hour=9, minute=0,  # 每天9点
    args=[task_config],
    id=f'monitor_{monitoring_id}'
)
```  
↓ _[用途：周期性执行]_  
保存任务配置  
↓ _[位置：/config/schedule_tasks.json]_  
任务执行日志  
↓ _[内容：记录每次执行]_  
异常处理和重试  
↓ _[意义：提高可靠性]_  
邮件/钉钉通知  
↓ _[用途：及时告警]_  
**📄 需要实现：ScheduleManager类**  

---

## 第六部分：异常处理与容错机制

### ❌ Cookie失效处理 [0%实现]
检测401/403响应  
↓ _[意义：识别认证失败]_  
暂停所有任务  
↓ _[内容：避免触发风控]_  
通知前端Cookie失效  
↓ _[用途：提示用户更新]_  
等待用户输入新Cookie  
↓ _[意义：恢复认证]_  
验证新Cookie有效性  
↓ _[内容：测试请求]_  
恢复任务执行  
↓ _[用途：继续处理]_  

### ❌ 并发控制与限流 [0%实现]
设置最大并发数  
↓ _[内容：max_workers=2]_  
请求间隔控制  
↓ _[用途：避免触发反爬]_  
```python
time.sleep(random.uniform(2, 5))  # 随机延迟
```  
↓ _[意义：模拟人工操作]_  
失败重试机制  
↓ _[内容：最多重试3次]_  
降级处理策略  
↓ _[用途：部分失败不影响整体]_  

---

## 系统部署配置

### 核心服务端口分配
- **8089**: 统一前端控制中心（改造后）
- **8093**: 下载/上传服务（作为后端）
- **8094**: CSV对比服务（作为后端）
- **8098**: AI处理服务（需要修复集成）
- **8100**: 打分算法服务（作为后端）

### 数据存储路径
- `/downloads/`: CSV/Excel下载文件
- `/csv_versions/`: 版本管理
- `/comparison_results/`: 对比结果
- `/scoring_results/`: 打分结果
- `/excel_uploads/marked/`: 涂色后Excel
- `/semantic_results/`: 语义分析结果
- `/monitoring_reports/`: 监控报告

### 配置文件
- `/config/monitoring_config.json`: 监控配置
- `/config/schedule_tasks.json`: 定时任务
- `/config/services.json`: 服务注册
- `/.env`: 环境变量和API密钥

---

## 📊 基于Spec文档的验证总结

### 实际架构情况（已验证）
根据25个spec文档和50个production模块的深度分析：

#### ✅ 已实现模块（>80%完成）
1. **下载系统** - 6个下载器模块，95%实现
2. **CSV对比** - 3个对比模块，85%实现  
3. **L2语义分析** - 4个AI分析模块，80%实现
4. **评分系统** - T-RICE+框架，85%实现
5. **上传系统** - 3个版本上传模块，90%实现
6. **配置管理** - ConfigManager+URLSync，90%实现
7. **时间管理** - WeekTimeManager，95%实现
8. **版本控制** - CSV版本管理，90%实现

#### ⚠️ 部分实现模块（50-79%完成）
1. **列标准化** - 模块存在但需集成，75%实现
2. **Excel涂色** - MCP模块需集成，65%实现

#### ❌ 未实现模块（<50%完成）
1. **8089控制中心改造** - 0%（8089仅为热力图展示）
2. **统一任务调度** - 0%（无任务队列）
3. **WebSocket实时推送** - 0%（无实时通信）
4. **自动化定时任务** - 30%（配置存在但未集成）

### 架构真相
- **系统类型**：单体应用，非微服务（spec/00-系统实际架构说明.md）
- **前端技术**：Flask模板+内嵌JS，无React（0个JSX文件）
- **数据存储**：JSON文件，无数据库
- **服务隔离**：各端口服务相互独立，缺乏集成

### 🔍 重要发现：遗漏的已实现模块
经过深度分析，发现以下重要模块已实现但未在流程中体现：

1. **自动恢复系统**
   - auto_recovery_system.py - 故障自动恢复
   - workflow_integration.py - 工作流集成

2. **表格发现和管理**
   - all_tables_discoverer.py - 自动发现所有表格
   - table_list_config.py - 表格列表配置
   - verification_table_generator.py - 验证表生成

3. **UI连接管理**
   - ui_connectivity_manager.py - UI连接性管理
   - adaptive_ui_handler.py - 自适应UI处理

4. **统一管理器**
   - unified_production_manager.py - 统一生产管理器
   - path_manager.py - 路径管理器

5. **腾讯API客户端**
   - tencent_api_client.py - API客户端
   - tencent_doc_automation_final.py - 文档自动化

### 实施建议
1. **短期（1周）**：集成已有模块，实现基础串行流程
2. **中期（2周）**：添加任务调度和并发处理
3. **长期（1月）**：改造8089为真正的控制中心

---

**文档版本**: v2.0  
**创建日期**: 2025-09-11  
**更新日期**: 2025-09-11（基于spec文档验证）  
**验证依据**: 25个spec文档 + 50个production模块  
**实现优先级**: P0-集成已有模块 > P1-任务调度 > P2-8089改造  
**预计工作量**: 基础集成1周，完整实现3-4周