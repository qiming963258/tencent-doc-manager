# 热力图UI参数来源与数据流说明 v2.0

**文档版本**: 2.0  
**更新日期**: 2025-09-13  
**目的**: 明确热力图UI所有输入参数的来源、数据流程和相互关系  
**重要原则**: UI只能从综合打分JSON文件获取数据（参考[0000标准](./0000-颜色和级别打分标准.md)）

## 1. 数据流架构总览

```mermaid
graph TD
    A[CSV文件对比] --> B[详细打分scoring_engine]
    B --> C[综合评分aggregator]
    C --> D[/tmp/comprehensive_scoring_data.json]
    D --> E[Flask服务器强制加载]
    E --> F[API端点提供数据]
    F --> G[React前端获取]
    G --> H[UI组件渲染]
    
    style D fill:#ff9999,stroke:#ff0000,stroke-width:3px
    
    %% 注意：UI不能直接访问其他数据源
    I[CSV文件] -.->|❌ 禁止直接访问| G
    B -.->|❌ 禁止直接访问| G
    
    L[用户交互参数] --> M[React状态管理]
    M --> H
```

**关键原则**：
- 🔴 **唯一数据源**：UI只能从 `/tmp/comprehensive_scoring_data.json` 获取数据
- 🚫 **禁止访问**：UI不能直接访问CSV文件、详细打分文件或其他中间文件
- ✅ **强制模式**：服务器启动时强制加载综合打分文件，不提供CSV模式回退

## 2. UI核心参数来源详解

### 2.1 TableModificationChart组件参数

| 参数名 | 来源 | 数据获取路径 | 数据源合规性 |
|--------|------|-------------|--------------|
| **pattern** | 综合打分JSON | comprehensive_scoring_data.json → table_scores | ✅ 合规 |
| **columnName** | 用户交互 | 鼠标悬停事件 → React状态 | ✅ 独立参数 |
| **isHovered** | 用户交互 | 鼠标事件 → React状态 | ✅ 独立参数 |
| **allPatterns** | 综合打分JSON | comprehensive_scoring_data.json → table_scores[] | ✅ 合规 |
| **globalMaxRows** | 综合打分JSON | comprehensive_scoring_data.json → table_scores[].total_rows | ✅ 合规 |
| **maxWidth** | UI配置 | 硬编码常量（300px） | ✅ 独立参数 |
| **maxHeight** | UI配置 | 硬编码常量（24px） | ✅ 独立参数 |
| **tableData** | 综合打分JSON | comprehensive_scoring_data.json → table_names + table_urls | ✅ 合规 |
| **detailedScores** | 综合打分JSON | comprehensive_scoring_data.json → table_scores[].column_scores | ✅ 合规 |

### 2.2 Pattern对象内部参数

```javascript
pattern = {
  tableId: number,              // 来源：表格配置的ID
  tableName: string,            // 来源：real_documents.json或动态生成
  columnPatterns: {},           // 来源：综合评分的column_scores
  rowOverallIntensity: number,  // 来源：计算值（修改数/总行数）
  riskLevel: 'L1'|'L2'|'L3',  // 来源：综合评分的risk_level
  realData: {
    totalRows: number,          // 来源：CSV文件实际行数
    totalDifferences: number,   // 来源：综合评分的total_modifications
    modifiedRowsCount: number,  // 来源：modified_rows数组长度
    allModifiedRows: [],        // 来源：综合评分的modified_rows
    originalTableId: number,    // 来源：原始表格ID
    currentPosition: number     // 来源：当前在数组中的位置
  },
  totalModifications: number    // 备用字段：综合评分的总修改数
}
```

## 3. 数据来源层级关系

### 3.1 第一层：CSV文件（源头）
- **位置**: `/root/projects/tencent-doc-manager/csv_versions/`
- **格式**: 标准CSV格式
- **内容**: 实际业务数据
- **作用**: 提供原始数据用于对比

### 3.2 第二层：详细打分（处理）
- **位置**: `/scoring_results/detailed/`
- **处理**: `scoring_engine.py`
- **输出**: 单表详细打分结果
- **包含**: 修改的具体单元格、风险等级、分数

### 3.3 第三层：综合评分（聚合）
- **位置**: `/tmp/comprehensive_scoring_data.json`
- **处理**: `comprehensive_aggregator.py`
- **输出**: 所有表格的聚合数据
- **关键字段**:
  ```json
  {
    "table_scores": [{
      "table_name": "表名",
      "total_rows": 270,        // CSV实际行数
      "total_modifications": 45, // 总修改数
      "column_scores": {
        "列名": {
          "modified_rows": [4, 6, 8, 11], // 修改的行号
          "aggregated_score": 0.75,
          "column_level": "L2"
        }
      }
    }]
  }
  ```

### 3.4 第四层：Flask服务器（提供）
- **加载**: 启动时加载综合评分数据
- **API端点**:
  - `/api/data` - 热力图主数据
  - `/api/detailed_scores/<table>` - 详细打分数据
  - `/api/document-links` - 文档链接

### 3.5 第五层：React前端（消费）
- **获取**: fetch API调用
- **处理**: 数据转换和计算
- **渲染**: 组件props传递

## 4. 关键参数的计算逻辑

### 4.1 rowOverallIntensity（行整体强度）
```javascript
// 计算公式
rowOverallIntensity = Math.min(0.95, totalModifications / 100 * 2);

// 或者从综合评分获取
rowOverallIntensity = table.max_intensity || table.risk_score || 计算值;
```

### 4.2 barWidth（横条宽度）
```javascript
// 修复后的计算逻辑
const normalizedIntensity = modifications > 0 ? Math.max(0.1, intensity) : intensity;
const barWidth = Math.max(20, Math.min(maxWidth * 0.8, normalizedIntensity * maxWidth * 0.8));
```

### 4.3 globalMaxRows（全局最大行数）
```javascript
// 从所有表格中取最大值
const globalMaxRows = Math.max(...tables.map(t => t.realData?.totalRows || 50));
```

## 5. 独立参数与流程参数的区别

### 5.1 流程参数（数据处理链的一部分）
这些参数是数据处理流程的产物，从CSV到UI的完整链路：
- ✅ **pattern** - 综合评分的核心数据
- ✅ **totalRows** - CSV文件的实际行数
- ✅ **modified_rows** - 实际修改的行号
- ✅ **riskLevel** - AI计算的风险等级
- ✅ **aggregated_score** - 聚合后的分数

### 5.2 独立参数（配置或交互产生）
这些参数独立于数据处理流程：
- ❌ **columnName** - 用户鼠标悬停产生
- ❌ **isHovered** - UI交互状态
- ❌ **maxWidth/maxHeight** - UI布局配置
- ❌ **颜色配置** - 视觉设计常量

## 6. 数据更新机制

### 6.1 实时更新
- 鼠标悬停立即触发
- API调用获取最新数据
- React状态更新触发重渲染

### 6.2 缓存机制
```javascript
// 5分钟缓存策略
const scoreCache = new Map();
const CACHE_DURATION = 300000; // 5分钟

function getCachedOrFetch(tableName) {
  if (scoreCache.has(tableName)) {
    return scoreCache.get(tableName);
  }
  // 获取新数据并缓存
  const data = await fetchData(tableName);
  scoreCache.set(tableName, data);
  setTimeout(() => scoreCache.delete(tableName), CACHE_DURATION);
  return data;
}
```

## 7. 数据完整性保证

### 7.1 必需字段验证
```javascript
// 确保关键字段存在
const requiredFields = ['total_rows', 'modified_rows', 'column_level'];
const isValid = requiredFields.every(field => data[field] !== undefined);
```

### 7.2 降级策略
1. **优先使用**: 综合评分数据（comprehensive）
2. **次选**: 详细打分数据（detailed）
3. **兜底**: 模拟数据（mock）

## 8. 调试与监控

### 8.1 数据流追踪
```javascript
console.log('📊 数据源:', dataSource);
console.log('📈 参数来源:', {
  pattern: '综合评分',
  columnName: '用户交互',
  totalRows: 'CSV文件',
  riskLevel: 'AI计算'
});
```

### 8.2 性能监控点
- CSV文件读取时间
- 打分计算耗时
- API响应延迟
- UI渲染帧率

## 9. 总结

UI参数来源可分为三类：
1. **核心业务数据**: 来自CSV对比和AI打分流程
2. **配置元数据**: 来自配置文件和系统设置
3. **交互状态数据**: 来自用户操作和UI状态

这些参数通过明确的数据流程，从源头（CSV文件）经过多层处理（打分、聚合、API），最终到达UI组件进行渲染。理解这个完整的数据流对于系统维护和问题排查至关重要。

---

**维护说明**: 本文档应与代码实现保持同步更新