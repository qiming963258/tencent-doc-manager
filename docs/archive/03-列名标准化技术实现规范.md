# 📋 列名标准化技术实现规范

> 📝 **注意**: 此文档描述的8081端口服务为计划实现功能
> - 相关集成代码已编写（claude_wrapper_integration.py）
> - 服务尚未实际部署运行
> - 当前系统使用内置AI服务进行列名标准化

**文档版本**: v3.1  
**创建时间**: 2025-08-18  
**最后更新**: 2025-09-12  
**适用步骤**: 腾讯文档智能监控系统 - 步骤3  
**核心实现**: column_standardization_processor_v3.py  

---

## 🎯 技术概述

### 功能定义
将CSV差异文件中的实际列名智能映射到19个标准列名，处理列名变异、缺失和语义匹配问题。

### 核心目标
- **智能映射**: 实际列名 → 标准列名的自动匹配
- **置信度评估**: 每个映射关系的可信度分数
- **变异处理**: 识别和处理列名的各种变异形式
- **API集成**: 通过Claude AI提供智能语义分析

---

## 🔧 技术架构

### 系统架构图（V3版本）
```
原始CSV文件（基线+目标）
           ↓
SimplifiedCSVComparator（简化对比器）
           ↓
简化JSON结果（2.6KB）
           ↓
ColumnStandardizationProcessorV3（V3处理器）
           ↓
DeepSeek API（智能标准化）
           ↓
标准化JSON结果（含19列映射）
```

### 核心组件
1. **统一CSV对比接口** - `UnifiedCSVComparator`类
2. **简化对比器** - `SimplifiedCSVComparator`类  
3. **V3标准化处理器** - `ColumnStandardizationProcessorV3`类
4. **DeepSeek客户端** - `DeepSeekClient`类
5. **19个标准列名** - 企业级列名规范

---

## 📂 文件路径和组件

### 关键文件清单（V3版本）
```
/root/projects/tencent-doc-manager/
├── unified_csv_comparator.py              # 统一CSV对比接口
├── simplified_csv_comparator.py           # 简化对比器实现
├── column_standardization_processor_v3.py # V3标准化处理器
├── deepseek_client.py                     # DeepSeek API客户端
├── csv_versions/2025_W36/midweek/
│   ├── *_baseline_*.csv                   # 输入：基线CSV文件
│   └── *_target_*.csv                     # 输入：目标CSV文件
├── comparison_results/
│   ├── simplified_*.json                  # 中间：简化对比结果（2.6KB）
│   └── simplified_*_standardized.json     # 输出：标准化结果（3-4KB）
└── docs/specifications/
    └── 03-列名标准化技术实现规范.md       # 本文档
```

### 核心类和方法
- **`SimplifiedCSVComparator.compare()`** - CSV对比主函数
- **`ColumnStandardizationProcessorV3.extract_columns_from_simplified_comparison()`** - 列提取
- **`ColumnStandardizationProcessorV3.build_smart_standardization_prompt()`** - 提示词构建
- **`ColumnStandardizationProcessorV3.standardize_column_names()`** - AI标准化调用
- **`ColumnStandardizationProcessorV3.apply_standardization_to_simplified_file()`** - 结果应用

---

## 🔄 完整程序调用链（V3版本）

### **总步骤数：4个核心步骤**

### **步骤1️⃣：CSV文件对比**

**①步骤概要**：对比两个CSV文件，识别所有差异

**②执行程序**：
```python
# 文件：/root/projects/tencent-doc-manager/simplified_csv_comparator.py
# 类：SimplifiedCSVComparator
# 方法：compare(baseline_path, target_path, output_dir)
# 代码行：第13-105行

comparator = SimplifiedCSVComparator()
result = comparator.compare(baseline_path, target_path, output_dir)
```

**③输入输出**：
- 输入：2个CSV文件（114行×26列）
- 输出：simplified_*.json文件（2.6KB）
- 格式：`{"modified_columns": {...}, "modifications": [...], "statistics": {...}}`

### **步骤2️⃣：修改列提取**

**①步骤概要**：从对比结果中提取修改列

**②执行程序**：
```python
# 文件：/root/projects/tencent-doc-manager/column_standardization_processor_v3.py
# 方法：extract_columns_from_simplified_comparison(comparison_file_path)
# 代码行：第46-81行

processor = ColumnStandardizationProcessorV3(api_key)
column_mapping = processor.extract_columns_from_simplified_comparison(file_path)
```

**③数据处理**：
```python
with open(comparison_file_path, 'r', encoding='utf-8') as f:
    data = json.load(f)
column_mapping = data.get('modified_columns', {})  # 直接提取
```

### **步骤3️⃣：AI智能标准化**

**①步骤概要**：构建提示词并调用DeepSeek API

**②执行程序**：
```python
# 方法1：build_smart_standardization_prompt(column_mapping)
# 代码行：第51-142行
prompt = processor.build_smart_standardization_prompt(column_mapping)

# 方法2：standardize_column_names(column_mapping)  
# 代码行：第144-192行
result = await processor.standardize_column_names(column_mapping)
```

**③API调用**：
```python
messages = [
    {"role": "system", "content": "数据分析专家..."},
    {"role": "user", "content": prompt}
]
result = await self.deepseek_client.chat_completion(messages, temperature=0.1)
```

### **步骤4️⃣：标准化结果应用**

**①步骤概要**：将AI结果写回文件

**②执行程序**：
```python
# 方法：apply_standardization_to_simplified_file()
# 代码行：第194-257行
result = processor.apply_standardization_to_simplified_file(
    comparison_file_path,
    standardization_result,
    output_path
)
```

**③输出文件**：
- 路径：comparison_results/simplified_*_standardized.json
- 大小：3-4KB
- 内容：原始数据 + 标准化映射 + 元数据

---

## 📊 文件输入输出转换流程

### **文件转换链**

```
输入阶段：
┌─────────────────────────────────────────┐
│ baseline.csv (114行×19列)               │
│ target.csv   (114行×26列)               │
└─────────────────────────────────────────┘
                    ↓
            SimplifiedCSVComparator
                    ↓
中间文件1：
┌─────────────────────────────────────────┐
│ simplified_*.json (2.6KB)               │
│ - modified_columns: 24个修改列          │
│ - modifications: 24个修改单元格         │
│ - statistics: 相似度0.992               │
└─────────────────────────────────────────┘
                    ↓
    ColumnStandardizationProcessorV3
                    ↓
                DeepSeek API
                    ↓
最终输出：
┌─────────────────────────────────────────┐
│ simplified_*_standardized.json (3-4KB)  │
│ - standardized_columns: 19个标准列      │
│ - original_modified_columns: 备份       │
│ - standardization_metadata: AI元数据    │
└─────────────────────────────────────────┘
```

### **具体文件示例**

**输入文件路径**：
```
/root/projects/tencent-doc-manager/csv_versions/2025_W36/midweek/
├── tencent_副本-测试版本-出国销售计划表-工作表1_csv_20250905_1137_midweek_W36.csv
└── tencent_副本-副本-测试版本-出国销售计划表-工作表1_csv_20250905_1137_midweek_W36.csv
```

**中间文件路径**：
```
/root/projects/tencent-doc-manager/comparison_results/
└── simplified_副本-测试版本-出国销售计划表-工作表1_vs_副本-副本-测试版本-出国销售计划表-工作表1_20250905_224147.json
```

**最终输出路径**：
```
/root/projects/tencent-doc-manager/comparison_results/
└── simplified_副本-测试版本-出国销售计划表-工作表1_vs_副本-副本-测试版本-出国销售计划表-工作表1_20250905_224147_standardized.json
```

### **数据转换统计**

| 阶段 | 数据量 | 文件大小 | 列数变化 |
|------|--------|----------|----------|
| 原始CSV | 114行 | ~50KB | 19-26列 |
| 简化JSON | 24个修改 | 2.6KB | 24个修改列 |
| 标准化JSON | 19个映射 | 3-4KB | 19个标准列 |

---

## 🚀 实现步骤

### Step 1: 服务验证
```bash
# 验证Claude API服务运行状态
curl http://localhost:8081/health
```

### Step 2: 输入数据准备
```bash
# 验证输入文件存在且格式正确
cat /root/projects/tencent-doc-manager/csv_versions/standard_outputs/table_001_diff.json
```

### Step 3: API调用测试
```bash
# 调用列名标准化接口
curl -X POST http://localhost:8081/api/ai-column-mapping \
  -H "Content-Type: application/json" \
  -d @csv_versions/standard_outputs/table_001_diff.json
```

### Step 4: 结果验证
```bash
# 检查输出格式和映射结果
# 期望输出包含: success, mapping, confidence_scores
```

---

## 📊 标准列名规范

### 19个标准列名
```json
[
  "序号", "项目类型", "来源", "任务发起时间", "目标对齐",
  "关键KR对齐", "具体计划内容", "邓总指导登记", "负责人",
  "协助人", "监督人", "重要程度", "预计完成时间", "完成进度", 
  "完成链接", "最新复盘时间", "对上汇报", "应用情况", "经理分析复盘"
]
```

### 风险等级分类
- **L1级** (绝对不能修改): 来源、任务发起时间、目标对齐、关键KR对齐、重要程度、预计完成时间、完成进度
- **L2级** (需要语义审核): 项目类型、具体计划内容、邓总指导登记、负责人、协助人、监督人、完成链接  
- **L3级** (可自由编辑): 序号、最新复盘时间、对上汇报、应用情况、经理分析复盘

---

## 🔄 API接口规范

### 请求格式
```json
{
  "comparison_summary": {
    "baseline_file": "文件名.csv",
    "current_file": "文件名.csv", 
    "total_differences": 18
  },
  "differences": [
    {
      "序号": 1,
      "行号": 1,
      "列名": "项目类型",
      "原值": "目标管理", 
      "新值": "体系建设"
    }
  ]
}
```

### 响应格式
```json
{
  "success": true,
  "mapping": {
    "项目类型": "项目类型",
    "具体计划内容": "具体计划内容"
  },
  "confidence_scores": {
    "项目类型": 1.0,
    "具体计划内容": 0.95
  },
  "processed_columns": ["项目类型", "具体计划内容"],
  "timestamp": 1692356400
}
```

---

## 🧪 测试用例

### 基础功能测试
```bash
# 测试1: 正常映射
curl -X POST http://localhost:8081/api/ai-column-mapping \
  -H "Content-Type: application/json" \
  -d '{"differences": [{"列名": "项目类型"}]}'

# 测试2: 变异列名
curl -X POST http://localhost:8081/api/ai-column-mapping \
  -H "Content-Type: application/json" \
  -d '{"differences": [{"列名": "项目类别"}]}'

# 测试3: 完整差异文件
curl -X POST http://localhost:8081/api/ai-column-mapping \
  -H "Content-Type: application/json" \
  -d @csv_versions/standard_outputs/table_001_diff.json
```

### 期望结果验证
- ✅ API响应success=true
- ✅ mapping包含列名映射关系
- ✅ confidence_scores包含置信度分数
- ✅ 响应时间 < 5秒

---

## ⚙️ 配置参数

### Claude API配置
```python
# /root/projects/tencent-doc-manager/claude_mini_wrapper/config.py
class ClaudeConfig:
    HOST = "0.0.0.0"
    PORT = 8081
    DEFAULT_MODEL = "claude-sonnet-4-20250514"
    MAX_TOKENS = 4000
    DEFAULT_TIMEOUT = 60
```

### 匹配算法参数
```python
# 置信度阈值配置
EXACT_MATCH_THRESHOLD = 1.0
VARIATION_MATCH_THRESHOLD = 0.8
SEMANTIC_MATCH_THRESHOLD = 0.6
POSITION_MATCH_THRESHOLD = 0.4
```

---

## 🔍 故障排除

### 常见问题
1. **API服务不可用**
   - 检查: `curl http://localhost:8081/health`
   - 解决: 重启服务 `python3 main.py`

2. **列名映射失败**
   - 检查: 输入文件格式是否正确
   - 解决: 验证JSON格式和differences字段

3. **置信度分数偏低**
   - 检查: 列名是否存在显著变异
   - 解决: 调整匹配阈值或添加变异规则

### 调试命令
```bash
# 查看API日志
tail -f claude_api.log

# 检查服务进程
ps aux | grep "python3 main.py"

# 验证配置文件
python3 -c "from config import ClaudeConfig; print(ClaudeConfig.validate_config())"
```

---

## 📈 性能指标

### 目标性能
- **响应时间**: < 5秒/请求
- **API成功率**: ≥ 95%
- **映射准确率**: ≥ 90%
- **并发处理**: 支持10个并发请求

### 实际测试结果
- ✅ **API成功率**: 100% (已验证)
- ✅ **服务稳定性**: 24/7运行
- ✅ **模型支持**: 4个Claude模型可用
- ⏳ **映射准确率**: 待测试验证

---

## 🖥️ UI集成与列顺序管理（新增 v3.1）

### 热力图UI中的列顺序切换
标准19列在热力图UI中支持两种显示模式：

1. **默认顺序模式**：
   - 按照本文档定义的标准19列顺序排列
   - 便于业务人员对照原始定义
   - 确保数据的业务语义清晰

2. **智能聚类模式**：
   - 基于风险值大小动态排序
   - 将高风险列聚集在左侧
   - 优化热力图的视觉效果

3. **实现位置**：
   - 服务器端：`/production/servers/final_heatmap_server.py`（第7294-7328行）
   - 全局变量：`USE_DEFAULT_COLUMN_ORDER`控制当前模式
   - API端点：`/api/reset_column_order`实现切换

## 📝 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v3.1 | 2025-09-12 | 添加UI集成说明，记录列顺序切换功能 |
| v3.0 | 2025-09-05 | 更新为V3处理器，添加完整程序调用链和文件转换流程 |
| v2.0 | 2025-09-04 | 迁移到DeepSeek API，支持超19列智能筛选 |
| v1.0 | 2025-08-18 | 初始版本，包含API接口和匹配算法规范 |

---

**维护团队**: Claude AI + 系统架构组  
**联系方式**: 通过技术文档Issue追踪问题  
**下一版本**: 计划添加批量处理和缓存机制