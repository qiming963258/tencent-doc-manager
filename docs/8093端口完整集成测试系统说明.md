# 8093端口 - 腾讯文档智能处理完整集成测试系统（增强版 v5.0）

## 📋 系统概述

8093端口提供了一个功能强大的端到端测试系统，实现从双文档下载到智能涂色上传的全自动化流程。**v5.0版本新增了文件浏览器、执行历史、预设模板、高级配置等功能，显著提升用户体验。**

### 访问地址
- 本地访问: http://localhost:8093
- 外网访问: http://202.140.143.88:8093

### 🆕 v5.0 新功能
- **三栏式布局**: 左侧配置、中间状态、右侧历史
- **文件浏览器**: 快速选择已下载文件
- **执行历史**: 追踪所有历史执行记录
- **预设模板**: 周度检查、紧急检查等快速配置
- **高级选项**: 上传模式、详细日志等配置
- **实时统计**: 变更单元格、风险分数、执行时间
- **Cookie管理**: 本地存储和自动加载
- **文件下载**: 直接下载所有生成的文件

## 🚀 功能特性

### 完整处理流程（10个步骤）

1. **下载基线文档（CSV）** - 从腾讯文档下载基准CSV文件
2. **下载目标文档（CSV）** - 从腾讯文档下载待对比的CSV文件
3. **CSV对比分析** - 使用AdaptiveTableComparator进行智能对比
4. **列标准化** - 统一列名和格式
5. **L2语义分析 + L1L3规则打分** - 智能评分系统
6. **生成详细打分JSON** - 输出完整的评分数据
7. **下载目标文档（XLSX）** - 获取Excel格式用于涂色
8. **修复Excel格式** - 处理腾讯文档的格式兼容性问题
9. **应用条纹涂色** - 根据打分结果进行智能标记
10. **上传到腾讯文档** - 将处理后的文件上传回腾讯文档

## 📁 核心文件路径

### 程序文件
```
主程序: /root/projects/tencent-doc-manager/production_integrated_test_system_8093.py
```

### 数据存储路径
```
下载目录: /root/projects/tencent-doc-manager/downloads/
CSV版本: /root/projects/tencent-doc-manager/csv_versions/
对比结果: /root/projects/tencent-doc-manager/comparison_results/
详细打分: /root/projects/tencent-doc-manager/scoring_results/detailed/
涂色输出: /root/projects/tencent-doc-manager/excel_outputs/marked/
系统日志: /root/projects/tencent-doc-manager/logs/
```

## 🔧 模块加载状态

系统启动时会自动检测并加载以下模块：

| 模块名称 | 功能说明 | 导入路径 |
|---------|---------|---------|
| downloader | 下载模块 | production.core_modules.tencent_export_automation |
| comparator | 比较模块 | production.core_modules.adaptive_table_comparator |
| standardizer | 列标准化 | production.core_modules.column_standardization_prompt |
| l2_analyzer | L2语义分析 | production.core_modules.l2_semantic_analysis_two_layer |
| marker | 智能标记 | intelligent_excel_marker |
| fixer | Excel修复 | fix_tencent_excel |
| uploader | 上传模块 | tencent_doc_uploader |
| week_manager | 时间管理 | production.core_modules.week_time_manager |

## 📊 使用说明

### 1. 启动系统
```bash
# 启动服务
python3 production_integrated_test_system_8093.py

# 后台运行
nohup python3 production_integrated_test_system_8093.py > /tmp/test_8093_enhanced.log 2>&1 &
```

### 2. 访问Web界面
打开浏览器访问 http://localhost:8093 或 http://202.140.143.88:8093

### 3. 界面功能区域

#### 左侧面板 - 输入配置
**基础配置标签**
- **基线文档链接**: 输入基准腾讯文档URL或选择已下载文件
- **目标文档链接**: 输入要对比的腾讯文档URL或选择已下载文件
- **Cookie**: 输入完整Cookie字符串（支持本地存储）
- **文件浏览器**: 点击"📁 选择已下载文件"快速选择本地文件

**高级选项标签**
- **上传方式**: 选择创建新文档或替换现有文档
- **目标文档URL**: 替换模式下的目标文档地址
- **详细日志**: 启用更详细的执行日志
- **保存为预设**: 将当前配置保存为预设模板

**预设模板标签**
- **快速预设**: 周度检查、紧急检查、完整分析、快速测试
- **自定义预设**: 保存和管理自定义配置模板

#### 中间面板 - 执行状态
- **状态指示器**: 实时显示执行状态（空闲/运行/完成/错误）
- **统计卡片**: 
  - 变更单元格数量
  - 风险分数评估
  - 执行时间计时
  - 模块成功率
- **日志容器**: 实时滚动显示执行日志
- **处理结果**: 显示生成的文件和下载链接

#### 右侧面板 - 历史与文件
**执行历史标签**
- 显示最近20条执行记录
- 包含执行ID、时间、状态
- 点击查看详细信息

**文件管理标签**
- 文件类别选择器：
  - 下载文件
  - CSV版本
  - 对比结果
  - 打分文件
  - Excel输出
- 文件浏览器显示文件信息
- 支持直接下载文件

### 4. 执行工作流

#### 基本流程
1. 输入基线和目标文档链接
2. 粘贴有效的Cookie
3. （可选）配置高级选项
4. 点击"开始执行完整流程"
5. 实时查看执行进度和日志
6. 完成后下载结果文件

#### 使用预设
1. 切换到"预设模板"标签
2. 选择合适的快速预设
3. 系统自动填充配置
4. 补充Cookie信息
5. 执行流程

#### 文件选择模式
1. 点击"📁 选择已下载文件"
2. 在弹出的文件选择器中浏览
3. 选择目标文件
4. 自动填充文件路径

### 5. 结果查看与下载
- **实时日志**: 中间面板滚动显示
- **进度条**: 顶部显示百分比进度
- **结果文件**: 完成后显示所有文件路径
- **下载链接**: 直接下载生成的文件
- **上传链接**: 如果上传成功，显示腾讯文档链接

## 📝 输出文件说明

### 详细打分JSON结构
```json
{
  "metadata": {
    "comparison_id": "唯一标识",
    "baseline_file": "基线文件名",
    "target_file": "目标文件名",
    "timestamp": "时间戳"
  },
  "statistics": {
    "total_cells": 总单元格数,
    "changed_cells": 变更单元格数,
    "high_risk_count": 高风险数,
    "medium_risk_count": 中风险数,
    "low_risk_count": 低风险数
  },
  "cell_scores": {
    "A1": {
      "row": 1,
      "column": 1,
      "old_value": "原值",
      "new_value": "新值",
      "risk_level": "high/medium/low",
      "score": 0-100
    }
  }
}
```

### 涂色规则
- **高风险（红色垂直条纹）**: score < 30
- **中风险（黄色水平条纹）**: 30 <= score < 70
- **低风险（绿色斜向条纹）**: score >= 70

## 🔍 日志查看

### 实时日志
```bash
# 查看最新日志
tail -f /tmp/test_8093.log

# 查看系统日志
ls -lt /root/projects/tencent-doc-manager/logs/
```

### 日志级别
- **INFO**: 常规信息（绿色边框）
- **WARNING**: 警告信息（黄色边框）
- **ERROR**: 错误信息（红色边框）
- **SUCCESS**: 成功信息（蓝色边框，加粗）

## 🔌 API接口说明

### REST API端点

| 端点 | 方法 | 说明 |
|------|------|------|
| `/` | GET | 主界面 |
| `/api/modules` | GET | 获取模块加载状态 |
| `/api/status` | GET | 获取当前工作流状态 |
| `/api/start` | POST | 启动工作流 |
| `/api/files/<category>` | GET | 列出特定类别文件 |
| `/api/presets` | GET | 列出所有预设 |
| `/api/presets/<name>` | GET | 获取特定预设 |
| `/api/presets` | POST | 保存预设 |
| `/api/history` | GET | 列出执行历史 |
| `/api/download/<path>` | GET | 下载文件 |

### 启动工作流请求格式
```json
POST /api/start
{
    "baseline_url": "https://docs.qq.com/sheet/xxx",
    "target_url": "https://docs.qq.com/sheet/yyy",
    "cookie": "cookie_string",
    "advanced_settings": {
        "upload_option": "new",
        "upload_target_url": "",
        "verbose_logging": false
    }
}
```

## ⚠️ 注意事项

1. **Cookie有效期**: Cookie通常24-48小时后失效，需要重新获取
2. **文档权限**: 确保Cookie对应的账号有访问文档的权限
3. **网络连接**: 确保服务器能访问腾讯文档（docs.qq.com）
4. **端口冲突**: 如果8093端口被占用，系统会自动尝试8094-8102端口
5. **浏览器兼容**: 建议使用Chrome、Edge或Firefox等现代浏览器
6. **本地存储**: Cookie会自动保存到浏览器本地存储，下次访问时可快速加载

## 🛠️ 故障排除

### 问题1: 模块加载失败
**解决**: 检查对应模块文件是否存在，查看日志中的具体错误信息

### 问题2: 下载失败
**解决**: 检查Cookie是否有效，文档链接是否正确

### 问题3: 涂色失败
**解决**: 确保Excel文件已通过fix_tencent_excel修复格式问题

### 问题4: 上传失败
**解决**: 检查Cookie是否有上传权限，网络是否正常

## 📞 技术支持

如遇到问题，请查看：
1. 系统日志: `/tmp/test_8093.log`
2. 详细日志: `/root/projects/tencent-doc-manager/logs/`
3. 相关文档: `/root/projects/tencent-doc-manager/docs/specifications/`

---

*本系统为腾讯文档智能监控项目的核心测试组件，请确保按照规范使用。*