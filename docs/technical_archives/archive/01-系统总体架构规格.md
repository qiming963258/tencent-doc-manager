# 系统总体架构规格书

## 1. 系统概述

### 1.1 项目背景
基于现有腾讯文档自动化平台，集成高级热力图可视化组件，实现文档变更的实时监控、智能分析和风险评估系统。

### 1.2 系统目标
- **智能监控**: 动态配置的N个腾讯文档表格的实时变更监控（支持任意数量）
- **风险分析**: L1/L2/L3三级风险自动分类和评估
- **可视化展示**: N×19动态热力图矩阵和表格内修改分布可视化（N根据文档数量自动调整）
- **自动化处理**: 端到端的文档下载、分析、标记、上传自动化流程

### 1.3 核心特性
1. **自适应表格对比**: 智能处理不同格式工作表的列名变异、缺失列等问题
2. **AI语义分析**: 集成Claude Sonnet进行L2级别修改的智能语义判断
3. **专业可视化标记**: 使用Excel MCP实现半填充对角线图案的错误位置标记
4. **完整数据流管道**: 从UI参数输入到腾讯文档上传的端到端自动化

## 2. 技术架构设计

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                    腾讯文档智能监控系统                           │
├─────────────────────────────────────────────────────────────────┤
│  前端层 (React + Tailwind CSS)                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ 监控设置面板     │  │ 热力图可视化     │  │ 表格内分布图     │ │
│  │ - 表格链接导入   │  │ - N×19动态矩阵   │  │ - 修改分布模式   │ │
│  │ - Cookie认证     │  │ - L1/L2/L3标识  │  │ - 行号标尺      │ │
│  │ - 监控参数配置   │  │ - 高斯平滑热力   │  │ - 风险状态点     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  API层 (Flask REST API)                                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ 用户认证API     │  │ 文档处理API     │  │ 监控分析API     │ │
│  │ - Cookie管理     │  │ - 批量下载       │  │ - 热力图数据     │ │
│  │ - 用户会话       │  │ - 批量上传       │  │ - 统计报告       │ │
│  │ - 权限控制       │  │ - 格式转换       │  │ - 实时状态       │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  业务逻辑层 (Python Services)                                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ 自适应对比引擎   │  │ AI语义分析服务   │  │ Excel标记服务    │ │
│  │ - 智能列匹配     │  │ - Claude API集成 │  │ - MCP可视化      │ │
│  │ - 数据标准化     │  │ - 提示词引擎     │  │ - 格式化处理     │ │
│  │ - 容错机制       │  │ - 结果缓存       │  │ - 批注生成       │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  数据处理层 (Playwright + Pandas)                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ 文档采集器       │  │ 并发处理器       │  │ 数据分析器       │ │
│  │ - Playwright自动化│  │ - 30+文档并发    │  │ - 风险评估算法   │ │
│  │ - Cookie认证     │  │ - 任务队列管理   │  │ - 统计计算       │ │
│  │ - 异常处理       │  │ - 进度跟踪       │  │ - 模式识别       │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  数据存储层                                                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ SQLite数据库    │  │ Redis缓存       │  │ 文件存储         │ │
│  │ - 用户信息       │  │ - 热力图数据     │  │ - CSV/Excel文件  │ │
│  │ - 文档历史       │  │ - AI分析结果     │  │ - 日志文件       │ │
│  │ - 操作记录       │  │ - 会话状态       │  │ - 配置文件       │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 技术栈详细规格

#### 2.2.1 前端技术栈
```javascript
// 基于现有AdvancedSortedHeatmap.jsx (1381行React组件)
{
  "框架": "React 18.x",
  "样式": "Tailwind CSS 3.x",
  "状态管理": "React Hooks (useState, useMemo, useCallback)",
  "可视化": "自定义Canvas热力图渲染",
  "HTTP客户端": "fetch API",
  "构建工具": "Vite",
  "核心组件": [
    "AdvancedSortedHeatmap.jsx",      // 主热力图组件
    "SettingsModal.jsx",             // 监控设置弹窗
    "TableModificationChart.jsx",    // 表格内分布图
    "HeatmapTooltip.jsx"            // 悬浮提示组件
  ]
}
```

#### 2.2.2 后端技术栈
```python
# 基于现有app.py Flask后端架构
{
  "框架": "Flask 2.x + Flask-CORS",
  "认证": "Cookie-based + SQLite会话存储", 
  "文档处理": "Playwright + pandas + openpyxl",
  "AI集成": "Claude Sonnet API",
  "并发处理": "asyncio + threading",
  "数据库": "SQLite 3.x",
  "缓存": "Redis 6.x",
  "任务队列": "concurrent_processor.py",
  "核心模块": [
    "app.py",                        // Flask API服务
    "tencent_export_automation.py",  // 文档下载自动化
    "tencent_upload_automation.py",  // 文档上传自动化
    "document_change_analyzer.py",   // 变更分析器
    "concurrent_processor.py"        // 并发任务处理器
  ]
}
```

#### 2.2.3 基础设施技术栈
```yaml
# 基于4H2G Ubuntu服务器部署配置
部署环境:
  服务器: "Ubuntu 20.04 LTS (4核2GB)"
  容器: "Docker + Docker Compose"
  反向代理: "Nginx"
  SSL证书: "Let's Encrypt"
  
监控运维:
  日志管理: "Python logging + 日志轮转"
  健康检查: "Flask /api/health端点"
  性能监控: "自定义性能指标收集"
  备份策略: "SQLite定时备份 + 增量备份"
```

### 2.3 核心组件关系图

```
                        ┌─────────────────┐
                        │  React前端界面   │
                        │  (5200+参数UI)  │
                        └─────┬───────────┘
                              │ HTTP API
                        ┌─────▼───────────┐
                        │   Flask API     │
                        │   (app.py)      │
                        └─────┬───────────┘
                              │
                ┌─────────────┼─────────────┐
                │             │             │
        ┌───────▼───────┐ ┌───▼───────┐ ┌───▼───────┐
        │ 自适应对比引擎 │ │ AI语义分析 │ │ Excel标记 │
        │ (智能列匹配)  │ │(Claude API)│ │ (MCP集成) │
        └───────┬───────┘ └───────────┘ └───────────┘
                │
    ┌───────────┼───────────┐
    │           │           │
┌───▼───┐   ┌───▼───┐   ┌───▼───┐
│Playwright│ │并发处理│ │数据分析│
│自动化   │ │任务队列│ │风险评估│
└───┬───┘   └───────┘ └───────┘
    │
┌───▼──────────────┐
│ 腾讯文档 (N个表格) │
└──────────────────┘
```

## 3. 数据模型设计

### 3.1 热力图数据模型
```python
# 基于N×19动态矩阵设计（配置驱动）
class HeatmapDataModel:
    """热力图核心数据模型"""
    def __init__(self):
        # 动态矩阵大小，N根据实际文档数量确定
        self.matrix_size = (len(self.documents), 19)  # N个表格×19个标准列
        self.standard_columns = [
            "序号", "项目类型", "来源", "任务发起时间", "目标对齐",
            "关键KR对齐", "具体计划内容", "邓总指导登记", "负责人",
            "协助人", "监督人", "重要程度", "预计完成时间", "完成进度",
            "形成计划清单", "复盘时间", "对上汇报", "应用情况", "进度分析总结"
        ]
        
        # 列风险等级配置
        self.column_risk_levels = {
            "来源": "L1", "任务发起时间": "L1", "目标对齐": "L1", 
            "关键KR对齐": "L1", "重要程度": "L1", "预计完成时间": "L1", 
            "完成进度": "L1",  # L1: 绝对不能修改
            
            "项目类型": "L2", "具体计划内容": "L2", "邓总指导登记": "L2",
            "负责人": "L2", "协助人": "L2", "监督人": "L2", 
            "形成计划清单": "L2",  # L2: 需要语义审核
            
            "序号": "L3", "复盘时间": "L3", "对上汇报": "L3", 
            "应用情况": "L3", "进度分析总结": "L3"  # L3: 可自由编辑
        }
```

### 3.2 表格基础数据结构
```python
# 基于现有SQLite数据库模式扩展
class TableSchema:
    """表格基础信息数据结构"""
    table_basic_info = {
        "table_id": "String",           # 表格唯一ID
        "table_name": "String",         # 表格显示名称
        "table_url": "String",          # 腾讯文档链接  
        "total_rows": "Integer",        # 表格总行数
        "actual_columns": "JSON",       # 实际包含的列
        "last_modified": "DateTime",    # 最后修改时间
        "owner": "String",              # 表格负责人
        "department": "String",         # 所属部门
        "avg_risk": "Float",            # 平均风险分数
        "max_cell_risk": "Float",       # 最高风险分数
        "critical_modifications": "Integer"  # 严重修改数量
    }
```

### 3.3 修改记录数据结构  
```python
# 扩展现有document_change_analyzer.py数据模型
class ModificationRecord:
    """修改记录详细数据结构"""
    modification_detail = {
        "table_id": "String",
        "column_name": "String", 
        "row_number": "Integer",
        "modification_intensity": "Float",      # 0-1修改强度
        "modification_count": "Integer",        # 修改次数
        "last_modified": "DateTime",
        "modifier": "String",                   # 修改人
        "change_type": "Enum",                  # 修改类型
        "severity": "Enum",                     # 严重程度
        "risk_level": "Enum",                   # L1/L2/L3
        "ai_analysis_result": "JSON",           # AI语义分析结果
        "approval_status": "Enum"               # 审批状态
    }
```

## 4. API接口设计概览

### 4.1 核心API端点扩展
```python
# 基于现有app.py Flask API扩展
@app.route('/api/heatmap/data', methods=['GET'])
def get_heatmap_data():
    """获取N×19动态热力图数据矩阵"""
    
@app.route('/api/heatmap/patterns', methods=['GET'])
def get_modification_patterns():
    """获取表格内修改分布模式数据"""
    
@app.route('/api/adaptive/compare', methods=['POST'])
def adaptive_table_compare():
    """自适应表格对比分析"""
    
@app.route('/api/ai/semantic-analysis', methods=['POST'])
def ai_semantic_analysis():
    """AI语义分析服务"""
    
@app.route('/api/excel/mark-visualization', methods=['POST'])
def excel_mark_visualization():
    """Excel MCP可视化标记"""
```

## 5. 部署架构设计

### 5.1 服务器配置规格
```yaml
# 基于4H2G Ubuntu服务器优化配置
服务器规格:
  CPU: 4核心
  内存: 2GB
  存储: 40GB SSD
  网络: 5Mbps带宽
  操作系统: Ubuntu 20.04 LTS

应用配置:
  Flask应用: 
    - 工作进程: 4个 (基于CPU核数)
    - 内存限制: 512MB/进程
    - 并发连接: 1000
  
  Redis缓存:
    - 内存分配: 256MB
    - 键过期策略: LRU
    
  SQLite数据库:
    - 连接池: 10个连接
    - WAL模式: 启用
    - 备份策略: 每日增量备份
```

### 5.2 容器化部署方案
```dockerfile
# Docker Compose配置示例
version: '3.8'
services:
  app:
    build: .
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=production
      - DATABASE_URL=sqlite:///tencent_docs.db
      - REDIS_URL=redis://redis:6379
    volumes:
      - ./uploads:/app/uploads
      - ./downloads:/app/downloads
      - ./docs:/app/docs
    depends_on:
      - redis
      
  redis:
    image: redis:6-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
      
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/ssl/certs
```

## 6. 性能和扩展性设计

### 6.1 性能优化策略
1. **前端优化**
   - React.useMemo缓存计算密集型操作
   - 高斯平滑算法服务端预计算
   - Canvas渲染优化和节流处理

2. **后端优化**
   - Redis缓存热点数据 (3600s TTL)
   - SQLite WAL模式提升并发性能
   - Playwright浏览器实例复用

3. **数据处理优化**
   - N个表格的并发下载处理（支持任意数量）
   - 增量数据传输减少网络开销
   - 异步任务队列处理批量操作

### 6.2 扩展性设计
1. **水平扩展**
   - 支持多实例部署
   - Redis集群模式
   - 负载均衡配置

2. **功能扩展**
   - 插件化AI分析引擎
   - 多租户支持
   - 移动端适配

## 7. 安全设计概览

### 7.1 认证授权机制
```python
# 基于现有Cookie认证扩展
class SecurityModel:
    """安全模型设计"""
    authentication = {
        "method": "Cookie-based Authentication",
        "storage": "SQLite encrypted cookies",
        "encryption": "AES-256",
        "session_timeout": "8小时",
        "csrf_protection": "启用"
    }
    
    authorization = {
        "role_based": ["admin", "manager", "user"],
        "resource_access": "基于表格所有权",
        "api_rate_limiting": "每用户100请求/分钟"
    }
```

### 7.2 数据安全保护
1. **敏感数据加密**: Cookie认证信息AES-256加密存储
2. **访问日志记录**: 完整的API访问和数据变更审计
3. **输入验证**: 严格的参数验证和SQL注入防护
4. **HTTPS强制**: 生产环境强制HTTPS访问

## 8. 监控和运维设计

### 8.1 健康监控体系
```python
# 基于Flask /api/health端点扩展
@app.route('/api/health/detailed', methods=['GET'])
def detailed_health_check():
    """详细健康状态检查"""
    return {
        "database": check_sqlite_connection(),
        "redis": check_redis_connection(), 
        "playwright": check_playwright_status(),
        "claude_api": check_ai_service_status(),
        "file_system": check_disk_space(),
        "memory_usage": get_memory_usage(),
        "active_jobs": get_active_job_count()
    }
```

### 8.2 日志和告警机制
1. **结构化日志**: JSON格式的应用和访问日志
2. **日志轮转**: 按天轮转，保留30天历史日志
3. **关键指标监控**: 响应时间、错误率、资源使用率
4. **告警通知**: 邮件和Webhook通知机制

## 9. 开发实施计划

### 9.1 开发里程碑 (6周计划)
- **Week 1-2**: 自适应对比算法开发 + AI语义分析集成
- **Week 3-4**: Excel MCP可视化标记 + API接口扩展
- **Week 5-6**: 系统集成测试 + 部署配置优化

### 9.2 质量标准
1. **功能完整性**: 端到端流程成功率 > 95%
2. **性能标准**: 动态数量表格并发处理，平均每个表格 < 20秒
3. **可用性**: 系统可用性 > 99.5%
4. **安全性**: 通过安全扫描和渗透测试

---

**文档版本**: v1.0  
**创建时间**: 2025-01-15  
**基于系统**: 腾讯文档自动化平台 + AdvancedSortedHeatmap.jsx  
**维护人员**: 系统架构团队