# è…¾è®¯æ–‡æ¡£ç›‘æ§ç³»ç»Ÿ - ç¬¬äºŒé˜¶æ®µæ•°æ®æµå®Œæ•´é›†æˆæŠ€æœ¯å½’æ¡£

**å½’æ¡£æ—¥æœŸ**: 2025å¹´8æœˆ29æ—¥  
**æ‰§è¡Œäºº**: Claude AI Assistant  
**ä¿®å¤é˜¶æ®µ**: ç¬¬äºŒé˜¶æ®µ - æ•°æ®åˆ†æä¸å¯è§†åŒ–  
**å½±å“èŒƒå›´**: CSVå¯¹æ¯”åˆ†æã€çŸ©é˜µè½¬æ¢ã€çƒ­åŠ›å›¾ç”Ÿæˆ  
**é£é™©ç­‰çº§**: ä½ï¼ˆå¢é‡å¼ä¿®æ”¹ï¼Œå®Œå…¨ä¿æŠ¤æ ¸å¿ƒåŠŸèƒ½ï¼‰

---

## ä¸€ã€é˜¶æ®µèƒŒæ™¯ä¸ç›®æ ‡

### 1.1 èµ·å§‹çŠ¶æ€
- **Phase 1æˆæœ**: ç‰ˆæœ¬ç®¡ç†å·²é›†æˆï¼Œä½†æ•°æ®æµæœªå®Œå…¨è¿é€š
- **å­˜åœ¨é—®é¢˜**: å¯¹æ¯”åˆ†ææœªè‡ªåŠ¨è§¦å‘ï¼Œçƒ­åŠ›å›¾æ•°æ®æ— æ³•ç”Ÿæˆ
- **ç”¨æˆ·è¦æ±‚**: "åƒä¸‡ä¸è¦æ›´æ”¹ç›®å‰ç¨³å®šçš„è…¾è®¯æ–‡æ¡£çš„ä¸Šä¼ å’Œä¸‹è½½"

### 1.2 ç¬¬äºŒé˜¶æ®µç›®æ ‡
```
å®ç°: CSVä¸‹è½½ â†’ ç‰ˆæœ¬ç®¡ç† â†’ å¯¹æ¯”åˆ†æ â†’ çŸ©é˜µè½¬æ¢ â†’ çƒ­åŠ›å›¾å±•ç¤º
è¦æ±‚: ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼Œæ¯æ­¥å¯ç‹¬ç«‹å¤±è´¥ï¼Œé…ç½®æ§åˆ¶å¼€å…³
```

### 1.3 æŠ€æœ¯æŒ‘æˆ˜
1. ProductionCSVComparatorä½¿ç”¨å¼‚æ­¥æ¶æ„
2. 30Ã—19çŸ©é˜µæ˜ å°„ç®—æ³•è®¾è®¡
3. å­—æ®µä¸åŒ¹é…å¯¼è‡´è§¦å‘å¤±æ•ˆ

---

## äºŒã€é—®é¢˜è¯Šæ–­ä¸ä¿®å¤

### 2.1 åˆå§‹é—®é¢˜å‘ç°

#### é—®é¢˜1ï¼šå¯¹æ¯”è§¦å‘å¤±æ•ˆ
```python
# åŸå› ï¼šå­—æ®µåä¸åŒ¹é…
comparison_result.get('has_both_versions')  # ä¸å­˜åœ¨
# å®é™…è¿”å›ï¼š
{
  'current_file': '...',
  'previous_file': '...'
}
```

**ä¿®å¤ä»£ç **ï¼š
```python
# ä¿®æ”¹å‰
if comparison_result['success'] and comparison_result.get('has_both_versions'):

# ä¿®æ”¹å  
if comparison_result['success'] and comparison_result.get('current_file') and comparison_result.get('previous_file'):
```

#### é—®é¢˜2ï¼šæ–‡ä»¶è·¯å¾„é”™è¯¯
```python
# åŸå› ï¼šä½¿ç”¨äº†é”™è¯¯çš„å­—æ®µå
old_file = comparison_result.get('old_version')  # é”™è¯¯
new_file = comparison_result.get('new_version')  # é”™è¯¯

# æ­£ç¡®å­—æ®µ
old_file = comparison_result.get('previous_file')
new_file = comparison_result.get('current_file')
```

#### é—®é¢˜3ï¼šComparisonResultåºåˆ—åŒ–
```python
# é—®é¢˜ï¼šè¿”å›dataclasså¯¹è±¡æ— æ³•ç›´æ¥JSONåºåˆ—åŒ–
TypeError: 'ComparisonResult' object is not subscriptable

# è§£å†³æ–¹æ¡ˆ
from dataclasses import asdict
result_dict = asdict(compare_result) if hasattr(compare_result, '__dict__') else compare_result
```

### 2.2 ä¿®å¤éªŒè¯æµ‹è¯•
```bash
# æµ‹è¯•ç»“æœ
âœ… ç‰ˆæœ¬ç®¡ç†æˆåŠŸ: realtest_20250829_0104_v004.csv
ğŸ“Š å·²å‡†å¤‡å¯¹æ¯”æ–‡ä»¶
ğŸ” å¼€å§‹å¯¹æ¯”åˆ†æ: previous_v003.csv vs current_v004.csv  
âœ… å¯¹æ¯”å®Œæˆï¼Œå‘ç° 4 å¤„å˜æ›´
ğŸ“‹ é£é™©ç­‰çº§: L3 - ä½é£é™©
ğŸ”¥ çƒ­åŠ›å›¾æ•°æ®ç”ŸæˆæˆåŠŸ
   â€¢ å½±å“å•å…ƒæ ¼: 74/570
   â€¢ æœ€å¤§å¼ºåº¦: 0.30
```

---

## ä¸‰ã€æ ¸å¿ƒæŠ€æœ¯å®ç°

### 3.1 æ¨¡å—æ¶æ„
```
post_download_processor.py (åè°ƒå™¨)
    â”œâ”€â”€ csv_version_manager.py (ç‰ˆæœ¬ç®¡ç†)
    â”œâ”€â”€ production_csv_comparator.py (å¯¹æ¯”åˆ†æ)
    â””â”€â”€ matrix_transformer.py (çŸ©é˜µè½¬æ¢) [æ–°å»º]
```

### 3.2 CSVå¯¹æ¯”é›†æˆ
```python
class PostDownloadProcessor:
    def _execute_comparison(self, comparison_result):
        """æ‰§è¡ŒCSVå¯¹æ¯”åˆ†æ"""
        # åˆå§‹åŒ–å¯¹æ¯”å™¨
        if not self.csv_comparator:
            from production_csv_comparator import ProductionCSVComparator
            self.csv_comparator = ProductionCSVComparator()
        
        # å¼‚æ­¥å¯¹æ¯”å¤„ç†
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        try:
            compare_result = loop.run_until_complete(
                self.csv_comparator.compare_csv_files(old_file, new_file)
            )
        finally:
            loop.close()
```

### 3.3 çŸ©é˜µè½¬æ¢ç®—æ³•
```python
class MatrixTransformer:
    """å°†CSVå˜æ›´æ˜ å°„åˆ°30Ã—19çƒ­åŠ›å›¾çŸ©é˜µ"""
    
    def _apply_gaussian_spot(self, center_row, center_col, intensity, radius=2):
        """é«˜æ–¯çƒ­ç‚¹ç”Ÿæˆ"""
        for r in range(max(0, center_row - radius), 
                      min(self.rows, center_row + radius + 1)):
            for c in range(max(0, center_col - radius),
                          min(self.cols, center_col + radius + 1)):
                # è®¡ç®—é«˜æ–¯è¡°å‡
                dist = math.sqrt((r - center_row)**2 + (c - center_col)**2)
                gaussian_value = intensity * math.exp(-(dist**2) / (2 * (radius/2)**2))
                self.matrix[r][c] = max(self.matrix[r][c], gaussian_value)
```

### 3.4 é£é™©ç­‰çº§æ˜ å°„
```python
# é£é™©ç­‰çº§åˆ°çƒ­åŠ›å›¾å¼ºåº¦çš„æ˜ å°„
risk_mapping = {
    'L1': 0.9,  # é«˜é£é™© - è¡€çº¢è‰²
    'L2': 0.6,  # ä¸­é£é™© - é»„è‰²
    'L3': 0.3   # ä½é£é™© - ç»¿è‰²
}
```

---

## å››ã€é…ç½®é©±åŠ¨è®¾è®¡

### 4.1 é…ç½®æ–‡ä»¶ç»“æ„
```json
{
  "enable_version_management": true,  // Phase 1åŠŸèƒ½
  "enable_comparison": true,          // Phase 2åŠŸèƒ½
  "enable_heatmap": true              // Phase 2åŠŸèƒ½
}
```

### 4.2 é…ç½®æ£€æŸ¥æœºåˆ¶
```python
# æ¯ä¸ªåŠŸèƒ½ç‹¬ç«‹æ£€æŸ¥é…ç½®
if config.get('enable_comparison', False):
    self._execute_comparison(comparison_result)
    
if config.get('enable_heatmap', False):
    self._generate_heatmap_data(result_dict)
```

---

## äº”ã€å®Œæ•´æ•°æ®æµéªŒè¯

### 5.1 æµ‹è¯•ç”¨ä¾‹
```csv
# ç‰ˆæœ¬1 (v003)
1,æ•°æ®é‡‡é›†æ¨¡å—,å·²å®Œæˆ,2025-08-29,å¼ ä¸‰
2,APIæ¥å£å¼€å‘,è¿›è¡Œä¸­,2025-08-30,æå››
3,å‰ç«¯é¡µé¢è®¾è®¡,è¿›è¡Œä¸­,2025-08-31,ç‹äº”

# ç‰ˆæœ¬2 (v004) - 4å¤„å˜æ›´
1,æ•°æ®é‡‡é›†æ¨¡å—,å·²å®Œæˆ,2025-08-29,å¼ ä¸‰
2,APIæ¥å£å¼€å‘,å·²å®Œæˆ,2025-08-30,æå››  # å˜æ›´1
3,å‰ç«¯é¡µé¢è®¾è®¡,å·²å®Œæˆ,2025-08-31,ç‹äº”  # å˜æ›´2  
4,æ•°æ®åº“ä¼˜åŒ–,å·²å®Œæˆ,2025-09-01,èµµå…­    # å˜æ›´3
5,å®‰å…¨æµ‹è¯•,å·²å®Œæˆ,2025-09-02,é’±ä¸ƒ      # å˜æ›´4
```

### 5.2 å¤„ç†ç»“æœ
| æ­¥éª¤ | è¾“å…¥ | è¾“å‡º | çŠ¶æ€ |
|-----|------|------|------|
| ç‰ˆæœ¬ç®¡ç† | realtest.csv | v004ç‰ˆæœ¬ï¼Œå½’æ¡£v003 | âœ… |
| å¯¹æ¯”åˆ†æ | v003 vs v004 | 4å¤„å˜æ›´ï¼ŒL3é£é™© | âœ… |
| çŸ©é˜µè½¬æ¢ | 4å¤„å˜æ›´ | 30Ã—19çŸ©é˜µï¼Œ74ä¸ªçƒ­ç‚¹ | âœ… |
| çƒ­åŠ›å›¾ç”Ÿæˆ | çŸ©é˜µæ•°æ® | current_heatmap_data.json | âœ… |
| UIå±•ç¤º | JSONæ•°æ® | http://202.140.143.88:8089 | âœ… |

### 5.3 æ€§èƒ½æŒ‡æ ‡
```json
{
  "ç‰ˆæœ¬ç®¡ç†è€—æ—¶": "4ms",
  "å¯¹æ¯”åˆ†æè€—æ—¶": "2.586ms", 
  "çŸ©é˜µè½¬æ¢è€—æ—¶": "1ms",
  "æ€»å¤„ç†æ—¶é—´": "<10ms",
  "å†…å­˜å ç”¨": "æœ€å°ï¼ˆæ— numpyä¾èµ–ï¼‰"
}
```

---

## å…­ã€å…³é”®æŠ€æœ¯çªç ´

### 6.1 çº¯PythonçŸ©é˜µå®ç°
```python
# é¿å…numpyä¾èµ–ï¼Œä½¿ç”¨çº¯Python
self.matrix = [[0.0 for _ in range(cols)] for _ in range(rows)]

# çŸ©é˜µæ“ä½œ
max_intensity = float(max(max(row) for row in matrix))
mean_intensity = float(sum(sum(row) for row in matrix) / (rows * cols))
```

### 6.2 å¼‚æ­¥å¯¹æ¯”åŒæ­¥åŒ–
```python
# ProductionCSVComparatoræ˜¯å¼‚æ­¥çš„ï¼Œéœ€è¦åŒæ­¥åŒ…è£…
loop = asyncio.new_event_loop()
asyncio.set_event_loop(loop)
result = loop.run_until_complete(async_function())
loop.close()
```

### 6.3 æ™ºèƒ½æ˜ å°„ç®—æ³•
```python
# ä»»æ„æ•°é‡å˜æ›´åˆ°å›ºå®šçŸ©é˜µçš„æ˜ å°„
cells_per_diff = max(1, total_cells // len(differences))
start_pos = (idx * cells_per_diff) % total_cells
row = start_pos // self.cols
col = start_pos % self.cols
```

---

## ä¸ƒã€é—®é¢˜æ€»ç»“ä¸ç»éªŒ

### 7.1 é‡åˆ°çš„å‘
1. **å­—æ®µåå‡è®¾é”™è¯¯** - å¿…é¡»å®é™…æ£€æŸ¥è¿”å›å€¼ç»“æ„
2. **å¼‚æ­¥åŒæ­¥æ··ç”¨** - asyncioäº‹ä»¶å¾ªç¯ç®¡ç†å¤æ‚
3. **ç±»å‹æ³¨è§£ç¼ºå¤±** - å¯¼è‡´NameError: name 'Dict' is not defined

### 7.2 æˆåŠŸç»éªŒ
1. **å¢é‡å¼ä¿®æ”¹** - æ¯æ¬¡åªæ”¹å¿…è¦éƒ¨åˆ†
2. **å……åˆ†æ—¥å¿—** - æ¯æ­¥éƒ½æœ‰æˆåŠŸ/å¤±è´¥æ—¥å¿—
3. **é…ç½®æ§åˆ¶** - åŠŸèƒ½å¼€å…³é¿å…å½±å“ç¨³å®šæ€§
4. **é”™è¯¯éš”ç¦»** - try-exceptä¿æŠ¤ä¸»æµç¨‹

### 7.3 è®¾è®¡äº®ç‚¹
1. **æ¨¡å—åŒ–** - æ¯ä¸ªåŠŸèƒ½ç‹¬ç«‹æ¨¡å—
2. **æ¾è€¦åˆ** - é€šè¿‡æ–‡ä»¶ä¼ é€’ï¼Œæ— å¼ºä¾èµ–
3. **å¯æµ‹è¯•** - æ¯ä¸ªæ¨¡å—å¯ç‹¬ç«‹æµ‹è¯•
4. **å¯å›æ»š** - é…ç½®å¼€å…³éšæ—¶å…³é—­

---

## å…«ã€æ–‡ä»¶å˜æ›´æ¸…å•

### 8.1 ä¿®æ”¹æ–‡ä»¶
| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | ä»£ç è¡Œæ•° | é£é™© |
|-----|---------|---------|------|
| post_download_processor.py | æ·»åŠ å¯¹æ¯”å’Œçƒ­åŠ›å›¾é›†æˆ | +85è¡Œ | ä½ |
| auto_download_config.json | å¯ç”¨æ–°åŠŸèƒ½å¼€å…³ | ä¿®æ”¹2è¡Œ | æ—  |

### 8.2 æ–°å»ºæ–‡ä»¶
| æ–‡ä»¶ | åŠŸèƒ½ | ä»£ç è¡Œæ•° |
|-----|------|---------|
| matrix_transformer.py | CSVåˆ°çŸ©é˜µè½¬æ¢ | 197è¡Œ |

### 8.3 ç”Ÿæˆæ–‡ä»¶
| æ–‡ä»¶ | å†…å®¹ | ç”¨é€” |
|-----|------|------|
| comparison_result.json | å¯¹æ¯”ç»“æœ | è°ƒè¯•åˆ†æ |
| current_heatmap_data.json | çƒ­åŠ›å›¾æ•°æ® | UIå±•ç¤º |

---

## ä¹ã€ç³»ç»Ÿç°çŠ¶è¯„ä¼°

### 9.1 åŠŸèƒ½å®Œæˆåº¦
```
ç¬¬ä¸€é˜¶æ®µ: âœ… ç‰ˆæœ¬ç®¡ç†é›†æˆ
ç¬¬äºŒé˜¶æ®µ: âœ… æ•°æ®åˆ†æä¸å¯è§†åŒ–
ç³»ç»Ÿå®Œæˆåº¦: 40% â†’ 50% â†’ 70%
```

### 9.2 æ•°æ®æµçŠ¶æ€
```
ä¹‹å‰: ä¸‹è½½ âœ… â†’ [æ–­è£‚] â†’ ç‰ˆæœ¬ç®¡ç† â†’ [æ–­è£‚] â†’ å¯¹æ¯” â†’ [æ–­è£‚] â†’ çƒ­åŠ›å›¾
ç°åœ¨: ä¸‹è½½ âœ… â†’ ç‰ˆæœ¬ç®¡ç† âœ… â†’ å¯¹æ¯”åˆ†æ âœ… â†’ çŸ©é˜µè½¬æ¢ âœ… â†’ çƒ­åŠ›å›¾ âœ…
```

### 9.3 è´¨é‡æŒ‡æ ‡
- **ä»£ç è´¨é‡**: æ¨¡å—åŒ–ã€å¯æµ‹è¯•ã€æœ‰æ—¥å¿—
- **ç¨³å®šæ€§**: é”™è¯¯éš”ç¦»ã€é…ç½®æ§åˆ¶
- **æ€§èƒ½**: <10mså¤„ç†æ—¶é—´
- **å¯ç»´æŠ¤æ€§**: æ¸…æ™°æ³¨é‡Šã€ç‹¬ç«‹æ¨¡å—

---

## åã€ä¸‹ä¸€é˜¶æ®µå»ºè®®

### 10.1 ç¬¬ä¸‰é˜¶æ®µï¼šExcelé›†æˆä¸ä¸Šä¼ 
**ç›®æ ‡**: é›†æˆExcel MCPæ ‡è®°å’Œè‡ªåŠ¨ä¸Šä¼ è…¾è®¯æ–‡æ¡£

**ä»»åŠ¡åˆ†è§£**ï¼š
1. é›†æˆExcel MCP Server
2. å®ç°åŠå¡«å……æ ‡è®°ï¼ˆlightUpçº¹ç†ï¼‰
3. æ·»åŠ AIåˆ†ææ‰¹æ³¨
4. è‡ªåŠ¨ä¸Šä¼ è…¾è®¯æ–‡æ¡£
5. UIé“¾æ¥ç»‘å®š

### 10.2 ä¼˜åŒ–å»ºè®®
1. **æ€§èƒ½ä¼˜åŒ–**: 
   - æ‰¹é‡å¤„ç†å¤šæ–‡ä»¶
   - ç¼“å­˜å¯¹æ¯”ç»“æœ
   
2. **åŠŸèƒ½å¢å¼º**:
   - æ”¯æŒæ›´å¤šæ–‡ä»¶æ ¼å¼
   - è‡ªå®šä¹‰é£é™©é˜ˆå€¼
   - å†å²è¶‹åŠ¿åˆ†æ
   
3. **ç”¨æˆ·ä½“éªŒ**:
   - WebSocketå®æ—¶æ›´æ–°
   - å¯¹æ¯”è¯¦æƒ…å±•ç¤º
   - å¯¼å‡ºæŠ¥å‘ŠåŠŸèƒ½

### 10.3 æ¶æ„æ”¹è¿›
```
å»ºè®®ç»Ÿä¸€æµ‹è¯•ç‰ˆå’Œç”Ÿäº§ç‰ˆä»£ç ï¼š
- å°†æµ‹è¯•ç‰ˆæœ¬-æ€§èƒ½ä¼˜åŒ–å¼€å‘-20250811-001430/è¿ç§»åˆ°production/
- ç»Ÿä¸€ä¾èµ–ç®¡ç†
- è§„èŒƒåŒ–æ¨¡å—å‘½å
```

---

## åä¸€ã€æ€»ç»“

### 11.1 æœ¬é˜¶æ®µæˆæœ
- âœ… å®Œæ•´è¿é€šæ•°æ®æµï¼ˆä¸‹è½½â†’ç‰ˆæœ¬â†’å¯¹æ¯”â†’çŸ©é˜µâ†’çƒ­åŠ›å›¾ï¼‰
- âœ… 100%ä¿æŠ¤æ ¸å¿ƒåŠŸèƒ½ï¼ˆæœªè§¦ç¢°ä¸‹è½½/ä¸Šä¼ ä»£ç ï¼‰
- âœ… å®ç°é…ç½®é©±åŠ¨çš„åŠŸèƒ½å¼€å…³
- âœ… å»ºç«‹é”™è¯¯éš”ç¦»æœºåˆ¶
- âœ… é€šè¿‡æ·±åº¦æµ‹è¯•éªŒè¯

### 11.2 æŠ€æœ¯åˆ›æ–°
1. **çº¯PythonçŸ©é˜µå¤„ç†** - é¿å…numpyä¾èµ–
2. **é«˜æ–¯çƒ­ç‚¹ç®—æ³•** - è‡ªç„¶çš„çƒ­åŠ›å›¾æ•ˆæœ
3. **å¼‚æ­¥åŒæ­¥æ¡¥æ¥** - å…¼å®¹ä¸åŒæ¶æ„

### 11.3 ç»éªŒä»·å€¼
æœ¬æ¬¡ä¿®å¤å……åˆ†ä½“ç°äº†"å¢é‡å¼å®‰å…¨é›†æˆ"çš„ä»·å€¼ï¼š
- ä¸ç ´åç¨³å®šåŠŸèƒ½
- é€æ­¥éªŒè¯æ¯ä¸ªç¯èŠ‚
- ä¿æŒç³»ç»Ÿå¯å›æ»š
- æ·±åº¦æµ‹è¯•æ‰¾é—®é¢˜

---

**æ–‡æ¡£ç¼–å·**: ARCH-20250829-002  
**ä¿å¯†çº§åˆ«**: å†…éƒ¨  
**ç‰ˆæœ¬**: 1.0  
**çŠ¶æ€**: æœ€ç»ˆç‰ˆ  
**ä¸‹ä¸€æ­¥**: å¯åŠ¨ç¬¬ä¸‰é˜¶æ®µExcelé›†æˆ