# 配置中心使用指南

**创建日期**: 2025-09-17
**版本**: 1.0
**作者**: 系统架构团队

## 📋 概述

配置中心是腾讯文档智能监控系统的统一配置管理系统，实现了"单一真相源（Single Source of Truth）"架构，解决了原系统中20个文件各自定义配置导致的维护困难问题。

## 🎯 核心优势

1. **配置统一**: 所有配置集中管理，消除重复定义
2. **向后兼容**: 保持原有接口不变，无缝迁移
3. **类型安全**: 配置项类型验证，减少错误
4. **易于维护**: 单一位置修改，全局生效
5. **可扩展性**: 方便添加新配置项

## 📁 配置中心结构

```
/production/config/
├── __init__.py                # 包初始化文件
├── config_center.py           # 配置中心主模块（单例模式）
├── column_definitions.py      # 列定义配置（标准19列）
├── risk_classification.py     # 风险分级配置（L1/L2/L3）
└── scoring_parameters.py      # 打分参数配置（权重、阈值等）
```

## 🔧 使用方法

### 1. 基础使用

#### 导入配置
```python
# 方式1：从配置中心直接导入
from production.config import (
    STANDARD_COLUMNS,
    L1_COLUMNS,
    L2_COLUMNS,
    L3_COLUMNS,
    get_column_weight
)

# 方式2：使用配置中心实例
from production.config import get_config_center

config = get_config_center()
columns = config.get_standard_columns()
```

#### 获取标准列定义
```python
from production.config import STANDARD_COLUMNS

# 获取所有19个标准列
for i, col in enumerate(STANDARD_COLUMNS):
    print(f"{i}: {col}")

# 输出:
# 0: 序号
# 1: 项目类型
# ...
# 14: 完成链接    （注意：不是"形成计划清单"）
# 15: 经理分析复盘  （注意：不是"进度分析总结"）
# 16: 最新复盘时间  （注意：不是"复盘时间"）
# ...
```

### 2. 风险分级使用

```python
from production.config import get_column_risk_level

# 获取列的风险级别
level = get_column_risk_level("重要程度")  # 返回 "L1"
level = get_column_risk_level("负责人")    # 返回 "L2"
level = get_column_risk_level("序号")      # 返回 "L3"
```

### 3. 权重获取

```python
from production.config import get_column_weight

# 获取列的权重
weight = get_column_weight("重要程度")  # 返回 1.4
weight = get_column_weight("负责人")    # 返回 1.2
weight = get_column_weight("序号")      # 返回 1.0（默认）
```

### 4. 配置验证

```python
from production.config import get_config_center

config = get_config_center()

# 验证列名是否正确
columns = ["序号", "项目类型", ...]  # 你的列名列表
valid, errors = config.validate_columns(columns)

if not valid:
    print("列名错误:")
    for error in errors:
        print(f"  - {error}")

# 验证配置一致性
if config.validate_config_consistency():
    print("✅ 配置一致性验证通过")
```

## 🔄 向后兼容

### 原有代码迁移

原代码无需修改即可使用配置中心：

```python
# 原代码（仍然有效）
from standard_columns_config import STANDARD_COLUMNS

# 实际上现在是从配置中心加载
# standard_columns_config.py已成为适配器
```

### 列名别名处理

配置中心自动处理历史列名：

```python
from production.config import normalize_column_name

# 自动转换旧列名为新列名
name = normalize_column_name("形成计划清单")  # 返回 "完成链接"
name = normalize_column_name("进度分析总结")  # 返回 "经理分析复盘"
name = normalize_column_name("复盘时间")      # 返回 "最新复盘时间"
```

## ⚠️ 注意事项

### 1. 列名统一

**重要**: 系统已统一使用以下列名，不再使用旧版本：

| 列索引 | 旧列名（已废弃） | 新列名（正确） |
|--------|-----------------|---------------|
| 14 | 形成计划清单 | **完成链接** |
| 15 | 进度分析总结 | **经理分析复盘** |
| 16 | 复盘时间 | **最新复盘时间** |

### 2. 缓存数据

配置中心只影响新生成的数据，不会修改已存在的缓存文件。如果发现数据仍使用旧列名：
- 检查是否读取了缓存文件
- 清理 `/scoring_results/` 目录下的旧数据
- 重新生成数据

### 3. 配置修改

所有配置修改应在配置中心文件中进行：
- **不要**在各个模块中修改配置
- **不要**创建本地配置副本
- **始终**从配置中心获取最新配置

## 📊 配置项清单

### 列定义配置
- `STANDARD_COLUMNS`: 标准19列名称
- `COLUMN_IDS`: 列的英文标识
- `COLUMN_TYPES`: 列的数据类型
- `COLUMN_WIDTHS`: 列的显示宽度
- `COLUMN_ALIASES`: 列名别名映射

### 风险分级配置
- `L1_COLUMNS`: 高风险列（7列）
- `L2_COLUMNS`: 中风险列（6列）
- `L3_COLUMNS`: 低风险列（6列）
- `RISK_LEVELS`: 风险等级详情

### 打分参数配置
- `COLUMN_WEIGHTS`: 列权重定义
- `BASE_SCORES`: 基础分配置
- `FORCE_THRESHOLDS`: 强制阈值
- `DIFFUSION_PARAMS`: 扩散算法参数
- `HEATMAP_COLOR_RANGES`: 热力图颜色映射

## 🔍 故障排查

### 问题1: 列名仍显示旧版本
**原因**: 可能在读取缓存数据
**解决**:
```bash
# 清理缓存
rm -f /root/projects/tencent-doc-manager/scoring_results/csv_comparison/latest_csv_heatmap.json
# 重启服务
systemctl restart heatmap-server
```

### 问题2: 配置未生效
**原因**: 服务未重启或有硬编码覆盖
**解决**:
1. 检查是否有硬编码的配置
2. 重启相关服务
3. 验证配置加载日志

### 问题3: 导入错误
**原因**: 路径问题或循环依赖
**解决**:
```python
# 确保路径正确
import sys
sys.path.append('/root/projects/tencent-doc-manager')

# 使用完整导入路径
from production.config import STANDARD_COLUMNS
```

## 📈 配置统计

运行以下命令查看配置统计：
```python
from production.config import get_config_center

config = get_config_center()
stats = config.get_config_stats()

print("配置统计:")
for key, value in stats.items():
    print(f"  {key}: {value}")
```

输出示例：
```
配置统计:
  total_columns: 19
  l1_columns: 7
  l2_columns: 6
  l3_columns: 6
  weighted_columns: 13
  config_items: 13
```

## 🚀 最佳实践

1. **始终使用配置中心**: 避免硬编码配置值
2. **定期验证一致性**: 运行 `validate_config_consistency()`
3. **使用类型提示**: 明确配置项类型
4. **记录配置变更**: 在Git提交中说明配置修改
5. **测试配置影响**: 修改配置后全面测试

## 📞 支持

如遇到配置相关问题：
1. 查看本文档的故障排查部分
2. 检查 `/tmp/heatmap_server.log` 日志
3. 运行配置验证脚本
4. 联系系统架构团队

---

**配置中心让系统维护更简单、更可靠！**