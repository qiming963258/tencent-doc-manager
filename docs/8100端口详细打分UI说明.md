# 8100端口详细打分UI系统说明

## 系统概述

8100端口提供了综合打分算法的Web测试界面，实现了从简化对比文件到详细打分再到综合汇总的完整流程。

**访问地址**: http://localhost:8100

## 核心架构

### 1. 详细打分算法调用链路

```
输入文件 → L1/L2/L3分类 → 打分处理 → 输出结果
```

#### 1.1 程序文件位置

| 组件 | 文件路径 | 功能描述 |
|------|----------|----------|
| **UI服务器** | `/root/projects/tencent-doc-manager/integrated_scoring_test_server.py` | 提供Web界面和API接口 |
| **打分引擎** | `/root/projects/tencent-doc-manager/production/scoring_engine/integrated_scorer.py` | 详细打分核心逻辑 |
| **L2分析器** | `/root/projects/tencent-doc-manager/production/core_modules/l2_semantic_analysis_two_layer.py` | L2列AI语义分析 |
| **API客户端** | `/root/projects/tencent-doc-manager/production/core_modules/deepseek_client.py` | DeepSeek API调用 |
| **综合汇总器** | `/root/projects/tencent-doc-manager/production/scoring_engine/comprehensive_aggregator.py` | 列级汇总处理 |

#### 1.2 输入输出文件

| 类型 | 路径模式 | 说明 |
|------|----------|------|
| **输入** | `/root/projects/tencent-doc-manager/comparison_results/simplified_*.json` | 标准化后的对比文件 |
| **详细打分输出** | `/root/projects/scoring_results/detailed/detailed_score_*.json` | 格子级打分结果 |
| **综合汇总输出** | `/root/projects/tencent-doc-manager/csv_security_results/*_comprehensive.json` | 列级汇总报告 |
| **L2分析缓存** | `/root/projects/tencent-doc-manager/semantic_results/2025_W36/*.json` | AI分析结果缓存 |

## L1/L2/L3分类打分策略

### L1列（高风险）
- **基础分**: 0.8
- **处理方式**: 纯规则打分
- **AI使用**: 否
- **典型列**: 重要程度、业务变更、具体问题、风险等级等

### L2列（中风险）⭐重点
- **基础分**: 0.5
- **处理方式**: **必须使用AI语义分析**
- **AI使用**: 是（强制，不允许降级）
- **典型列**: 项目类型、具体计划内容、邓总指导登记、负责人、协助人、监督人、形成计划清单
- **两层AI架构**:
  - 第一层：快速筛选（67%通过率）
  - 第二层：深度分析（33%需要深入评估）

### L3列（低风险）
- **基础分**: 0.2
- **处理方式**: 纯规则打分
- **AI使用**: 否
- **典型列**: 其他未分类列

## L2语义分析详细流程

### 调用链路图

```
integrated_scorer.py::process_l2_modification(mod)
    ↓
检查AI服务可用性
    ↓ 如果不可用，抛出异常（禁止降级）
l2_analyzer.analyze_single_modification(mod)
    ↓
build_layer1_prompt() → DeepSeek API调用
    ↓
判断是否需要第二层（RISKY/UNSURE或置信度<70）
    ↓ 如果需要
build_layer2_prompt() → DeepSeek API调用
    ↓
返回分析结果 {
    'layer1_result': {...},
    'layer2_result': {...},  // 可选
    'final_decision': 'APPROVE/REVIEW/REJECT',
    'approval_required': bool
}
    ↓
计算AI调整系数和置信度权重
    ↓
最终得分 = 0.5 × 变更系数 × 重要性权重 × AI调整系数 × 置信度加权
```

### AI决策映射

| AI决策 | 调整系数 | 说明 |
|--------|----------|------|
| APPROVE | 0.6 | 变更合理，风险较低 |
| CONDITIONAL | 0.8 | 有条件批准 |
| REVIEW | 1.2 | 需要人工审核 |
| REJECT | 1.5 | 拒绝，高风险 |
| UNSURE | 1.0 | 不确定，保持中立 |

### 置信度权重

| 置信度范围 | 权重 |
|------------|------|
| ≥90% | 1.0 |
| 70-89% | 0.9 |
| 50-69% | 0.8 |
| <50% | 0.7 |

## 打分公式详解

```python
# 核心公式
最终得分 = min(
    基础风险分 × 变更系数 × 重要性权重 × AI调整系数 × 置信度加权,
    1.0  # 上限截断
)

# 变更系数计算
- 完全删除: 1.5
- 内容变更: 1.0-1.2
- 格式调整: 0.7
- 新增内容: 0.8

# 重要性权重
- 关键列（如"重要程度"）: 1.4
- 标准列: 1.0
- 低影响列: 0.8
```

## 风险等级划分

| 分数范围 | 风险等级 | 颜色标记 | 图标 | 行动要求 |
|----------|----------|----------|------|----------|
| ≥0.8 | EXTREME_HIGH | 红色 | 🔴 | 立即审核 |
| 0.6-0.8 | HIGH | 橙色 | 🟠 | 人工审核 |
| 0.4-0.6 | MEDIUM | 黄色 | 🟡 | 定期检查 |
| 0.2-0.4 | LOW | 绿色 | 🟢 | 仅记录 |
| <0.2 | EXTREME_LOW | 蓝色 | 🔵 | 无需操作 |

## 系统特性

### 强制失败原则
- L2列必须使用AI分析，如果AI服务不可用，系统将报错而非降级
- 不允许任何形式的降级、备用或简化方法
- 确保L2列的语义分析质量

### 性能优化
- 批量处理：L2列按批次（每批20个）调用AI
- 两层架构：67%的修改在第一层快速通过，节省Token
- 缓存机制：相同修改不重复调用AI

### 监控指标
- AI调用成功率
- Token消耗统计
- 各风险等级分布
- L2列AI介入率

## 使用示例

### 1. 执行详细打分
```
输入: /root/projects/tencent-doc-manager/comparison_results/simplified_*.json
输出: /root/projects/scoring_results/detailed/detailed_score_*.json
```

### 2. 查看L2分析结果
打开输出文件，查找column_level为"L2"的项，可看到：
- ai_analysis字段包含完整的AI分析结果
- layer1_result: 第一层快速筛选结果
- layer2_result: 第二层深度分析结果（如有）
- final_decision: 最终AI决策
- confidence: AI置信度

### 3. 综合汇总
将多个详细打分文件汇总为列级报告，分析风险趋势和模式。

## 故障排查

### 常见问题

1. **L2列打分失败**
   - 检查环境变量：`echo $DEEPSEEK_API_KEY`
   - 确认API密钥有效
   - 查看错误日志：`/root/projects/tencent-doc-manager/logs/`

2. **AI服务不可用**
   - 系统将拒绝处理并报错（设计如此，禁止降级）
   - 需要配置有效的DeepSeek API密钥

3. **输出文件为空**
   - 检查输入文件格式是否正确
   - 确认column_name字段存在

## 配置要求

### 环境变量
```bash
export DEEPSEEK_API_KEY="your_api_key_here"
```

### Python依赖
- Flask >= 2.0
- flask-cors
- pandas（用于数据处理）
- 其他见requirements.txt

## 更新历史

- **2025-09-08**: 强制L2列使用AI，移除所有降级方法
- **2025-09-07**: 实现两层AI架构，优化Token使用
- **2025-09-06**: 初始版本，支持L1/L2/L3分类打分