#!/usr/bin/env python3
"""
é£é™©åˆ†çº§é…ç½® - L1/L2/L3åˆ—åˆ†ç±»å®šä¹‰
å®šä¹‰å„åˆ—çš„é£é™©ç­‰çº§å’Œåˆ†ç±»
åˆ›å»ºæ—¥æœŸï¼š2025-09-17

åŸºäºã€Š06-è¯¦ç»†åˆ†è¡¨æ‰“åˆ†æ–¹æ³•è§„èŒƒã€‹
"""

# =============================================================================
# L1çº§åˆ— - é«˜é£é™©åˆ—ï¼ˆ7åˆ—ï¼‰
# è¿™äº›åˆ—çš„å˜æ›´éœ€è¦é«˜åº¦å…³æ³¨ï¼Œå¯¹ä¸šåŠ¡å½±å“é‡å¤§
# =============================================================================

L1_COLUMNS = [
    "æ¥æº",              # ä»»åŠ¡æ¥æºå˜æ›´å½±å“é‡å¤§
    "ä»»åŠ¡å‘èµ·æ—¶é—´",      # æ—¶é—´çº¿å˜æ›´éœ€è¦å…³æ³¨
    "ç›®æ ‡å¯¹é½",          # ç›®æ ‡å˜æ›´æ˜¯é‡è¦äº‹é¡¹
    "å…³é”®KRå¯¹é½",        # KRå¯¹é½ç›´æ¥å½±å“ç»©æ•ˆ
    "é‡è¦ç¨‹åº¦",          # ä¼˜å…ˆçº§å˜æ›´éœ€è¦è¯„ä¼°
    "é¢„è®¡å®Œæˆæ—¶é—´",      # äº¤ä»˜æ—¶é—´å˜æ›´éœ€è¦å…³æ³¨
    "å®Œæˆè¿›åº¦"           # è¿›åº¦å˜æ›´ç›´æ¥åæ˜ æ‰§è¡ŒçŠ¶å†µ
]

# =============================================================================
# L2çº§åˆ— - ä¸­é£é™©åˆ—ï¼ˆ6åˆ—ï¼‰
# è¿™äº›åˆ—çš„å˜æ›´éœ€è¦é€‚åº¦å…³æ³¨ï¼Œå¯¹æ‰§è¡Œæœ‰ä¸€å®šå½±å“
# =============================================================================

L2_COLUMNS = [
    "é¡¹ç›®ç±»å‹",          # ç±»å‹å˜æ›´å½±å“èµ„æºåˆ†é…
    "å…·ä½“è®¡åˆ’å†…å®¹",      # å†…å®¹å˜æ›´å½±å“æ‰§è¡Œæ–¹æ¡ˆ
    "é‚“æ€»æŒ‡å¯¼ç™»è®°",      # é¢†å¯¼æŒ‡å¯¼éœ€è¦é‡è§†
    "è´Ÿè´£äºº",            # è´Ÿè´£äººå˜æ›´å½±å“æ‰§è¡Œ
    "ååŠ©äºº",            # ååŠ©äººå˜æ›´å½±å“åä½œ
    "ç›‘ç£äºº"             # ç›‘ç£äººå˜æ›´å½±å“ç®¡æ§
]

# =============================================================================
# L3çº§åˆ— - ä½é£é™©åˆ—ï¼ˆ6åˆ—ï¼‰
# è¿™äº›åˆ—çš„å˜æ›´å½±å“è¾ƒå°ï¼Œä¸»è¦æ˜¯å‚è€ƒæ€§ä¿¡æ¯
# =============================================================================

L3_COLUMNS = [
    "åºå·",              # ä»…ä¸ºæ ‡è¯†ï¼Œæ— å®è´¨å½±å“
    "å®Œæˆé“¾æ¥",          # å‚è€ƒæ€§ä¿¡æ¯
    "ç»ç†åˆ†æå¤ç›˜",      # äº‹ååˆ†æï¼Œå‚è€ƒä»·å€¼
    "æœ€æ–°å¤ç›˜æ—¶é—´",      # æ—¶é—´è®°å½•ï¼Œå‚è€ƒä¿¡æ¯
    "å¯¹ä¸Šæ±‡æŠ¥",          # æ±‡æŠ¥è®°å½•ï¼Œå‚è€ƒä¿¡æ¯
    "åº”ç”¨æƒ…å†µ"           # åº”ç”¨è®°å½•ï¼Œå‚è€ƒä¿¡æ¯
]

# =============================================================================
# é£é™©ç­‰çº§å®šä¹‰
# =============================================================================

RISK_LEVELS = {
    "L1": {
        "name": "é«˜é£é™©",
        "base_score": 0.8,     # L1åŸºç¡€åˆ†
        "min_score": 0.8,       # L1æœ€ä½åˆ†ï¼ˆå¼ºåˆ¶é˜ˆå€¼ï¼‰
        "color": "#FF4444",     # çº¢è‰²
        "description": "å…³é”®ä¸šåŠ¡åˆ—ï¼Œå˜æ›´éœ€é«˜åº¦å…³æ³¨"
    },
    "L2": {
        "name": "ä¸­é£é™©",
        "base_score": 0.5,     # L2åŸºç¡€åˆ†
        "min_score": 0.6,       # L2æœ€ä½åˆ†ï¼ˆå¼ºåˆ¶é˜ˆå€¼ï¼‰
        "color": "#FFB144",     # æ©™è‰²
        "description": "é‡è¦æ‰§è¡Œåˆ—ï¼Œå˜æ›´éœ€é€‚åº¦å…³æ³¨"
    },
    "L3": {
        "name": "ä½é£é™©",
        "base_score": 0.2,     # L3åŸºç¡€åˆ†
        "min_score": 0.0,       # L3æ— æœ€ä½åˆ†è¦æ±‚
        "color": "#44FF44",     # ç»¿è‰²
        "description": "å‚è€ƒä¿¡æ¯åˆ—ï¼Œå˜æ›´å½±å“è¾ƒå°"
    }
}

# =============================================================================
# è¾…åŠ©å‡½æ•°
# =============================================================================

def get_column_risk_level(column_name: str) -> str:
    """
    è·å–åˆ—çš„é£é™©çº§åˆ«
    è¿”å›: 'L1', 'L2', 'L3' æˆ– None
    """
    if column_name in L1_COLUMNS:
        return "L1"
    elif column_name in L2_COLUMNS:
        return "L2"
    elif column_name in L3_COLUMNS:
        return "L3"
    else:
        # æœªçŸ¥åˆ—é»˜è®¤ä¸ºL3
        return "L3"


def get_risk_info(risk_level: str) -> dict:
    """è·å–é£é™©ç­‰çº§çš„è¯¦ç»†ä¿¡æ¯"""
    return RISK_LEVELS.get(risk_level, RISK_LEVELS["L3"])


def get_base_score(column_name: str) -> float:
    """æ ¹æ®åˆ—åè·å–åŸºç¡€åˆ†"""
    risk_level = get_column_risk_level(column_name)
    risk_info = get_risk_info(risk_level)
    return risk_info["base_score"]


def validate_risk_classification() -> tuple[bool, list]:
    """
    éªŒè¯é£é™©åˆ†ç±»çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§
    è¿”å›: (æ˜¯å¦æœ‰æ•ˆ, é”™è¯¯ä¿¡æ¯åˆ—è¡¨)
    """
    from .column_definitions import STANDARD_COLUMNS

    errors = []

    # 1. æ£€æŸ¥åˆ—æ•°é‡
    total_classified = len(L1_COLUMNS) + len(L2_COLUMNS) + len(L3_COLUMNS)
    if total_classified != 19:
        errors.append(f"åˆ†ç±»åˆ—æ€»æ•°ä¸æ­£ç¡®ï¼šæœŸæœ›19åˆ—ï¼Œå®é™…{total_classified}åˆ—")

    # 2. æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤
    l1_set = set(L1_COLUMNS)
    l2_set = set(L2_COLUMNS)
    l3_set = set(L3_COLUMNS)

    if l1_set & l2_set:
        errors.append(f"L1å’ŒL2æœ‰é‡å¤åˆ—: {l1_set & l2_set}")
    if l2_set & l3_set:
        errors.append(f"L2å’ŒL3æœ‰é‡å¤åˆ—: {l2_set & l3_set}")
    if l1_set & l3_set:
        errors.append(f"L1å’ŒL3æœ‰é‡å¤åˆ—: {l1_set & l3_set}")

    # 3. æ£€æŸ¥æ˜¯å¦éƒ½åœ¨æ ‡å‡†åˆ—ä¸­
    all_classified = l1_set | l2_set | l3_set
    standard_set = set(STANDARD_COLUMNS)

    missing = standard_set - all_classified
    if missing:
        errors.append(f"ä»¥ä¸‹æ ‡å‡†åˆ—æœªåˆ†ç±»: {missing}")

    extra = all_classified - standard_set
    if extra:
        errors.append(f"ä»¥ä¸‹åˆ—ä¸åœ¨æ ‡å‡†åˆ—ä¸­: {extra}")

    return len(errors) == 0, errors


if __name__ == "__main__":
    # æµ‹è¯•
    print("ğŸ“Š é£é™©åˆ†çº§é…ç½®")
    print("=" * 60)

    print(f"\nğŸ”´ L1çº§åˆ—ï¼ˆé«˜é£é™©ï¼Œ{len(L1_COLUMNS)}åˆ—ï¼‰:")
    for col in L1_COLUMNS:
        print(f"  - {col}")

    print(f"\nğŸŸ  L2çº§åˆ—ï¼ˆä¸­é£é™©ï¼Œ{len(L2_COLUMNS)}åˆ—ï¼‰:")
    for col in L2_COLUMNS:
        print(f"  - {col}")

    print(f"\nğŸŸ¢ L3çº§åˆ—ï¼ˆä½é£é™©ï¼Œ{len(L3_COLUMNS)}åˆ—ï¼‰:")
    for col in L3_COLUMNS:
        print(f"  - {col}")

    print("\nğŸ” éªŒè¯é£é™©åˆ†ç±»...")
    valid, errors = validate_risk_classification()
    if valid:
        print("âœ… é£é™©åˆ†ç±»éªŒè¯é€šè¿‡")
    else:
        print("âŒ é£é™©åˆ†ç±»éªŒè¯å¤±è´¥:")
        for error in errors:
            print(f"  - {error}")

    print(f"\nğŸ“ˆ ç»Ÿè®¡:")
    print(f"  æ€»åˆ—æ•°: {len(L1_COLUMNS) + len(L2_COLUMNS) + len(L3_COLUMNS)}")
    print(f"  L1åˆ—æ•°: {len(L1_COLUMNS)}")
    print(f"  L2åˆ—æ•°: {len(L2_COLUMNS)}")
    print(f"  L3åˆ—æ•°: {len(L3_COLUMNS)}")