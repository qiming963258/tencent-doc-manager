# 腾讯文档监控系统 - UI数据需求完整说明
**日期**: 2025-09-15
**版本**: 1.0

## 🔴 问题根源分析

### 当前数据流断层情况

```
CSV对比结果 → 详细打分 → 综合打分 → UI显示
    ↓            ↓           ↓          ↓
 6个真实修改   18个假修改   假数据     错误显示
```

### 具体问题

1. **CSV对比结果（真实数据）**
   - 文件：`comparison_results/simplified_*.json`
   - 实际修改：6个（C4、E6、G8、I11、J12、M14）
   - 这是真实的对比结果

2. **详细打分文件（生成的假数据）**
   - 文件：`scoring_results/detailed/detailed_score_*.json`
   - 显示修改：18个（每列一个，从行3到行19）
   - 明显是生成的测试数据，与CSV对比不符

3. **综合打分文件（混乱数据）**
   - 文件：`scoring_results/comprehensive/comprehensive_score_*.json`
   - column_scores：包含示例数据（如任务发起时间[5,10,15,20,25]）
   - 这些数据既不匹配CSV对比，也不匹配详细打分

4. **UI显示（完全错误）**
   - 显示的修改位置与任何数据源都不匹配
   - 右侧一维图显示错误的修改位置

## ✅ UI所需的完整参数清单

### 1. 热力图主体（19×N矩阵）
```json
{
  "heatmap_data": [
    [0.8, 0.1, 0.1, 0.8, 0.8, 0.9, ...],  // 第一个表格19列的热力值
    [0.1, 0.1, 0.1, 0.1, 0.1, 0.1, ...]   // 第二个表格19列的热力值
  ]
}
```

### 2. 表格信息
```json
{
  "tables": [
    {
      "name": "出国销售计划表",
      "total_rows": 270,              // 真实CSV行数
      "total_modifications": 6,       // 真实修改总数
      "risk_level": "L3",
      "url": "https://docs.qq.com/..."
    }
  ]
}
```

### 3. 列信息（标准19列）
```json
{
  "columns": [
    "任务发起时间", "任务类型", "当前任务状态", "任务截止时间",
    "主类目", "风险等级", "责任人", "协作人员", "进度百分比",
    "备注信息", "创建时间", "最后更新", "审批状态", "优先级",
    "任务标签", "相关文档", "预算金额", "实际花费", "完成情况"
  ]
}
```

### 4. 右侧一维图数据（关键！）
```json
{
  "row_level_data": {
    "项目类型": {
      "modified_rows": [4],           // C4修改（基于CSV对比）
      "aggregated_score": 0.8,
      "modifications": 1
    },
    "来源": {
      "modified_rows": [],            // 无修改
      "aggregated_score": 0,
      "modifications": 0
    },
    "任务发起时间": {
      "modified_rows": [6],           // E6修改
      "aggregated_score": 0.1,
      "modifications": 1
    },
    "目标对齐": {
      "modified_rows": [],            // 无修改
      "aggregated_score": 0,
      "modifications": 0
    },
    "关键KR对齐": {
      "modified_rows": [8],           // G8修改
      "aggregated_score": 0.8,
      "modifications": 1
    },
    // ... 其他列类似
  }
}
```

### 5. 统计信息
```json
{
  "statistics": {
    "total_modifications": 6,         // 基于CSV对比
    "hot_cells": 3,                  // 高风险修改数
    "risk_distribution": {
      "L1": 2,
      "L2": 1,
      "L3": 3
    }
  }
}
```

## 📊 数据映射关系

### CSV列号 → 标准列名映射
```
A (1)  → 序号
B (2)  → 项目管理ID
C (3)  → 项目类型
D (4)  → 来源
E (5)  → 任务发起时间
F (6)  → 目标对齐
G (7)  → 关键KR对齐
H (8)  → 具体计划内容
I (9)  → 邓总指导登记
J (10) → 负责人
K (11) → 协助人
L (12) → 监督人
M (13) → 重要程度
N (14) → 预计完成时间
O (15) → 完成进度
P (16) → 完成链接
Q (17) → 经理分析复盘
R (18) → 最新复盘时间
S (19) → 对上汇报
T (20) → 应用情况
```

### 标准19列（用于UI显示）
```
1. 任务发起时间 (E列)
2. 任务类型 (C列)
3. 当前任务状态 (D列)
4. 任务截止时间 (N列)
5. 主类目 (F列)
6. 风险等级 (G列)
7. 责任人 (J列)
8. 协作人员 (K列)
9. 进度百分比 (O列)
10. 备注信息 (H列)
11. 创建时间 (新增虚拟列)
12. 最后更新 (R列)
13. 审批状态 (新增虚拟列)
14. 优先级 (M列)
15. 任务标签 (新增虚拟列)
16. 相关文档 (P列)
17. 预算金额 (新增虚拟列)
18. 实际花费 (新增虚拟列)
19. 完成情况 (S列)
```

## 🔧 修复方案

### 1. 基于真实CSV对比重建数据流
```python
# 从CSV对比结果构建真实的modified_rows
csv_comparison = {
    "C4": "项目类型",
    "E6": "任务发起时间",
    "G8": "关键KR对齐",
    "I11": "邓总指导登记",
    "J12": "负责人",
    "M14": "预计完成时间"
}

# 转换为标准列的修改信息
standard_column_modifications = {
    "任务类型": [4],        # C列 → 任务类型
    "任务发起时间": [6],    # E列 → 任务发起时间
    "风险等级": [8],        # G列 → 风险等级
    "备注信息": [11],       # I列 → 备注信息（邓总指导）
    "责任人": [12],         # J列 → 责任人
    "任务截止时间": [14]    # M列 → 任务截止时间（预计完成）
}
```

### 2. 修正综合打分文件
- 删除假的column_scores数据
- 基于真实CSV对比结果重建
- 确保total_rows和modified_rows准确

### 3. 修复UI显示逻辑
- 读取正确的column_scores数据
- 正确映射到19个标准列
- 在右侧一维图显示真实修改位置

## 📝 测试用例

### 正确的UI显示应该是：
1. **热力图第二行（出国销售计划表）**
   - 第2列（任务类型）：有热力值（C4修改）
   - 第1列（任务发起时间）：有热力值（E6修改）
   - 第6列（风险等级）：有热力值（G8修改）
   - 第10列（备注信息）：有热力值（I11修改）
   - 第7列（责任人）：有热力值（J12修改）
   - 第4列（任务截止时间）：有热力值（M14修改）
   - 其他列：蓝色（无修改）

2. **右侧一维图**
   - 总刻度：270行
   - 修改标记：在第4、6、8、11、12、14行位置

## 🚨 当前紧急修复项

1. **立即修复综合打分文件的column_scores**
2. **确保UI读取真实数据而非示例数据**
3. **验证列名映射的正确性**

## 📌 结论

整个系统的数据流存在严重断层：
- CSV对比产生真实数据（6个修改）
- 详细打分使用假数据（18个修改）
- 综合打分使用示例数据（错误的modified_rows）
- UI显示完全错误

需要从CSV对比结果开始，重新构建整个数据流，确保每个环节使用真实数据。