# 综合打分数据流向图

## 🗺️ 数据流向全景图

```
┌─────────────────────────────────────────────────────────────────────┐
│                     综合打分JSON文件 (唯一数据源)                      │
│                /tmp/comprehensive_scoring_data.json                 │
└────────────────────────┬────────────────────────────────────────────┘
                         │
                         ▼
         ┌───────────────────────────────────┐
         │        Flask服务器加载            │
         │   COMPREHENSIVE_MODE = True       │
         └───────────────┬───────────────────┘
                         │
        ┌────────────────┼────────────────┐
        ▼                ▼                ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│   API端点1   │ │   API端点2   │ │   API端点3   │
│  /api/data   │ │/api/detailed│ │/api/document │
└──────┬───────┘ └──────┬───────┘ └──────┬───────┘
       │                │                │
       └────────────────┼────────────────┘
                        ▼
              ┌─────────────────┐
              │  React前端获取   │
              └────────┬─────────┘
                       │
    ┌──────────────────┼──────────────────┐
    ▼                  ▼                  ▼
┌─────────┐    ┌──────────────┐    ┌──────────┐
│ 热力图  │    │ 右侧分布图    │    │ 统计面板 │
└─────────┘    └──────────────┘    └──────────┘
```

## 📊 五个关键内容的数据映射

### 1️⃣ table_names → UI组件映射

```
comprehensive_data.table_names[]
           │
           ├──→ 热力图Y轴标签
           │    └─ 每个表格名称作为一行
           │
           ├──→ 下拉选择框选项
           │    └─ 用户可选择查看特定表格
           │
           └──→ 导航侧边栏
                └─ 表格快速跳转列表
```

### 2️⃣ column_avg_scores → UI组件映射

```
comprehensive_data.column_avg_scores{}
           │
           ├──→ 热力图顶部风险指标条
           │    └─ 19个列的平均风险值
           │
           ├──→ 列风险排行榜
           │    └─ 按风险值排序显示
           │
           └──→ 风险趋势图
                └─ 显示各列的风险分布
```

### 3️⃣ column_scores详细数据 → UI组件映射

```
table_scores[].column_scores{}
           │
           ├─ avg_score ──────→ 热力图单元格颜色
           │                    ├─ ≥0.8 → 红色
           │                    ├─ ≥0.6 → 橙色
           │                    ├─ ≥0.4 → 黄色
           │                    ├─ ≥0.1 → 绿色
           │                    └─ <0.1 → 蓝色
           │
           ├─ modified_rows[] ─→ 悬停弹窗
           │                    └─ "修改行：5, 12, 28"
           │
           ├─ row_scores[] ───→ 详细风险列表
           │                    └─ "行5: 0.95 (高风险)"
           │
           ├─ column_level ───→ 列级别标识
           │                    ├─ L1 → 🔴红点标记
           │                    ├─ L2 → 🟡黄点标记
           │                    └─ L3 → 🟢绿点标记
           │
           └─ ai_decisions[] ─→ AI建议图标（仅L2）
                               ├─ APPROVE → ✅
                               ├─ REVIEW → ⚠️
                               └─ REJECT → ❌
```

### 4️⃣ table_url → 链接跳转

```
table_scores[].table_url
           │
           ├──→ 表格名称点击事件
           │    └─ window.open(url, '_blank')
           │
           ├──→ 右键菜单"在新标签页打开"
           │
           └──→ 快捷键 Ctrl+Click
                └─ 直接跳转腾讯文档
```

### 5️⃣ total_modifications → 统计显示

```
comprehensive_data.total_modifications
           │
           ├──→ 页面顶部大数字显示
           │    └─ "总修改: 499"
           │
           ├──→ 仪表盘核心指标
           │    └─ 圆形进度图
           │
           └──→ 标题栏动态更新
                └─ document.title = "热力图 (499改)"
```

## 🔄 实时数据更新流程

```
用户操作
   │
   ├─ 鼠标悬停单元格
   │     ↓
   │  获取 table_id + column_name
   │     ↓
   │  读取 table_scores[table_id].column_scores[column_name]
   │     ↓
   │  显示悬停详情弹窗
   │
   ├─ 点击表格名称
   │     ↓
   │  获取 table_scores[table_id].table_url
   │     ↓
   │  新标签页打开腾讯文档
   │
   └─ 切换视图模式
         ↓
      重新渲染热力图矩阵
```

## 🎨 颜色计算流程

```
获取分数值 (avg_score)
        │
        ▼
┌──────────────────┐
│  score >= 0.8 ?  │───是──→ 返回 #FF0000 (红色)
└────────┬─────────┘
         │否
         ▼
┌──────────────────┐
│  score >= 0.6 ?  │───是──→ 返回 #FFA500 (橙色)
└────────┬─────────┘
         │否
         ▼
┌──────────────────┐
│  score >= 0.4 ?  │───是──→ 返回 #FFFF00 (黄色)
└────────┬─────────┘
         │否
         ▼
┌──────────────────┐
│  score >= 0.1 ?  │───是──→ 返回 #00FF00 (绿色)
└────────┬─────────┘
         │否
         ▼
    返回 #0000FF (蓝色)
```

## 📐 数据结构层级关系

```
comprehensive_scoring_data.json
├── generation_time          [元数据]
├── scoring_version          [元数据]
├── scoring_standard         [元数据]
│
├── table_names[]            [关键内容1] ─→ Y轴
│   ├── "表格1"
│   ├── "表格2"
│   └── "表格3"
│
├── column_avg_scores{}      [关键内容2] ─→ 顶部指标
│   ├── "序号": 0.85
│   ├── "项目类型": 0.92
│   └── ... (19个列)
│
├── table_scores[]           [关键内容3&4] ─→ 矩阵数据
│   └── [表格对象]
│       ├── table_id
│       ├── table_name
│       ├── table_url       [关键内容4] ─→ 链接跳转
│       ├── total_rows
│       ├── total_modifications
│       ├── overall_risk_score
│       └── column_scores{}  [关键内容3] ─→ 单元格
│           └── [列名]
│               ├── column_level (L1/L2/L3)
│               ├── avg_score ─────────→ 颜色
│               ├── modified_rows[] ────→ 行号列表
│               ├── row_scores[] ───────→ 打分列表
│               ├── modifications
│               ├── ai_decisions[] (仅L2)
│               └── ai_confidence[] (仅L2)
│
├── total_modifications      [关键内容5] ─→ 总统计
│
└── risk_summary{}           [附加统计]
    ├── high_risk_count
    ├── medium_risk_count
    └── low_risk_count
```

## 🔍 数据访问路径示例

### 获取特定单元格数据
```javascript
// 获取第2个表格的"负责人"列数据
let cellData = comprehensive_data
               .table_scores[1]        // 第2个表格(索引1)
               .column_scores["负责人"]; // 负责人列

// cellData包含：
// {
//   column_level: "L2",
//   avg_score: 0.55,
//   modified_rows: [8, 15, 22],
//   row_scores: [0.45, 0.52, 0.58],
//   modifications: 3,
//   ai_decisions: ["APPROVE", "REVIEW", "REVIEW"]
// }
```

### 获取表格URL
```javascript
// 获取第1个表格的腾讯文档链接
let url = comprehensive_data
          .table_scores[0]      // 第1个表格
          .table_url;           // URL字段

// url = "https://docs.qq.com/sheet/DWEFNU25TemFnZXJN"
```

### 计算列的整体风险
```javascript
// 获取"项目类型"列的整体风险
let columnRisk = comprehensive_data
                 .column_avg_scores["项目类型"];

// columnRisk = 0.92 (极高风险)
```

## 🚦 数据验证检查点

```
服务器启动
    │
    ▼
加载comprehensive_scoring_data.json
    │
    ├─ 检查文件是否存在 ──────→ 否 → 报错退出
    │                        是↓
    ├─ 验证JSON格式 ─────────→ 无效 → 报错退出
    │                        有效↓
    ├─ 验证五个关键内容 ──────→ 缺失 → 报错退出
    │                        完整↓
    ├─ 验证打分规则 ─────────→ 违规 → 报错退出
    │                        合规↓
    └─ 启动成功，提供API服务
```

---

**文档说明**：本图表展示了综合打分数据从JSON文件到UI组件的完整流向，以及各个字段的具体映射关系。

**更新时间**：2025-09-13