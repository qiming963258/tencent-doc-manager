# ç®€åŒ–ç‰ˆçƒ­åŠ›å›¾æ˜ å°„æµç¨‹è¯´æ˜

## ä¸€ã€æ ¸å¿ƒç†å¿µ

**ç›´æ¥æ˜ å°„ï¼Œæ— éœ€è®¡ç®—**ï¼šå–æ¶ˆçƒ­åŠ›å›¾UIçš„æ‰€æœ‰æ‰“åˆ†é€»è¾‘ï¼Œç›´æ¥ä½¿ç”¨ç»¼åˆæ‰“åˆ†çš„`aggregated_score`ä½œä¸ºçƒ­åŠ›å€¼ã€‚

## äºŒã€æ˜ å°„è§„åˆ™ï¼ˆæç®€ä¸‰æ­¥ï¼‰

### ç¬¬1æ­¥ï¼šè¡¨æ ¼å â†’ è¡Œä½ç½®
```python
table_row_mapping = {
    "å‰¯æœ¬-æµ‹è¯•ç‰ˆæœ¬-å‡ºå›½é”€å”®è®¡åˆ’è¡¨": (0, 10),   # ç¬¬1ä¸ªè¡¨æ ¼å ç”¨è¡Œ0-9
    "å‰¯æœ¬-æµ‹è¯•ç‰ˆæœ¬-å›å›½é”€å”®è®¡åˆ’è¡¨": (10, 20),  # ç¬¬2ä¸ªè¡¨æ ¼å ç”¨è¡Œ10-19
    "æµ‹è¯•ç‰ˆæœ¬-å°çº¢ä¹¦éƒ¨é—¨": (20, 30)            # ç¬¬3ä¸ªè¡¨æ ¼å ç”¨è¡Œ20-29
}
```

### ç¬¬2æ­¥ï¼šåˆ—å â†’ åˆ—ä½ç½®
```python
standard_columns = [
    "åºå·",           # åˆ—0
    "é¡¹ç›®ç±»å‹",       # åˆ—1
    "æ¥æº",           # åˆ—2
    "ä»»åŠ¡å‘èµ·æ—¶é—´",   # åˆ—3
    "ç›®æ ‡å¯¹é½",       # åˆ—4
    "å…³é”®KRå¯¹é½",     # åˆ—5
    "å…·ä½“è®¡åˆ’å†…å®¹",   # åˆ—6
    "é‚“æ€»æŒ‡å¯¼ç™»è®°",   # åˆ—7
    "è´Ÿè´£äºº",         # åˆ—8
    "ååŠ©äºº",         # åˆ—9
    "ç›‘ç£äºº",         # åˆ—10
    "é‡è¦ç¨‹åº¦",       # åˆ—11
    "é¢„è®¡å®Œæˆæ—¶é—´",   # åˆ—12
    "å®Œæˆè¿›åº¦",       # åˆ—13
    "å½¢æˆè®¡åˆ’æ¸…å•",   # åˆ—14
    "å¤ç›˜æ—¶é—´",       # åˆ—15
    "å¯¹ä¸Šæ±‡æŠ¥",       # åˆ—16
    "åº”ç”¨æƒ…å†µ",       # åˆ—17
    "è¿›åº¦åˆ†ææ€»ç»“"    # åˆ—18
]
```

### ç¬¬3æ­¥ï¼šåˆ†æ•° â†’ çƒ­åŠ›å€¼
```python
# ç›´æ¥èµ‹å€¼ï¼Œæ— éœ€ä»»ä½•è®¡ç®—ï¼
matrix[row][col] = aggregated_score
```

## ä¸‰ã€æ•°æ®æµç¤ºä¾‹

### è¾“å…¥æ•°æ®ï¼ˆç»¼åˆæ‰“åˆ†ï¼‰
```json
{
  "table_scores": [{
    "table_name": "å‰¯æœ¬-æµ‹è¯•ç‰ˆæœ¬-å‡ºå›½é”€å”®è®¡åˆ’è¡¨",
    "column_scores": {
      "é¡¹ç›®ç±»å‹": {
        "aggregated_score": 0.58  // è¿™ä¸ªå€¼ç›´æ¥æˆä¸ºçƒ­åŠ›å€¼
      },
      "ä»»åŠ¡å‘èµ·æ—¶é—´": {
        "aggregated_score": 0.975  // è¿™ä¸ªå€¼ç›´æ¥æˆä¸ºçƒ­åŠ›å€¼
      }
    }
  }]
}
```

### æ˜ å°„è¿‡ç¨‹
```
1. "å‰¯æœ¬-æµ‹è¯•ç‰ˆæœ¬-å‡ºå›½é”€å”®è®¡åˆ’è¡¨" â†’ è¡Œ0-9
2. "é¡¹ç›®ç±»å‹" â†’ åˆ—1
3. matrix[0-9][1] = 0.58  // 10ä¸ªå•å…ƒæ ¼éƒ½å¡«å……0.58

4. "ä»»åŠ¡å‘èµ·æ—¶é—´" â†’ åˆ—3
5. matrix[0-9][3] = 0.975  // 10ä¸ªå•å…ƒæ ¼éƒ½å¡«å……0.975
```

### è¾“å‡ºçŸ©é˜µï¼ˆ30Ã—19ï¼‰
```
       åˆ—0   åˆ—1   åˆ—2   åˆ—3   åˆ—4  ...  åˆ—18
è¡Œ0   [0.05][0.58][0.05][0.975][0.05]...[0.05]
è¡Œ1   [0.05][0.58][0.05][0.975][0.05]...[0.05]
...
è¡Œ9   [0.05][0.58][0.05][0.975][0.05]...[0.05]
è¡Œ10  [0.12][0.05][0.05][0.05][0.05]...[0.05]  â† ç¬¬äºŒä¸ªè¡¨æ ¼
...
è¡Œ29  [0.05][0.05][0.05][0.05][0.05]...[0.05]  â† ç¬¬ä¸‰ä¸ªè¡¨æ ¼
```

## å››ã€å®Œæ•´æ•°æ®æµ

```mermaid
graph LR
    A[ç»¼åˆæ‰“åˆ†JSON] --> B[æå–aggregated_score]
    B --> C[æŸ¥æ‰¾è¡¨æ ¼è¡Œä½ç½®]
    C --> D[æŸ¥æ‰¾åˆ—ç´¢å¼•]
    D --> E[ç›´æ¥å¡«å……çŸ©é˜µ]
    E --> F[é«˜æ–¯å¹³æ»‘ä¼˜åŒ–]
    F --> G[çƒ­åŠ›å›¾æ¸²æŸ“]
```

## äº”ã€å®é™…æ˜ å°„ç¤ºä¾‹ï¼ˆW37æ•°æ®ï¼‰

### è¡¨æ ¼1ï¼šå‡ºå›½é”€å”®è®¡åˆ’è¡¨ï¼ˆè¡Œ0-9ï¼‰
| åˆ—å | åˆ—ç´¢å¼• | aggregated_score | å¡«å……ä½ç½® |
|------|--------|-----------------|----------|
| é¡¹ç›®ç±»å‹ | 1 | 0.58 | matrix[0-9][1] = 0.58 |
| ä»»åŠ¡å‘èµ·æ—¶é—´ | 3 | 0.975 | matrix[0-9][3] = 0.975 |
| å…³é”®KRå¯¹é½ | 5 | 0.8 | matrix[0-9][5] = 0.8 |
| è´Ÿè´£äºº | 8 | 0.70 | matrix[0-9][8] = 0.70 |
| é¢„è®¡å®Œæˆæ—¶é—´ | 12 | 0.96 | matrix[0-9][12] = 0.96 |

### è¡¨æ ¼2ï¼šå›å›½é”€å”®è®¡åˆ’è¡¨ï¼ˆè¡Œ10-19ï¼‰
| åˆ—å | åˆ—ç´¢å¼• | aggregated_score | å¡«å……ä½ç½® |
|------|--------|-----------------|----------|
| åºå· | 0 | 0.12 | matrix[10-19][0] = 0.12 |
| é‡è¦ç¨‹åº¦ | 11 | 0.877 | matrix[10-19][11] = 0.877 |
| å®Œæˆè¿›åº¦ | 13 | 0.45 | matrix[10-19][13] = 0.45 |
| å¯¹ä¸Šæ±‡æŠ¥ | 16 | 0.65 | matrix[10-19][16] = 0.65 |

### è¡¨æ ¼3ï¼šå°çº¢ä¹¦éƒ¨é—¨ï¼ˆè¡Œ20-29ï¼‰
| åˆ—å | åˆ—ç´¢å¼• | aggregated_score | å¡«å……ä½ç½® |
|------|--------|-----------------|----------|
| é‚“æ€»æŒ‡å¯¼ç™»è®° | 7 | 0.55 | matrix[20-29][7] = 0.55 |
| ååŠ©äºº | 9 | 0.18 | matrix[20-29][9] = 0.18 |
| å½¢æˆè®¡åˆ’æ¸…å• | 14 | 0.48 | matrix[20-29][14] = 0.48 |
| åº”ç”¨æƒ…å†µ | 17 | 0.22 | matrix[20-29][17] = 0.22 |

## å…­ã€è§†è§‰æ•ˆæœï¼ˆä¿æŒä¸å˜ï¼‰

### é¢œè‰²æ˜ å°„ï¼ˆè‡ªåŠ¨æ ¹æ®åˆ†æ•°å€¼ï¼‰
- **0.0-0.2**: ğŸŸ¦ æ·±è“è‰²ï¼ˆä½é£é™©ï¼‰
- **0.2-0.4**: ğŸŸ© ç»¿è‰²ï¼ˆè¾ƒä½é£é™©ï¼‰
- **0.4-0.6**: ğŸŸ¨ é»„è‰²ï¼ˆä¸­ç­‰é£é™©ï¼‰
- **0.6-0.8**: ğŸŸ§ æ©™è‰²ï¼ˆè¾ƒé«˜é£é™©ï¼‰
- **0.8-1.0**: ğŸŸ¥ çº¢è‰²ï¼ˆé«˜é£é™©ï¼‰

### ä¿ç•™çš„æ¸²æŸ“åŠŸèƒ½
1. **IDWæ’å€¼**ï¼šå¤„ç†ç¨€ç–æ•°æ®ï¼Œç”Ÿæˆè¿ç»­åœº
2. **ä¸‰å±‚èšç±»**ï¼šçƒ­å—èšé›†ï¼Œä¼˜åŒ–æ’åˆ—
3. **é«˜æ–¯å¹³æ»‘**ï¼šè½»å¾®æ¨¡ç³Šï¼Œæ”¹å–„è§†è§‰
4. **FLIRè‰²å½©**ï¼šæ ‡å‡†çƒ­æˆåƒé…è‰²

## ä¸ƒã€APIè°ƒç”¨

### è¯·æ±‚
```bash
GET /api/scoring_enhanced_heatmap?week=37
```

### å“åº”
```json
{
  "heatmap_data": [[...]],      // 30Ã—19çŸ©é˜µ
  "table_names": [...],          // 30ä¸ªè¡¨æ ¼å
  "column_names": [...],         // 19ä¸ªåˆ—å
  "row_order": [0,1,2,...,29],  // è¡Œé¡ºåº
  "col_order": [0,1,2,...,18],  // åˆ—é¡ºåº
  "statistics": {
    "average_risk_score": 0.560,  // ç›´æ¥åæ˜ ç»¼åˆæ‰“åˆ†
    "high_risk_count": 120,       // >0.7çš„å•å…ƒæ ¼æ•°
    "medium_risk_count": 150      // 0.4-0.7çš„å•å…ƒæ ¼æ•°
  },
  "metadata": {
    "mapper_version": "v2.0-simple"  // ç®€åŒ–ç‰ˆæ ‡è¯†
  }
}
```

## å…«ã€ä¼˜åŠ¿æ€»ç»“

### ç®€åŒ–å‰ï¼ˆå¤æ‚ç‰ˆï¼‰
```python
# 5æ­¥è®¡ç®—
base_heat = risk_level_mapping[column_level]  # L1:0.8, L2:0.5, L3:0.2
modification_weight = min(1.0, modifications / 5)
ai_factor = calculate_ai_impact(ai_decisions)
trend_factor = trend_mapping[risk_trend]
heat_value = base_heat * aggregated_score * modification_weight * ai_factor * trend_factor
```

### ç®€åŒ–åï¼ˆå½“å‰ç‰ˆï¼‰
```python
# 1æ­¥å®Œæˆ
heat_value = aggregated_score  # å°±è¿™ä¹ˆç®€å•ï¼
```

### æ•ˆæœå¯¹æ¯”
| æŒ‡æ ‡ | ç®€åŒ–å‰ | ç®€åŒ–å |
|------|--------|--------|
| ä»£ç è¡Œæ•° | 475è¡Œ | 290è¡Œ |
| è®¡ç®—å¤æ‚åº¦ | O(nÃ—mÃ—5) | O(nÃ—m) |
| ç»´æŠ¤éš¾åº¦ | é«˜ | ä½ |
| æ•°æ®ä¸€è‡´æ€§ | å¯èƒ½ä¸ä¸€è‡´ | 100%ä¸€è‡´ |
| æ€§èƒ½ | è¾ƒæ…¢ | å¿«é€Ÿ |

## ä¹ã€æµ‹è¯•å‘½ä»¤

```python
# æµ‹è¯•æ˜ å°„å™¨
cd /root/projects/tencent-doc-manager/production/core_modules
python3 scoring_heatmap_mapper_simple.py

# æµ‹è¯•API
curl http://localhost:8089/api/scoring_enhanced_heatmap?week=37

# æŸ¥çœ‹ç»“æœ
cat /root/projects/tencent-doc-manager/scoring_heatmap_simple_test.json
```

## åã€æ€»ç»“

ç®€åŒ–ç‰ˆæ˜ å°„å®ç°äº†ï¼š
1. âœ… **æ•°æ®æºå•ä¸€åŒ–**ï¼šaggregated_scoreæ˜¯å”¯ä¸€æ•°æ®æº
2. âœ… **æ˜ å°„è§„åˆ™æ¸…æ™°**ï¼šè¡¨æ ¼åâ†’è¡Œï¼Œåˆ—åâ†’åˆ—ï¼Œåˆ†æ•°â†’çƒ­åŠ›å€¼
3. âœ… **è§†è§‰æ•ˆæœä¿æŒ**ï¼šæ‰€æœ‰æ¸²æŸ“åŠŸèƒ½ä¸å˜
4. âœ… **ç»´æŠ¤æç®€åŒ–**ï¼šä»£ç é‡å‡å°‘40%ï¼Œé€»è¾‘ä¸€ç›®äº†ç„¶
5. âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šå»é™¤å¤æ‚è®¡ç®—ï¼Œå“åº”æ›´å¿«

è¿™å°±æ˜¯æ‚¨å»ºè®®çš„"éå¸¸ç®€å•çš„åŒ¹é…"æ–¹æ¡ˆçš„å®Œç¾å®ç°ï¼