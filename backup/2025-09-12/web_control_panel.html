<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è…¾è®¯æ–‡æ¡£ä¸‹è½½æ§åˆ¶é¢æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }
        
        h1 {
            text-align: center;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .status-card {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .status-row:last-child {
            margin-bottom: 0;
        }
        
        .status-label {
            color: #4a5568;
            font-weight: 500;
        }
        
        .status-value {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #cbd5e0;
        }
        
        .status-indicator.connected {
            background: #48bb78;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.disconnected {
            background: #fc8181;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .control-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            color: #2d3748;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-label {
            display: block;
            color: #4a5568;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .input-field.textarea {
            min-height: 100px;
            resize: vertical;
            font-family: monospace;
            font-size: 12px;
        }
        
        .button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .button.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .button.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .button.secondary:hover {
            background: #cbd5e0;
        }
        
        .button.danger {
            background: #fc8181;
            color: white;
        }
        
        .button.danger:hover {
            background: #f56565;
        }
        
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .doc-list {
            background: #f7fafc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .doc-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        
        .doc-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .doc-item:last-child {
            margin-bottom: 0;
        }
        
        .doc-info {
            flex: 1;
        }
        
        .doc-id {
            font-family: monospace;
            color: #4a5568;
            font-size: 14px;
        }
        
        .doc-status {
            font-size: 12px;
            color: #718096;
            margin-top: 4px;
        }
        
        .log-container {
            background: #2d3748;
            color: #a0aec0;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-left: 3px solid transparent;
        }
        
        .log-entry.info {
            border-left-color: #4299e1;
        }
        
        .log-entry.success {
            border-left-color: #48bb78;
            color: #68d391;
        }
        
        .log-entry.error {
            border-left-color: #fc8181;
            color: #fc8181;
        }
        
        .log-entry.warning {
            border-left-color: #f6ad55;
            color: #f6ad55;
        }
        
        .help-text {
            background: #fef5e7;
            border-left: 4px solid #f6ad55;
            padding: 12px;
            margin-top: 20px;
            border-radius: 4px;
            font-size: 14px;
            color: #744210;
        }
        
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ è…¾è®¯æ–‡æ¡£ä¸‹è½½æ§åˆ¶é¢æ¿</h1>
        <p class="subtitle">é€šè¿‡æœ¬åœ°æµè§ˆå™¨æ¡¥æ¥å®‰å…¨ä¸‹è½½æ–‡æ¡£</p>
        
        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="status-card">
            <div class="status-row">
                <span class="status-label">æ¡¥æ¥æœåŠ¡çŠ¶æ€</span>
                <div class="status-value">
                    <span class="status-indicator" id="bridgeStatus"></span>
                    <span id="bridgeStatusText">æœªè¿æ¥</span>
                </div>
            </div>
            <div class="status-row">
                <span class="status-label">æµè§ˆå™¨çŠ¶æ€</span>
                <div class="status-value">
                    <span class="status-indicator" id="browserStatus"></span>
                    <span id="browserStatusText">æœªå¯åŠ¨</span>
                </div>
            </div>
            <div class="status-row">
                <span class="status-label">ç™»å½•çŠ¶æ€</span>
                <div class="status-value">
                    <span id="loginStatusText">æœªçŸ¥</span>
                </div>
            </div>
        </div>
        
        <!-- æ­¥éª¤1ï¼šè¿æ¥æœ¬åœ°æœåŠ¡ -->
        <div class="control-section">
            <h2 class="section-title">æ­¥éª¤1ï¼šè¿æ¥æœ¬åœ°æ¡¥æ¥æœåŠ¡</h2>
            <button class="button primary" onclick="connectBridge()">
                <span id="connectBtnText">è¿æ¥æœ¬åœ°æœåŠ¡</span>
            </button>
            <button class="button secondary" onclick="checkStatus()">æ£€æŸ¥çŠ¶æ€</button>
        </div>
        
        <!-- æ­¥éª¤2ï¼šCookieè®¾ç½®ï¼ˆå¯é€‰ï¼‰ -->
        <div class="control-section">
            <h2 class="section-title">æ­¥éª¤2ï¼šè®¾ç½®Cookieï¼ˆå¯é€‰ï¼‰</h2>
            <div class="input-group">
                <label class="input-label">Cookieå­—ç¬¦ä¸²ï¼ˆå¦‚æœå·²ç™»å½•å¯è·³è¿‡ï¼‰</label>
                <textarea class="input-field textarea" id="cookieInput" 
                    placeholder="ç²˜è´´æ‚¨çš„Cookieå­—ç¬¦ä¸²ï¼Œæ ¼å¼ï¼škey1=value1; key2=value2"></textarea>
            </div>
            <button class="button secondary" onclick="initBrowserWithCookie()">ä½¿ç”¨Cookieå¯åŠ¨æµè§ˆå™¨</button>
            <button class="button secondary" onclick="initBrowserNoCookie()">ç›´æ¥å¯åŠ¨æµè§ˆå™¨</button>
        </div>
        
        <!-- æ­¥éª¤3ï¼šä¸‹è½½æ–‡æ¡£ -->
        <div class="control-section">
            <h2 class="section-title">æ­¥éª¤3ï¼šä¸‹è½½æ–‡æ¡£</h2>
            
            <div class="input-group">
                <label class="input-label">æ–‡æ¡£IDæˆ–é“¾æ¥</label>
                <input type="text" class="input-field" id="docInput" 
                    placeholder="è¾“å…¥æ–‡æ¡£IDï¼ˆå¦‚ï¼šDWEVjZndkR2xVSWJNï¼‰æˆ–å®Œæ•´é“¾æ¥">
            </div>
            
            <div class="input-group">
                <label class="input-label">ä¸‹è½½æ ¼å¼</label>
                <select class="input-field" id="formatSelect">
                    <option value="xlsx">Excel (.xlsx)</option>
                    <option value="csv">CSV (.csv)</option>
                </select>
            </div>
            
            <button class="button primary" onclick="downloadDocument()">
                <span id="downloadBtnText">å¼€å§‹ä¸‹è½½</span>
            </button>
            
            <!-- é¢„è®¾æ–‡æ¡£åˆ—è¡¨ -->
            <div class="doc-list" style="margin-top: 20px;">
                <div style="margin-bottom: 10px; color: #4a5568; font-weight: 500;">å¿«é€Ÿä¸‹è½½æµ‹è¯•æ–‡æ¡£</div>
                <div class="doc-item">
                    <div class="doc-info">
                        <div class="doc-id">DWEVjZndkR2xVSWJN</div>
                        <div class="doc-status">æµ‹è¯•ç‰ˆæœ¬-å°çº¢ä¹¦éƒ¨é—¨</div>
                    </div>
                    <button class="button secondary" onclick="quickDownload('DWEVjZndkR2xVSWJN')">ä¸‹è½½</button>
                </div>
                <div class="doc-item">
                    <div class="doc-info">
                        <div class="doc-id">DRFppYm15RGZ2WExN</div>
                        <div class="doc-status">æµ‹è¯•ç‰ˆæœ¬-å›å›½é”€å”®è®¡åˆ’è¡¨</div>
                    </div>
                    <button class="button secondary" onclick="quickDownload('DRFppYm15RGZ2WExN')">ä¸‹è½½</button>
                </div>
                <div class="doc-item">
                    <div class="doc-info">
                        <div class="doc-id">DRHZrS1hOS3pwRGZB</div>
                        <div class="doc-status">æµ‹è¯•ç‰ˆæœ¬-å‡ºå›½é”€å”®è®¡åˆ’è¡¨</div>
                    </div>
                    <button class="button secondary" onclick="quickDownload('DRHZrS1hOS3pwRGZB')">ä¸‹è½½</button>
                </div>
            </div>
        </div>
        
        <!-- æ“ä½œæ—¥å¿— -->
        <div class="control-section">
            <h2 class="section-title">æ“ä½œæ—¥å¿—</h2>
            <div class="log-container" id="logContainer"></div>
        </div>
        
        <!-- å¸®åŠ©ä¿¡æ¯ -->
        <div class="help-text">
            <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
            1. é¦–å…ˆè¿è¡Œæœ¬åœ°æ¡¥æ¥æœåŠ¡ï¼š<code>python3 local_browser_bridge.py</code><br>
            2. ç‚¹å‡»"è¿æ¥æœ¬åœ°æœåŠ¡"å»ºç«‹WebSocketè¿æ¥<br>
            3. å¦‚æœæœªç™»å½•ï¼Œå¯ä»¥ç²˜è´´Cookieæˆ–ç›´æ¥å¯åŠ¨æµè§ˆå™¨æ‰‹åŠ¨ç™»å½•<br>
            4. è¾“å…¥æ–‡æ¡£IDæˆ–ä½¿ç”¨å¿«é€Ÿä¸‹è½½æµ‹è¯•<br>
            5. ä¸‹è½½çš„æ–‡ä»¶å°†ä¿å­˜åˆ° ~/Downloads/TencentDocs ç›®å½•
        </div>
    </div>
    
    <script>
        let ws = null;
        let isConnected = false;
        let isBrowserRunning = false;
        
        // æ—¥å¿—è®°å½•
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(element, text, connected = false) {
            const statusElement = document.getElementById(element + 'Status');
            const textElement = document.getElementById(element + 'StatusText');
            
            if (statusElement) {
                statusElement.className = `status-indicator ${connected ? 'connected' : 'disconnected'}`;
            }
            if (textElement) {
                textElement.textContent = text;
            }
        }
        
        // è¿æ¥æœ¬åœ°æ¡¥æ¥æœåŠ¡
        function connectBridge() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                addLog('å·²ç»è¿æ¥åˆ°æœ¬åœ°æœåŠ¡', 'warning');
                return;
            }
            
            addLog('æ­£åœ¨è¿æ¥æœ¬åœ°æ¡¥æ¥æœåŠ¡...', 'info');
            document.getElementById('connectBtnText').innerHTML = '<span class="spinner"></span> è¿æ¥ä¸­...';
            
            try {
                ws = new WebSocket('ws://localhost:8765');
                
                ws.onopen = () => {
                    isConnected = true;
                    updateStatus('bridge', 'å·²è¿æ¥', true);
                    document.getElementById('connectBtnText').textContent = 'å·²è¿æ¥';
                    addLog('æˆåŠŸè¿æ¥åˆ°æœ¬åœ°æ¡¥æ¥æœåŠ¡', 'success');
                    
                    // æ£€æŸ¥çŠ¶æ€
                    checkStatus();
                };
                
                ws.onclose = () => {
                    isConnected = false;
                    updateStatus('bridge', 'æœªè¿æ¥', false);
                    updateStatus('browser', 'æœªçŸ¥', false);
                    document.getElementById('connectBtnText').textContent = 'é‡æ–°è¿æ¥';
                    addLog('ä¸æœ¬åœ°æœåŠ¡æ–­å¼€è¿æ¥', 'error');
                };
                
                ws.onerror = (error) => {
                    addLog('è¿æ¥é”™è¯¯ï¼šè¯·ç¡®ä¿æœ¬åœ°æ¡¥æ¥æœåŠ¡æ­£åœ¨è¿è¡Œ', 'error');
                    document.getElementById('connectBtnText').textContent = 'è¿æ¥å¤±è´¥';
                };
                
                ws.onmessage = (event) => {
                    try {
                        const response = JSON.parse(event.data);
                        handleResponse(response);
                    } catch (e) {
                        addLog('è§£æå“åº”å¤±è´¥: ' + e.message, 'error');
                    }
                };
                
            } catch (error) {
                addLog('åˆ›å»ºWebSocketè¿æ¥å¤±è´¥: ' + error.message, 'error');
                document.getElementById('connectBtnText').textContent = 'è¿æ¥å¤±è´¥';
            }
        }
        
        // å¤„ç†å“åº”
        function handleResponse(response) {
            if (response.status === 'success') {
                if (response.data) {
                    // å¤„ç†ä¸åŒç±»å‹çš„æˆåŠŸå“åº”
                    if (response.data.bridge_version) {
                        // çŠ¶æ€æ£€æŸ¥å“åº”
                        addLog(`æ¡¥æ¥æœåŠ¡ç‰ˆæœ¬: ${response.data.bridge_version}`, 'info');
                        isBrowserRunning = response.data.browser_connected;
                        updateStatus('browser', isBrowserRunning ? 'è¿è¡Œä¸­' : 'æœªå¯åŠ¨', isBrowserRunning);
                    }
                    
                    if (response.data.logged_in !== undefined) {
                        // ç™»å½•çŠ¶æ€å“åº”
                        const loginText = response.data.logged_in ? 'å·²ç™»å½•' : 'æœªç™»å½•';
                        document.getElementById('loginStatusText').textContent = loginText;
                        addLog(`ç™»å½•çŠ¶æ€: ${loginText}`, response.data.logged_in ? 'success' : 'warning');
                    }
                    
                    if (response.data.filepath) {
                        // ä¸‹è½½å®Œæˆå“åº”
                        addLog(`æ–‡ä»¶å·²ä¸‹è½½: ${response.data.filename} (${response.data.size} bytes)`, 'success');
                        addLog(`ä¿å­˜ä½ç½®: ${response.data.filepath}`, 'info');
                        document.getElementById('downloadBtnText').textContent = 'å¼€å§‹ä¸‹è½½';
                    }
                } else {
                    addLog(response.message || 'æ“ä½œæˆåŠŸ', 'success');
                }
            } else {
                addLog(`é”™è¯¯: ${response.message}`, 'error');
                document.getElementById('downloadBtnText').textContent = 'å¼€å§‹ä¸‹è½½';
            }
        }
        
        // å‘é€å‘½ä»¤
        function sendCommand(command) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addLog('è¯·å…ˆè¿æ¥æœ¬åœ°æœåŠ¡', 'error');
                return false;
            }
            
            ws.send(JSON.stringify(command));
            return true;
        }
        
        // æ£€æŸ¥çŠ¶æ€
        function checkStatus() {
            if (sendCommand({action: 'check_status'})) {
                addLog('æ£€æŸ¥æœåŠ¡çŠ¶æ€...', 'info');
            }
        }
        
        // ä½¿ç”¨Cookieåˆå§‹åŒ–æµè§ˆå™¨
        function initBrowserWithCookie() {
            const cookieInput = document.getElementById('cookieInput').value.trim();
            
            if (!cookieInput) {
                addLog('è¯·è¾“å…¥Cookieå­—ç¬¦ä¸²', 'error');
                return;
            }
            
            if (sendCommand({
                action: 'init_browser',
                cookies: cookieInput
            })) {
                addLog('æ­£åœ¨å¯åŠ¨æµè§ˆå™¨å¹¶è®¾ç½®Cookie...', 'info');
                updateStatus('browser', 'å¯åŠ¨ä¸­...', false);
                
                // 3ç§’åæ£€æŸ¥ç™»å½•çŠ¶æ€
                setTimeout(() => {
                    sendCommand({action: 'login_check'});
                }, 3000);
            }
        }
        
        // ç›´æ¥å¯åŠ¨æµè§ˆå™¨
        function initBrowserNoCookie() {
            if (sendCommand({action: 'init_browser'})) {
                addLog('æ­£åœ¨å¯åŠ¨æµè§ˆå™¨...', 'info');
                updateStatus('browser', 'å¯åŠ¨ä¸­...', false);
                
                // 3ç§’åæ£€æŸ¥ç™»å½•çŠ¶æ€
                setTimeout(() => {
                    sendCommand({action: 'login_check'});
                }, 3000);
            }
        }
        
        // ä¸‹è½½æ–‡æ¡£
        function downloadDocument() {
            const docInput = document.getElementById('docInput').value.trim();
            const format = document.getElementById('formatSelect').value;
            
            if (!docInput) {
                addLog('è¯·è¾“å…¥æ–‡æ¡£IDæˆ–é“¾æ¥', 'error');
                return;
            }
            
            // ä»é“¾æ¥ä¸­æå–æ–‡æ¡£ID
            let docId = docInput;
            if (docInput.includes('docs.qq.com')) {
                const match = docInput.match(/sheet\/([A-Za-z0-9]+)/);
                if (match) {
                    docId = match[1];
                }
            }
            
            document.getElementById('downloadBtnText').innerHTML = '<span class="spinner"></span> ä¸‹è½½ä¸­...';
            
            if (sendCommand({
                action: 'download_document',
                doc_id: docId,
                format: format
            })) {
                addLog(`å¼€å§‹ä¸‹è½½æ–‡æ¡£: ${docId} (${format})`, 'info');
            }
        }
        
        // å¿«é€Ÿä¸‹è½½
        function quickDownload(docId) {
            document.getElementById('docInput').value = docId;
            downloadDocument();
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å°è¯•è¿æ¥
        window.onload = () => {
            addLog('é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·è¿æ¥æœ¬åœ°æœåŠ¡', 'info');
        };
        
        // é¡µé¢å…³é—­æ—¶æ¸…ç†
        window.onbeforeunload = () => {
            if (ws) {
                ws.close();
            }
        };
    </script>
</body>
</html>