<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="腾讯文档自动化服务 - 高效管理您的腾讯文档，支持下载、上传、分析、修改，现代化PWA应用">
    <meta name="keywords" content="腾讯文档,自动化,文档管理,Excel,CSV,下载,上传,PWA">
    <meta name="author" content="腾讯文档自动化服务">
    
    <!-- Open Graph / 社交媒体元数据 -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="腾讯文档自动化服务">
    <meta property="og:description" content="高效管理您的腾讯文档 - 下载、上传、分析、修改一站式解决">
    <meta property="og:site_name" content="腾讯文档自动化服务">
    <meta property="og:image" content="/static/images/og-image.png">
    
    <!-- PWA 元数据 -->
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="腾讯文档工具">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA 图标和清单 -->
    <link rel="apple-touch-icon" href="/static/images/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/images/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/images/icon-16x16.png">
    <link rel="manifest" href="/static/manifest.json">
    
    <title>腾讯文档自动化服务 | 现代化文档管理平台</title>
    
    <!-- 预加载关键资源 -->
    <link rel="preload" href="/static/css/modern-theme.css" as="style">
    <link rel="preload" href="/static/js/performance-monitor.js" as="script">
    <link rel="preload" href="/static/js/error-boundary.js" as="script">
    <link rel="preload" href="/static/js/components.js" as="script">
    
    <!-- DNS 预解析 -->
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    
    <!-- 预连接重要域名 -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet"></noscript>
    
    <!-- 现代主题样式 -->
    <link href="/static/css/modern-theme.css" rel="stylesheet">
    
    <!-- 关键CSS内联 -->
    <style>
        /* 关键渲染路径CSS */
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f8fafc;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            transition: opacity 0.5s ease;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .app-layout {
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .app-layout.loaded {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- 应用加载覆盖层 -->
    <div class="loading-overlay" id="appLoader">
        <div class="text-center">
            <div class="loading-spinner"></div>
            <div>
                <h2 style="margin: 0 0 8px 0;">腾讯文档自动化服务</h2>
                <p style="margin: 0; opacity: 0.8;">正在启动现代化文档管理平台...</p>
            </div>
        </div>
    </div>
    
    <!-- 主应用容器 -->
    <div class="app-layout" id="appLayout">
        <!-- 应用头部 -->
        <header class="app-header">
            <div class="container">
                <div class="flex items-center justify-between py-4">
                    <!-- Logo 和标题 -->
                    <div class="flex items-center gap-4">
                        <i class="bi bi-file-earmark-text text-3xl text-primary-600" aria-hidden="true"></i>
                        <div>
                            <h1 class="text-2xl font-bold text-primary">腾讯文档自动化服务</h1>
                            <p class="text-sm text-muted">现代化PWA文档管理平台</p>
                        </div>
                    </div>
                    
                    <!-- 工具栏 -->
                    <div class="flex items-center gap-3">
                        <!-- 网络状态指示器 -->
                        <div class="status-indicator info" id="networkStatus">
                            <i class="bi bi-wifi" aria-hidden="true"></i>
                            <span>在线</span>
                        </div>
                        
                        <!-- API状态指示器 -->
                        <div class="status-indicator success" id="apiStatus">
                            <i class="bi bi-server" aria-hidden="true"></i>
                            <span>正常</span>
                        </div>
                        
                        <!-- 用户信息 -->
                        <div class="text-sm text-muted" id="userInfo">
                            <span id="userDisplay">未设置用户</span>
                        </div>
                        
                        <!-- 主题切换 -->
                        <button 
                            id="themeToggle" 
                            class="btn btn-ghost btn-sm"
                            title="切换主题 (Ctrl+D)"
                            aria-label="切换明暗主题"
                            data-component="ThemeToggle"
                        >
                            <i class="bi bi-sun" aria-hidden="true"></i>
                        </button>
                        
                        <!-- 设置菜单 -->
                        <div class="relative" id="settingsMenu">
                            <button class="btn btn-ghost btn-sm" id="settingsToggle" title="更多设置">
                                <i class="bi bi-three-dots-vertical" aria-hidden="true"></i>
                            </button>
                            <div class="dropdown-menu hidden" id="settingsDropdown">
                                <a href="#" class="dropdown-item" onclick="window.pwaManager?.checkForUpdate()">
                                    <i class="bi bi-arrow-clockwise" aria-hidden="true"></i>
                                    检查更新
                                </a>
                                <a href="#" class="dropdown-item" onclick="window.pwaManager?.clearCache()">
                                    <i class="bi bi-trash" aria-hidden="true"></i>
                                    清除缓存
                                </a>
                                <div class="dropdown-divider"></div>
                                <a href="#" class="dropdown-item" onclick="window.errorBoundary?.getErrorStats()">
                                    <i class="bi bi-bug" aria-hidden="true"></i>
                                    错误报告
                                </a>
                                <a href="#" class="dropdown-item" onclick="window.performanceMonitor?.getSnapshot()">
                                    <i class="bi bi-speedometer" aria-hidden="true"></i>
                                    性能报告
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 导航栏 -->
                <nav class="nav" role="navigation" aria-label="主导航">
                    <a href="#settings" class="nav-link active" data-route="settings">
                        <i class="bi bi-gear" aria-hidden="true"></i>
                        <span>设置</span>
                        <kbd class="kbd">Alt+1</kbd>
                    </a>
                    <a href="#download" class="nav-link" data-route="download">
                        <i class="bi bi-cloud-download" aria-hidden="true"></i>
                        <span>下载文档</span>
                        <kbd class="kbd">Alt+2</kbd>
                    </a>
                    <a href="#upload" class="nav-link" data-route="upload">
                        <i class="bi bi-cloud-upload" aria-hidden="true"></i>
                        <span>上传文档</span>
                        <kbd class="kbd">Alt+3</kbd>
                    </a>
                    <a href="#analyze" class="nav-link" data-route="analyze">
                        <i class="bi bi-graph-up" aria-hidden="true"></i>
                        <span>分析文档</span>
                        <kbd class="kbd">Alt+4</kbd>
                    </a>
                    <a href="#history" class="nav-link" data-route="history">
                        <i class="bi bi-clock-history" aria-hidden="true"></i>
                        <span>历史记录</span>
                        <kbd class="kbd">Alt+5</kbd>
                    </a>
                </nav>
            </div>
        </header>
        
        <!-- 主内容区域 -->
        <main class="app-main flex-1" role="main">
            <div id="mainContent">
                <!-- 内容将由JavaScript动态加载 -->
                <div class="container">
                    <div class="text-center py-20">
                        <div class="spinner mb-4"></div>
                        <p class="text-muted">正在加载内容...</p>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- 应用底部 -->
        <footer class="app-footer">
            <div class="container">
                <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                    <div class="text-center md:text-left">
                        <p>&copy; 2024 腾讯文档自动化服务. 现代化PWA文档管理解决方案.</p>
                    </div>
                    <div class="flex items-center gap-6 text-sm">
                        <a href="#" class="text-muted hover:text-primary transition-colors" onclick="showHelpModal()">
                            <i class="bi bi-question-circle mr-1" aria-hidden="true"></i>
                            使用帮助
                        </a>
                        <a href="#" class="text-muted hover:text-primary transition-colors" onclick="showAboutModal()">
                            <i class="bi bi-info-circle mr-1" aria-hidden="true"></i>
                            关于
                        </a>
                        <a href="https://github.com" class="text-muted hover:text-primary transition-colors" target="_blank" rel="noopener">
                            <i class="bi bi-github mr-1" aria-hidden="true"></i>
                            源码
                        </a>
                        <div class="text-muted" id="appVersion">v1.0.0</div>
                    </div>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- JavaScript 模块 - 按依赖顺序加载 -->
    <!-- 1. 核心系统 -->
    <script src="/static/js/performance-monitor.js" defer></script>
    <script src="/static/js/error-boundary.js" defer></script>
    
    <!-- 2. PWA 功能 -->
    <script src="/static/js/pwa-manager.js" defer></script>
    
    <!-- 3. 组件系统 -->
    <script src="/static/js/components.js" defer></script>
    
    <!-- 4. API 客户端 -->
    <script src="/static/js/api-client.js" defer></script>
    
    <!-- 5. 主应用逻辑 -->
    <script src="/static/js/app.js" defer></script>
    
    <!-- 应用初始化脚本 -->
    <script>
        // 性能标记
        performance.mark('app-start');
        
        // 应用启动逻辑
        document.addEventListener('DOMContentLoaded', function() {
            performance.mark('dom-ready');
            
            // 延迟加载非关键资源
            setTimeout(loadNonCriticalResources, 100);
            
            // 设置应用
            setupApp();
        });
        
        function loadNonCriticalResources() {
            // 预加载其他资源
            const resources = [
                '/static/css/components.css',
                '/static/js/main.js'
            ];
            
            resources.forEach(src => {
                const link = document.createElement('link');
                link.rel = 'prefetch';
                link.href = src;
                document.head.appendChild(link);
            });
        }
        
        function setupApp() {
            // 等待所有脚本加载完成
            let checkInterval = setInterval(() => {
                if (window.TencentDocApp && window.Components && window.API) {
                    clearInterval(checkInterval);
                    initializeApp();
                }
            }, 100);
            
            // 超时保护
            setTimeout(() => {
                clearInterval(checkInterval);
                if (!window.TencentDocApp) {
                    showFallbackUI();
                }
            }, 10000);
        }
        
        function initializeApp() {
            performance.mark('app-init-start');
            
            try {
                // 隐藏加载覆盖层
                const loader = document.getElementById('appLoader');
                const layout = document.getElementById('appLayout');
                
                loader.style.opacity = '0';
                layout.classList.add('loaded');
                
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 500);
                
                // 设置导航事件处理
                setupNavigation();
                
                // 设置全局功能
                setupGlobalFeatures();
                
                // 性能测量
                performance.mark('app-init-end');
                performance.measure('app-initialization', 'app-init-start', 'app-init-end');
                
                console.log('✅ 腾讯文档自动化服务已成功启动');
                
                // 显示欢迎消息（如果是首次访问）
                if (!localStorage.getItem('app-visited')) {
                    setTimeout(showWelcomeMessage, 1000);
                    localStorage.setItem('app-visited', 'true');
                }
                
            } catch (error) {
                console.error('App initialization failed:', error);
                showFallbackUI();
            }
        }
        
        function setupNavigation() {
            // 处理导航链接点击
            document.addEventListener('click', function(e) {
                const navLink = e.target.closest('.nav-link[data-route]');
                if (navLink) {
                    e.preventDefault();
                    const route = navLink.dataset.route;
                    
                    // 更新活动状态
                    document.querySelectorAll('.nav-link').forEach(link => {
                        link.classList.remove('active');
                    });
                    navLink.classList.add('active');
                    
                    // 导航到路由
                    if (window.app) {
                        window.app.router.navigateTo(route);
                    }
                }
            });
            
            // 设置菜单切换
            const settingsToggle = document.getElementById('settingsToggle');
            const settingsDropdown = document.getElementById('settingsDropdown');
            
            if (settingsToggle && settingsDropdown) {
                settingsToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    settingsDropdown.classList.toggle('hidden');
                });
                
                // 点击外部关闭菜单
                document.addEventListener('click', function() {
                    settingsDropdown.classList.add('hidden');
                });
            }
        }
        
        function setupGlobalFeatures() {
            // 网络状态监控
            function updateNetworkStatus() {
                const indicator = document.getElementById('networkStatus');
                if (!indicator) return;
                
                if (navigator.onLine) {
                    indicator.className = 'status-indicator success';
                    indicator.innerHTML = '<i class="bi bi-wifi" aria-hidden="true"></i><span>在线</span>';
                } else {
                    indicator.className = 'status-indicator error';
                    indicator.innerHTML = '<i class="bi bi-wifi-off" aria-hidden="true"></i><span>离线</span>';
                }
            }
            
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
            updateNetworkStatus();
            
            // API状态监控
            window.addEventListener('api:stateChange', function(e) {
                const indicator = document.getElementById('apiStatus');
                if (!indicator) return;
                
                if (e.detail.hasPending) {
                    indicator.className = 'status-indicator warning';
                    indicator.innerHTML = '<i class="bi bi-hourglass-split animate-spin" aria-hidden="true"></i><span>处理中</span>';
                } else {
                    indicator.className = 'status-indicator success';
                    indicator.innerHTML = '<i class="bi bi-server" aria-hidden="true"></i><span>正常</span>';
                }
            });
            
            // 键盘快捷键
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + K: 快速导航
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    showQuickNavigation();
                }
                
                // Alt + 数字键: 快速导航到对应标签
                if (e.altKey && e.key >= '1' && e.key <= '5') {
                    e.preventDefault();
                    const routes = ['settings', 'download', 'upload', 'analyze', 'history'];
                    const index = parseInt(e.key) - 1;
                    if (routes[index] && window.app) {
                        window.app.router.navigateTo(routes[index]);
                    }
                }
                
                // Ctrl/Cmd + D: 切换主题
                if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                    e.preventDefault();
                    const themeToggle = document.getElementById('themeToggle');
                    if (themeToggle) {
                        themeToggle.click();
                    }
                }
            });
            
            // 页面可见性变化处理
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && window.app) {
                    // 页面重新可见时检查API健康状态
                    window.app.checkAPIHealth();
                }
            });
        }
        
        function showFallbackUI() {
            const loader = document.getElementById('appLoader');
            loader.innerHTML = `
                <div class="text-center">
                    <i class="bi bi-exclamation-triangle text-4xl mb-4" style="color: #fbbf24;"></i>
                    <h2 style="margin: 0 0 16px 0;">应用启动异常</h2>
                    <p style="margin: 0 0 24px 0;">请刷新页面重试，或检查网络连接</p>
                    <button onclick="window.location.reload()" style="
                        background: white; 
                        color: #1f2937; 
                        border: none; 
                        padding: 12px 24px; 
                        border-radius: 8px; 
                        cursor: pointer; 
                        font-size: 16px;
                        font-weight: 600;
                    ">
                        刷新页面
                    </button>
                </div>
            `;
        }
        
        function showWelcomeMessage() {
            if (window.Components && window.Components.Toast) {
                window.Components.Toast.success('欢迎使用腾讯文档自动化服务！', '欢迎');
            }
        }
        
        function showQuickNavigation() {
            // 可以实现快速导航模态框
            console.log('Quick navigation shortcut triggered');
        }
        
        function showHelpModal() {
            if (window.Components && window.Components.Modal) {
                const helpModal = new window.Components.Modal(null, {
                    title: '使用帮助',
                    size: 'lg',
                    content: `
                        <div class="help-content">
                            <h3>快捷键</h3>
                            <ul>
                                <li><kbd>Ctrl+K</kbd> - 快速导航</li>
                                <li><kbd>Ctrl+D</kbd> - 切换主题</li>
                                <li><kbd>Alt+1-5</kbd> - 快速切换标签页</li>
                            </ul>
                            
                            <h3>功能说明</h3>
                            <ul>
                                <li><strong>下载文档</strong>: 从腾讯文档URL导出Excel或CSV文件</li>
                                <li><strong>上传文档</strong>: 上传和处理Excel文档</li>
                                <li><strong>分析文档</strong>: 分析Excel文件结构和内容</li>
                                <li><strong>历史记录</strong>: 查看操作历史</li>
                            </ul>
                            
                            <h3>PWA功能</h3>
                            <p>本应用支持离线使用，可安装到桌面或主屏幕，获得原生应用般的体验。</p>
                        </div>
                    `,
                    actions: [{
                        key: 'close',
                        text: '关闭',
                        variant: 'primary',
                        onClick: (modal) => modal.hide()
                    }]
                });
                helpModal.show();
            }
        }
        
        function showAboutModal() {
            if (window.Components && window.Components.Modal) {
                const aboutModal = new window.Components.Modal(null, {
                    title: '关于应用',
                    content: `
                        <div class="about-content text-center">
                            <i class="bi bi-file-earmark-text text-6xl text-primary-600 mb-4"></i>
                            <h3>腾讯文档自动化服务</h3>
                            <p class="text-muted mb-4">现代化PWA文档管理平台</p>
                            <div class="grid md:grid-cols-2 gap-4 mt-6">
                                <div>
                                    <h4>技术特性</h4>
                                    <ul class="text-sm text-left">
                                        <li>• 渐进式Web应用(PWA)</li>
                                        <li>• 现代ES6+架构</li>
                                        <li>• 离线功能支持</li>
                                        <li>• 实时性能监控</li>
                                        <li>• 错误边界保护</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4>应用信息</h4>
                                    <ul class="text-sm text-left">
                                        <li>• 版本: v1.0.0</li>
                                        <li>• 构建: ${new Date().toLocaleDateString()}</li>
                                        <li>• 环境: ${location.hostname.includes('localhost') ? '开发' : '生产'}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `,
                    actions: [{
                        key: 'close',
                        text: '关闭',
                        variant: 'primary',
                        onClick: (modal) => modal.hide()
                    }]
                });
                aboutModal.show();
            }
        }
    </script>
</body>
</html>