# 定时采集系统设计文档

## 数据格式定义

### 1. 采集任务配置格式 (JSON)

```json
{
  "task_id": "daily_report_collection", 
  "name": "每日报表采集",
  "schedule": {
    "type": "cron",
    "expression": "0 9 * * *",
    "timezone": "Asia/Shanghai"
  },
  "urls": [
    "https://docs.qq.com/sheet/DYkNJRlp0cWRWZUlH?tab=BB08J2",
    "https://docs.qq.com/sheet/DYkNJRlp0cWRWZUlH?tab=g2hi7f",
    "https://docs.qq.com/sheet/DYkNJRlp0cWRWZUlH?tab=kgc5ou"
  ],
  "cookies": "uin=xxx; skey=xxx; ...",
  "options": {
    "concurrent_limit": 3,
    "timeout": 60,
    "retry_times": 2,
    "compare_with_previous": true,
    "keep_history_days": 30
  },
  "notification": {
    "enabled": true,
    "webhook_url": "http://localhost/api/webhook",
    "notify_on_change": true,
    "notify_on_error": true
  }
}
```

### 2. 定时配置支持格式

#### Cron表达式格式
- `0 9 * * *` - 每天上午9点
- `0 */6 * * *` - 每6小时一次
- `0 0 * * 1` - 每周一午夜
- `0 0 1 * *` - 每月1号午夜

#### 简化时间格式  
- `daily:09:00` - 每天9点
- `hourly:30` - 每小时30分
- `weekly:monday:09:00` - 每周一9点
- `monthly:1:09:00` - 每月1号9点

### 3. 采集结果数据格式

```json
{
  "collection_id": "20250811_091500_daily_report",
  "task_id": "daily_report_collection",
  "timestamp": "2025-08-11T09:15:00.123Z",
  "status": "completed",
  "results": [
    {
      "url": "https://docs.qq.com/sheet/DYkNJRlp0cWRWZUlH?tab=BB08J2",
      "doc_id": "DYkNJRlp0cWRWZUlH",
      "tab_id": "BB08J2", 
      "success": true,
      "duration": 5.2,
      "data_hash": "sha256:abc123...",
      "row_count": 150,
      "col_count": 8,
      "data_path": "/data/collections/20250811_091500/BB08J2.json",
      "error": null
    }
  ],
  "summary": {
    "total_docs": 3,
    "successful": 3,
    "failed": 0,
    "total_duration": 15.8,
    "changes_detected": true
  },
  "comparison": {
    "previous_collection": "20250810_091500_daily_report",
    "changed_docs": ["BB08J2", "g2hi7f"],
    "change_summary": {
      "BB08J2": {
        "type": "modified",
        "row_changes": 5,
        "cell_changes": 12
      }
    }
  }
}
```

### 4. 文档差异对比格式

```json
{
  "comparison_id": "BB08J2_20250810_vs_20250811",
  "doc_info": {
    "doc_id": "DYkNJRlp0cWRWZUlH",
    "tab_id": "BB08J2",
    "title": "销售数据表"
  },
  "versions": {
    "previous": {
      "timestamp": "2025-08-10T09:15:00.123Z",
      "data_hash": "sha256:def456...",
      "row_count": 145,
      "col_count": 8
    },
    "current": {
      "timestamp": "2025-08-11T09:15:00.123Z", 
      "data_hash": "sha256:abc123...",
      "row_count": 150,
      "col_count": 8
    }
  },
  "changes": {
    "summary": {
      "total_changes": 17,
      "added_rows": 5,
      "deleted_rows": 0,
      "modified_cells": 12,
      "structure_changed": false
    },
    "details": {
      "row_changes": [
        {
          "type": "added",
          "row_index": 146,
          "data": ["2025-08-11", "新客户", "1000", "已成交"]
        }
      ],
      "cell_changes": [
        {
          "type": "modified",
          "position": {"row": 10, "col": 3},
          "previous_value": "500",
          "current_value": "800", 
          "value_type": "number"
        },
        {
          "type": "modified",
          "position": {"row": 10, "col": 4},
          "previous_value": "待跟进",
          "current_value": "已成交",
          "value_type": "string"
        }
      ]
    }
  },
  "metadata": {
    "comparison_time": "2025-08-11T09:30:00.123Z",
    "algorithm": "deep_cell_comparison",
    "threshold": 0.01
  }
}
```

## 系统架构设计

### 1. 核心组件
- `scheduler.py` - 定时任务调度器
- `collector.py` - 文档数据采集器  
- `comparator.py` - 文档差异对比器
- `storage.py` - 数据存储管理
- `notification.py` - 通知系统

### 2. 数据存储结构
```
/data/
├── tasks/              # 任务配置
│   ├── task_001.json
│   └── task_002.json
├── collections/        # 采集数据
│   ├── 20250811_091500/
│   │   ├── metadata.json
│   │   ├── BB08J2.json
│   │   └── g2hi7f.json
│   └── 20250810_091500/
└── comparisons/        # 对比结果
    ├── BB08J2_20250810_vs_20250811.json
    └── g2hi7f_20250810_vs_20250811.json
```

### 3. 性能优化策略
- 并发采集（最多3个文档同时处理）
- 增量对比（只对比变化的部分）
- 数据压缩存储
- 内存使用控制
- 自动清理历史数据

## 配置示例

### 每日定时采集配置
```json
{
  "task_id": "daily_sales_report",
  "name": "每日销售报表采集",
  "schedule": {
    "type": "simple", 
    "expression": "daily:09:00",
    "timezone": "Asia/Shanghai"
  },
  "urls": [
    "https://docs.qq.com/sheet/DYkNJRlp0cWRWZUlH?tab=sales_daily",
    "https://docs.qq.com/sheet/DYkNJRlp0cWRWZUlH?tab=customer_data"
  ],
  "cookies": "your_cookies_here",
  "options": {
    "concurrent_limit": 2,
    "compare_with_previous": true,
    "keep_history_days": 7
  }
}
```

### 每小时监控配置
```json
{
  "task_id": "realtime_monitor", 
  "name": "实时数据监控",
  "schedule": {
    "type": "simple",
    "expression": "hourly:00"
  },
  "urls": [
    "https://docs.qq.com/sheet/DYkNJRlp0cWRWZUlH?tab=realtime_data"
  ],
  "cookies": "your_cookies_here",
  "options": {
    "concurrent_limit": 1,
    "compare_with_previous": true,
    "notification": {
      "notify_on_change": true
    }
  }
}
```

这种设计能够支持4H2G服务器的并发处理需求，提供灵活的时间配置和详细的差异对比功能。