#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
è…¾è®¯æ–‡æ¡£ç®¡ç†é¡¹ç›® - å®Œæ•´é›†æˆæµ‹è¯•ç³»ç»Ÿï¼ˆå¢å¼ºç‰ˆï¼‰
ç«¯å£: 8093
ç‰ˆæœ¬: 5.0.0 - Enhanced Production Integration
åŠŸèƒ½: å®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•æµç¨‹ï¼Œä»åŒæ–‡æ¡£ä¸‹è½½åˆ°æ™ºèƒ½æ¶‚è‰²ä¸Šä¼ 
æ–°å¢: æ–‡ä»¶æµè§ˆå™¨ã€å†å²è®°å½•ã€é¢„è®¾æ¨¡æ¿ã€é«˜çº§é…ç½®ç­‰åŠŸèƒ½
ä½œè€…: ç³»ç»Ÿæ¶æ„å›¢é˜Ÿ
æ—¥æœŸ: 2025-09-10
"""

from flask import Flask, render_template_string, request, jsonify, send_file
import os
import sys
import json
import time
import logging
import traceback
import uuid
import threading
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Optional, Tuple, Any
import subprocess
import glob
import hashlib

# æ·»åŠ é¡¹ç›®è·¯å¾„
sys.path.insert(0, '/root/projects/tencent-doc-manager')
sys.path.insert(0, '/root/projects/tencent-doc-manager/production/core_modules')

app = Flask(__name__)

# ==================== é¡¹ç›®æ­£å¼è·¯å¾„é…ç½® ====================
BASE_DIR = Path('/root/projects/tencent-doc-manager')
DOWNLOAD_DIR = BASE_DIR / 'downloads'
CSV_VERSIONS_DIR = BASE_DIR / 'csv_versions'
COMPARISON_RESULTS_DIR = BASE_DIR / 'comparison_results'
SCORING_RESULTS_DIR = BASE_DIR / 'scoring_results' / 'detailed'
EXCEL_OUTPUTS_DIR = BASE_DIR / 'excel_outputs' / 'marked'
LOG_DIR = BASE_DIR / 'logs'
TEMP_DIR = BASE_DIR / 'temp_workflow'
HISTORY_DIR = BASE_DIR / 'workflow_history'
PRESETS_DIR = BASE_DIR / 'workflow_presets'

# ç¡®ä¿æ‰€æœ‰ç›®å½•å­˜åœ¨
for dir_path in [DOWNLOAD_DIR, CSV_VERSIONS_DIR, COMPARISON_RESULTS_DIR, 
                 SCORING_RESULTS_DIR, EXCEL_OUTPUTS_DIR, LOG_DIR, TEMP_DIR,
                 HISTORY_DIR, PRESETS_DIR]:
    dir_path.mkdir(exist_ok=True, parents=True)

# ==================== æ—¥å¿—é…ç½® ====================
log_file = LOG_DIR / f'integrated_test_8093_{datetime.now().strftime("%Y%m%d_%H%M%S")}.log'
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - [%(levelname)s] - %(message)s',
    handlers=[
        logging.FileHandler(log_file, encoding='utf-8'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# ==================== å…¨å±€çŠ¶æ€ç®¡ç† ====================
class WorkflowState:
    def __init__(self):
        self.current_task = ""
        self.progress = 0
        self.logs = []
        self.status = "idle"  # idle, running, completed, error
        self.results = {}
        self.baseline_file = None
        self.target_file = None
        self.score_file = None
        self.marked_file = None
        self.upload_url = None
        self.start_time = None
        self.end_time = None
        self.execution_id = None
        self.advanced_settings = {}
        
    def add_log(self, message, level="INFO"):
        timestamp = datetime.now().strftime("%H:%M:%S")
        log_entry = {
            "time": timestamp,
            "level": level,
            "message": message
        }
        self.logs.append(log_entry)
        logger.info(f"[{level}] {message}")
        
    def update_progress(self, task, progress):
        self.current_task = task
        self.progress = progress
        
    def reset(self):
        self.__init__()
        
    def save_to_history(self):
        """ä¿å­˜æ‰§è¡Œå†å²"""
        if self.execution_id:
            history_file = HISTORY_DIR / f"workflow_{self.execution_id}.json"
            history_data = {
                "id": self.execution_id,
                "start_time": self.start_time.isoformat() if self.start_time else None,
                "end_time": self.end_time.isoformat() if self.end_time else None,
                "status": self.status,
                "results": self.results,
                "logs": self.logs[-20:],  # åªä¿å­˜æœ€å20æ¡æ—¥å¿—
                "settings": self.advanced_settings
            }
            with open(history_file, 'w', encoding='utf-8') as f:
                json.dump(history_data, f, ensure_ascii=False, indent=2)

workflow_state = WorkflowState()

# ==================== å·¥ä½œæµé¢„è®¾ç®¡ç† ====================
class PresetManager:
    @staticmethod
    def save_preset(name, config):
        """ä¿å­˜é¢„è®¾é…ç½®"""
        preset_file = PRESETS_DIR / f"{name}.json"
        with open(preset_file, 'w', encoding='utf-8') as f:
            json.dump(config, f, ensure_ascii=False, indent=2)
    
    @staticmethod
    def load_preset(name):
        """åŠ è½½é¢„è®¾é…ç½®"""
        preset_file = PRESETS_DIR / f"{name}.json"
        if preset_file.exists():
            with open(preset_file, 'r', encoding='utf-8') as f:
                return json.load(f)
        return None
    
    @staticmethod
    def list_presets():
        """åˆ—å‡ºæ‰€æœ‰é¢„è®¾"""
        presets = []
        for preset_file in PRESETS_DIR.glob("*.json"):
            with open(preset_file, 'r', encoding='utf-8') as f:
                config = json.load(f)
                presets.append({
                    "name": preset_file.stem,
                    "description": config.get("description", "æ— æè¿°"),
                    "created": preset_file.stat().st_mtime
                })
        return sorted(presets, key=lambda x: x['created'], reverse=True)

# ==================== å¯¼å…¥ç”Ÿäº§æ¨¡å—ï¼ˆä¿®å¤ç‰ˆï¼‰ ====================
MODULES_STATUS = {}

# 1. ä¸‹è½½æ¨¡å—
try:
    from production.core_modules.tencent_export_automation import TencentDocAutoExporter
    MODULES_STATUS['downloader'] = True
    logger.info("âœ… æˆåŠŸå¯¼å…¥ä¸‹è½½æ¨¡å—")
except ImportError as e:
    MODULES_STATUS['downloader'] = False
    logger.error(f"âŒ æ— æ³•å¯¼å…¥ä¸‹è½½æ¨¡å—: {e}")

# 2. æ¯”è¾ƒæ¨¡å—
try:
    from production.core_modules.adaptive_table_comparator import AdaptiveTableComparator
    from unified_csv_comparator import UnifiedCSVComparator
    MODULES_STATUS['comparator'] = True
    logger.info("âœ… æˆåŠŸå¯¼å…¥æ¯”è¾ƒæ¨¡å—")
except ImportError as e:
    MODULES_STATUS['comparator'] = False
    logger.error(f"âŒ æ— æ³•å¯¼å…¥æ¯”è¾ƒæ¨¡å—: {e}")

# 3. åˆ—æ ‡å‡†åŒ–æ¨¡å—ï¼ˆä¿®å¤ç±»åï¼‰
try:
    from production.core_modules.column_standardization_prompt import ColumnStandardizationPrompt
    MODULES_STATUS['standardizer'] = True
    logger.info("âœ… æˆåŠŸå¯¼å…¥åˆ—æ ‡å‡†åŒ–æ¨¡å—")
except ImportError as e:
    MODULES_STATUS['standardizer'] = False
    logger.error(f"âŒ æ— æ³•å¯¼å…¥åˆ—æ ‡å‡†åŒ–æ¨¡å—: {e}")

# 4. L2è¯­ä¹‰åˆ†ææ¨¡å—
try:
    from production.core_modules.l2_semantic_analysis_two_layer import L2SemanticAnalyzer
    MODULES_STATUS['l2_analyzer'] = True
    logger.info("âœ… æˆåŠŸå¯¼å…¥L2è¯­ä¹‰åˆ†ææ¨¡å—")
except ImportError as e:
    MODULES_STATUS['l2_analyzer'] = False
    logger.error(f"âŒ æ— æ³•å¯¼å…¥L2è¯­ä¹‰åˆ†ææ¨¡å—: {e}")

# 5. æ™ºèƒ½æ ‡è®°æ¨¡å—
try:
    from intelligent_excel_marker import IntelligentExcelMarker, DetailedScoreGenerator
    MODULES_STATUS['marker'] = True
    logger.info("âœ… æˆåŠŸå¯¼å…¥æ™ºèƒ½æ ‡è®°æ¨¡å—")
except ImportError as e:
    MODULES_STATUS['marker'] = False
    logger.error(f"âŒ æ— æ³•å¯¼å…¥æ™ºèƒ½æ ‡è®°æ¨¡å—: {e}")

# 6. Excelä¿®å¤æ¨¡å—
try:
    from fix_tencent_excel import fix_tencent_excel
    MODULES_STATUS['fixer'] = True
    logger.info("âœ… æˆåŠŸå¯¼å…¥Excelä¿®å¤æ¨¡å—")
except ImportError as e:
    MODULES_STATUS['fixer'] = False
    logger.error(f"âŒ æ— æ³•å¯¼å…¥Excelä¿®å¤æ¨¡å—: {e}")

# 7. ä¸Šä¼ æ¨¡å—ï¼ˆä½¿ç”¨ç»ˆæç‰ˆæœ¬ï¼‰
try:
    from tencent_doc_uploader_ultimate import sync_upload_file
    MODULES_STATUS['uploader'] = True
    logger.info("âœ… æˆåŠŸå¯¼å…¥ä¸Šä¼ æ¨¡å—(ç»ˆæç‰ˆ)")
except ImportError:
    try:
        # å¤‡ç”¨1ï¼šå°è¯•ä¿®å¤ç‰ˆ
        from tencent_doc_uploader_fixed import sync_upload_file
        MODULES_STATUS['uploader'] = True
        logger.info("âœ… æˆåŠŸå¯¼å…¥ä¸Šä¼ æ¨¡å—(ä¿®å¤ç‰ˆ)")
    except ImportError:
        try:
            # å¤‡ç”¨2ï¼šå°è¯•åŸç‰ˆæœ¬
            from tencent_doc_uploader import sync_upload_file
            MODULES_STATUS['uploader'] = True
            logger.info("âœ… æˆåŠŸå¯¼å…¥ä¸Šä¼ æ¨¡å—(åŸç‰ˆæœ¬)")
        except ImportError as e:
            MODULES_STATUS['uploader'] = False
            logger.error(f"âŒ æ— æ³•å¯¼å…¥ä¸Šä¼ æ¨¡å—: {e}")

# 8. å‘¨æ—¶é—´ç®¡ç†å™¨
try:
    from production.core_modules.week_time_manager import WeekTimeManager
    MODULES_STATUS['week_manager'] = True
    logger.info("âœ… æˆåŠŸå¯¼å…¥å‘¨æ—¶é—´ç®¡ç†å™¨")
except ImportError as e:
    MODULES_STATUS['week_manager'] = False
    logger.error(f"âŒ æ— æ³•å¯¼å…¥å‘¨æ—¶é—´ç®¡ç†å™¨: {e}")

# ==================== æ ¸å¿ƒå·¥ä½œæµå‡½æ•° ====================
def run_complete_workflow(baseline_url: str, target_url: str, cookie: str, advanced_settings: dict = None):
    """
    æ‰§è¡Œå®Œæ•´çš„å·¥ä½œæµç¨‹ï¼ˆå¢å¼ºç‰ˆï¼‰
    """
    try:
        workflow_state.reset()
        workflow_state.status = "running"
        workflow_state.start_time = datetime.now()
        workflow_state.execution_id = datetime.now().strftime("%Y%m%d_%H%M%S")
        workflow_state.advanced_settings = advanced_settings or {}
        
        # ========== æ­¥éª¤1: ä¸‹è½½åŸºçº¿CSVæ–‡ä»¶ ==========
        workflow_state.update_progress("ä¸‹è½½åŸºçº¿æ–‡æ¡£", 10)
        workflow_state.add_log("å¼€å§‹ä¸‹è½½åŸºçº¿æ–‡æ¡£...")
        
        if MODULES_STATUS.get('downloader'):
            # ä¸ºæ¯ä¸ªä¸‹è½½åˆ›å»ºæ–°çš„exporterå®ä¾‹ï¼Œé¿å…æµè§ˆå™¨ä¸Šä¸‹æ–‡å†²çª
            exporter_baseline = TencentDocAutoExporter()
            
            # ä¸‹è½½åŸºçº¿æ–‡æ¡£ï¼ˆç›´æ¥ä¼ é€’cookieå‚æ•°ï¼‰
            baseline_result = exporter_baseline.export_document(baseline_url, cookies=cookie, format='csv')
            if baseline_result and baseline_result.get('success'):
                baseline_file = baseline_result.get('file_path')
                workflow_state.baseline_file = baseline_file
                workflow_state.add_log(f"âœ… åŸºçº¿æ–‡æ¡£ä¸‹è½½æˆåŠŸ: {os.path.basename(baseline_file)}")
            else:
                raise Exception("åŸºçº¿æ–‡æ¡£ä¸‹è½½å¤±è´¥")
        else:
            # ä¸å…è®¸é™çº§ï¼Œå¿…é¡»æœ‰ä¸‹è½½æ¨¡å—
            workflow_state.add_log("âŒ ä¸‹è½½æ¨¡å—æœªåŠ è½½", "ERROR")
            raise Exception("ä¸‹è½½æ¨¡å—æœªåŠ è½½ï¼Œæ— æ³•ç»§ç»­")
        
        # ========== æ­¥éª¤2: ä¸‹è½½ç›®æ ‡CSVæ–‡ä»¶ ==========
        workflow_state.update_progress("ä¸‹è½½ç›®æ ‡æ–‡æ¡£", 20)
        workflow_state.add_log("å¼€å§‹ä¸‹è½½ç›®æ ‡æ–‡æ¡£...")
        
        if MODULES_STATUS.get('downloader'):
            # ä¸ºç›®æ ‡æ–‡æ¡£åˆ›å»ºæ–°çš„exporterå®ä¾‹
            exporter_target = TencentDocAutoExporter()
            
            target_result = exporter_target.export_document(target_url, cookies=cookie, format='csv')
            if target_result and target_result.get('success'):
                target_file = target_result.get('file_path')
                workflow_state.target_file = target_file
                workflow_state.add_log(f"âœ… ç›®æ ‡æ–‡æ¡£ä¸‹è½½æˆåŠŸ: {os.path.basename(target_file)}")
            else:
                raise Exception("ç›®æ ‡æ–‡æ¡£ä¸‹è½½å¤±è´¥")
        else:
            workflow_state.target_file = str(DOWNLOAD_DIR / "test_target.csv")
            workflow_state.add_log("âš ï¸ ä¸‹è½½æ¨¡å—æœªåŠ è½½ï¼Œä½¿ç”¨æµ‹è¯•æ–‡ä»¶", "WARNING")
        
        # ========== æ­¥éª¤3: CSVå¯¹æ¯”åˆ†æ ==========
        workflow_state.update_progress("æ‰§è¡ŒCSVå¯¹æ¯”åˆ†æ", 30)
        workflow_state.add_log("å¼€å§‹å¯¹æ¯”åˆ†æ...")
        
        comparison_result = None
        if MODULES_STATUS.get('comparator'):
            # ä½¿ç”¨ç»Ÿä¸€CSVå¯¹æ¯”å™¨ï¼ˆæ ¹æ®è§„èŒƒè¦æ±‚ï¼‰
            unified_comparator = UnifiedCSVComparator()
            
            # ç›´æ¥å¯¹æ¯”CSVæ–‡ä»¶
            comparison_result = unified_comparator.compare(
                workflow_state.baseline_file,
                workflow_state.target_file
            )
            
            # ä¿å­˜å¯¹æ¯”ç»“æœ
            comparison_file = COMPARISON_RESULTS_DIR / f"comparison_{workflow_state.execution_id}.json"
            with open(comparison_file, 'w', encoding='utf-8') as f:
                json.dump(comparison_result, f, ensure_ascii=False, indent=2)
            
            # è·å–å˜æ›´æ•°é‡
            num_changes = comparison_result.get('statistics', {}).get('total_modifications', 0)
            workflow_state.add_log(f"âœ… å¯¹æ¯”åˆ†æå®Œæˆï¼Œå‘ç° {num_changes} å¤„å˜æ›´")
        else:
            workflow_state.add_log("âš ï¸ æ¯”è¾ƒæ¨¡å—æœªåŠ è½½ï¼Œè·³è¿‡", "WARNING")
        
        # ========== æ­¥éª¤4: åˆ—æ ‡å‡†åŒ– ==========
        workflow_state.update_progress("åˆ—æ ‡å‡†åŒ–å¤„ç†", 40)
        workflow_state.add_log("å¼€å§‹åˆ—æ ‡å‡†åŒ–...")
        
        standardized_result = None
        if MODULES_STATUS.get('standardizer') and comparison_result:
            try:
                from production.core_modules.column_standardization_prompt import ColumnStandardizationPrompt
                standardizer = ColumnStandardizationPrompt()
                
                # æå–åˆ—åè¿›è¡Œæ ‡å‡†åŒ–
                if workflow_state.baseline_file and workflow_state.target_file:
                    # è¯»å–æ–‡ä»¶è·å–åˆ—å
                    with open(workflow_state.baseline_file, 'r', encoding='utf-8') as f:
                        baseline_headers = csv.reader(f).__next__()
                    with open(workflow_state.target_file, 'r', encoding='utf-8') as f:
                        target_headers = csv.reader(f).__next__()
                    
                    # è°ƒç”¨æ ‡å‡†åŒ–ï¼ˆè¿™é‡Œå¯èƒ½éœ€è¦AIï¼Œä½†æˆ‘ä»¬ä½¿ç”¨è§„åˆ™åŸºç¡€æ–¹æ³•ï¼‰
                    standardized_result = {
                        'baseline_headers': baseline_headers,
                        'target_headers': target_headers,
                        'mapping': dict(zip(target_headers, baseline_headers[:len(target_headers)]))
                    }
                    workflow_state.add_log(f"âœ… åˆ—æ ‡å‡†åŒ–å®Œæˆï¼Œæ˜ å°„äº† {len(standardized_result['mapping'])} ä¸ªåˆ—")
            except Exception as e:
                workflow_state.add_log(f"âš ï¸ åˆ—æ ‡å‡†åŒ–å‡ºé”™: {str(e)}", "WARNING")
        else:
            workflow_state.add_log("âš ï¸ æ ‡å‡†åŒ–æ¨¡å—æœªåŠ è½½æˆ–æ— å¯¹æ¯”ç»“æœ", "WARNING")
        
        # ========== æ­¥éª¤5: L2è¯­ä¹‰åˆ†æ + L1L3è§„åˆ™æ‰“åˆ† ==========
        workflow_state.update_progress("è¯­ä¹‰åˆ†æå’Œæ‰“åˆ†", 50)
        workflow_state.add_log("å¼€å§‹L2è¯­ä¹‰åˆ†æå’ŒL1L3è§„åˆ™æ‰“åˆ†...")
        
        semantic_scores = None
        if MODULES_STATUS.get('l2_analyzer') and comparison_result:
            try:
                from production.core_modules.l2_semantic_analysis_two_layer import L2SemanticAnalyzer
                analyzer = L2SemanticAnalyzer()
                
                # å‡†å¤‡ä¿®æ”¹æ•°æ®æ ¼å¼ï¼ˆå…¼å®¹UnifiedCSVComparatorçš„è¾“å‡ºï¼‰
                modifications = []
                # UnifiedCSVComparatorä½¿ç”¨'modifications'è€Œä¸æ˜¯'changes'
                if comparison_result and 'modifications' in comparison_result:
                    for change in comparison_result['modifications']:
                        # ä»å•å…ƒæ ¼åœ°å€æå–è¡Œå·
                        cell = change.get('cell', 'A1')
                        row_num = int(''.join(filter(str.isdigit, cell))) if any(c.isdigit() for c in cell) else 0
                        
                        modifications.append({
                            'column_name': cell[0] if cell else '',
                            'old_value': change.get('old', ''),
                            'new_value': change.get('new', ''),
                            'row': row_num,
                            'cell': cell
                        })
                
                # æ‰§è¡Œè¯­ä¹‰åˆ†æï¼ˆä½¿ç”¨æ­£ç¡®çš„æ–¹æ³•åï¼‰
                semantic_scores = analyzer.analyze_modifications(modifications)
                workflow_state.add_log(f"âœ… è¯­ä¹‰åˆ†æå®Œæˆï¼Œåˆ†æäº† {len(modifications)} å¤„å˜æ›´")
            except Exception as e:
                workflow_state.add_log(f"âŒ è¯­ä¹‰åˆ†æå¤±è´¥: {str(e)}", "ERROR")
                raise  # ä¸å…è®¸é™çº§ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸
        
        # ========== æ­¥éª¤6: ç”Ÿæˆè¯¦ç»†æ‰“åˆ†JSON ==========
        workflow_state.update_progress("ç”Ÿæˆè¯¦ç»†æ‰“åˆ†", 60)
        workflow_state.add_log("ç”Ÿæˆè¯¦ç»†æ‰“åˆ†JSON...")
        
        if MODULES_STATUS.get('marker') and workflow_state.baseline_file and workflow_state.target_file:
            try:
                generator = DetailedScoreGenerator()
                
                # ä½¿ç”¨çœŸå®çš„æ‰“åˆ†ç”Ÿæˆæ–¹æ³•
                score_file_path = generator.generate_score_json(
                    baseline_file=workflow_state.baseline_file,
                    target_file=workflow_state.target_file,
                    output_dir=str(SCORING_RESULTS_DIR)
                )
                
                workflow_state.score_file = score_file_path
                workflow_state.add_log(f"âœ… è¯¦ç»†æ‰“åˆ†ç”Ÿæˆå®Œæˆ: {os.path.basename(score_file_path)}")
            except Exception as e:
                # ä¸å…è®¸é™çº§ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸
                workflow_state.add_log(f"âŒ æ‰“åˆ†ç”Ÿæˆå¤±è´¥: {str(e)}", "ERROR")
                raise
        
        # ========== æ­¥éª¤7: ä¸‹è½½ç›®æ ‡XLSX ==========
        workflow_state.update_progress("ä¸‹è½½Excelæ ¼å¼", 70)
        workflow_state.add_log("ä¸‹è½½ç›®æ ‡æ–‡æ¡£çš„Excelæ ¼å¼...")
        
        excel_file = None
        if MODULES_STATUS.get('downloader'):
            # ä¸ºExcelä¸‹è½½åˆ›å»ºæ–°çš„exporterå®ä¾‹
            exporter_excel = TencentDocAutoExporter()
            
            excel_result = exporter_excel.export_document(target_url, cookies=cookie, format='xlsx')
            if excel_result and excel_result.get('success'):
                excel_file = excel_result.get('file_path')
                workflow_state.add_log(f"âœ… Excelæ–‡æ¡£ä¸‹è½½æˆåŠŸ: {os.path.basename(excel_file)}")
            else:
                workflow_state.add_log("âš ï¸ Excelä¸‹è½½å¤±è´¥", "WARNING")
        
        # ========== æ­¥éª¤8: ä¿®å¤Excelæ ¼å¼ ==========
        if excel_file and MODULES_STATUS.get('fixer'):
            workflow_state.update_progress("ä¿®å¤Excelæ ¼å¼", 75)
            workflow_state.add_log("ä¿®å¤è…¾è®¯æ–‡æ¡£Excelæ ¼å¼é—®é¢˜...")
            
            fixed_file = fix_tencent_excel(excel_file)
            if fixed_file:
                excel_file = fixed_file
                workflow_state.add_log(f"âœ… Excelæ ¼å¼ä¿®å¤å®Œæˆ")
        
        # ========== æ­¥éª¤9: åº”ç”¨æ¡çº¹æ¶‚è‰² ==========
        if excel_file and MODULES_STATUS.get('marker') and workflow_state.score_file:
            workflow_state.update_progress("åº”ç”¨æ™ºèƒ½æ¶‚è‰²", 85)
            workflow_state.add_log("åº”ç”¨æ¡çº¹æ¶‚è‰²æ ‡è®°...")
            
            marker = IntelligentExcelMarker()
            marked_file = marker.apply_striped_coloring(
                excel_file,
                workflow_state.score_file
            )
            
            if marked_file:
                workflow_state.marked_file = marked_file
                workflow_state.add_log(f"âœ… æ¶‚è‰²æ ‡è®°å®Œæˆ: {os.path.basename(marked_file)}")
        
        # ========== æ­¥éª¤10: ä¸Šä¼ åˆ°è…¾è®¯æ–‡æ¡£ ==========
        if workflow_state.marked_file and MODULES_STATUS.get('uploader'):
            workflow_state.update_progress("ä¸Šä¼ è…¾è®¯æ–‡æ¡£", 95)
            workflow_state.add_log("ä¸Šä¼ å¤„ç†åçš„æ–‡æ¡£åˆ°è…¾è®¯æ–‡æ¡£...")
            
            # æ ¹æ®é«˜çº§è®¾ç½®å†³å®šä¸Šä¼ æ–¹å¼
            upload_option = advanced_settings.get('upload_option', 'new')
            target_doc_url = advanced_settings.get('upload_target_url', '')
            
            upload_result = sync_upload_file(
                workflow_state.marked_file,
                upload_option=upload_option,
                target_url=target_doc_url,
                cookie_string=cookie
            )
            
            if upload_result and upload_result.get('success'):
                workflow_state.upload_url = upload_result.get('url')
                workflow_state.add_log(f"âœ… æ–‡æ¡£ä¸Šä¼ æˆåŠŸ!")
                if workflow_state.upload_url:
                    workflow_state.add_log(f"ğŸ“ æ–‡æ¡£é“¾æ¥: {workflow_state.upload_url}")
            else:
                workflow_state.add_log("âš ï¸ æ–‡æ¡£ä¸Šä¼ å¤±è´¥", "WARNING")
        
        # ========== å®Œæˆ ==========
        workflow_state.update_progress("å¤„ç†å®Œæˆ", 100)
        workflow_state.status = "completed"
        workflow_state.end_time = datetime.now()
        workflow_state.add_log("ğŸ‰ æ‰€æœ‰æ­¥éª¤æ‰§è¡Œå®Œæˆ!", "SUCCESS")
        
        # ä¿å­˜ç»“æœ
        workflow_state.results = {
            "baseline_file": workflow_state.baseline_file,
            "target_file": workflow_state.target_file,
            "score_file": workflow_state.score_file,
            "marked_file": workflow_state.marked_file,
            "upload_url": workflow_state.upload_url,
            "execution_time": str(workflow_state.end_time - workflow_state.start_time) if workflow_state.end_time and workflow_state.start_time else None
        }
        
        # ä¿å­˜å†å²è®°å½•
        workflow_state.save_to_history()
        
    except Exception as e:
        workflow_state.status = "error"
        workflow_state.end_time = datetime.now()
        workflow_state.add_log(f"âŒ æ‰§è¡Œå‡ºé”™: {str(e)}", "ERROR")
        workflow_state.save_to_history()
        logger.error(f"å·¥ä½œæµæ‰§è¡Œå¤±è´¥: {e}", exc_info=True)

# ==================== Flaskè·¯ç”± ====================
@app.route('/')
def index():
    return render_template_string(HTML_TEMPLATE)

@app.route('/api/modules')
def get_modules():
    """è·å–æ¨¡å—åŠ è½½çŠ¶æ€"""
    return jsonify(MODULES_STATUS)

@app.route('/api/status')
def get_status():
    """è·å–å½“å‰å·¥ä½œæµçŠ¶æ€"""
    return jsonify({
        "status": workflow_state.status,
        "progress": workflow_state.progress,
        "current_task": workflow_state.current_task,
        "logs": workflow_state.logs[-50:],  # æœ€å50æ¡æ—¥å¿—
        "results": workflow_state.results
    })

@app.route('/api/start', methods=['POST'])
def start_workflow():
    """å¯åŠ¨å·¥ä½œæµ"""
    if workflow_state.status == "running":
        return jsonify({"error": "å·¥ä½œæµæ­£åœ¨è¿è¡Œä¸­"}), 400
    
    data = request.json
    baseline_url = data.get('baseline_url')
    target_url = data.get('target_url')
    cookie = data.get('cookie')
    advanced_settings = data.get('advanced_settings', {})
    
    if not all([baseline_url, target_url, cookie]):
        return jsonify({"error": "ç¼ºå°‘å¿…è¦å‚æ•°"}), 400
    
    # åœ¨åå°çº¿ç¨‹ä¸­è¿è¡Œå·¥ä½œæµ
    thread = threading.Thread(
        target=run_complete_workflow,
        args=(baseline_url, target_url, cookie, advanced_settings)
    )
    thread.daemon = True
    thread.start()
    
    return jsonify({"message": "å·¥ä½œæµå·²å¯åŠ¨", "execution_id": workflow_state.execution_id})

@app.route('/api/files/<path:category>')
def list_files(category):
    """åˆ—å‡ºç‰¹å®šç±»åˆ«çš„æ–‡ä»¶"""
    file_dirs = {
        'downloads': DOWNLOAD_DIR,
        'csv_versions': CSV_VERSIONS_DIR,
        'comparisons': COMPARISON_RESULTS_DIR,
        'scores': SCORING_RESULTS_DIR,
        'excel_outputs': EXCEL_OUTPUTS_DIR
    }
    
    if category not in file_dirs:
        return jsonify({"error": "æ— æ•ˆçš„æ–‡ä»¶ç±»åˆ«"}), 400
    
    target_dir = file_dirs[category]
    files = []
    
    for file_path in sorted(target_dir.glob('*'), key=lambda x: x.stat().st_mtime, reverse=True)[:20]:
        if file_path.is_file():
            files.append({
                'name': file_path.name,
                'size': file_path.stat().st_size,
                'modified': datetime.fromtimestamp(file_path.stat().st_mtime).isoformat(),
                'path': str(file_path)
            })
    
    return jsonify(files)

@app.route('/api/presets')
def list_presets():
    """åˆ—å‡ºæ‰€æœ‰é¢„è®¾"""
    return jsonify(PresetManager.list_presets())

@app.route('/api/presets/<name>')
def get_preset(name):
    """è·å–ç‰¹å®šé¢„è®¾"""
    preset = PresetManager.load_preset(name)
    if preset:
        return jsonify(preset)
    return jsonify({"error": "é¢„è®¾ä¸å­˜åœ¨"}), 404

@app.route('/api/presets', methods=['POST'])
def save_preset():
    """ä¿å­˜é¢„è®¾"""
    data = request.json
    name = data.get('name')
    config = data.get('config')
    
    if not name or not config:
        return jsonify({"error": "ç¼ºå°‘é¢„è®¾åç§°æˆ–é…ç½®"}), 400
    
    PresetManager.save_preset(name, config)
    return jsonify({"message": "é¢„è®¾ä¿å­˜æˆåŠŸ"})

@app.route('/api/history')
def list_history():
    """åˆ—å‡ºæ‰§è¡Œå†å²"""
    history_files = sorted(HISTORY_DIR.glob('*.json'), key=lambda x: x.stat().st_mtime, reverse=True)[:20]
    history = []
    
    for history_file in history_files:
        with open(history_file, 'r', encoding='utf-8') as f:
            data = json.load(f)
            history.append({
                'id': data['id'],
                'start_time': data['start_time'],
                'end_time': data['end_time'],
                'status': data['status'],
                'results': data.get('results', {})
            })
    
    return jsonify(history)

@app.route('/api/download/<path:file_path>')
def download_file(file_path):
    """ä¸‹è½½æ–‡ä»¶"""
    file_path = Path(file_path)
    if file_path.exists() and file_path.is_file():
        return send_file(str(file_path), as_attachment=True)
    return jsonify({"error": "æ–‡ä»¶ä¸å­˜åœ¨"}), 404

# ==================== HTMLæ¨¡æ¿ï¼ˆå¢å¼ºç‰ˆï¼‰ ====================
HTML_TEMPLATE = '''
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è…¾è®¯æ–‡æ¡£æ™ºèƒ½å¤„ç†ç³»ç»Ÿ - å®Œæ•´é›†æˆæµ‹è¯•ï¼ˆå¢å¼ºç‰ˆï¼‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .header p {
            color: #666;
            text-align: center;
        }
        
        .version-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr 400px;
            gap: 30px;
        }
        
        .panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            color: #666;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            margin-bottom: -2px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input, 
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, 
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .progress-bar {
            height: 40px;
            background: #f0f0f0;
            border-radius: 20px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            transition: width 0.5s ease;
        }
        
        .modules-status {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .module-item {
            padding: 8px;
            border-radius: 8px;
            font-size: 12px;
            text-align: center;
        }
        
        .module-loaded {
            background: #E8F5E9;
            color: #2E7D32;
        }
        
        .module-failed {
            background: #FFEBEE;
            color: #C62828;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-idle { background: #9E9E9E; }
        .status-running { 
            background: #4CAF50;
            animation: pulse 1.5s infinite;
        }
        .status-completed { background: #2196F3; }
        .status-error { background: #F44336; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .log-container {
            height: 400px;
            overflow-y: auto;
            background: #f8f8f8;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 5px;
            background: white;
        }
        
        .log-INFO { border-left: 3px solid #4CAF50; }
        .log-WARNING { 
            border-left: 3px solid #FF9800;
            background: #FFF3E0;
        }
        .log-ERROR { 
            border-left: 3px solid #F44336;
            background: #FFEBEE;
        }
        .log-SUCCESS {
            border-left: 3px solid #2196F3;
            background: #E3F2FD;
            font-weight: bold;
        }
        
        .results-panel {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .result-item a {
            color: #667eea;
            text-decoration: none;
        }
        
        .file-browser {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 10px;
        }
        
        .file-item {
            padding: 8px;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.2s;
        }
        
        .file-item:hover {
            background: #f0f0f0;
        }
        
        .file-item.selected {
            background: #E3F2FD;
            border: 1px solid #2196F3;
        }
        
        .history-item {
            padding: 15px;
            background: #f8f8f8;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .history-item:hover {
            background: #e0e0e0;
            transform: translateX(5px);
        }
        
        .preset-item {
            padding: 12px;
            background: #f8f8f8;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preset-item:hover {
            background: #e0e0e0;
        }
        
        .advanced-settings {
            background: #f8f8f8;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .setting-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .setting-row label {
            flex: 1;
            margin-bottom: 0;
        }
        
        .setting-row input[type="checkbox"] {
            width: auto;
            margin-left: 10px;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .quick-action-btn {
            padding: 10px;
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .quick-action-btn:hover {
            background: #e0e0e0;
            border-color: #667eea;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ è…¾è®¯æ–‡æ¡£æ™ºèƒ½å¤„ç†ç³»ç»Ÿ <span class="version-badge">v5.0 å¢å¼ºç‰ˆ</span></h1>
            <div style="background: #f0f8ff; border-left: 4px solid #1890ff; padding: 12px; margin: 20px 0; border-radius: 4px;">
                <strong>ğŸ“Œ ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                    <li><strong>åŸºçº¿æ–‡æ¡£</strong>ï¼šé€‰æ‹©ä¸Šå‘¨æˆ–æ›´æ—©çš„ç‰ˆæœ¬ä½œä¸ºå¯¹æ¯”åŸºå‡†</li>
                    <li><strong>ç›®æ ‡æ–‡æ¡£</strong>ï¼šé€‰æ‹©å½“å‰æœ€æ–°ç‰ˆæœ¬è¿›è¡Œå˜æ›´æ£€æµ‹</li>
                    <li><strong>é‡è¦</strong>ï¼šä¸¤ä¸ªURLå¿…é¡»ä¸åŒï¼Œå¦åˆ™æ— æ³•æ£€æµ‹åˆ°å˜æ›´</li>
                </ul>
            </div>
            <p>å®Œæ•´é›†æˆæµ‹è¯• - ä»ä¸‹è½½åˆ°ä¸Šä¼ çš„å…¨è‡ªåŠ¨åŒ–æµç¨‹</p>
        </div>
        
        <div class="main-content">
            <!-- å·¦ä¾§é¢æ¿ï¼šè¾“å…¥é…ç½® -->
            <div class="panel">
                <h2>ğŸ“¥ è¾“å…¥é…ç½®</h2>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('basic')">åŸºç¡€é…ç½®</button>
                    <button class="tab" onclick="switchTab('advanced')">é«˜çº§é€‰é¡¹</button>
                    <button class="tab" onclick="switchTab('presets')">é¢„è®¾æ¨¡æ¿</button>
                </div>
                
                <!-- åŸºç¡€é…ç½® -->
                <div id="basic-tab" class="tab-content active">
                    <div class="form-group">
                        <label>åŸºçº¿æ–‡æ¡£é“¾æ¥ <span style="color: #666; font-size: 12px;">(ä¸Šå‘¨æˆ–æ›´æ—©ç‰ˆæœ¬)</span></label>
                        <input type="text" id="baselineUrl" placeholder="https://docs.qq.com/sheet/xxx (æ—§ç‰ˆæœ¬)">
                        <button class="btn-secondary" style="margin-top: 5px; padding: 5px;" onclick="browseFiles('baseline')">
                            ğŸ“ é€‰æ‹©å·²ä¸‹è½½æ–‡ä»¶
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label>ç›®æ ‡æ–‡æ¡£é“¾æ¥ <span style="color: #666; font-size: 12px;">(å½“å‰æœ€æ–°ç‰ˆæœ¬)</span></label>
                        <input type="text" id="targetUrl" placeholder="https://docs.qq.com/sheet/xxx (æ–°ç‰ˆæœ¬)">
                        <button class="btn-secondary" style="margin-top: 5px; padding: 5px;" onclick="browseFiles('target')">
                            ğŸ“ é€‰æ‹©å·²ä¸‹è½½æ–‡ä»¶
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label>Cookieï¼ˆç”¨äºä¸‹è½½å’Œä¸Šä¼ ï¼‰</label>
                        <textarea id="cookie" rows="4" placeholder="è¾“å…¥å®Œæ•´çš„Cookieå­—ç¬¦ä¸²"></textarea>
                        <button class="btn-secondary" style="margin-top: 5px; padding: 5px;" onclick="loadSavedCookie()">
                            ğŸ” åŠ è½½ä¿å­˜çš„Cookie
                        </button>
                    </div>
                    
                    <button class="btn" id="startBtn" onclick="startWorkflow()">
                        å¼€å§‹æ‰§è¡Œå®Œæ•´æµç¨‹
                    </button>
                </div>
                
                <!-- é«˜çº§é€‰é¡¹ -->
                <div id="advanced-tab" class="tab-content">
                    <div class="advanced-settings">
                        <div class="setting-row">
                            <label>ä¸Šä¼ æ–¹å¼</label>
                            <select id="uploadOption">
                                <option value="new">åˆ›å»ºæ–°æ–‡æ¡£</option>
                                <option value="replace">æ›¿æ¢ç°æœ‰æ–‡æ¡£</option>
                            </select>
                        </div>
                        
                        <div class="setting-row">
                            <label>ç›®æ ‡æ–‡æ¡£URLï¼ˆæ›¿æ¢æ¨¡å¼ï¼‰</label>
                            <input type="text" id="uploadTargetUrl" placeholder="ç•™ç©ºåˆ™åˆ›å»ºæ–°æ–‡æ¡£">
                        </div>
                        
                        <div class="setting-row">
                            <label>å¯ç”¨è¯¦ç»†æ—¥å¿—</label>
                            <input type="checkbox" id="verboseLogging">
                        </div>
                        
                        <div class="setting-row">
                            <label>ä¿å­˜æ‰§è¡Œé…ç½®ä¸ºé¢„è®¾</label>
                            <input type="checkbox" id="saveAsPreset">
                        </div>
                        
                        <div class="form-group" id="presetNameGroup" style="display: none;">
                            <label>é¢„è®¾åç§°</label>
                            <input type="text" id="presetName" placeholder="è¾“å…¥é¢„è®¾åç§°">
                        </div>
                    </div>
                </div>
                
                <!-- é¢„è®¾æ¨¡æ¿ -->
                <div id="presets-tab" class="tab-content">
                    <div class="quick-actions">
                        <div class="quick-action-btn" onclick="loadPreset('weekly_check')">
                            ğŸ“… å‘¨åº¦æ£€æŸ¥
                        </div>
                        <div class="quick-action-btn" onclick="loadPreset('emergency_check')">
                            ğŸš¨ ç´§æ€¥æ£€æŸ¥
                        </div>
                        <div class="quick-action-btn" onclick="loadPreset('full_analysis')">
                            ğŸ“Š å®Œæ•´åˆ†æ
                        </div>
                        <div class="quick-action-btn" onclick="loadPreset('quick_test')">
                            âš¡ å¿«é€Ÿæµ‹è¯•
                        </div>
                    </div>
                    
                    <div id="presetsList"></div>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%">
                        0%
                    </div>
                </div>
                
                <div class="modules-status" id="modulesStatus"></div>
            </div>
            
            <!-- ä¸­é—´é¢æ¿ï¼šæ‰§è¡ŒçŠ¶æ€å’Œæ—¥å¿— -->
            <div class="panel">
                <h2>ğŸ“Š æ‰§è¡ŒçŠ¶æ€</h2>
                
                <div style="margin-bottom: 15px;">
                    <span class="status-indicator status-idle" id="statusIndicator"></span>
                    <span id="statusText">ç­‰å¾…å¼€å§‹</span>
                    <span style="float: right;" id="currentTask"></span>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="changedCells">0</div>
                        <div class="stat-label">å˜æ›´å•å…ƒæ ¼</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #FF6B6B, #FF8E53);">
                        <div class="stat-value" id="riskScore">0</div>
                        <div class="stat-label">é£é™©åˆ†æ•°</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #4ECDC4, #44A08D);">
                        <div class="stat-value" id="executionTime">00:00</div>
                        <div class="stat-label">æ‰§è¡Œæ—¶é—´</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #FA709A, #FEE140);">
                        <div class="stat-value" id="successRate">0%</div>
                        <div class="stat-label">æˆåŠŸç‡</div>
                    </div>
                </div>
                
                <div class="log-container" id="logContainer"></div>
                
                <div class="results-panel" id="resultsPanel">
                    <h3>ğŸ“ å¤„ç†ç»“æœ</h3>
                    <div id="resultsContent"></div>
                </div>
            </div>
            
            <!-- å³ä¾§é¢æ¿ï¼šå†å²è®°å½•å’Œæ–‡ä»¶ç®¡ç† -->
            <div class="panel">
                <h2>ğŸ“š å†å²ä¸æ–‡ä»¶</h2>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchRightTab('history')">æ‰§è¡Œå†å²</button>
                    <button class="tab" onclick="switchRightTab('files')">æ–‡ä»¶ç®¡ç†</button>
                </div>
                
                <!-- æ‰§è¡Œå†å² -->
                <div id="history-tab" class="tab-content active">
                    <div id="historyList"></div>
                </div>
                
                <!-- æ–‡ä»¶ç®¡ç† -->
                <div id="files-tab" class="tab-content">
                    <div class="form-group">
                        <label>æ–‡ä»¶ç±»åˆ«</label>
                        <select id="fileCategory" onchange="loadFiles()">
                            <option value="downloads">ä¸‹è½½æ–‡ä»¶</option>
                            <option value="csv_versions">CSVç‰ˆæœ¬</option>
                            <option value="comparisons">å¯¹æ¯”ç»“æœ</option>
                            <option value="scores">æ‰“åˆ†æ–‡ä»¶</option>
                            <option value="excel_outputs">Excelè¾“å‡º</option>
                        </select>
                    </div>
                    
                    <div class="file-browser" id="fileBrowser"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡† -->
    <div id="fileDialog" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 20px; width: 600px; max-height: 500px;">
            <h3>é€‰æ‹©æ–‡ä»¶</h3>
            <div class="file-browser" id="dialogFileBrowser" style="height: 300px; margin: 20px 0;"></div>
            <div style="text-align: right;">
                <button class="btn-secondary" style="width: auto; padding: 10px 20px; margin-right: 10px;" onclick="closeFileDialog()">å–æ¶ˆ</button>
                <button class="btn" style="width: auto; padding: 10px 20px;" onclick="selectFile()">é€‰æ‹©</button>
            </div>
        </div>
    </div>
    
    <script>
        let isRunning = false;
        let statusInterval = null;
        let selectedFile = null;
        let fileDialogTarget = null;
        let executionStartTime = null;
        let timeInterval = null;
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            loadModules();
            loadHistory();
            loadPresets();
            
            // ç›‘å¬é«˜çº§è®¾ç½®å˜åŒ–
            document.getElementById('saveAsPreset').addEventListener('change', function(e) {
                document.getElementById('presetNameGroup').style.display = e.target.checked ? 'block' : 'none';
            });
        }
        
        function loadModules() {
            fetch('/api/modules')
                .then(r => r.json())
                .then(data => {
                    displayModules(data);
                });
        }
        
        function displayModules(modules) {
            const container = document.getElementById('modulesStatus');
            container.innerHTML = '<h4 style="grid-column: 1/-1; margin-bottom: 10px;">æ¨¡å—åŠ è½½çŠ¶æ€</h4>';
            
            const moduleNames = {
                'downloader': 'ä¸‹è½½æ¨¡å—',
                'comparator': 'æ¯”è¾ƒæ¨¡å—',
                'standardizer': 'æ ‡å‡†åŒ–',
                'l2_analyzer': 'L2åˆ†æ',
                'marker': 'æ™ºèƒ½æ ‡è®°',
                'fixer': 'Excelä¿®å¤',
                'uploader': 'ä¸Šä¼ æ¨¡å—',
                'week_manager': 'æ—¶é—´ç®¡ç†'
            };
            
            let loadedCount = 0;
            let totalCount = 0;
            
            for (let [key, loaded] of Object.entries(modules)) {
                totalCount++;
                if (loaded) loadedCount++;
                
                const div = document.createElement('div');
                div.className = 'module-item ' + (loaded ? 'module-loaded' : 'module-failed');
                div.innerHTML = (loaded ? 'âœ… ' : 'âŒ ') + (moduleNames[key] || key);
                container.appendChild(div);
            }
            
            // æ›´æ–°æˆåŠŸç‡
            document.getElementById('successRate').textContent = Math.round(loadedCount / totalCount * 100) + '%';
        }
        
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        function switchRightTab(tabName) {
            // å³ä¾§é¢æ¿çš„æ ‡ç­¾åˆ‡æ¢
            const rightPanel = event.target.closest('.panel');
            rightPanel.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            rightPanel.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            rightPanel.querySelector('#' + tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'files') {
                loadFiles();
            }
        }
        
        function startWorkflow() {
            if (isRunning) {
                alert('å·¥ä½œæµæ­£åœ¨è¿è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆ');
                return;
            }
            
            const baselineUrl = document.getElementById('baselineUrl').value;
            const targetUrl = document.getElementById('targetUrl').value;
            const cookie = document.getElementById('cookie').value;
            
            if (!baselineUrl || !targetUrl || !cookie) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…è¦å­—æ®µ');
                return;
            }
            
            // éªŒè¯URLä¸èƒ½ç›¸åŒ
            if (baselineUrl === targetUrl) {
                alert('âŒ é”™è¯¯ï¼šåŸºçº¿æ–‡æ¡£å’Œç›®æ ‡æ–‡æ¡£ä¸èƒ½ç›¸åŒï¼\n\n' +
                      'åŸºçº¿æ–‡æ¡£ï¼šåº”é€‰æ‹©ä¸Šå‘¨æˆ–æ›´æ—©ç‰ˆæœ¬\n' +
                      'ç›®æ ‡æ–‡æ¡£ï¼šåº”é€‰æ‹©å½“å‰æœ€æ–°ç‰ˆæœ¬\n\n' +
                      'è¯·ä½¿ç”¨ä¸åŒçš„æ–‡æ¡£URLè¿›è¡Œå¯¹æ¯”ã€‚');
                return;
            }
            
            // æ”¶é›†é«˜çº§è®¾ç½®
            const advancedSettings = {
                upload_option: document.getElementById('uploadOption').value,
                upload_target_url: document.getElementById('uploadTargetUrl').value,
                verbose_logging: document.getElementById('verboseLogging').checked
            };
            
            // å¦‚æœéœ€è¦ä¿å­˜ä¸ºé¢„è®¾
            if (document.getElementById('saveAsPreset').checked) {
                const presetName = document.getElementById('presetName').value;
                if (presetName) {
                    savePreset(presetName, {
                        baseline_url: baselineUrl,
                        target_url: targetUrl,
                        advanced_settings: advancedSettings,
                        description: 'ç”¨æˆ·è‡ªå®šä¹‰é¢„è®¾'
                    });
                }
            }
            
            isRunning = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('logContainer').innerHTML = '';
            document.getElementById('resultsContent').innerHTML = '';
            
            // å¼€å§‹è®¡æ—¶
            executionStartTime = Date.now();
            timeInterval = setInterval(updateExecutionTime, 1000);
            
            fetch('/api/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    baseline_url: baselineUrl,
                    target_url: targetUrl,
                    cookie: cookie,
                    advanced_settings: advancedSettings
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    resetUI();
                } else {
                    // å¼€å§‹è½®è¯¢çŠ¶æ€
                    statusInterval = setInterval(updateStatus, 1000);
                }
            });
        }
        
        function updateStatus() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    // æ›´æ–°è¿›åº¦æ¡
                    document.getElementById('progressBar').style.width = data.progress + '%';
                    document.getElementById('progressBar').textContent = data.progress + '%';
                    
                    // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
                    const indicator = document.getElementById('statusIndicator');
                    indicator.className = 'status-indicator status-' + data.status;
                    
                    // æ›´æ–°çŠ¶æ€æ–‡æœ¬
                    const statusTexts = {
                        'idle': 'ç­‰å¾…å¼€å§‹',
                        'running': 'æ­£åœ¨æ‰§è¡Œ',
                        'completed': 'æ‰§è¡Œå®Œæˆ',
                        'error': 'æ‰§è¡Œå‡ºé”™'
                    };
                    document.getElementById('statusText').textContent = statusTexts[data.status] || data.status;
                    
                    // æ›´æ–°å½“å‰ä»»åŠ¡
                    document.getElementById('currentTask').textContent = data.current_task || '';
                    
                    // æ›´æ–°æ—¥å¿—
                    if (data.logs && data.logs.length > 0) {
                        const container = document.getElementById('logContainer');
                        container.innerHTML = '';
                        data.logs.forEach(log => {
                            const div = document.createElement('div');
                            div.className = 'log-entry log-' + log.level;
                            div.innerHTML = `<span style="color: #666;">[${log.time}]</span> ${log.message}`;
                            container.appendChild(div);
                        });
                        container.scrollTop = container.scrollHeight;
                    }
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    if (data.results && data.results.statistics) {
                        const stats = data.results.statistics;
                        document.getElementById('changedCells').textContent = stats.changed_cells || 0;
                        document.getElementById('riskScore').textContent = stats.risk_score || 0;
                    }
                    
                    // å¦‚æœå®Œæˆæˆ–å‡ºé”™ï¼Œåœæ­¢è½®è¯¢
                    if (data.status === 'completed' || data.status === 'error') {
                        clearInterval(statusInterval);
                        clearInterval(timeInterval);
                        isRunning = false;
                        document.getElementById('startBtn').disabled = false;
                        
                        // æ˜¾ç¤ºç»“æœ
                        if (data.results) {
                            displayResults(data.results);
                        }
                        
                        // åˆ·æ–°å†å²è®°å½•
                        loadHistory();
                    }
                });
        }
        
        function updateExecutionTime() {
            if (executionStartTime) {
                const elapsed = Math.floor((Date.now() - executionStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('executionTime').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        function displayResults(results) {
            const container = document.getElementById('resultsContent');
            container.innerHTML = '';
            
            const files = [
                {label: 'åŸºçº¿æ–‡ä»¶', key: 'baseline_file'},
                {label: 'ç›®æ ‡æ–‡ä»¶', key: 'target_file'},
                {label: 'æ‰“åˆ†æ–‡ä»¶', key: 'score_file'},
                {label: 'æ ‡è®°æ–‡ä»¶', key: 'marked_file'}
            ];
            
            files.forEach(file => {
                if (results[file.key]) {
                    const div = document.createElement('div');
                    div.className = 'result-item';
                    const filename = results[file.key].split('/').pop();
                    div.innerHTML = `
                        <span>${file.label}: ${filename}</span>
                        <a href="/api/download/${results[file.key]}" download>ä¸‹è½½</a>
                    `;
                    container.appendChild(div);
                }
            });
            
            if (results.upload_url) {
                const div = document.createElement('div');
                div.className = 'result-item';
                div.innerHTML = `
                    <span>ä¸Šä¼ é“¾æ¥:</span>
                    <a href="${results.upload_url}" target="_blank">æ‰“å¼€æ–‡æ¡£</a>
                `;
                container.appendChild(div);
            }
        }
        
        function resetUI() {
            isRunning = false;
            document.getElementById('startBtn').disabled = false;
            clearInterval(statusInterval);
            clearInterval(timeInterval);
        }
        
        function browseFiles(target) {
            fileDialogTarget = target;
            document.getElementById('fileDialog').style.display = 'block';
            loadDialogFiles();
        }
        
        function loadDialogFiles() {
            fetch('/api/files/downloads')
                .then(r => r.json())
                .then(files => {
                    const browser = document.getElementById('dialogFileBrowser');
                    browser.innerHTML = '';
                    
                    files.forEach(file => {
                        const div = document.createElement('div');
                        div.className = 'file-item';
                        div.onclick = () => {
                            document.querySelectorAll('.file-item').forEach(item => {
                                item.classList.remove('selected');
                            });
                            div.classList.add('selected');
                            selectedFile = file;
                        };
                        
                        const size = (file.size / 1024).toFixed(2) + ' KB';
                        const date = new Date(file.modified).toLocaleDateString();
                        
                        div.innerHTML = `
                            <div style="font-weight: 500;">${file.name}</div>
                            <div style="font-size: 12px; color: #666;">${size} | ${date}</div>
                        `;
                        
                        browser.appendChild(div);
                    });
                });
        }
        
        function selectFile() {
            if (selectedFile) {
                if (fileDialogTarget === 'baseline') {
                    document.getElementById('baselineUrl').value = selectedFile.path;
                } else if (fileDialogTarget === 'target') {
                    document.getElementById('targetUrl').value = selectedFile.path;
                }
            }
            closeFileDialog();
        }
        
        function closeFileDialog() {
            document.getElementById('fileDialog').style.display = 'none';
            selectedFile = null;
            fileDialogTarget = null;
        }
        
        function loadFiles() {
            const category = document.getElementById('fileCategory').value;
            fetch('/api/files/' + category)
                .then(r => r.json())
                .then(files => {
                    const browser = document.getElementById('fileBrowser');
                    browser.innerHTML = '';
                    
                    files.forEach(file => {
                        const div = document.createElement('div');
                        div.className = 'file-item';
                        
                        const size = (file.size / 1024).toFixed(2) + ' KB';
                        const date = new Date(file.modified).toLocaleDateString();
                        
                        div.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 500;">${file.name}</div>
                                    <div style="font-size: 12px; color: #666;">${size} | ${date}</div>
                                </div>
                                <a href="/api/download/${file.path}" download style="color: #667eea;">ä¸‹è½½</a>
                            </div>
                        `;
                        
                        browser.appendChild(div);
                    });
                });
        }
        
        function loadHistory() {
            fetch('/api/history')
                .then(r => r.json())
                .then(history => {
                    const container = document.getElementById('historyList');
                    container.innerHTML = '';
                    
                    if (history.length === 0) {
                        container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— æ‰§è¡Œå†å²</div>';
                        return;
                    }
                    
                    history.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'history-item';
                        
                        const startTime = item.start_time ? new Date(item.start_time).toLocaleString() : 'æœªçŸ¥';
                        const statusIcon = {
                            'completed': 'âœ…',
                            'error': 'âŒ',
                            'running': 'â³'
                        }[item.status] || 'â“';
                        
                        div.innerHTML = `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <strong>${statusIcon} ${item.id}</strong>
                                <span style="color: #666; font-size: 12px;">${item.status}</span>
                            </div>
                            <div style="font-size: 12px; color: #666;">${startTime}</div>
                        `;
                        
                        div.onclick = () => loadHistoryDetails(item.id);
                        container.appendChild(div);
                    });
                });
        }
        
        function loadHistoryDetails(id) {
            // å¯ä»¥å±•å¼€æ˜¾ç¤ºå†å²è¯¦æƒ…
            console.log('Loading history:', id);
        }
        
        function loadPresets() {
            fetch('/api/presets')
                .then(r => r.json())
                .then(presets => {
                    const container = document.getElementById('presetsList');
                    container.innerHTML = '<h4 style="margin-bottom: 10px;">è‡ªå®šä¹‰é¢„è®¾</h4>';
                    
                    if (presets.length === 0) {
                        container.innerHTML += '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— è‡ªå®šä¹‰é¢„è®¾</div>';
                        return;
                    }
                    
                    presets.forEach(preset => {
                        const div = document.createElement('div');
                        div.className = 'preset-item';
                        div.innerHTML = `
                            <div>
                                <div style="font-weight: 500;">${preset.name}</div>
                                <div style="font-size: 12px; color: #666;">${preset.description}</div>
                            </div>
                            <button class="btn-secondary" style="width: auto; padding: 5px 15px;" onclick="applyPreset('${preset.name}')">åº”ç”¨</button>
                        `;
                        container.appendChild(div);
                    });
                });
        }
        
        function loadPreset(presetType) {
            // é¢„å®šä¹‰çš„å¿«é€Ÿé¢„è®¾
            const presets = {
                'weekly_check': {
                    baseline_url: 'https://docs.qq.com/sheet/baseline_week',
                    target_url: 'https://docs.qq.com/sheet/target_week',
                    advanced_settings: {
                        upload_option: 'new'
                    }
                },
                'emergency_check': {
                    baseline_url: '',
                    target_url: '',
                    advanced_settings: {
                        upload_option: 'replace',
                        verbose_logging: true
                    }
                },
                'full_analysis': {
                    baseline_url: '',
                    target_url: '',
                    advanced_settings: {
                        upload_option: 'new',
                        verbose_logging: true
                    }
                },
                'quick_test': {
                    baseline_url: '',
                    target_url: '',
                    advanced_settings: {
                        upload_option: 'new'
                    }
                }
            };
            
            const preset = presets[presetType];
            if (preset) {
                if (preset.baseline_url) document.getElementById('baselineUrl').value = preset.baseline_url;
                if (preset.target_url) document.getElementById('targetUrl').value = preset.target_url;
                if (preset.advanced_settings) {
                    document.getElementById('uploadOption').value = preset.advanced_settings.upload_option || 'new';
                    document.getElementById('uploadTargetUrl').value = preset.advanced_settings.upload_target_url || '';
                    document.getElementById('verboseLogging').checked = preset.advanced_settings.verbose_logging || false;
                }
                
                // åˆ‡æ¢åˆ°åŸºç¡€é…ç½®æ ‡ç­¾
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.querySelector('.tab').classList.add('active');
                document.getElementById('basic-tab').classList.add('active');
            }
        }
        
        function applyPreset(name) {
            fetch('/api/presets/' + name)
                .then(r => r.json())
                .then(preset => {
                    if (preset.baseline_url) document.getElementById('baselineUrl').value = preset.baseline_url;
                    if (preset.target_url) document.getElementById('targetUrl').value = preset.target_url;
                    if (preset.cookie) document.getElementById('cookie').value = preset.cookie;
                    if (preset.advanced_settings) {
                        document.getElementById('uploadOption').value = preset.advanced_settings.upload_option || 'new';
                        document.getElementById('uploadTargetUrl').value = preset.advanced_settings.upload_target_url || '';
                        document.getElementById('verboseLogging').checked = preset.advanced_settings.verbose_logging || false;
                    }
                    
                    // åˆ‡æ¢åˆ°åŸºç¡€é…ç½®æ ‡ç­¾
                    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.querySelector('.tab').classList.add('active');
                    document.getElementById('basic-tab').classList.add('active');
                });
        }
        
        function savePreset(name, config) {
            fetch('/api/presets', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: name,
                    config: config
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.message) {
                    loadPresets();
                }
            });
        }
        
        function loadSavedCookie() {
            // å°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½Cookie
            const savedCookie = localStorage.getItem('tencent_doc_cookie');
            if (savedCookie) {
                document.getElementById('cookie').value = savedCookie;
                alert('CookieåŠ è½½æˆåŠŸ');
            } else {
                alert('æ²¡æœ‰ä¿å­˜çš„Cookie');
            }
        }
        
        // ä¿å­˜Cookieåˆ°æœ¬åœ°å­˜å‚¨
        document.getElementById('cookie').addEventListener('change', function() {
            if (this.value) {
                localStorage.setItem('tencent_doc_cookie', this.value);
            }
        });
    </script>
</body>
</html>
'''

# ==================== ä¸»ç¨‹åºå…¥å£ ====================
if __name__ == '__main__':
    logger.info("="*60)
    logger.info("è…¾è®¯æ–‡æ¡£æ™ºèƒ½å¤„ç†ç³»ç»Ÿ - å®Œæ•´é›†æˆæµ‹è¯•ï¼ˆå¢å¼ºç‰ˆï¼‰")
    logger.info(f"è®¿é—®: http://localhost:8093")
    logger.info("="*60)
    
    # å°è¯•å¤šä¸ªç«¯å£
    ports = [8093, 8094, 8095, 8096, 8097, 8098, 8099, 8100, 8101, 8102]
    
    for port in ports:
        try:
            app.run(host='0.0.0.0', port=port, debug=False)
            break
        except OSError as e:
            if "Address already in use" in str(e):
                logger.warning(f"ç«¯å£ {port} å·²è¢«å ç”¨ï¼Œå°è¯•ä¸‹ä¸€ä¸ª...")
                continue
            else:
                raise
    else:
        logger.error("æ‰€æœ‰ç«¯å£éƒ½è¢«å ç”¨ï¼Œæ— æ³•å¯åŠ¨æœåŠ¡")